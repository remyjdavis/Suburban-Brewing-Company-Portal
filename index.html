<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8" />
  <title>Suburban Brewing Co. | Command Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Suburban Brewing">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">
  
  <link rel="icon" type="image/png" href="Logo.png">
  <link rel="apple-touch-icon" href="Logo.png">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <script src="/Suburban-Brewing-Company-Portal/portal.js" defer></script>

  <style>
    /* --- SHARED THEME VARIABLES --- */
    :root {
      --bg: #f8fafc;
      --sidebar: #0f172a;
      --accent: #2563eb;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --card-bg: #ffffff;
      
      /* Status Colors */
      --fermenting: #f59e0b;
      --crashing: #3b82f6;
      --ready: #10b981;
      --carbonating: #8b5cf6;
      --danger: #ef4444;
      --ml-blue: #3498db;
      --purple-accent: #8b5cf6;
      --green-accent: #10b981;
    }

    /* --- GLOBAL RESET & LAYOUT --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; background: var(--bg); color: var(--text-main); 
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      display: flex; min-height: 100vh;
    }

    /* --- AUTO-HIDING SIDEBAR (PHANTOM DRAWER) --- */
    .sidebar { 
        width: 260px; 
        background: var(--sidebar); 
        color: #fff; 
        padding: 24px 0; 
        flex-shrink: 0; 
        position: fixed; 
        height: 100vh; 
        /* Hide scrollbar when closed for clean edge */
        overflow-y: hidden; 
        z-index: 3000; /* High Z-index to float over everything */
        
        /* LOGIC: Push off-screen, leaving 10px visible */
        left: 0;
        transform: translateX(-250px); 
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
    }

    /* OPEN ON HOVER */
    .sidebar:hover {
        transform: translateX(0);
        box-shadow: 10px 0 25px rgba(0,0,0,0.5);
        overflow-y: auto; /* Re-enable scrolling when open */
    }

    .sidebar h2 { margin: 0 24px 32px; font-size: 20px; font-weight: 800; color: #fff; }

    /* COLLAPSIBLE HEADERS */
    .nav-section-header, .section-heading, .subsection-heading { 
      cursor: pointer; display: flex; justify-content: space-between; align-items: center;
      user-select: none;
    }

    .nav-section-header {
      font-size: 11px; text-transform: uppercase; color: #94a3b8; 
      margin: 18px 24px 8px; font-weight: 700; letter-spacing: 1px; 
    }
    .nav-section-header:hover { color: #fff; }

    .section-heading { 
      font-size: 16px; font-weight: 800; margin: 30px 0 15px; 
      color: var(--text-main); text-transform: uppercase;
      padding-bottom: 8px; border-bottom: 2px solid #e2e8f0;
    }
    .section-heading:hover { color: var(--accent); border-bottom-color: var(--accent); }

    .subsection-heading {
      font-size: 13px; font-weight: 700; margin: 20px 0 10px 10px;
      color: var(--text-muted); text-transform: uppercase;
      padding-bottom: 5px; border-bottom: 1px dashed #cbd5e1;
    }
    .subsection-heading:hover { color: var(--accent); }

    .chevron { transition: transform 0.3s ease; font-size: 10px; }
    .collapsed .chevron { transform: rotate(-90deg); }

    .collapsible-content {
      max-height: 2500px; overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
      opacity: 1;
    }
    .collapsible-content.collapsed { max-height: 0; opacity: 0; }

    /* LINKS */
    .nav-link { 
      display: flex; align-items: center; padding: 10px 24px; 
      color: #64748b; text-decoration: none; font-size: 14px; 
      transition: 0.2s; border-left: 4px solid transparent;
    }
    .nav-link:hover, .nav-link.active { color: #fff; background: #1e293b; }
    .nav-link.active { border-left-color: var(--accent); color: #fff; }

   /* --- FULL WIDTH MAIN CONTENT --- */
    .main { 
        flex: 1; 
        margin-left: 0 !important; 
        width: 100%; 
        display: flex; 
        flex-direction: column;
        
        /* FIX: Add safety padding so text isn't cut off by the screen edge */
        padding-left: 50px; 
        padding-right: 40px;
    }
    /* Mobile Handling: Disable the hover effect on phones */
    @media (max-width: 1024px) {
        .sidebar { 
            transform: none !important; /* Reset the slide logic */
            left: -260px; /* Completely hide it */
            overflow-y: auto; /* Ensure scrolling works if opened via button */
        }
        .sidebar.open { 
            left: 0; /* Button click brings it back */
        }
        
        /* Ensure main content has padding on mobile */
        .main { padding: 20px 15px; }

        /* Floating Menu Toggle Button (Thumb-zone optimized) */
        #menu-toggle {
            display: flex;
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            z-index: 10001;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            cursor: pointer;
            border: none;
        }
        
        /* Ensure text labels and headers remain visible in the mobile drawer */
        .sidebar h2, .nav-section-header, .sidebar span { display: block !important; }
        
        /* Dark background overlay when menu is active */
        .menu-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            backdrop-filter: blur(2px);
        }
        .menu-overlay.active { display: block; }
    }
    
    #menu-toggle { display: none; } /* Hidden on Desktop */

    .header-bar { margin-bottom: 32px; }
    .header-bar h1 { font-size: 28px; font-weight: 800; margin: 0; }
    
    /* --- CARDS & TIERS --- */
    .tier-1, .tier-2, .tier-3, .tier-4 {
      display: flex !important; overflow-x: auto !important;
      scroll-snap-type: x mandatory; gap: 20px; padding: 10px 5px 25px 5px;
      -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .tier-1::-webkit-scrollbar, .tier-2::-webkit-scrollbar, .tier-3::-webkit-scrollbar, .tier-4::-webkit-scrollbar { display: none; }

    .card, .ml-card { flex: 0 0 300px; scroll-snap-align: start; }
    .tank-card { flex: 0 0 170px; scroll-snap-align: start; }

    .card { 
      background: var(--card-bg); padding: 24px; border-radius: 16px; 
      border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative;
    }
    .card h3 { margin: 0; font-size: 12px; color: var(--text-muted); text-transform: uppercase; }
    .card .val { font-size: 32px; font-weight: 800; margin: 12px 0 4px; color: var(--text-main); }
    .card p { margin: 0; font-size: 13px; color: var(--text-muted); }

    /* ZONE SPECIFIC STYLING */
    .card-alert { border-left: 5px solid var(--danger); }
    .card-sales { border-left: 5px solid var(--accent); }
    .card-quality { border-left: 5px solid var(--purple-accent); }
    .card-finance { border-left: 5px solid var(--green-accent); }

    /* --- TANK VISUALS --- */
    .tank-card { background: #fff; border-radius: 20px; padding: 20px; text-align: center; border: 1px solid #e2e8f0; }
    .tank-vessel { width: 70px; height: 110px; background: #f1f5f9; margin: 16px auto; border-radius: 8px 8px 30px 30px; position: relative; overflow: hidden; border: 2px solid #e2e8f0; }
    .tank-fill { position: absolute; bottom: 0; width: 100%; transition: height 1s ease; }
    .status-badge { font-size: 10px; font-weight: 700; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; }

   /* --- ML CARD STYLES (Fixed Visuals) --- */
    .ml-card {
        /* 1. RESTORED VISUALS: This makes it look like a card again */
        background: #ffffff; 
        padding: 24px;
        border-radius: 16px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        border-top: 6px solid var(--ml-blue); /* Default Blue Accent */
        cursor: pointer;

        /* 2. FUNCTIONAL LOGIC: This handles the expansion animation */
        position: relative;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 1;
        overflow: hidden;
        height: 100%; /* Ensures it matches height of neighbor cards */
    }

    /* Base state: Hide the overlay body */
    .ml-overlay-body { display: none; }

    /* --- EXPANDED STATE (Pop-up Overlay) --- */
    .ml-card.expanded {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        height: auto;
        max-height: 85vh;
        z-index: 10002; /* Above the overlay */
        background: white;
        padding: 25px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border-radius: 16px;
        overflow-y: auto;
        border: none; /* Remove border in modal mode */
    }

    /* When expanded: Show body, hide hint, hide main stat */
    .ml-card.expanded .ml-overlay-body { display: block; animation: fadeIn 0.3s ease; }
    .ml-card.expanded .expand-hint { display: none; }
    .ml-card.expanded .ml-stat-val { display: none; } /* Hides the big number so it doesn't double up */

    /* Header adjustments when expanded */
    .ml-card.expanded .ml-card-header {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    /* Overlay Top Bar */
    .overlay-top-bar {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
    }
    .close-overlay-btn {
        background: #f1f5f9; border: none; font-size: 16px;
        width: 32px; height: 32px; border-radius: 50%;
        cursor: pointer; color: #64748b;
        display: flex; justify-content: center; align-items: center;
    }
    .close-overlay-btn:hover { background: #e2e8f0; color: #ef4444; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* --- LOGOUT & SYSTEM STYLING --- */
    .logout-link {
      margin-top: 20px;
      color: #f87171 !important; 
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .logout-link:hover {
      background: #450a0a !important; 
      color: #fee2e2 !important;
      border-left-color: #ef4444;
    }
    .logout-link span.icon {
      margin-right: 12px;
      font-size: 16px;
    }

    /* --- MOBILE DATA GRID TWEAKS --- */
    @media (max-width: 768px) {
      input, select, textarea { font-size: 16px !important; }
      .header { flex-direction: column !important; align-items: flex-start !important; gap: 10px; }
      #welcome-target { text-align: left !important; width: 100%; justify-content: flex-start !important; }
      
      .tier-1, .tier-2, .tier-3, .tier-4 { flex-direction: column !important; overflow-x: hidden !important; gap: 15px; }
      .card, .ml-card, .tank-card { flex: 1 1 100% !important; width: 100% !important; max-height: none !important; }
      
      #grid-production, #grid-brite, #grid-pilot { 
        grid-template-columns: repeat(2, 1fr) !important; 
        display: grid !important; 
        gap: 10px; 
      }
      .header-bar h1 { font-size: 22px; }
    }

    /* --- FOOTER STYLES (FORCED SLIM) --- */
    .app-footer {
        margin-top: auto;
        /* !important forces the browser to use these values */
        padding: 8px 0 !important; 
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #94a3b8; 
        font-size: 11px !important;
        font-weight: 500;
        line-height: 1.2 !important;
        /* Ensure it doesn't get crushed */
        min-height: 35px;
        /* Add some bottom space so it's not glued to the monitor edge */
        margin-bottom: 10px;
    }

    .footer-links a {
        color: var(--text-muted);
        text-decoration: none;
        margin-left: 20px;
        transition: color 0.2s ease;
    }

    .footer-links a:hover {
        color: var(--accent);
        text-decoration: underline;
    }

    .system-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-left: 15px;
        padding-left: 15px;
        border-left: 1px solid #cbd5e1;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background-color: var(--ready); /* Green */
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
        70% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    /* Mobile Adjustment: Reduce padding on small screens */
    @media (max-width: 1024px) {
        .main { padding: 20px 15px; } /* Smaller padding for phones */
        .content { padding-top: 20px; }
    }
    /* --- USER DROPDOWN MENU STYLES --- */
    .user-profile-container {
        position: relative;
        display: inline-block;
    }

    .user-dropdown-menu {
        display: none; /* Hidden by default */
        position: absolute;
        right: 0;
        top: 100%; /* Position below the profile */
        margin-top: 10px;
        background-color: white;
        min-width: 180px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        z-index: 5000;
        overflow: hidden;
    }

    .user-dropdown-menu.show { display: block; animation: fadeIn 0.2s ease; }

    .user-dropdown-menu a {
        color: var(--text-main);
        padding: 12px 16px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.2s;
        border-bottom: 1px solid #f1f5f9;
    }

    .user-dropdown-menu a:last-child { border-bottom: none; }
    .user-dropdown-menu a:hover { background-color: #f8fafc; color: var(--accent); }
    
    .menu-icon { width: 16px; text-align: center; font-size: 14px; }
    .notification-badge { 
        position: absolute; top: -5px; right: -5px; 
        background: var(--danger); color: white; border-radius: 50%; 
        width: 20px; height: 20px; font-size: 11px; font-weight: 800; 
        display: none; justify-content: center; align-items: center; 
        border: 2px solid white; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    /* ============================================================
   MOBILE & TABLET DRAWER LOGIC (FIXED)
   ============================================================ */
@media (max-width: 1024px) {
    /* Reset the "Phantom Drawer" logic for mobile */
    .sidebar { 
        left: -260px !important; 
        transform: none !important; 
        transition: left 0.3s ease !important;
        overflow-y: auto !important;
    }

    /* Force the sidebar to show when .open is applied via JS */
    .sidebar.open { 
        left: 0 !important; 
        box-shadow: 10px 0 25px rgba(0,0,0,0.5); 
        z-index: 10001;
    }

    /* Floating Menu Button */
    #menu-toggle {
        display: flex;
        position: fixed;
        bottom: 25px;
        right: 25px;
        width: 65px;
        height: 65px;
        background: var(--accent);
        color: white;
        border-radius: 50%;
        justify-content: center;
        align-items: center;
        font-size: 28px;
        z-index: 10002;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        cursor: pointer;
        border: none;
    }

    /* Ensure background overlay is visible when active */
    .menu-overlay.active {
        display: block !important;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(2px);
    }

    /* Standard mobile layout tweaks */
    .main { padding: 20px 15px !important; margin-left: 0 !important; }
    .tier-1, .tier-2, .tier-3, .tier-4 { flex-direction: column !important; }
    .card, .ml-card, .tank-card { flex: 1 1 100% !important; width: 100% !important; }
}
    /* FORCE PROFILE PICTURE SIZE */
#display-avatar {
    width: 40px !important;
    height: 40px !important;
    min-width: 40px !important; /* Prevents squishing */
    border-radius: 50% !important;
    object-fit: cover !important;
    border: 2px solid #2563eb !important;
}
</style>
</head>

<body>
  <button id="menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
  <div id="menu-overlay" class="menu-overlay" onclick="toggleMobileMenu()"></div>

  <aside class="sidebar">
    <h2>SUBURBAN BREWING</h2>
    
    <a href="index.html" class="nav-link active"><span>Command Center</span></a>
    
    <div id="admin-nav-link" style="display:none; margin-top: 10px; border-top: 1px solid #1e293b; padding-top:10px;">
    <a href="Admin.html" class="nav-link" style="color: #ef4444;">
        <span>ðŸ”’ Admin Console</span>
    </a>
</div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-sample', this)"><span>Samplings</span><span class="chevron">â–¼</span></div>
    <div id="grp-sample" class="collapsible-content">
      <a href="Samplings/Schedule-Sampling.html" class="nav-link"><span>Schedule Sampling</span></a>
      <a href="Samplings/sampling-calendar.html" class="nav-link"><span>Sampling Calendar</span></a>
      <a href="Samplings/sampling-report.html" class="nav-link"><span>Log Sampling Report</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-sales', this)"><span>Sales</span><span class="chevron">â–¼</span></div>
    <div id="grp-sales" class="collapsible-content">
      <a href="sales/sales-opportunities.html" class="nav-link"><span>Sales Opportunities</span></a>
      <a href="sales/leads.html" class="nav-link"><span>AI Sales Leads</span></a>
      <a href="sales/invoice-search.html" class="nav-link"><span>Invoice Search</span></a>
      <a href="sales/deliveries.html" class="nav-link"><span>Delivery Tracking</span></a>
      <a href="sales/new invoices.html" class="nav-link"><span>New Invoice</span></a>
    </div>

    <div class="nav-section-header" onclick="toggleGroup('grp-inv', this)"><span>Inventory</span><span class="chevron">â–¼</span></div>
    <div id="grp-inv" class="collapsible-content">
      <a href="inventory/Ingredient-inventory.html" class="nav-link"><span>Ingredient Inventory</span></a>
      <a href="inventory/brewery.html" class="nav-link"><span>Packaged Inventory</span></a>
      <a href="inventory/wholesaler-inventory.html" class="nav-link"><span>Wholesaler Inventory</span></a>
      <a href="inventory/restaurant-inventory.html" class="nav-link"><span>Restaurant Inventory</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-brew', this)"><span>Brewing</span><span class="chevron">â–¼</span></div>
    <div id="grp-brew" class="collapsible-content">
      <a href="Brewing/brew-calendar.html" class="nav-link"><span>Brewing Calendar</span></a>
      <a href="Brewing/Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
      <a href="Brewing/Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
      <a href="Brewing/cellar.html" class="nav-link"><span>Cellar Management</span></a>
      <a href="Brewing/qc-dashboard.html" class="nav-link"><span>QC Dashboard</span></a>
      <a href="Brewing/packaging.html" class="nav-link"><span>Packaging log</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-rep', this)"><span>Reporting & Analytics</span><span class="chevron">â–¼</span></div>
    <div id="grp-rep" class="collapsible-content">
      <a href="Reports/Monthly-sales.html" class="nav-link"><span>Monthly Sales Report</span></a>
      <a href="Reports/ProfitAnalysis.html" class="nav-link"><span>Profit Analysis Report</span></a>
      <a href="Reports/Route.html" class="nav-link"><span>Sales Route Opt.</span></a>
    </div>
  </aside>

  <main class="main">
    <div id="system-banner" style="display:none; background:#fef3c7; color:#92400e; border-bottom:1px solid #fcd34d; padding:12px 20px; text-align:center; font-weight:700; font-size:14px; width:100%;">
        ðŸ“¢ <span id="system-banner-text">Alert Message</span>
    </div>
    <header class="header-bar">
      <div class="header" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
        <div>
          <h1 id="portal-title">Command Center</h1>
          <div id="current-date" style="color: var(--text-muted); font-size: 14px; font-weight: 500;"></div>
        </div>
        <span id="welcome-target" style="font-weight: 600; color: #6b7280; text-align: right;"></span>
      </div>
    </header>

     <div class="section-heading" onclick="toggleGroup('sect-sales', this)">
      <span>Zone 1: Sales Intelligence</span><span class="chevron">â–¼</span>
    </div>
    <div id="sect-sales" class="collapsible-content">
      <div class="tier-1">
        <div class="card card-sales" onclick="showRouteDetails()" style="cursor:pointer;">
          <h3>Sales Outreach</h3>
          <div class="val" id="followUpCount">--</div>
          <p>Due/Optimized Stops Today</p>
          <div id="daily-route-summary" class="route-list-summary">Loading route...</div>
          <div style="font-size: 10px; color: var(--accent); font-weight: 800; margin-top: 5px; text-transform: uppercase;">Click to View Detailed Route</div>
        </div>

        <div class="card card-quality" onclick="location.href='Samplings/sampling-calendar.html'" style="cursor:pointer;">
          <h3>Next Sampling</h3>
          <div class="val" id="nextSamplingClient" style="font-size: 20px; margin-top: 15px;">Loading...</div>
          <p id="nextSamplingDetails">Checking Schedule...</p>
        </div>

        <div class="card card-sales" style="cursor:pointer;" onclick="showDeliveryDetails()">
          <h3>Delivery Status</h3>
          <div class="val" id="activeDeliveryVal">--</div>
          <p id="delivery-summary">Checking Tracking...</p>
        </div>

        <div class="card card-finance" style="cursor:pointer;" onclick="showConversionDetails()">
            <h3>Lead Conversion</h3>
            <div id="leadConversionVal" class="val">--%</div>
            <p>Leads converted to Sales</p>
        </div>
      </div>
    </div>
    
<div class="section-heading" onclick="toggleGroup('sect-ops', this)">
    <span>Zone 2: Daily Operations</span><span class="chevron">â–¼</span>
</div>
<div id="sect-ops" class="collapsible-content">
    <div class="tier-1">
        <div class="card card-alert" onclick="location.href='inventory/brewery.html'" style="cursor:pointer;">
            <h3>Inventory Alerts</h3>
            <div class="val" id="alertCount">--</div>
            <p>Low Stock Master SKUs</p>
        </div>

        <div class="card card-quality" id="sensoryAlertCard" style="cursor:pointer;" onclick="showSensoryDetails()">
            <h3>Sensory Panel</h3>
            <div class="val" id="sensoryCount">--</div>
            <p id="sensoryStatus">Checking logs...</p>
            <div id="sensory-due-list" style="display:none;"></div>
        </div>

        <div class="ml-card" id="perfCard" onclick="toggleMLCard('perfCard', event)">
            <div class="ml-card-header">
                <div style="text-align: left;">
                    <h3 style="margin: 0; color: var(--ml-blue); font-size: 14px;">Learned Performance</h3>
                    <span class="expand-hint">Click for Trend Chart</span>
                </div>
                <div id="ml-efficiency-display" class="ml-stat-val" style="font-size: 2.2rem; line-height: 1;">--%</div>
            </div>
            
            <div class="ml-overlay-body">
                <div class="overlay-top-bar">
                    <span style="font-weight:bold; color:#1e293b;">Efficiency Trend (Last 15 Batches)</span>
                    <button class="close-overlay-btn" onclick="closeMLCard('perfCard', event)">âœ•</button>
                </div>
                <div class="chart-container" style="height: 300px; display:block;">
                    <canvas id="efficiencyChart"></canvas>
                </div>
                <div style="margin-top:15px; padding:10px; background:#f8fafc; border-radius:6px; font-size:12px; color:#64748b;">
                    <strong style="color:var(--ml-blue)">AI Insight:</strong> <span id="ml-advice">Connecting...</span>
                </div>
            </div>
        </div>

        <div class="ml-card" id="costCard" onclick="toggleMLCard('costCard', event)" style="border-top-color: #10b981;">
            <div class="ml-card-header">
                <div style="text-align: left;">
                    <h3 style="margin: 0; color: #10b981; font-size: 14px;">Avg Malt Cost</h3>
                    <span class="expand-hint">Click for Breakdown</span>
                </div>
                <div id="avg-malt-cost-display" class="ml-stat-val" style="font-size: 2.2rem; color: #10b981; line-height: 1;">$ --</div>
            </div>

            <div class="ml-overlay-body">
                <div class="overlay-top-bar">
                    <span style="font-weight:bold; color:#1e293b;">Cost Analysis</span>
                    <button class="close-overlay-btn" onclick="closeMLCard('costCard', event)">âœ•</button>
                </div>
                <div class="ml-stats-grid" style="display: flex; gap: 20px; margin-top: 20px;">
                    <div style="flex:1; text-align:center; padding:20px; background:#ecfdf5; border-radius:10px;">
                        <div style="font-size:11px; text-transform:uppercase; color:#065f46; font-weight:700;">Est. Savings</div>
                        <div id="cost-dollars-saved" style="font-size:28px; font-weight:800; color:#10b981;">$ --</div>
                    </div>
                    <div style="flex:1; text-align:center; padding:20px; background:#eff6ff; border-radius:10px;">
                        <div style="font-size:11px; text-transform:uppercase; color:#1e40af; font-weight:700;">Grain Waste Reduced</div>
                        <div id="cost-lbs-saved" style="font-size:28px; font-weight:800; color:#3b82f6;">-- lbs</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
   <div class="section-heading" onclick="toggleGroup('grp-all-tanks', this)">
    <span>Zone 3: Active Cellar Overview</span> <span class="chevron">â–¼</span>
</div>
<div id="grp-all-tanks" class="collapsible-content">
    <div class="subsection-heading" onclick="toggleGroup('sect-prod', this)"><span>Production FVs (10 BBL)</span><span class="chevron">â–¼</span></div>
    <div id="sect-prod" class="collapsible-content"><div class="tier-2" id="grid-production"></div></div>

    <div class="subsection-heading" onclick="toggleGroup('sect-pilot', this)"><span>Pilot System FVs (1 BBL)</span><span class="chevron">â–¼</span></div>
    <div id="sect-pilot" class="collapsible-content"><div class="tier-2" id="grid-pilot"></div></div>

    <div class="subsection-heading" onclick="toggleGroup('sect-brite', this)"><span>Brite Tanks (10 BBL)</span><span class="chevron">â–¼</span></div>
    <div id="sect-brite" class="collapsible-content"><div class="tier-2" id="grid-brite"></div></div>
</div>
    <footer class="app-footer">
        <div class="footer-left">
            <span>&copy; <span id="copyright-year">2025</span> Suburban Brewing Co.</span>
            <span class="system-status">
                <span class="status-dot"></span>
                System Operational
            </span>
        </div>
        <div class="footer-links">
            <span>Portal v2.5</span>
            <a href="https://github.com/remyjdavis/Suburban-Brewing-Company-Portal" target="_blank">Repo</a>
            <a href="#" onclick="Swal.fire({
                title: 'App Support', 
                html: '<b>Remy Davis</b><br>remyjdavis90@gmail.com', 
                icon: 'info',
                confirmButtonColor: 'var(--accent)'
            })">Support</a>
            <a href="#" onclick="location.reload()">Refresh Data</a>
        </div>
    </footer>
  </main>

 <script>
    const MASTER_API_URL = 'https://script.google.com/macros/s/AKfycbzzkG7_Def-aiH-cF_m0NrdJe53WqQEqRDPa4Fa0nQz9-tu7kII6XmU29N3fe5T6UDF/exec';
    const CELLAR_API_URL = 'https://script.google.com/macros/s/AKfycbzyzJqFRnoeLudi-FtJInszxxuJrtSj24MAnioa1SNe6xsJEEpM9eGISdOUc0_qLUWH/exec'; 
    const PRODUCTION_API_URL = 'https://script.google.com/macros/s/AKfycbzhM9bt6E7afijwvW9rPSB9oP8PJyW6DCPHNkfMHNNGP_z2yGo28AbDpGcO3NtcMqYNrA/exec';

    let dashboardCharts = {};

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('copyright-year').innerText = new Date().getFullYear();
      setupWelcomeUI();
        runAllSyncs();
        // Auto-refresh every 5 minutes
        setInterval(runAllSyncs, 300000);
    });

    function runAllSyncs() {
        syncOutreachAndInventory(); // Zone 1 General
        syncSamplingCard();         // Zone 1 Sampling
        syncDeliveryCard();         // Zone 1 Delivery
        syncLeadConversion();       // Zone 1 Leads
        refreshCellarTanks();       // Zone 3 Tanks
        refreshMLEngine();          // Zone 2 ML/Stats
        checkSystemBanner(); // ðŸ”´ Add this line!
    }

    // --- DRAWER & UI TOGGLES ---
    function toggleMobileMenu() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.getElementById('menu-overlay');
    const btn = document.getElementById('menu-toggle');
    
    // 1. Toggle Sidebar
    const isOpen = sidebar.classList.toggle('open');
    
    // 2. Toggle Background Overlay
    overlay.classList.toggle('active');
    
    // 3. Change Icon
    btn.innerText = isOpen ? 'âœ•' : 'â˜°';
    
    // 4. Lock background scroll when menu is open
    document.body.style.overflow = isOpen ? 'hidden' : '';
}
    function toggleGroup(id, el) {
        document.getElementById(id).classList.toggle('collapsed');
        el.classList.toggle('collapsed');
    }

    // 1. OPEN Logic (Clicking the Card)
    function toggleMLCard(cardId, event) {
        const card = document.getElementById(cardId);
        const overlay = document.getElementById('menu-overlay');

        // If we clicked something inside the card that shouldn't trigger an open/close 
        // (like clicking the chart itself), ignore it.
        if (event && card.classList.contains('expanded')) {
             // Optional: Allow clicking inside to do nothing, so you don't accidentally close it
             return; 
        }

        // Close any other expanded cards first
        document.querySelectorAll('.ml-card.expanded').forEach(c => {
            if(c.id !== cardId) {
                c.classList.remove('expanded');
            }
        });

        // Open this card
        card.classList.add('expanded');
        overlay.classList.add('active');

        // Initialize Chart if this is the Performance card
        if (cardId === 'perfCard') {
            initEfficiencyChart();
        }
    }

    // 2. CLOSE Logic (Clicking the X)
    function closeMLCard(cardId, event) {
        // STOP the click from hitting the card underneath
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        const card = document.getElementById(cardId);
        const overlay = document.getElementById('menu-overlay');

        card.classList.remove('expanded');
        overlay.classList.remove('active');
    }

    async function initEfficiencyChart() {
        const canvas = document.getElementById('efficiencyChart');
        if (!canvas) return;

        try {
            const res = await fetch(`${PRODUCTION_API_URL}?action=getMLTrend`);
            const data = await res.json();

            // Destroy old chart to prevent "glitching" overlay
            if (dashboardCharts['eff']) dashboardCharts['eff'].destroy();

            dashboardCharts['eff'] = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: data.batchHistory.map((_, i) => `Batch ${i+1}`),
                    datasets: [{
                        label: 'Brewhouse Efficiency',
                        data: data.batchHistory.map(v => (v * 100).toFixed(1)),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        } catch (e) { console.error("Chart Error", e); }
    }

    // --- NAVIGATION & MODALS ---
    function showRouteDetails() {
        Swal.fire({
            title: 'Sales Route',
            text: document.getElementById('daily-route-summary').innerText,
            icon: 'info',
            confirmButtonColor: 'var(--accent)'
        });
    }

    function showSensoryDetails() {
        Swal.fire({
            title: 'Sensory Panel',
            html: document.getElementById('sensory-due-list').innerHTML || "No active sensory tasks.",
            icon: 'info',
            confirmButtonColor: 'var(--purple-accent)'
        });
    }

    function showDeliveryDetails() {
        Swal.fire({
            title: 'Delivery Status',
            text: 'Track current outgoing shipments and overdue invoices.',
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Open Delivery Page',
            confirmButtonColor: 'var(--accent)'
        }).then((result) => {
            if (result.isConfirmed) window.location.href = 'sales/deliveries.html';
        });
    }

    function showConversionDetails() {
        Swal.fire({
            title: 'Lead Conversion',
            text: 'Analyze how many AI leads have converted to successful sales.',
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: 'View AI Leads',
            confirmButtonColor: 'var(--green-accent)'
        }).then((result) => {
            if (result.isConfirmed) window.location.href = 'sales/leads.html';
        });
    }

    // --- DATA FETCHERS ---

    // 1. Zone 1: Outreach, Inventory & Sensory
    async function syncOutreachAndInventory() {
        try {
            // Outreach
            const outRes = await fetch(`${MASTER_API_URL}?action=getOutreachData`);
            const outJson = await outRes.json();
            if (outJson.status === 'success') {
                document.getElementById('followUpCount').innerText = outJson.count;
                document.getElementById('daily-route-summary').innerText = outJson.route.join(' â†’ ') || "No stops today";
            }

            // Inventory Alerts
            const invRes = await fetch(`${MASTER_API_URL}?action=getInventoryAlerts`);
            const invJson = await invRes.json();
            if (invJson.status === 'success') document.getElementById('alertCount').innerText = invJson.count;

            // Sensory
            const senRes = await fetch(`${MASTER_API_URL}?action=getSensoryDue`);
            const senJson = await senRes.json();
            if (senJson.status === 'success' || senJson.status === 'idle') {
                document.getElementById('sensoryCount').innerText = senJson.count || 0;
                document.getElementById('sensoryStatus').innerText = (senJson.count > 0) ? "QC Samples Due" : "Logs Current";
                document.getElementById('sensory-due-list').innerText = senJson.list || "No tasks";
            }
        } catch (e) { console.error("Zone 1 Gen Sync Error", e); }
    }

    // 2. Zone 1: Sampling
    async function syncSamplingCard() {
        try {
            const res = await fetch(`${MASTER_API_URL}?action=getNextSampling`);
            const json = await res.json();
            if (json.status === 'success') {
                document.getElementById('nextSamplingClient').innerText = json.client;
                document.getElementById('nextSamplingDetails').innerText = `${json.displayDate} @ ${json.time}`;
            }
        } catch (e) { console.error("Sampling Sync Error", e); }
    }

    // 3. Zone 1: Delivery
    async function syncDeliveryCard() {
        try {
            const res = await fetch(`${MASTER_API_URL}?action=getDeliveryStatus`);
            const json = await res.json();
            const valEl = document.getElementById('activeDeliveryVal');
            const sumEl = document.getElementById('delivery-summary');
            
            if (json.status === 'success' && Array.isArray(json.data)) {
                const overdue = json.data.filter(d => d.isOverdue === true || d.isOverdue === "TRUE").length;
                if(overdue > 0) {
                    valEl.innerText = overdue;
                    valEl.style.color = "var(--danger)";
                    sumEl.innerText = `${overdue} Overdue`;
                } else {
                    valEl.innerText = json.data.length;
                    valEl.style.color = "var(--text-main)";
                    sumEl.innerText = "On Track";
                }
            }
        } catch (e) { console.error("Delivery Sync Error", e); }
    }

    // 4. Zone 1: Leads
    async function syncLeadConversion() {
        try {
            const res = await fetch(`${MASTER_API_URL}?action=getLeadConversion`);
            const json = await res.json();
            if (json.status === 'success') {
                document.getElementById('leadConversionVal').innerText = `${json.rate}%`;
            }
        } catch (e) { console.error("Lead Sync Error", e); }
    }

    // 5. Zone 2: ML Engine
    async function refreshMLEngine() {
        try {
            const res = await fetch(`${PRODUCTION_API_URL}?action=getMLTrend`);
            const data = await res.json();
            
            // Efficiency
            const eff = data.brewhousePredictiveEfficiency || 0.75;
            document.getElementById('ml-efficiency-display').innerText = (eff * 100).toFixed(1) + "%";
            
            // Financials
            document.getElementById('cost-dollars-saved').innerText = "$" + (data.estimatedSavings || 0).toFixed(2);
            
            const lbsEl = document.getElementById('cost-lbs-saved');
            if (lbsEl) lbsEl.innerText = (data.grainWasteSaved || 0) + " lbs";
            
            const adviceEl = document.getElementById('ml-advice');
            if (adviceEl) adviceEl.innerText = "Model active. Tracking batch history.";
        } catch (e) { console.error("ML Sync Error", e); }
    }

    // 6. Zone 3: Cellar Tanks
    async function refreshCellarTanks() {
        const categories = { 'grid-production': ["FV 1", "FV 2", "FV 3", "FV 4", "FV 5", "FV 6"], 'grid-pilot': ["Pilot 1", "Pilot 2"], 'grid-brite': ["BT 1", "BT 2"] };
        try {
            const res = await fetch(`${CELLAR_API_URL}?action=getTankStatus`);
            const live = await res.json();
            
            Object.keys(categories).forEach(gridId => {
                const container = document.getElementById(gridId);
                if (!container) return;
                container.innerHTML = "";
                
                categories[gridId].forEach(tank => {
                    const data = Array.isArray(live) ? live.find(b => b.vessel === tank) : null;
                    const isActive = !!data;
                    const color = isActive ? (data.status.includes("Ready") ? "var(--ready)" : "var(--fermenting)") : "var(--text-muted)";
                    
                    container.innerHTML += `
                        <div class="tank-card" style="opacity: ${isActive ? '1' : '0.5'}; border-color: ${isActive ? color : '#e2e8f0'};">
                            <span class="status-badge" style="color: ${color};">${isActive ? data.status : 'Empty'}</span>
                            <div class="tank-vessel">
                                <div class="tank-fill" style="height: ${isActive ? data.fill : 0}%; background: ${color};"></div>
                            </div>
                            <div style="font-weight:700;">${tank}</div>
                            <div style="font-size: 11px;">${isActive ? data.brand : 'Available'}</div>
                        </div>`;
                });
            });
        } catch (e) { console.error("Cellar Error", e); }
    }

   // --- 7. SYSTEM BANNER CHECK (ROBUST VERSION) ---
    async function checkSystemBanner() {
        try {
            const res = await fetch(`${MASTER_API_URL}?action=getSystemConfig`);
            const json = await res.json();
            
            if (json.status === 'success') {
                const banner = document.getElementById('system-banner');
                const textSpan = document.getElementById('system-banner-text');
                
                // ðŸ”´ THE FIX: Convert value to String first, then Uppercase it.
                // This handles Boolean true, String "TRUE", and String "true"
                const rawValue = json.config.announcement_active;
                const isActive = String(rawValue).toUpperCase() === "TRUE";

                if (isActive) {
                    textSpan.innerText = json.config.announcement_text;
                    banner.style.display = 'block'; 
                } else {
                    banner.style.display = 'none'; 
                }
            }
        } catch(e) { console.error("Banner Sync Error", e); }
    }
</script>
  
</body>
</html>
