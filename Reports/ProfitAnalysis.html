<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Analysis Report</title>
    <style>
      body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f4; padding: 20px; color: #333; }
      .container { max-width: 1400px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
      h1 { text-align: center; color: #2c3e50; }
      
      /* KPI Cards */
      .summary-cards { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
      .card { flex: 1; background: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 15px; text-align: center; min-width: 150px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
      .card h3 { margin: 0 0 5px 0; font-size: 14px; color: #7f8c8d; }
      .card .value { font-size: 20px; font-weight: bold; color: #2c3e50; }

      /* Table Styles */
      table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
      th { background-color: #34495e; color: white; padding: 12px; text-align: left; position: sticky; top: 0; }
      td { padding: 10px; border-bottom: 1px solid #ddd; }
      tr:hover { background-color: #f1f1f1; }
      
      /* Conditional Formatting */
      .positive { color: #27ae60; font-weight: bold; }
      .negative { color: #c0392b; font-weight: bold; }
      .trend-up { color: #27ae60; }
      .trend-down { color: #c0392b; }
      
      /* AI Recommendation Pill */
      .ai-rec { background-color: #e8f6f3; color: #16a085; padding: 4px 8px; border-radius: 12px; font-size: 12px; border: 1px solid #1abc9c; display: inline-block;}

      .btn { background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
      .btn:hover { background-color: #2980b9; }
      .loading { text-align: center; padding: 50px; color: #666; }
    </style>
  </head>
  <body>
    <div class="container">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>SBC Profit Analysis</h1>
        <button class="btn" onclick="loadData()">Refresh Report</button>
      </div>

      <div class="summary-cards">
        <div class="card"><h3>Total Profit</h3><div id="kpiProfit" class="value">--</div></div>
        <div class="card"><h3>Top Brand</h3><div id="kpiBrand" class="value">--</div></div>
        <div class="card"><h3>Avg Efficiency</h3><div id="kpiEff" class="value">--</div></div>
        <div class="card"><h3>Total Cases</h3><div id="kpiCases" class="value">--</div></div>
      </div>

      <div id="tableContainer">
        <div class="loading">Loading analysis...</div>
      </div>
    </div>

    <script>
  // ðŸ”´ CONFIGURATION
  // Your Web App URL (Exec version)
  const API_URL = "https://script.google.com/macros/s/AKfycbyDxr8REPMn1QfMik5w0iEUEyUiPqhvbk11aNgTNCfEK30zjbcj4kotZ-oqyz2UjP0/exec";

  window.onload = loadData;

  function loadData() {
    const container = document.getElementById('tableContainer');
    container.innerHTML = '<div class="loading">Fetching data via API...</div>';

    // We use POST because your backend logic is in doPost()
    // We use URLSearchParams to ensure e.parameter can read it
    const formData = new URLSearchParams();
    formData.append('action', 'getReports');

    fetch(API_URL, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(json => {
      if (json.status === 'success') {
        render(json.data);
      } else {
        showError("API Error: " + json.data);
      }
    })
    .catch(error => {
      console.error('Fetch error:', error);
      showError("Connection failed. If testing locally, check CORS or browser privacy settings.");
    });
  }

  function render(data) {
    if (!data || data.length === 0) {
      document.getElementById('tableContainer').innerHTML = '<p style="text-align:center;">No data found.</p>';
      return;
    }

    let html = '<table><thead><tr>';
    html += '<th>Brand</th><th>Total Profit</th><th>Velocity ($/Mo)</th><th>Efficiency ($/BBL)</th><th>Vol (Cases)</th><th>Vol (Kegs)</th><th>AI Recommendation</th>';
    html += '</tr></thead><tbody>';

    let totalProfit = 0;
    let totalCases = 0;
    let efficiencySum = 0;
    let count = 0;
    let bestBrand = "N/A";
    let maxProfit = -Infinity;

    // The API returns an array of objects: { brand, totalProfit, profitPerMonth... }
    data.forEach(item => {
      // KPI Calcs
      totalProfit += item.totalProfit;
      totalCases += item.caseVol;
      efficiencySum += item.profitPerBBL;
      
      if(item.totalProfit > maxProfit) { 
        maxProfit = item.totalProfit; 
        bestBrand = item.brand; 
      }
      count++;

      let profitClass = item.totalProfit >= 0 ? 'positive' : 'negative';
      let recClass = getRecClass(item.action);

      html += `<tr>
        <td><strong>${item.brand}</strong></td>
        <td class="${profitClass}">$${formatNum(item.totalProfit)}</td>
        <td>$${formatNum(item.profitPerMonth)}</td>
        <td>$${formatNum(item.profitPerBBL)}</td>
        <td>${item.caseVol}</td>
        <td>${item.kegVol}</td>
        <td><span class="ai-rec ${recClass}">${item.action}</span></td>
      </tr>`;
    });

    html += '</tbody></table>';
    document.getElementById('tableContainer').innerHTML = html;

    // Update KPIs
    updateKPI("kpiProfit", totalProfit, true);
    document.getElementById("kpiBrand").innerText = bestBrand;
    updateKPI("kpiCases", totalCases, false);
    updateKPI("kpiEff", count > 0 ? (efficiencySum / count) : 0, true);
  }

  // Helper to color code the AI Recommendation pill
  function getRecClass(action) {
    if (action.includes("SCALE") || action.includes("CASH")) return "positive-bg";
    if (action.includes("CUT")) return "negative-bg";
    return "neutral-bg";
  }

  function updateKPI(id, val, isMoney) {
    document.getElementById(id).innerText = (isMoney ? '$' : '') + formatNum(val);
  }

  function formatNum(n) {
    return n.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
  }

  function showError(msg) {
    document.getElementById('tableContainer').innerHTML = `<p style="color:red; text-align:center;">${msg}</p>`;
  }
</script>

<style>
  /* Add these utility classes to your CSS for the pills */
  .positive-bg { background-color: #dcfce7; color: #166534; border-color: #166534; }
  .negative-bg { background-color: #fee2e2; color: #991b1b; border-color: #991b1b; }
  .neutral-bg { background-color: #f3f4f6; color: #1f2937; border-color: #1f2937; }
</style>
  </body>
</html>
