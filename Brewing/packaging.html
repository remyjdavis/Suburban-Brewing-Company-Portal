<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Production | Packaging Log</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --sidebar-bg: #0f172a;
            --sidebar-text: #94a3b8;
            --bg-color: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --accent: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            margin: 0;
            display: flex;
            height: 100vh;
            color: var(--text-main);
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 24px 0;
            flex-shrink: 0;
        }
        
        .brand {
            color: #fff;
            font-size: 1.2rem;
            font-weight: 800;
            padding: 0 24px 30px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #1e293b;
            margin-bottom: 20px;
        }

        .nav-item {
            padding: 12px 24px;
            color: var(--sidebar-text);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            transition: 0.2s;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover { background: #1e293b; color: #fff; }
        .nav-item.active { background: #1e293b; color: #fff; border-left-color: var(--accent); }
        .nav-icon { margin-right: 12px; width: 20px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title h1 { margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
        .page-title p { margin: 5px 0 0; color: var(--text-light); }

        .total-counter {
            background: var(--card-bg);
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            text-align: right;
        }
        .counter-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); font-weight: 700; }
        .counter-val { font-size: 1.5rem; font-weight: 800; color: var(--accent); }

        /* --- FORMS & GRIDS --- */
        .grid-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            max-width: 1200px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .card-header {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-light);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .form-col { flex: 1; }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            transition: border 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Special Inputs */
        .input-yield { font-size: 1.2rem; font-weight: 700; color: var(--success); border-color: #bbf7d0; }
        .input-waste { color: var(--danger); border-color: #fecaca; }

        .btn-submit {
            width: 100%;
            padding: 18px;
            background: var(--text-main);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-submit:hover { background: #0f172a; }
        .btn-submit:active { transform: scale(0.99); }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- MOBILE TWEAKS --- */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow: auto; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; }
            .brand { display: none; }
            .nav-item { white-space: nowrap; border-left: none; border-bottom: 3px solid transparent; }
            .nav-item.active { border-left: none; border-bottom-color: var(--accent); }
            .grid-container { grid-template-columns: 1fr; }
            .main-content { padding: 20px; }
            .form-row { flex-direction: column; gap: 15px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand">SBC PRODUCTION</div>
        <a href="#" class="nav-item active"><span class="nav-icon">üì¶</span> Packaging Log</a>
        <a href="#" class="nav-item"><span class="nav-icon">üç∫</span> Brew Log</a>
        <a href="#" class="nav-item"><span class="nav-icon">üè≠</span> Cellar Ops</a>
        <a href="#" class="nav-item"><span class="nav-icon">üìä</span> Inventory</a>
    </nav>

    <main class="main-content">
        
        <div class="top-bar">
            <div class="page-title">
                <h1>Packaging Run</h1>
                <p>Log output, track waste, and sync inventory.</p>
            </div>
            <div class="total-counter">
                <div class="counter-label">Total Packaged</div>
                <div class="counter-val"><span id="totalBBL">0.0</span> <span style="font-size:0.9rem;">BBL</span></div>
            </div>
        </div>

        <div class="grid-container">
            
            <div>
                <div class="card">
                    <div class="card-header">Run Context</div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label>Product / Brand</label>
                            <select id="pkg-brand">
                                <option value="" disabled selected>Loading Brands...</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Source Tank</label>
                            <input type="text" id="vessel-source" placeholder="e.g. FV-04">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-col">
                            <label>Batch ID</label>
                            <input type="text" id="pkg-batch-id" placeholder="B-2026-###">
                        </div>
                        <div class="form-col">
                            <label>Date</label>
                            <input type="date" id="pkg-date">
                        </div>
                    </div>
                </div>

                <div class="card" style="border-top: 4px solid var(--success);">
                    <div class="card-header">
                        <span style="color:var(--success)">Saleable Yield</span>
                        <span>üì¶</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label>1/2 BBL Kegs</label>
                            <input type="number" class="input-yield" id="yield-half" placeholder="0" oninput="calcTotal()">
                        </div>
                        <div class="form-col">
                            <label>1/6 BBL Kegs</label>
                            <input type="number" class="input-yield" id="yield-sixth" placeholder="0" oninput="calcTotal()">
                        </div>
                        <div class="form-col">
                            <label>Cases (24x16)</label>
                            <input type="number" class="input-yield" id="yield-cases" placeholder="0" oninput="calcTotal()">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <label>Shift Notes</label>
                    <textarea id="pkg-notes" rows="2" placeholder="Start/Stop times, DO readings, downtime issues..."></textarea>
                </div>
            </div>

            <div>
                <div class="card" style="border-top: 4px solid var(--danger);">
                    <div class="card-header">
                        <span style="color:var(--danger)">Loss / Waste</span>
                        <span>‚ö†Ô∏è</span>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>Low Fills (Cans)</label>
                        <input type="number" class="input-waste" id="waste-lowfill" placeholder="0">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label>Seam Failures</label>
                        <input type="number" class="input-waste" id="waste-seams" placeholder="0">
                    </div>
                    <div>
                        <label>Tank Bottoms (Est. Gal)</label>
                        <input type="number" class="input-waste" id="waste-bottoms" placeholder="0">
                    </div>
                </div>

                <div class="card">
                    <label>Operator Sign-off</label>
                    <input type="text" id="operator" placeholder="Initials">
                    <div style="margin-top: 20px;">
                        <button class="btn-submit" onclick="submitPackaging()">LOG PRODUCTION</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // üî¥ PASTE YOUR PRODUCTION BACKEND URL HERE üî¥
        const API_URL = "https://script.google.com/macros/s/AKfycbwHgZeSFsMCbj0I4eUHuDxfs9DX6YZBhkzm26dWlWoyRX0EH0v7Csnnqm1unOdbwEjj/exec";

        // Global variable to store tank data for auto-fill
        let tankCache = [];

        // 1. Initialize Page
        window.onload = function() {
            document.getElementById('pkg-date').valueAsDate = new Date();
            loadBrands();
        };

        // 2. Fetch Active Tanks
        async function loadBrands() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: new URLSearchParams({ "action": "getProducts" })
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    tankCache = data.message; // Save data to global cache
                    const select = document.getElementById('pkg-brand');
                    
                    select.innerHTML = '<option value="" disabled selected>Select Active Tank...</option>';
                    
                    // Populate Dropdown using the Array Index as the value
                    tankCache.forEach((tank, index) => {
                        let opt = document.createElement('option');
                        opt.value = index; // We store the INDEX, not the name
                        opt.text = tank.display; // "Suburban IPA (FV-04)"
                        select.add(opt);
                    });
                }
            } catch (err) {
                console.error("Failed to load tanks", err);
                document.getElementById('pkg-brand').innerHTML = '<option disabled>Error connecting to Cellar</option>';
            }
        }

        // 3. AUTO-FILL FUNCTION
        function fillTankDetails() {
            const select = document.getElementById('pkg-brand');
            const selectedIndex = select.value;

            // Look up the full data object using the index
            const tank = tankCache[selectedIndex];

            if (tank) {
                // Auto-fill the fields
                document.getElementById('vessel-source').value = tank.vessel;
                document.getElementById('pkg-batch-id').value = tank.batch;
            }
        }

        // 4. Real-time Calculator
        function calcTotal() {
            const halfs = parseFloat(document.getElementById('yield-half').value) || 0;
            const sixths = parseFloat(document.getElementById('yield-sixth').value) || 0;
            const cases = parseFloat(document.getElementById('yield-cases').value) || 0;

            // 16oz Case (24pk) = 0.0968 BBL
            const totalBBL = (halfs * 0.5) + (sixths * 0.165) + (cases * 0.0968);
            
            document.getElementById('totalBBL').innerText = totalBBL.toFixed(1);
        }

        // 5. Submit Data
        async function submitPackaging() {
            const btn = document.querySelector('.btn-submit');
            const operator = document.getElementById('operator').value;
            const select = document.getElementById('pkg-brand');
            
            // Get the clean brand name from our cache (not the index!)
            const selectedIndex = select.value;
            const tankData = tankCache[selectedIndex];

            if(!operator || !tankData) {
                Swal.fire({ icon: 'warning', title: 'Missing Info', text: 'Please select a Tank and enter Operator.', confirmButtonColor: '#1e293b' });
                return;
            }
            
            const payload = {
                operator: operator,
                brand: tankData.brand, // Send the CLEAN brand name (e.g. "Suburban IPA")
                vessel: document.getElementById('vessel-source').value,
                batchId: document.getElementById('pkg-batch-id').value,
                date: document.getElementById('pkg-date').value,
                yield: {
                    halfBBL: document.getElementById('yield-half').value || 0,
                    sixthBBL: document.getElementById('yield-sixth').value || 0,
                    cases: document.getElementById('yield-cases').value || 0
                },
                waste: {
                    lowFills: document.getElementById('waste-lowfill').value || 0,
                    seams: document.getElementById('waste-seams').value || 0,
                    bottoms: document.getElementById('waste-bottoms').value || 0
                },
                notes: document.getElementById('pkg-notes').value
            };

            btn.innerText = "Syncing Inventory...";
            btn.disabled = true;

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        "action": "submitPackagingRun",
                        "data": JSON.stringify(payload)
                    })
                });
                
                Swal.fire({
                    icon: 'success',
                    title: 'Production Logged',
                    text: `Added stock for ${tankData.brand}.`,
                    confirmButtonColor: '#10b981'
                }).then(() => {
                    // Clear inputs but keep tank selection for convenience? 
                    // Or reset all? Let's reset yields.
                    document.getElementById('yield-half').value = "";
                    document.getElementById('yield-sixth').value = "";
                    document.getElementById('yield-cases').value = "";
                    document.getElementById('totalBBL').innerText = "0.0";
                });

            } catch (error) {
                Swal.fire('Error', 'Connection failed.', 'error');
            } finally {
                btn.innerText = "LOG PRODUCTION";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
