<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellar Management | Suburban Brewing Co.</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --sidebar-width: 240px; 
            --primary-dark: #111827; 
            --accent: #2563eb; 
            --accent-green: #27ae60;
            --accent-orange: #f39c12;
            --status-dirty: #ef4444;
            --status-clean: #10b981;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f3f4f6; margin: 0; display: flex; color: #1f2937; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: var(--sidebar-width); background: var(--primary-dark); height: 100vh; color: white; position: fixed; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar-header { padding: 25px 20px; font-weight: 800; font-size: 1.2rem; border-bottom: 1px solid #1f2937; letter-spacing: 1px; }
        .nav-section-title { font-size: 11px; text-transform: uppercase; opacity: 0.5; margin: 20px 20px 8px; font-weight: 700; letter-spacing: 1px; }
        .nav-link { display: block; padding: 10px 24px; color: #d1d5db; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .nav-link:hover { background: #1f2937; color: #fff; }
        .nav-link.active { background: var(--accent); color: #fff; font-weight: 600; }

        /* --- MAIN CONTENT --- */
        .main-content { margin-left: var(--sidebar-width); flex-grow: 1; height: 100vh; overflow-y: auto; }
        .header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 10; }
        .container { padding: 30px; }

        /* --- VESSEL GRID --- */
        .grid-section-title {
            font-size: 1.1rem; font-weight: 800; color: var(--primary-dark);
            margin: 30px 0 15px 0; border-left: 5px solid var(--accent); padding-left: 10px;
        }
        .vessel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        
        .vessel-card { background: white; border-radius: 12px; padding: 15px; text-align: center; border: 2px solid #e5e7eb; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .vessel-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        
        .vessel-card.active { border-color: var(--accent-green); border-width: 3px; }
        .vessel-card.dirty { border-color: var(--status-dirty); border-width: 3px; background: #fef2f2; }
        .vessel-card.clean { border-color: var(--status-clean); border-width: 3px; border-style: dashed; }
        .vessel-card.brite-active { border-color: var(--accent-orange); border-width: 3px; }
        
        .tank-name { font-size: 1.2rem; font-weight: bold; margin: 0; color: #111827; }
        .status-tag { font-size: 0.65rem; font-weight: bold; padding: 3px 8px; border-radius: 4px; background: #f3f4f6; display: inline-block; margin-top: 5px; text-transform: uppercase; }

        /* --- MODAL --- */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
        #vessel-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 0; border-radius: 15px; z-index: 1000; width: 90%; max-width: 950px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden;
        }
        
        .modal-header { background: #f9fafb; padding: 20px 25px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .modal-tabs { display: flex; background: #f3f4f6; border-bottom: 1px solid #e5e7eb; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #6b7280; border-bottom: 3px solid transparent; transition: 0.2s; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: white; }
        
        .modal-content-area { padding: 25px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; color: #4b5563; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-green { background: var(--accent-green); }
        .btn-blue { background: var(--accent); }
        .btn-orange { background: var(--accent-orange); }

        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">SUBURBAN BREWING</div>
        <div class="nav-section-title">Main Menu</div> 
        <a href="../index.html" class="nav-link"><span>Command Center</span></a>
        
        <div class="nav-section-title">Samplings</div>
        <a href="../Samplings/Schedule-Sampling.html" class="nav-link"><span>Schedule Sampling</span></a>
        <a href="../Samplings/sampling-calendar.html" class="nav-link"><span>Sampling Calendar</span></a>
        <a href="../Samplings/sampling-report.html" class="nav-link"><span>Log Sampling Report</span></a>
        
        <div class="nav-section-title">Sales & Outreach</div>
        <a href="../sales/leads.html" class="nav-link"><span>AI Sales Leads</span></a>
        <a href="../sales/invoice-search.html" class="nav-link"><span>Invoice Search</span></a>
        <a href="../sales/deliveries.html" class="nav-link"><span>Delivery Tracking</span></a>
        <a href="../sales/new invoices.html" class="nav-link"><span>New Invoice</span></a>

        <div class="nav-section-title">Inventory</div>
        <a href="../inventory/Ingredient-inventory.html" class="nav-link"><span>Ingredient Inventory</span></a>
        <a href="../inventory/brewery.html" class="nav-link"><span>Packaged Inventory</span></a>
        <a href="../inventory/wholesaler-inventory.html" class="nav-link"><span>Wholesaler Inventory</span></a>
        <a href="../inventory/restaurant-inventory.html" class="nav-link"><span>Restaurant Inventory</span></a>
    
        <div class="nav-section-title">Brewing</div>
        <a href="Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
        <a href="Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
        <a href="cellar.html" class="nav-link active"><span>Cellar Management</span></a>
        <a href="packaging.html" class="nav-link"><span>Packaging log</span></a>
    
        <div class="nav-section-title">Reporting & Analytics</div>
        <a href="../Reports/Monthly-sales.html" class="nav-link"><span>Monthly Sales Report</span></a>
        <a href="../Reports/sales-route.html" class="nav-link"><span>Sales Route Opt.</span></a>
        <a href="../Reports/client-inventory.html" class="nav-link"><span>Client Inventory</span></a>
    </aside>

    <main class="main-content">
        <div class="header">
            <span style="font-weight: 600; color: #6b7280;">Brewing Operations</span>
            <span style="font-size: 0.9rem; font-weight: bold;">Cellar Overview</span>
        </div>

        <div class="container">
            <div class="grid-section-title">Production Fermenters (10 BBL)</div>
            <div id="grid-production" class="vessel-grid"></div>

            <div class="grid-section-title" style="border-color: var(--accent-orange);">Pilot Fermenters (1 BBL)</div>
            <div id="grid-pilot" class="vessel-grid"></div>

            <div class="grid-section-title" style="border-color: var(--accent-green);">Brite Tanks (10 BBL)</div>
            <div id="grid-brite" class="vessel-grid"></div>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div id="vessel-modal">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="margin:0;">Vessel Detail</h2>
                <small id="modal-subtitle" style="color: #6b7280;">Loading...</small>
            </div>
            <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <div class="modal-tabs">
            <button class="tab-btn active" onclick="switchTab('tab-daily', this)">Daily Log</button>
            <button class="tab-btn" onclick="switchTab('tab-actions', this)">Actions & Status</button>
            <button class="tab-btn" onclick="switchTab('tab-drops', this)">Drops & Harvests</button>
        </div>

        <div class="modal-content-area">
            <div id="tab-daily" class="tab-content active">
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <div class="form-group"><label>Gravity (SG)</label><input type="number" step="0.001" id="log-sg"></div>
                        <div class="form-group"><label>Temp (°F)</label><input type="number" id="log-temp"></div>
                        <div class="form-group"><label>pH</label><input type="number" step="0.01" id="log-ph"></div>
                        <div class="form-group"><label>Pressure (PSI)</label><input type="number" id="log-psi"></div>
                        <button class="btn-action btn-green" onclick="submitDailyLog()">Save Log Entry</button>
                    </div>
                    <div style="flex: 2; height: 300px;">
                        <canvas id="fermChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-actions" class="tab-content">
                <div class="form-group">
                    <label>Update Tank Status</label>
                    <select id="status-select">
                        <option value="Primary Fermentation">Primary Fermentation</option>
                        <option value="Diacetyl Rest">Diacetyl Rest</option>
                        <option value="Spunding">Spunding / Capped</option>
                        <option value="Soft Crash">Soft Crash (50°F)</option>
                        <option value="Cold Crash">Cold Crash (32°F)</option>
                        <option value="Ready to Package">Ready to Package</option>
                        <option value="Dirty">Dirty</option>
                        <option value="Clean">Clean / Available</option>
                    </select>
                    <button class="btn-action btn-blue" onclick="updateStatus()">Update Status</button>
                </div>
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                
                <div id="dry-hop-section" style="display:none;">
                    <label style="color:var(--accent-orange); font-weight:bold;">PENDING DRY HOP DETECTED</label>
                    <div style="background:#fff7ed; border:1px solid #ffedd5; padding:15px; border-radius:8px; margin-top:5px;">
                        <p style="margin:0 0 10px 0; font-size:0.9rem;"><strong>Action:</strong> Dry Hop (Scheduled)</p>
                        <button class="btn-action btn-orange" onclick="logDryHop()">Confirm Dry Hop Added</button>
                    </div>
                </div>
            </div>

            <div id="tab-drops" class="tab-content">
                <div class="form-group">
                    <label>Action Type</label>
                    <select id="drop-type">
                        <option value="Trub Dump">Trub Dump</option>
                        <option value="Yeast Harvest">Yeast Harvest</option>
                        <option value="Hop Drop">Hop Drop</option>
                    </select>
                </div>
                <div class="form-group"><label>Est. Volume Removed (Gal)</label><input type="number" id="drop-vol"></div>
                <div class="form-group"><label>Notes / Generation #</label><textarea id="drop-notes" rows="3"></textarea></div>
                <button class="btn-action btn-green" onclick="logDrop()">Log Drop</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CELLAR_API_URL = "https://script.google.com/macros/s/AKfycbzyzJqFRnoeLudi-FtJInszxxuJrtSj24MAnioa1SNe6xsJEEpM9eGISdOUc0_qLUWH/exec";
        
        let currentBatchId = null;
        let currentVessel = null;

        // --- 1. INITIALIZATION: LOAD LIVE TANKS ---
        window.onload = refreshGrid;

        async function refreshGrid() {
            const categories = {
                'grid-production': ["FV 1", "FV 2", "FV 3", "FV 4", "FV 5", "FV 6"],
                'grid-pilot': ["Pilot 1", "Pilot 2"],
                'grid-brite': ["BT 1", "BT 2"]
            };

            try {
                const res = await fetch(`${CELLAR_API_URL}?action=getTankStatus`, { redirect: "follow" });
                const live = await res.json();

                Object.keys(categories).forEach(gridId => {
                    const container = document.getElementById(gridId);
                    if (!container) return;
                    container.innerHTML = "";
                    
                    categories[gridId].forEach(name => {
                        const data = Array.isArray(live) ? live.find(b => b.vessel === name) : null;
                        const active = !!data && data.isActive;
                        const status = active ? data.status : "Available";
                        
                        let cardClass = active ? "active" : "clean";
                        if (status === "Dirty") cardClass = "dirty";

                        container.innerHTML += `
                            <div class="vessel-card ${cardClass}" onclick="openModal('${name}', '${active ? data.batchId : ''}', '${active ? data.brand : ''}', '${status}')">
                                <p class="tank-name">${name}</p>
                                <span class="status-tag">${status}</span>
                                <br><small>${active ? data.brand : '---'}</small>
                            </div>`;
                    });
                });
            } catch (e) { console.error("Grid Load Error:", e); }
        }

        // --- 2. MODAL & INTERACTION LOGIC ---
        function openModal(vessel, batchId, beerName, status) {
            currentVessel = vessel;
            currentBatchId = batchId;
            
            document.getElementById('vessel-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modal-title').innerText = vessel;
            
            if (batchId) {
                document.getElementById('modal-subtitle').innerText = `${beerName} (Batch #${batchId})`;
                document.getElementById('dry-hop-section').style.display = 'block';
                initChart(batchId);
            } else {
                document.getElementById('modal-subtitle').innerText = "Vessel is " + status;
                document.getElementById('dry-hop-section').style.display = 'none';
            }
        }

        function closeModal() {
            document.getElementById('vessel-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        // --- 3. DATA PERSISTENCE FUNCTIONS (POST) ---
        async function updateStatus() {
            const newStage = document.getElementById('status-select').value;
            if (!currentBatchId) return Swal.fire("No Active Batch", "Cannot update an empty vessel.", "warning");

            try {
                await fetch(CELLAR_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'updateStage', data: { batchId: currentBatchId, stage: newStage } })
                });
                Swal.fire('Updated', `Vessel stage set to: ${newStage}`, 'success').then(() => {
                    closeModal();
                    refreshGrid();
                });
            } catch(e) { Swal.fire('Error', 'Sync failed', 'error'); }
        }

        async function submitDailyLog() {
            const payload = {
                batchId: currentBatchId,
                gravity: document.getElementById('log-sg').value,
                temp: document.getElementById('log-temp').value,
                ph: document.getElementById('log-ph').value,
                psi: document.getElementById('log-psi').value
            };

            try {
                await fetch(CELLAR_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'logDaily', data: payload })
                });
                Swal.fire('Success', 'Daily fermentation log saved.', 'success');
            } catch(e) { Swal.fire('Error', 'Submission failed', 'error'); }
        }

        async function logDrop() {
            const payload = {
                batchId: currentBatchId,
                vessel: currentVessel,
                type: document.getElementById('drop-type').value,
                volume: document.getElementById('drop-vol').value,
                notes: document.getElementById('drop-notes').value
            };
            
            try {
                await fetch(CELLAR_API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'logDrop', data: payload })
                });
                Swal.fire('Logged', 'Action recorded in Fermenter Drops.', 'success');
                document.getElementById('drop-vol').value = '';
                document.getElementById('drop-notes').value = '';
            } catch(e) { Swal.fire('Error', 'Sync failed', 'error'); }
        }

        async function logDryHop() {
            // This would link to a task completion logic
            Swal.fire('Success', 'Dry Hop task marked as completed.', 'success');
            document.getElementById('dry-hop-section').style.display = 'none';
        }

        // --- 4. VISUALIZATION ---
        function initChart(batchId) {
            const ctx = document.getElementById('fermChart').getContext('2d');
            if(window.fermChartObj) window.fermChartObj.destroy();
            
            window.fermChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Day 0', 'Day 1', 'Day 2', 'Day 3'],
                    datasets: [{
                        label: 'Gravity Progress',
                        data: [1.060, 1.052, 1.044, 1.036],
                        borderColor: '#2563eb',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
