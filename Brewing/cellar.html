<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellar Management | Suburban Brewing Co.</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --sidebar-width: 240px; 
            --primary-dark: #111827; 
            --accent: #2563eb; 
            --accent-green: #27ae60;
            --accent-orange: #f39c12;
            --status-dirty: #ef4444;
            --status-clean: #10b981;
            --qc-warning: #facc15;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f3f4f6; 
            margin: 0; 
            display: flex; 
            color: #1f2937; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- SIDEBAR NAVIGATION --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--primary-dark); 
            height: 100vh; 
            color: white; 
            position: fixed; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
        }
        
        .sidebar-header { 
            padding: 25px 20px; 
            font-weight: 800; 
            font-size: 1.2rem; 
            border-bottom: 1px solid #1f2937; 
            letter-spacing: 1px; 
        }
        
        .nav-section-title { 
            font-size: 11px; 
            text-transform: uppercase; 
            opacity: 0.5; 
            margin: 20px 20px 8px; 
            font-weight: 700; 
            letter-spacing: 1px; 
        }
        
        .nav-link { 
            display: block; 
            padding: 10px 24px; 
            color: #d1d5db; 
            text-decoration: none; 
            font-size: 14px; 
            transition: 0.2s; 
        }
        
        .nav-link:hover { background: #1f2937; color: #fff; }
        .nav-link.active { background: var(--accent); color: #fff; font-weight: 600; }

        /* --- MAIN CONTENT AREA --- */
        .main-content { 
            margin-left: var(--sidebar-width); 
            flex-grow: 1; 
            height: 100vh; 
            overflow-y: auto; 
        }
        
        .header { 
            background: white; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #e5e7eb; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .container { padding: 30px; }

        /* --- ANALYTICS DASHBOARD --- */
        .dashboard-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-label { font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 700; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-dark); }

        /* --- VESSEL GRID LAYOUT --- */
        .grid-section-title {
            font-size: 1.1rem; 
            font-weight: 800; 
            color: var(--primary-dark);
            margin: 30px 0 15px 0; 
            border-left: 5px solid var(--accent); 
            padding-left: 10px;
        }
        
        .vessel-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        
        .vessel-card { 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            text-align: center; 
            border: 2px solid #e5e7eb; 
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            position: relative;
        }
        
        .vessel-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .vessel-card.active { border-color: var(--accent-green); border-width: 3px; }
        .vessel-card.dirty { border-color: var(--status-dirty); border-width: 3px; background: #fef2f2; }
        .vessel-card.clean { border-color: var(--status-clean); border-width: 3px; border-style: dashed; }
        .vessel-card.waiting-qc { border-color: var(--qc-warning); border-width: 3px; }

        .qc-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--qc-warning);
            color: #854d0e;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tank-name { font-size: 1.2rem; font-weight: bold; margin: 0; color: #111827; }
        .status-tag { 
            font-size: 0.65rem; 
            font-weight: bold; 
            padding: 3px 8px; 
            border-radius: 4px; 
            background: #f3f4f6; 
            display: inline-block; 
            margin-top: 5px; 
            text-transform: uppercase; 
        }

        /* --- MODAL SYSTEM --- */
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 999; 
        }
        
        #vessel-modal { 
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: white; 
            padding: 0; 
            border-radius: 15px; 
            z-index: 1000; 
            width: 90%; max-width: 1000px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
            overflow: hidden;
        }
        
        .modal-header { 
            background: #f9fafb; 
            padding: 20px 25px; 
            border-bottom: 1px solid #e5e7eb; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-tabs { 
            display: flex; 
            background: #f3f4f6; 
            border-bottom: 1px solid #e5e7eb; 
        }
        
        .tab-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-weight: bold; 
            color: #6b7280; 
            border-bottom: 3px solid transparent; 
            transition: 0.2s; 
        }
        
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: white; }
        .modal-content-area { padding: 25px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #4b5563; 
            text-transform: uppercase; 
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #d1d5db; 
            border-radius: 6px; 
            box-sizing: border-box; 
        }
        
        .btn-action { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            margin-top: 10px; 
        }
        
        .btn-green { background: var(--accent-green); }
        .btn-blue { background: var(--accent); }
        .btn-orange { background: var(--accent-orange); }

        .qc-section-title {
            font-size: 10px;
            color: var(--accent);
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: 1px;
            display: block;
        }

        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">SUBURBAN BREWING</div>
        <div class="nav-section-title">Main Menu</div> 
        <a href="../index.html" class="nav-link"><span>Command Center</span></a>
        
        <div class="nav-section-title">Brewing</div>
        <a href="Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
        <a href="Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
        <a href="cellar.html" class="nav-link active"><span>Cellar Management</span></a>
    </aside>

    <main class="main-content">
        <div class="header">
            <span style="font-weight: 600; color: #6b7280;">Brewing Operations</span>
            <span style="font-size: 0.9rem; font-weight: bold;">Cellar Overview</span>
        </div>

        <div class="container">
            <div class="dashboard-row">
                <div class="stat-card">
                    <div class="stat-label">Total Volume in Cellar</div>
                    <div class="stat-value" id="stat-total-bbl">-- BBL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Fermentations</div>
                    <div class="stat-value" id="stat-active-count">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Batches Awaiting QC</div>
                    <div class="stat-value" id="stat-qc-pending" style="color: var(--accent-orange);">--</div>
                </div>
            </div>

            <div class="grid-section-title">Production Fermenters (10 BBL)</div>
            <div id="grid-production" class="vessel-grid"></div>

            <div class="grid-section-title" style="border-color: var(--accent-orange);">Pilot Fermenters (1 BBL)</div>
            <div id="grid-pilot" class="vessel-grid"></div>

            <div class="grid-section-title" style="border-color: var(--accent-green);">Brite Tanks (10 BBL)</div>
            <div id="grid-brite" class="vessel-grid"></div>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    
    <div id="vessel-modal">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="margin:0;">Vessel Detail</h2>
                <small id="modal-subtitle" style="color: #6b7280;">Loading...</small>
            </div>
            <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <div class="modal-tabs">
            <button class="tab-btn active" onclick="switchTab('tab-daily', this)">Daily Log & QC</button>
            <button class="tab-btn" onclick="switchTab('tab-actions', this)">Actions & Status</button>
            <button class="tab-btn" onclick="switchTab('tab-additions', this)">Additions & Hops</button>
            <button class="tab-btn" onclick="switchTab('tab-drops', this)">Drops & Harvests</button>
        </div>

        <div class="modal-content-area">
            <div id="tab-daily" class="tab-content active">
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1; border-right: 1px solid #e5e7eb; padding-right: 25px;">
                        <div class="form-group"><label>Gravity (SG)</label><input type="number" step="0.001" id="log-sg"></div>
                        <div class="form-group"><label>Temp (°F)</label><input type="number" id="log-temp"></div>
                        <div class="form-group"><label>pH</label><input type="number" step="0.01" id="log-ph"></div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px;">
                            <span class="qc-section-title">QUALITY CONTROL GATES</span>
                            <div class="form-group">
                                <label>VDK Test Result</label>
                                <select id="log-vdk">
                                    <option value="">-- No Test --</option>
                                    <option value="PASS">PASS (Diacetyl Clean)</option>
                                    <option value="FAIL">FAIL (Keep Warming)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Carbonation (CO2 Vol)</label>
                                <input type="number" step="0.01" id="log-carb" placeholder="e.g. 2.55">
                            </div>
                        </div>
                        
                        <button class="btn-action btn-green" onclick="submitDailyLog()">Save Log & QC Gates</button>
                    </div>
                    <div style="flex: 1.5; height: 380px;">
                        <canvas id="fermChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-additions" class="tab-content">
                <div style="display: flex; background: #f1f5f9; padding: 5px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                    <button id="toggle-dh" class="tab-btn active" style="flex:1; padding: 8px; font-size: 11px; border-radius: 6px; border:none;" onclick="setAdditionMode('DH')">Dry Hop (Recipe Driven)</button>
                    <button id="toggle-ing" class="tab-btn" style="flex:1; padding: 8px; font-size: 11px; border-radius: 6px; border:none;" onclick="setAdditionMode('ING')">Other Addition (Inventory)</button>
                </div>

                <div id="mode-dryhop">
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <label style="color: #1e40af; font-weight: 700; font-size: 10px; text-transform: uppercase;">Planned Recipe Additions</label>
                        <div id="recipe-dh-list" style="margin-top: 10px; font-size: 14px; font-weight: 600; color: #1e293b;">
                            <span style="color: #64748b; font-weight: 400; font-style: italic;">Loading recipe plan...</span>
                        </div>
                    </div>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group"><label>Actual Weight (lbs)</label><input type="number" id="dh-actual-weight"></div>
                        <div class="form-group"><label>Lot # Used</label><input type="text" id="dh-actual-lot"></div>
                    </div>
                    <button class="btn-action btn-blue" onclick="submitAddition('Dry Hop')">Complete Dry Hop Task</button>
                </div>

                <div id="mode-ingredient" style="display: none;">
                    <div class="form-group">
                        <label>Available Stock Item (On-Hand)</label>
                        <select id="inv-item-select" class="actual-input" onchange="syncInvLot()">
                            <option value="">-- Select In-Stock Ingredient --</option>
                        </select>
                    </div>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group"><label>Quantity</label><input type="number" id="ing-qty"></div>
                        <div class="form-group"><label>Current Lot</label><input type="text" id="ing-lot-read" readonly style="background:#f8fafc; color: #64748b;"></div>
                    </div>
                    <div class="form-group">
                        <label>Addition Purpose</label>
                        <input type="text" id="ing-purpose" placeholder="e.g. Fruiting, Biofine, Spices">
                    </div>
                    <button class="btn-action btn-green" onclick="submitAddition('Ingredient')">Log Ingredient Addition</button>
                </div>
            </div>

            <div id="tab-actions" class="tab-content">
                <div class="form-group">
                    <label>Update Tank Status</label>
                    <select id="status-select">
                        <option value="Primary Fermentation">Primary Fermentation</option>
                        <option value="Diacetyl Rest">Diacetyl Rest</option>
                        <option value="Cold Crash">Cold Crash</option>
                        <option value="Conditioning">Conditioning</option>
                        <option value="Ready to Package">Ready to Package</option>
                        <option value="Dirty">Dirty</option>
                        <option value="Clean">Clean / Available</option>
                    </select>
                </div>
                <div id="qc-alert-box" style="display:none; padding: 15px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 8px; margin-bottom: 20px; color: #92400e; font-size: 13px; line-height: 1.5;">
                    ⚠️ <b>Verification Required:</b> This stage change requires a <b>VDK PASS</b> or <b>Carbonation Check</b> to be logged in the Daily Log before advancing.
                </div>
                <button class="btn-action btn-blue" onclick="updateStatus()">Apply Stage Transition</button>
            </div>

            <div id="tab-drops" class="tab-content">
                <div class="form-group">
                    <label>Action Type</label>
                    <select id="drop-type">
                        <option value="Trub Dump">Trub Dump</option>
                        <option value="Yeast Harvest">Yeast Harvest</option>
                        <option value="Hop Drop">Hop Drop</option>
                    </select>
                </div>
                <div class="form-group"><label>Est. Volume Removed (Gal)</label><input type="number" id="drop-vol"></div>
                <div class="form-group"><label>Notes / Generation #</label><textarea id="drop-notes" rows="3"></textarea></div>
                <button class="btn-action btn-green" onclick="logDrop()">Log Drop / Harvest</button>
            </div>
        </div>
    </div>

    <script>
        // --- MASTER CONFIGURATION ---
        const CELLAR_API_URL = "https://script.google.com/macros/s/AKfycbzyzJqFRnoeLudi-FtJInszxxuJrtSj24MAnioa1SNe6xsJEEpM9eGISdOUc0_qLUWH/exec";
        
        let currentBatchId = null;
        let currentVessel = null;
        let currentAdditionMode = 'DH';

        // --- GRID INITIALIZATION ---
        window.onload = refreshGrid;

        async function refreshGrid() {
            const categories = {
                'grid-production': ["FV 1", "FV 2", "FV 3", "FV 4", "FV 5", "FV 6"],
                'grid-pilot': ["Pilot 1", "Pilot 2"],
                'grid-brite': ["BT 1", "BT 2"]
            };

            try {
                const res = await fetch(`${CELLAR_API_URL}?action=getTankStatus`, { redirect: "follow" });
                const live = await res.json();

                let totalBBL = 0;
                let activeCount = 0;
                let qcPendingCount = 0;

                Object.keys(categories).forEach(gridId => {
                    const container = document.getElementById(gridId);
                    if (!container) return;
                    container.innerHTML = "";
                    
                    categories[gridId].forEach(name => {
                        const data = Array.isArray(live) ? live.find(b => b.vessel === name) : null;
                        const active = !!data && data.isActive;
                        const status = active ? data.status : "Available";
                        
                        // DASHBOARD AGGREGATION
                        if(active) {
                            activeCount++;
                            const isPilot = gridId.includes('pilot');
                            totalBBL += isPilot ? 1 : 10;
                            
                            // Batches waiting for a gate (D-Rest needs VDK, Conditioning/Brite needs Carb)
                            if(status === "Diacetyl Rest" || (status === "Conditioning" && gridId.includes('brite'))) {
                                qcPendingCount++;
                            }
                        }

                        let cardClass = active ? "active" : "clean";
                        if (status === "Dirty") cardClass = "dirty";
                        
                        let qcBadge = "";
                        if(active && status === "Diacetyl Rest") {
                            qcBadge = `<div class="qc-badge">VDK REQ</div>`;
                            cardClass += " waiting-qc";
                        }

                        container.innerHTML += `
                            <div class="vessel-card ${cardClass}" onclick="openModal('${name}', '${active ? data.batchId : ''}', '${active ? data.brand : ''}', '${status}')">
                                ${qcBadge}
                                <p class="tank-name">${name}</p>
                                <span class="status-tag">${status}</span>
                                <br><small>${active ? data.brand : '---'}</small>
                            </div>`;
                    });
                });

                // UPDATE DASHBOARD STATS
                document.getElementById('stat-total-bbl').innerText = totalBBL + " BBL";
                document.getElementById('stat-active-count').innerText = activeCount;
                document.getElementById('stat-qc-pending').innerText = qcPendingCount;

            } catch (e) { console.error("Grid Load Error:", e); }
        }

        // --- MODAL & DATA FETCHING ---
        async function openModal(vessel, batchId, beerName, status) {
            currentVessel = vessel;
            currentBatchId = batchId;
            
            document.getElementById('vessel-modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modal-title').innerText = vessel;
            
            // Logic for Quality Gate Warning Box
            const qcBox = document.getElementById('qc-alert-box');
            if(status === "Diacetyl Rest" || status === "Conditioning") {
                qcBox.style.display = 'block';
            } else {
                qcBox.style.display = 'none';
            }

            if (batchId && batchId !== "") {
                document.getElementById('modal-subtitle').innerText = `${beerName} (Batch #${batchId})`;
                fetchRecipeHops(beerName); 
                initChart(batchId);
            } else {
                document.getElementById('modal-subtitle').innerText = "Vessel Status: " + status;
                document.getElementById('recipe-dh-list').innerHTML = "No active production batch.";
            }
        }

        async function fetchRecipeHops(recipeName) {
            const listDiv = document.getElementById('recipe-dh-list');
            try {
                const res = await fetch(`${CELLAR_API_URL}?action=getRecipePlan&name=${encodeURIComponent(recipeName)}`);
                const plan = await res.json();
                
                if (plan && plan.hops && plan.hops.length > 0) {
                    listDiv.innerHTML = plan.hops.map(h => 
                        `<div style="padding: 4px 0; border-bottom: 1px solid #dbeafe;">
                            <span style="color: #1e40af;">${h.variety}</span>: ${h.amount} lbs
                        </div>`
                    ).join('');
                } else {
                    listDiv.innerHTML = "No dry hop schedule in master recipe.";
                }
            } catch (e) { listDiv.innerHTML = "Recipe data retrieval error."; }
        }

        // --- ADDITION TOGGLE LOGIC ---
        function setAdditionMode(mode) {
            currentAdditionMode = mode;
            document.getElementById('mode-dryhop').style.display = mode === 'DH' ? 'block' : 'none';
            document.getElementById('mode-ingredient').style.display = mode === 'ING' ? 'block' : 'none';
            
            document.getElementById('toggle-dh').classList.toggle('active', mode === 'DH');
            document.getElementById('toggle-ing').classList.toggle('active', mode === 'ING');

            if (mode === 'ING') loadInventoryDropdown();
        }

        async function loadInventoryDropdown() {
            const select = document.getElementById('inv-item-select');
            try {
                const res = await fetch(`${CELLAR_API_URL}?action=getInventoryItems`);
                const items = await res.json();
                select.innerHTML = '<option value="">-- Select In-Stock Ingredient --</option>';
                items.forEach(i => {
                    select.innerHTML += `<option value="${i.name}" data-lot="${i.lot}">${i.name} (Lot: ${i.lot})</option>`;
                });
            } catch (e) { console.error("Inventory Load Error", e); }
        }

        function syncInvLot() {
            const select = document.getElementById('inv-item-select');
            const opt = select.options[select.selectedIndex];
            document.getElementById('ing-lot-read').value = opt.getAttribute('data-lot') || "";
        }

        // --- DATA SUBMISSION ---
        async function submitAddition(type) {
            const payload = {
                action: type === 'Dry Hop' ? 'logDryHop' : 'logIngredient',
                data: {
                    batchId: currentBatchId,
                    vessel: currentVessel,
                    item: type === 'Dry Hop' ? document.getElementById('recipe-dh-list').innerText : document.getElementById('inv-item-select').value,
                    qty: type === 'Dry Hop' ? document.getElementById('dh-actual-weight').value : document.getElementById('ing-qty').value,
                    lot: type === 'Dry Hop' ? document.getElementById('dh-actual-lot').value : document.getElementById('ing-lot-read').value,
                    notes: type === 'Ingredient' ? document.getElementById('ing-purpose').value : "Manual Addition"
                }
            };

            await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            Swal.fire("Success", `${type} addition logged.`, "success");
            closeModal();
            refreshGrid();
        }

        async function updateStatus() {
            const stage = document.getElementById('status-select').value;
            await fetch(CELLAR_API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'updateStage', data: { batchId: currentBatchId, stage: stage } })
            });
            
            Swal.fire('Updated', `Tank status moved to: ${stage}`, 'success').then(() => { closeModal(); refreshGrid(); });
        }

        async function submitDailyLog() {
            const payload = {
                batchId: currentBatchId,
                gravity: document.getElementById('log-sg').value,
                temp: document.getElementById('log-temp').value,
                ph: document.getElementById('log-ph').value,
                vdkResult: document.getElementById('log-vdk').value,
                co2Vol: document.getElementById('log-carb').value
            };
            await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logDaily', data: payload }) });
            Swal.fire("Logged", "Daily fermentation data saved.", "success");
            closeModal();
            refreshGrid();
        }

        async function logDrop() {
            const payload = {
                batchId: currentBatchId,
                vessel: currentVessel,
                type: document.getElementById('drop-type').value,
                volume: document.getElementById('drop-vol').value,
                notes: document.getElementById('drop-notes').value
            };
            await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logDrop', data: payload }) });
            Swal.fire("Logged", "Vessel drop/harvest recorded.", "success");
        }

        // --- UTILS & UI ---
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        function closeModal() { 
            document.getElementById('vessel-modal').style.display = 'none'; 
            document.getElementById('overlay').style.display = 'none'; 
        }

        function initChart(batchId) {
            const ctx = document.getElementById('fermChart').getContext('2d');
            if(window.fermChartObj) window.fermChartObj.destroy();
            window.fermChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Log 1', 'Log 2', 'Log 3', 'Log 4'],
                    datasets: [{
                        label: 'Specific Gravity',
                        data: [1.065, 1.050, 1.035, 1.012],
                        borderColor: '#2563eb',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(37, 99, 235, 0.05)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
