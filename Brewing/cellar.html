<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cellar Management | Suburban Brewing Co.</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --sidebar-width: 240px; 
            --primary-dark: #111827; 
            --accent: #2563eb; 
            --accent-green: #27ae60;
            --accent-orange: #f39c12;
            --status-dirty: #ef4444;
            --status-clean: #10b981;
            --qc-warning: #facc15;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f3f4f6; 
            margin: 0; 
            display: flex; 
            color: #1f2937; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- SIDEBAR NAVIGATION --- */
        .sidebar { 
            width: var(--sidebar-width); 
            background: var(--primary-dark); 
            height: 100vh; 
            color: white; 
            position: fixed; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
        }
        
        .sidebar-header { 
            padding: 25px 20px; 
            font-weight: 800; 
            font-size: 1.2rem; 
            border-bottom: 1px solid #1f2937; 
            letter-spacing: 1px; 
        }
        
        .nav-section-title { 
            font-size: 11px; 
            text-transform: uppercase; 
            opacity: 0.5; 
            margin: 20px 20px 8px; 
            font-weight: 700; 
            letter-spacing: 1px; 
        }
        
        .nav-link { 
            display: block; 
            padding: 10px 24px; 
            color: #d1d5db; 
            text-decoration: none; 
            font-size: 14px; 
            transition: 0.2s; 
        }
        
        .nav-link:hover { background: #1f2937; color: #fff; }
        .nav-link.active { background: var(--accent); color: #fff; font-weight: 600; }

        /* --- MAIN CONTENT AREA --- */
        .main-content { 
            margin-left: var(--sidebar-width); 
            flex-grow: 1; 
            height: 100vh; 
            overflow-y: auto; 
        }
        
        .header { 
            background: white; 
            padding: 15px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #e5e7eb; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .container { padding: 30px; }

        /* --- DASHBOARD STATS --- */
        .dashboard-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .stat-label { font-size: 11px; text-transform: uppercase; color: #6b7280; font-weight: 700; }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--primary-dark); }

        /* --- VESSEL GRID LAYOUT --- */
        .grid-section-title {
            font-size: 1.1rem; 
            font-weight: 800; 
            color: var(--primary-dark);
            margin: 30px 0 15px 0; 
            border-left: 5px solid var(--accent); 
            padding-left: 10px;
        }
        
        .vessel-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 15px; 
        }
        
        .vessel-card { 
            background: white; 
            border-radius: 12px; 
            padding: 15px; 
            text-align: center; 
            border: 2px solid #e5e7eb; 
            cursor: pointer; 
            transition: 0.2s; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            position: relative;
        }
        
        .vessel-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .vessel-card.active { border-color: var(--accent-green); border-width: 3px; }
        .vessel-card.dirty { border-color: var(--status-dirty); border-width: 3px; background: #fef2f2; }
        .vessel-card.clean { border-color: var(--status-clean); border-width: 3px; border-style: dashed; }
        .vessel-card.waiting-qc { border-color: var(--qc-warning); border-width: 3px; }

        .qc-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--qc-warning);
            color: #854d0e;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .tank-name { font-size: 1.2rem; font-weight: bold; margin: 0; color: #111827; }
        .status-tag { 
            font-size: 0.65rem; 
            font-weight: bold; 
            padding: 3px 8px; 
            border-radius: 4px; 
            background: #f3f4f6; 
            display: inline-block; 
            margin-top: 5px; 
            text-transform: uppercase; 
        }

        /* --- MODAL SYSTEM --- */
        .overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 999; 
        }
        
        #vessel-modal { 
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: white; 
            padding: 0; 
            border-radius: 15px; 
            z-index: 1000; 
            width: 90%; max-width: 1000px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
            overflow: hidden;
        }
        
        .modal-header { 
            background: #f9fafb; 
            padding: 20px 25px; 
            border-bottom: 1px solid #e5e7eb; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-tabs { 
            display: flex; 
            background: #f3f4f6; 
            border-bottom: 1px solid #e5e7eb; 
        }
        
        .tab-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            font-weight: bold; 
            color: #6b7280; 
            border-bottom: 3px solid transparent; 
            transition: 0.2s; 
        }
        
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: white; }
        .modal-content-area { padding: 25px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #4b5563; 
            text-transform: uppercase; 
        }
        
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #d1d5db; 
            border-radius: 6px; 
            box-sizing: border-box; 
        }
        
        .btn-action { 
            width: 100%; 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            margin-top: 10px; 
        }
        
        .btn-green { background: var(--accent-green); }
        .btn-blue { background: var(--accent); }
        .btn-orange { background: var(--accent-orange); }

        .qc-section-title {
            font-size: 10px;
            color: var(--accent);
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: 1px;
            display: block;
        }

        .aa-calculator-box {
            background: #fffbeb;
            border: 1px solid #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        @media (max-width: 768px) { .sidebar { display: none; } .main-content { margin-left: 0; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">SUBURBAN BREWING</div>
        
        <div class="nav-section-title">Main Menu</div> 
        <a href="../index.html" class="nav-link"><span>Command Center</span></a>
        
        <div class="nav-section-title">Samplings</div>
        <a href="../Samplings/Schedule-Sampling.html" class="nav-link"><span>Schedule Sampling</span></a>
        <a href="../Samplings/sampling-calendar.html" class="nav-link"><span>Sampling Calendar</span></a>
        <a href="../Samplings/sampling-report.html" class="nav-link"><span>Log Sampling Report</span></a>
        
        <div class="nav-section-title">Sales & Outreach</div>
        <a href="../sales/leads.html" class="nav-link"><span>AI Sales Leads</span></a>
        <a href="../sales/invoice-search.html" class="nav-link"><span>Invoice Search</span></a>
        <a href="../sales/deliveries.html" class="nav-link"><span>Delivery Tracking</span></a>
        <a href="../sales/new invoices.html" class="nav-link"><span>New Invoice</span></a>

        <div class="nav-section-title">Inventory</div>
        <a href="../inventory/Ingredient-inventory.html" class="nav-link"><span>Ingredient Inventory</span></a>
        <a href="../inventory/brewery.html" class="nav-link"><span>Packaged Inventory</span></a>
        <a href="../inventory/wholesaler-inventory.html" class="nav-link"><span>Wholesaler Inventory</span></a>
        <a href="../inventory/restaurant-inventory.html" class="nav-link"><span>Restaurant Inventory</span></a>
    
        <div class="nav-section-title">Brewing</div>
        <a href="Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
        <a href="Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
        <a href="cellar.html" class="nav-link active"><span>Cellar Management</span></a>
        <a href="qc-dashboard.html" class="nav-link"><span>QC Dashboard</span></a>
        <a href="packaging.html" class="nav-link"><span>Packaging log</span></a>
    
        <div class="nav-section-title">Reporting & Analytics</div>
        <a href="../Reports/Monthly-sales.html" class="nav-link"><span>Monthly Sales Report</span></a>
        <a href="../Reports/sales-route.html" class="nav-link"><span>Sales Route Opt.</span></a>
        <a href="../Reports/client-inventory.html" class="nav-link"><span>Client Inventory</span></a>
  </aside>

    <main class="main-content">
        <div class="header">
            <span style="font-weight: 600; color: #6b7280;">Brewing Operations</span>
            <span style="font-size: 0.9rem; font-weight: bold;">Cellar Overview</span>
        </div>

        <div class="container">
            <div class="dashboard-row">
                <div class="stat-card">
                    <div class="stat-label">Total Volume in Cellar</div>
                    <div class="stat-value" id="stat-total-bbl">-- BBL</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Fermentations</div>
                    <div class="stat-value" id="stat-active-count">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Batches Awaiting QC</div>
                    <div class="stat-value" id="stat-qc-pending" style="color: var(--accent-orange);">--</div>
                </div>
            </div>

            <div class="grid-section-title">Production Fermenters (10 BBL)</div>
            <div id="grid-production" class="vessel-grid"></div>

            <div class="grid-section-title" style="border-color: var(--accent-orange);">Pilot Fermenters (1 BBL)</div>
            <div id="grid-pilot" class="vessel-grid"></div>

            <div class="grid-section-title" style="border-color: var(--accent-green);">Brite Tanks (10 BBL)</div>
            <div id="grid-brite" class="vessel-grid"></div>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    
    <div id="vessel-modal">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="margin:0;">Vessel Detail</h2>
                <small id="modal-subtitle" style="color: #6b7280;">Loading...</small>
            </div>
            <button onclick="closeModal()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <div class="modal-tabs">
            <button class="tab-btn active" onclick="switchTab('tab-daily', this)">Daily Log & QC</button>
            <button class="tab-btn" onclick="switchTab('tab-actions', this)">Actions & Status</button>
            <button class="tab-btn" onclick="switchTab('tab-additions', this)">Additions & Hops</button>
            <button class="tab-btn" onclick="switchTab('tab-drops', this)">Drops & Harvests</button>
            <button class="tab-btn" onclick="switchTab('tab-transfer', this)">Transfer / Brite</button>
            <button class="tab-btn" onclick="switchTab('tab-ml', this)">ML Insights</button>
        </div>

        <div class="modal-content-area">
            
            <div id="tab-daily" class="tab-content active">
                <div style="display: flex; gap: 30px;">
                    <div style="flex: 1; border-right: 1px solid #e5e7eb; padding-right: 25px;">
                        <div class="form-group"><label>Gravity (SG)</label><input type="number" step="0.001" id="log-sg"></div>
                        <div class="form-group"><label>Temp (¬∞F)</label><input type="number" id="log-temp"></div>
                        <div class="form-group"><label>pH</label><input type="number" step="0.01" id="log-ph"></div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-top: 20px;">
                            <span class="qc-section-title">QUALITY CONTROL GATES</span>
                            <div class="form-group">
                                <label>VDK Test Result</label>
                                <select id="log-vdk">
                                    <option value="">-- No Test --</option>
                                    <option value="PASS">PASS (Diacetyl Clean)</option>
                                    <option value="FAIL">FAIL (Keep Warming)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Carbonation (CO2 Vol)</label>
                                <input type="number" step="0.01" id="log-carb" placeholder="e.g. 2.55">
                            </div>
                        </div>
                        
                        <button class="btn-action btn-green" onclick="submitDailyLog()">Save Log & QC Gates</button>
                    </div>
                    <div style="flex: 1.5; height: 380px;">
                        <canvas id="fermChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-actions" class="tab-content">
                <div class="form-group">
                    <label>Update Tank Status</label>
                    <select id="status-select">
                        <option value="Primary Fermentation">Primary Fermentation</option>
                        <option value="Diacetyl Rest">Diacetyl Rest</option>
                        <option value="Cold Crash">Cold Crash</option>
                        <option value="Conditioning">Conditioning</option>
                        <option value="Ready to Package">Ready to Package</option>
                        <option value="Dirty">Dirty</option>
                        <option value="Clean">Clean / Available</option>
                    </select>
                </div>
                <div id="qc-alert-box" style="display:none; padding: 15px; background: #fffbeb; border: 1px solid #fef3c7; border-radius: 8px; margin-bottom: 20px; color: #92400e; font-size: 13px; line-height: 1.5;">
                    ‚ö†Ô∏è <b>Verification Required:</b> This stage change requires a <b>VDK PASS</b> or <b>Carbonation Check</b> to be logged in the Daily Log before advancing.
                </div>
                <button class="btn-action btn-blue" onclick="updateStatus()">Apply Stage Transition</button>
            </div>

            <div id="tab-additions" class="tab-content">
                <div style="display: flex; background: #f1f5f9; padding: 5px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                    <button id="toggle-dh" class="tab-btn active" style="flex:1; padding: 8px; font-size: 11px; border-radius: 6px; border:none;" onclick="setAdditionMode('DH')">Dry Hop (Recipe Driven)</button>
                    <button id="toggle-ing" class="tab-btn" style="flex:1; padding: 8px; font-size: 11px; border-radius: 6px; border:none;" onclick="setAdditionMode('ING')">Other Addition (Inventory)</button>
                </div>

                <div id="mode-dryhop">
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <label style="color: #1e40af; font-weight: 700; font-size: 10px; text-transform: uppercase;">Planned Recipe Additions</label>
                        <div id="recipe-dh-list" style="margin-top: 10px; font-size: 14px; font-weight: 600; color: #1e293b;">
                            <span style="color: #64748b; font-weight: 400; font-style: italic;">Loading recipe plan...</span>
                        </div>
                    </div>
                    
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group"><label>Recipe Weight (lbs)</label><input type="number" id="dh-recipe-weight"></div>
                        <div class="form-group"><label>Recipe Target AA%</label><input type="number" step="0.1" id="dh-target-aa"></div>
                    </div>
                    <div class="form-group">
                        <label>Choose Inventory Lot (Updates AA%)</label>
                        <select id="dh-lot-select" onchange="calculateAAAdjustment()">
                            <option value="">-- Select Inventory Lot --</option>
                        </select>
                    </div>
                    <div id="aa-calc-display" class="aa-calculator-box">
                        ‚öñÔ∏è <b>Alpha Adjustment:</b> Scaled weight to <span id="dh-adjusted-val" style="font-weight: 900; color: #2563eb;">0.00</span> lbs.
                    </div>
                    
                    <button class="btn-action btn-blue" onclick="submitAddition('Dry Hop')">Complete Dry Hop Task</button>
                </div>

                <div id="mode-ingredient" style="display: none;">
                    <div class="form-group">
                        <label>Available Stock Item (On-Hand)</label>
                        <select id="inv-item-select" class="actual-input" onchange="syncInvLot()">
                            <option value="">-- Select In-Stock Ingredient --</option>
                        </select>
                    </div>
                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group"><label>Quantity</label><input type="number" id="ing-qty"></div>
                        <div class="form-group"><label>Current Lot</label><input type="text" id="ing-lot-read" readonly style="background:#f8fafc; color: #64748b;"></div>
                    </div>
                    <div class="form-group">
                        <label>Addition Purpose</label>
                        <input type="text" id="ing-purpose" placeholder="e.g. Fruiting, Biofine, Spices">
                    </div>
                    <button class="btn-action btn-green" onclick="submitAddition('Ingredient')">Log Ingredient Addition</button>
                </div>
            </div>

            <div id="tab-drops" class="tab-content">
                <div class="form-group">
                    <label>Action Type</label>
                    <select id="drop-type">
                        <option value="Trub Dump">Trub Dump</option>
                        <option value="Yeast Harvest">Yeast Harvest</option>
                        <option value="Hop Drop">Hop Drop</option>
                    </select>
                </div>
                <div class="form-group"><label>Est. Volume Removed (Gal)</label><input type="number" id="drop-vol"></div>
                <div class="form-group"><label>Notes / Generation #</label><textarea id="drop-notes" rows="3"></textarea></div>
                <button class="btn-action btn-green" onclick="logDrop()">Log Drop / Harvest</button>
            </div>

            <div id="tab-transfer" class="tab-content">
                <div class="form-group">
                    <label>Destination Vessel (Brite/Conditioning)</label>
                    <select id="transfer-dest">
                        <option value="BT 1">BT 1</option>
                        <option value="BT 2">BT 2</option>
                        <option value="Kegs">Kegs (Direct Packaging)</option>
                    </select>
                </div>
                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group"><label>Transfer Vol (BBL)</label><input type="number" id="transfer-vol"></div>
                    <div class="form-group"><label>Final Gravity (P/SG)</label><input type="number" id="transfer-fg"></div>
                </div>
                <div class="form-group">
                    <label>Carb Stone Setting (PSI)</label>
                    <input type="number" id="transfer-psi">
                </div>
                <div style="padding: 15px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 6px; margin-bottom: 15px; color: #065f46; font-size: 0.8rem;">
                    ‚ÑπÔ∏è <b>Note:</b> Confirming this transfer will mark <b><span id="lbl-source-vessel">CURRENT</span></b> as "Empty/Dirty" and create a new active record for the destination tank.
                </div>
                <button class="btn-action btn-blue" onclick="submitTransfer()">Confirm Transfer</button>
            </div>

            <div id="tab-ml" class="tab-content">
                <div style="background: #1f2937; color: #fff; padding: 20px; border-radius: 8px;">
                    <h3 style="margin-top:0; color: #60a5fa;">ü§ñ AI Fermentation Analyst</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <label style="color: #9ca3af; font-size: 0.7rem; text-transform: uppercase;">Predicted Finish Date</label>
                            <div id="ml-finish-date" style="font-size: 1.5rem; font-weight: bold;">--/--</div>
                        </div>
                        <div>
                            <label style="color: #9ca3af; font-size: 0.7rem; text-transform: uppercase;">Curve Health</label>
                            <div id="ml-health-status" style="font-size: 1.2rem; font-weight: bold;">Analyzing...</div>
                        </div>
                    </div>
                    <div id="ml-anomaly-box" style="margin-top: 15px; padding: 10px; background: #7f1d1d; color: #fecaca; border-radius: 4px; display: none;">
                        ‚ö†Ô∏è <b>ANOMALY DETECTED:</b> Fermentation is slower than historical average for this brand. Check temp control.
                    </div>
                    <button class="btn-action" style="background: #374151; margin-top: 20px;" onclick="runMLAnalysis()">Update Analysis</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- MASTER CONFIGURATION ---
    const CELLAR_API_URL = "https://script.google.com/macros/s/AKfycbzyzJqFRnoeLudi-FtJInszxxuJrtSj24MAnioa1SNe6xsJEEpM9eGISdOUc0_qLUWH/exec";
    
    let currentBatchId = null;
    let currentVessel = null;
    let currentBrand = null;
    let currentAdditionMode = 'DH';

    // --- 1. INITIALIZATION (FIXED) ---
    // We remove 'await' so both functions fire immediately and independently
    window.onload = function() {
        console.log("Page Loaded. initializing...");
        refreshGrid();       // Draw the visual grid
        checkForQRContext(); // Check URL for QR data
    };

    // --- 2. QR CODE LISTENER (WITH DEBUGGING) ---
    async function checkForQRContext() {
        const urlParams = new URLSearchParams(window.location.search);
        const qrVessel = urlParams.get('vessel');
        
        // DEBUG LOG: See if the code actually detects the URL parameter
        console.log("URL Parameter 'vessel' detected:", qrVessel);

        if (qrVessel) {
            // Show a "Thinking..." toast so you know it's working
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
            });
            Toast.fire({ icon: 'info', title: `Scanning ${qrVessel}...` });

            try {
                const res = await fetch(`${CELLAR_API_URL}?action=getTankStatus`);
                const allTanks = await res.json();
                
                // FUZZY MATCHING: Removes spaces/dashes and ignores case
                // e.g. "FV-1" matches "FV 1" matches "fv1"
                const normalize = (str) => String(str).replace(/[-\s]/g, '').toUpperCase();
                const targetScan = normalize(decodeURIComponent(qrVessel));
                
                console.log("Looking for Normalized Tank:", targetScan);

                const target = allTanks.find(t => normalize(t.vessel) === targetScan);

                if (target) {
                    console.log("Tank Found:", target);
                    if (target.isActive) {
                        // SUCCESS: Open the modal
                        console.log("Opening Modal for Active Tank");
                        openModal(target.vessel, target.batchId, target.brand, target.status);
                    } else {
                        // TANK IS EMPTY: Prompt for new brew
                        console.log("Tank is Empty/Inactive");
                        Swal.fire({
                            title: `${target.vessel} is Available`,
                            text: "Tank is currently empty. What's next?",
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonText: 'Start New Brew',
                            confirmButtonColor: '#2563eb',
                            cancelButtonText: 'Receive Transfer',
                            cancelButtonColor: '#10b981'
                        }).then((result) => {
                            if (result.isConfirmed) window.location.href = "Brew-Log.html";
                            else if (result.dismiss === Swal.DismissReason.cancel) Swal.fire("Ready to Receive", "Scan Source Tank QR to start transfer.", "info");
                        });
                    }
                } else {
                    console.warn("Tank NOT found in database.");
                    Swal.fire("Unknown Vessel", `Could not find "${qrVessel}" in the system.`, "error");
                }
            } catch (e) {
                console.error("QR Lookup Failed:", e);
                Swal.fire("Connection Error", "Could not talk to the brewery database.", "error");
            }
        }
    }

    // --- 3. GRID & DATA FUNCTIONS ---
    async function refreshGrid() {
        const categories = {
            'grid-production': ["FV 1", "FV 2", "FV 3", "FV 4", "FV 5", "FV 6"],
            'grid-pilot': ["Pilot 1", "Pilot 2"],
            'grid-brite': ["BT 1", "BT 2"]
        };

        try {
            const res = await fetch(`${CELLAR_API_URL}?action=getTankStatus`, { redirect: "follow" });
            const live = await res.json();

            let totalBBL = 0;
            let activeCount = 0;
            let qcPendingCount = 0;

            Object.keys(categories).forEach(gridId => {
                const container = document.getElementById(gridId);
                if (!container) return;
                container.innerHTML = "";
                
                categories[gridId].forEach(name => {
                    const data = Array.isArray(live) ? live.find(b => b.vessel === name) : null;
                    const active = !!data && data.isActive;
                    const status = active ? data.status : "Available";
                    
                    if(active) {
                        activeCount++;
                        totalBBL += gridId.includes('pilot') ? 1 : 10;
                        if(status === "Diacetyl Rest" || status === "Conditioning") qcPendingCount++;
                    }

                    let cardClass = active ? "active" : "clean";
                    if (status === "Dirty") cardClass = "dirty";
                    
                    let qcBadge = "";
                    if(active && status === "Diacetyl Rest") {
                        qcBadge = `<div class="qc-badge">VDK REQ</div>`;
                        cardClass += " waiting-qc";
                    }

                    container.innerHTML += `
                        <div class="vessel-card ${cardClass}" onclick="openModal('${name}', '${active ? data.batchId : ''}', '${active ? data.brand : ''}', '${status}')">
                            ${qcBadge}
                            <p class="tank-name">${name}</p>
                            <span class="status-tag">${status}</span>
                            <br><small>${active ? data.brand : '---'}</small>
                        </div>`;
                });
            });

            document.getElementById('stat-total-bbl').innerText = totalBBL + " BBL";
            document.getElementById('stat-active-count').innerText = activeCount;
            document.getElementById('stat-qc-pending').innerText = qcPendingCount;

        } catch (e) { console.error("Grid Load Error:", e); }
    }

    async function openModal(vessel, batchId, beerName, status) {
        currentVessel = vessel;
        currentBatchId = batchId;
        currentBrand = beerName;
        
        document.getElementById('vessel-modal').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('modal-title').innerText = vessel;
        
        const qcBox = document.getElementById('qc-alert-box');
        qcBox.style.display = (status === "Diacetyl Rest" || status === "Conditioning") ? 'block' : 'none';

        if (batchId && batchId !== "") {
            document.getElementById('modal-subtitle').innerText = `${beerName} (Batch #${batchId})`;
            fetchRecipeHops(beerName); 
            loadInventoryLots(); 
            initChart(batchId, beerName); 
        } else {
            document.getElementById('modal-subtitle').innerText = "Vessel Status: " + status;
        }
    }

    async function loadInventoryLots() {
        const select = document.getElementById('dh-lot-select');
        try {
            const res = await fetch(`${CELLAR_API_URL}?action=getHopAlphaData`);
            const items = await res.json();
            select.innerHTML = '<option value="">-- Choose Inventory Lot --</option>';
            items.forEach(i => {
                select.innerHTML += `<option value="${i.lot}" data-aa="${i.aa}">${i.variety} (Lot: ${i.lot} | ${i.aa}%)</option>`;
            });
        } catch (e) { console.error(e); }
    }

    function calculateAAAdjustment() {
        const recipeWeight = parseFloat(document.getElementById('dh-recipe-weight').value);
        const targetAA = parseFloat(document.getElementById('dh-target-aa').value);
        const select = document.getElementById('dh-lot-select');
        const actualAA = parseFloat(select.options[select.selectedIndex].getAttribute('data-aa'));

        if (!recipeWeight || !targetAA || !actualAA) return;

        const adjusted = (recipeWeight * targetAA) / actualAA;
        document.getElementById('dh-adjusted-val').innerText = adjusted.toFixed(2);
        document.getElementById('aa-calc-display').style.display = 'block';
    }

    async function fetchRecipeHops(recipeName) {
        const listDiv = document.getElementById('recipe-dh-list');
        try {
            const res = await fetch(`${CELLAR_API_URL}?action=getRecipePlan&name=${encodeURIComponent(recipeName)}`);
            const plan = await res.json();
            if (plan && plan.hops && plan.hops.length > 0) {
                listDiv.innerHTML = plan.hops.map(h => 
                    `<div style="padding: 4px 0; border-bottom: 1px solid #dbeafe;">
                        <span style="color: #1e40af;">${h.variety}</span>: ${h.amount} lbs (Target: ${h.targetAA}%)
                    </div>`
                ).join('');
                document.getElementById('dh-recipe-weight').value = plan.hops[0].amount;
                document.getElementById('dh-target-aa').value = plan.hops[0].targetAA;
            }
        } catch (e) { listDiv.innerHTML = "Recipe data retrieval error."; }
    }

    async function initChart(batchId, brand) {
        const ctx = document.getElementById('fermChart').getContext('2d');
        if(window.fermChartObj) window.fermChartObj.destroy();

        try {
            const res = await fetch(`${CELLAR_API_URL}?action=getFermAnalysis&batchId=${batchId}&brand=${encodeURIComponent(brand)}`);
            const comparison = await res.json();

            window.fermChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: comparison.benchmark.map(b => 'Day ' + b.day),
                    datasets: [
                        {
                            label: 'Current Gravity',
                            data: comparison.current.map(c => c.gravity),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.05)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Historical Benchmark',
                            data: comparison.benchmark.map(b => b.benchmarkGravity),
                            borderColor: '#94a3b8',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        } catch (e) { console.warn("Chart Load Error", e); }
    }

    async function runMLAnalysis() {
        document.getElementById('ml-health-status').innerText = "Computing...";
        try {
            const res = await fetch(`${CELLAR_API_URL}?action=runMLPrediction&batchId=${currentBatchId}`);
            const mlData = await res.json();
            
            document.getElementById('ml-finish-date').innerText = mlData.prediction || "Unknown";
            
            if (mlData.anomaly) {
                document.getElementById('ml-health-status').innerText = "Deviation Detected";
                document.getElementById('ml-health-status').style.color = "#ef4444";
                document.getElementById('ml-anomaly-box').style.display = "block";
            } else {
                document.getElementById('ml-health-status').innerText = "Healthy Curve";
                document.getElementById('ml-health-status').style.color = "#10b981";
                document.getElementById('ml-anomaly-box').style.display = "none";
            }
        } catch (e) {
            console.error("ML Error", e);
            document.getElementById('ml-health-status').innerText = "Data Error";
        }
    }

    async function submitTransfer() {
        if(!confirm("Are you sure? This will empty the current vessel.")) return;
        
        const payload = {
            action: 'transferVolume',
            data: {
                batchId: currentBatchId,
                sourceVessel: currentVessel,
                destVessel: document.getElementById('transfer-dest').value,
                volume: document.getElementById('transfer-vol').value,
                gravity: document.getElementById('transfer-fg').value,
                carb: document.getElementById('transfer-psi').value,
                brandName: currentBrand
            }
        };

        Swal.fire({title: 'Transferring...', didOpen: () => Swal.showLoading()});
        
        await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        
        Swal.fire("Success", "Volume transferred. Source tank marked Empty/Dirty.", "success")
            .then(() => { location.reload(); });
    }

    async function submitAddition(type) {
        const isDH = type === 'Dry Hop';
        const payload = {
            action: isDH ? 'logDryHop' : 'logIngredient',
            data: {
                batchId: currentBatchId,
                vessel: currentVessel,
                item: isDH ? document.getElementById('dh-lot-select').options[document.getElementById('dh-lot-select').selectedIndex].text.split(' (')[0] : document.getElementById('inv-item-select').value,
                qty: isDH ? document.getElementById('dh-recipe-weight').value : document.getElementById('ing-qty').value,
                recipeTargetAA: isDH ? document.getElementById('dh-target-aa').value : 0,
                lot: isDH ? document.getElementById('dh-lot-select').value : document.getElementById('ing-lot-read').value,
                notes: isDH ? "AA% Adjusted" : document.getElementById('ing-purpose').value
            }
        };
        await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        Swal.fire("Success", `${type} logged.`, "success").then(() => { closeModal(); refreshGrid(); });
    }

    async function updateStatus() {
        const stage = document.getElementById('status-select').value;
        await fetch(CELLAR_API_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ action: 'updateStage', data: { batchId: currentBatchId, stage: stage } })
        });
        Swal.fire('Updated', `Stage: ${stage}`, 'success').then(() => { closeModal(); refreshGrid(); });
    }

    async function submitDailyLog() {
        const payload = {
            batchId: currentBatchId,
            gravity: document.getElementById('log-sg').value,
            temp: document.getElementById('log-temp').value,
            ph: document.getElementById('log-ph').value,
            vdkResult: document.getElementById('log-vdk').value,
            co2Check: document.getElementById('log-carb').value
        };
        await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logDaily', data: payload }) });
        Swal.fire("Logged", "Data saved.", "success").then(() => { closeModal(); refreshGrid(); });
    }

    async function logDrop() {
        const payload = {
            batchId: currentBatchId,
            vessel: currentVessel,
            type: document.getElementById('drop-type').value,
            volume: document.getElementById('drop-vol').value,
            notes: document.getElementById('drop-notes').value
        };
        await fetch(CELLAR_API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'logDrop', data: payload }) });
        Swal.fire("Logged", "Entry saved.", "success");
    }

    function setAdditionMode(mode) {
        currentAdditionMode = mode;
        document.getElementById('mode-dryhop').style.display = mode === 'DH' ? 'block' : 'none';
        document.getElementById('mode-ingredient').style.display = mode === 'ING' ? 'block' : 'none';
        document.getElementById('toggle-dh').classList.toggle('active', mode === 'DH');
        document.getElementById('toggle-ing').classList.toggle('active', mode === 'ING');
        if (mode === 'ING') loadInventoryDropdown();
    }

    async function loadInventoryDropdown() {
        const select = document.getElementById('inv-item-select');
        try {
            const res = await fetch(`${CELLAR_API_URL}?action=getInventoryItems`);
            const items = await res.json();
            select.innerHTML = '<option value="">-- Select In-Stock Ingredient --</option>';
            items.forEach(i => {
                select.innerHTML += `<option value="${i.name}" data-lot="${i.lot}">${i.name} (Lot: ${i.lot})</option>`;
            });
        } catch (e) { console.error(e); }
    }

    function syncInvLot() {
        const select = document.getElementById('inv-item-select');
        const opt = select.options[select.selectedIndex];
        document.getElementById('ing-lot-read').value = opt.getAttribute('data-lot') || "";
    }

    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        btn.classList.add('active');
    }

    function closeModal() { 
        document.getElementById('vessel-modal').style.display = 'none'; 
        document.getElementById('overlay').style.display = 'none'; 
    }
</script>
</body>
</html>
