<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Suburban Brewing | Sensory Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --accent: #2563eb; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
    
    .container { max-width: 800px; margin: 0 auto; }
    
    /* Header */
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { margin: 0; font-size: 1.8rem; color: #0f172a; }
    .header p { color: #64748b; margin-top: 5px; }

    /* Cards */
    .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 20px; }
    
    /* Form Elements */
    label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: #475569; }
    input[type="text"], select, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
    
    /* Sliders */
    .slider-group { margin-bottom: 20px; }
    .slider-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
    input[type="range"] { width: 100%; margin: 10px 0; accent-color: var(--accent); cursor: pointer; }
    
    /* Off Flavor Chips */
    .chip-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .chip-check { display: none; }
    .chip-label { 
      padding: 8px 16px; background: #f1f5f9; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; border: 1px solid transparent; 
    }
    .chip-check:checked + .chip-label { background: #fee2e2; color: #ef4444; border-color: #ef4444; font-weight: 600; }

    /* Button */
    .btn-submit { width: 100%; padding: 16px; background: #0f172a; color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 20px; }
    .btn-submit:hover { background: #1e293b; }

    /* Chart Container */
    .chart-box { position: relative; height: 300px; width: 100%; margin: 20px 0; }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>Sensory Analysis</h1>
      <p>Quality Control Panel | Suburban Brewing Co.</p>
    </div>

    <div class="card">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label>Taster Name</label>
          <input type="text" id="taster" placeholder="Your Name">
        </div>
        <div>
          <label>Role</label>
          <select id="role">
            <option value="Staff">Brewery Staff</option>
            <option value="Guest">Guest / Public</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 15px;">
        <label>Beer / Batch</label>
        <select id="beerSelect">
          <option value="">Select Beer...</option>
          <option value="Suburban IPA">Suburban IPA</option>
          <option value="Main St. Stout">Main St. Stout</option>
          <option value="Honey Brook Helles">Honey Brook Helles</option>
          <option value="Seasonal Sour">Seasonal Sour</option>
        </select>
      </div>
      <div style="margin-top: 15px;">
        <label>Batch Number (Optional)</label>
        <input type="text" id="batch" placeholder="e.g. B-2026-004">
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Profile Intensity</h3>
      
      <div class="chart-box">
        <canvas id="sensoryChart"></canvas>
      </div>

      <div class="slider-group">
        <div class="slider-row"><label>Maltiness</label> <span id="val-malt">3</span></div>
        <input type="range" min="0" max="5" step="0.5" value="3" oninput="updateChart('malt', this.value)">
      </div>

      <div class="slider-group">
        <div class="slider-row"><label>Hop Aroma</label> <span id="val-hops">3</span></div>
        <input type="range" min="0" max="5" step="0.5" value="3" oninput="updateChart('hops', this.value)">
      </div>

      <div class="slider-group">
        <div class="slider-row"><label>Bitterness</label> <span id="val-bitterness">3</span></div>
        <input type="range" min="0" max="5" step="0.5" value="3" oninput="updateChart('bitterness', this.value)">
      </div>

      <div class="slider-group">
        <div class="slider-row"><label>Esters (Fruity)</label> <span id="val-esters">1</span></div>
        <input type="range" min="0" max="5" step="0.5" value="1" oninput="updateChart('esters', this.value)">
      </div>

      <div class="slider-group">
        <div class="slider-row"><label>Body / Mouthfeel</label> <span id="val-body">3</span></div>
        <input type="range" min="0" max="5" step="0.5" value="3" oninput="updateChart('body', this.value)">
      </div>
    </div>

    <div class="card">
      <label>Off-Flavor Detection</label>
      <div class="chip-grid">
        <input type="checkbox" id="off1" class="chip-check" value="Diacetyl"><label for="off1" class="chip-label">Diacetyl (Butter)</label>
        <input type="checkbox" id="off2" class="chip-check" value="DMS"><label for="off2" class="chip-label">DMS (Corn)</label>
        <input type="checkbox" id="off3" class="chip-check" value="Oxidation"><label for="off3" class="chip-label">Oxidation (Cardboard)</label>
        <input type="checkbox" id="off4" class="chip-check" value="Acetaldehyde"><label for="off4" class="chip-label">Acetaldehyde (Green Apple)</label>
        <input type="checkbox" id="off5" class="chip-check" value="Phenolic"><label for="off5" class="chip-label">Phenolic (Medicinal)</label>
        <input type="checkbox" id="off6" class="chip-check" value="Sour/Acidic"><label for="off6" class="chip-label">Unintended Sour</label>
      </div>

      <div style="margin-top: 25px;">
        <label>Overall Score (1-10)</label>
        <input type="range" min="1" max="10" step="0.1" value="8" oninput="document.getElementById('score-disp').innerText=this.value" style="accent-color: #10b981;">
        <div style="text-align: center; font-size: 2rem; font-weight: 800; color: #10b981;" id="score-disp">8</div>
      </div>

      <div style="margin-top: 15px;">
        <label>Notes</label>
        <textarea id="notes" rows="3" placeholder="Additional comments on appearance, head retention, etc."></textarea>
      </div>

      <button class="btn-submit" onclick="submitSensory()">Submit Analysis</button>
    </div>

  </div>

  <script>
    // ðŸ”´ UPDATE URL ðŸ”´
    const API_URL = "https://script.google.com/macros/s/AKfycbyxhEEZIVpBQmESc3DD_12jS2Fnjgp2uQJK0o5Dy5o0n31aouq-Pr4Tzj_oQBUWE9Juhg/exec";

    // --- CHART CONFIG ---
    const ctx = document.getElementById('sensoryChart').getContext('2d');
    const sensoryChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Malt', 'Hops', 'Bitterness', 'Esters', 'Body'],
        datasets: [{
          label: 'Flavor Profile',
          data: [3, 3, 3, 1, 3],
          backgroundColor: 'rgba(37, 99, 235, 0.2)',
          borderColor: 'rgba(37, 99, 235, 1)',
          borderWidth: 2,
          pointBackgroundColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            angleLines: { color: '#e2e8f0' },
            grid: { color: '#e2e8f0' },
            suggestedMin: 0,
            suggestedMax: 5,
            ticks: { display: false } // Hide numbers on chart for cleaner look
          }
        },
        plugins: { legend: { display: false } }
      }
    });

    // --- UPDATE CHART ON SLIDER MOVE ---
    function updateChart(metric, val) {
      document.getElementById('val-' + metric).innerText = val; // Update text number
      
      const map = { 'malt':0, 'hops':1, 'bitterness':2, 'esters':3, 'body':4 }; // Map metric name to array index
      sensoryChart.data.datasets[0].data[map[metric]] = parseFloat(val);
      
      // Dynamic Phenol (If user drags esters high, maybe hint at phenol? Just kidding, keeping it simple)
      sensoryChart.update();
    }

    // --- SUBMIT FUNCTION ---
    async function submitSensory() {
      const taster = document.getElementById('taster').value;
      const beer = document.getElementById('beerSelect').value;
      
      if(!taster || !beer) {
        Swal.fire('Missing Info', 'Please enter your name and select a beer.', 'warning');
        return;
      }

      // Collect Off Flavors
      const offFlavors = [];
      document.querySelectorAll('.chip-check:checked').forEach(c => offFlavors.push(c.value));
      if(offFlavors.length === 0) offFlavors.push("None Detected");

      const payload = {
        taster: taster,
        role: document.getElementById('role').value,
        beer: beer,
        batch: document.getElementById('batch').value || "N/A",
        score: document.getElementById('score-disp').innerText,
        profile: {
          malt: sensoryChart.data.datasets[0].data[0],
          hops: sensoryChart.data.datasets[0].data[1],
          bitterness: sensoryChart.data.datasets[0].data[2],
          esters: sensoryChart.data.datasets[0].data[3],
          phenols: 0, // Placeholder if you add phenol slider later
          body: sensoryChart.data.datasets[0].data[4]
        },
        offFlavors: offFlavors,
        notes: document.getElementById('notes').value
      };

      Swal.fire({ title: 'Submitting...', didOpen: () => Swal.showLoading() });

      try {
        await fetch(API_URL, {
          method: 'POST',
          body: new URLSearchParams({
            "action": "submitSensoryLog",
            "data": JSON.stringify(payload)
          })
        });

        Swal.fire('Success', 'Sensory analysis logged.', 'success').then(() => {
          location.reload(); // Refresh for next taster
        });
      } catch(e) {
        Swal.fire('Error', e.toString(), 'error');
      }
    }
  </script>
</body>
</html>
