<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brewery Master Log Portal</title>
    <style>
        :root {
            --header-bg: #2c3e50;
            --section-bg: #ecf0f1;
            --active-green: #27ae60;
            --text-dark: #333;
            --white: #ffffff;
            --input-bg: #fdfdfd;
            --accent-gray: #7f8c8d;
        }

        body {
            font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
            margin: 0; padding: 0;
            color: var(--text-dark);
            padding-bottom: 100px;
        }

        /* --- STICKY ACTION HEADER --- */
        .sticky-header {
            position: sticky;
            top: 0;
            background: var(--header-bg);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .batch-summary { font-size: 1.1rem; font-weight: bold; }
        
        .btn-save {
            background-color: var(--active-green);
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            text-transform: uppercase;
        }

        /* --- MAIN CONTAINER --- */
        #main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }

        /* --- !MAIN SCREEN VISIBILITY --- */
        #main-screen { display: block !important; }
        #follow-up-sheet { display: none !important; }

        /* --- COLLAPSIBLE SECTIONS --- */
        .brew-stage {
            background: white;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .stage-header {
            background-color: var(--section-bg);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        .stage-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--header-bg);
            margin: 0;
        }

        .toggle-indicator { font-size: 1.5rem; font-weight: bold; color: var(--accent-gray); }

        .stage-content { padding: 20px; display: block; }
        .stage-content.collapsed { display: none; }

        /* --- FORMS & TABLES --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group { display: flex; flex-direction: column; }
        
        label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent-gray);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            background: var(--input-bg);
        }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--header-bg); color: white; padding: 10px; text-align: left; font-size: 0.85rem; }
        td { border-bottom: 1px solid #eee; padding: 8px; }
        
        /* --- BUTTONS --- */
        .btn-add-row {
            margin-top: 10px;
            background: var(--slate-light, #34495e);
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
        }

        .btn-small-add {
            background: white;
            border: 1px solid #ccc;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            border-radius: 3px;
            margin-top: 5px;
        }

        /* --- DEEP CUT STYLING --- */
        .deep-cut-wrapper {
            background: #f9f9f9;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .sub-section-title {
            margin: 15px 0 10px 0; 
            color: var(--header-bg); 
            border-bottom: 2px solid #ddd; 
            padding-bottom: 5px;
        }

        /* --- MOBILE RESPONSIVENESS (ICON-FREE) --- */
        @media screen and (max-width: 768px) {
            i, svg, .icon { display: none !important; }
            .form-grid { grid-template-columns: 1fr; }
            td input { font-size: 16px; } /* Prevent iOS zoom */
        }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="batch-summary">
        BATCH: <span id="header-batch-id">---</span> | <span id="header-recipe">New Entry</span>
    </div>
    <button class="btn-save" onclick="saveBrewLog()">Save Master Log</button>
</div>

<div id="main-container">

    <div id="main-screen">
        
        <div class="brew-stage">
            <div class="stage-header" onclick="toggleSection('setup-content', this)">
                <h3 class="stage-title">1. Batch Setup</h3>
                <span class="toggle-indicator">-</span>
            </div>
            <div id="setup-content" class="stage-content">
                <div class="form-grid">
                    <div class="input-group">
                        <label>Batch ID</label>
                        <input type="text" id="batchId" placeholder="B-XXXX">
                    </div>
                    <div class="input-group">
                        <label>Brew Date</label>
                        <input type="date" id="brewDate">
                    </div>
                    <div class="input-group">
                        <label>Beer Name</label>
                        <input type="text" id="beerName" placeholder="Style/Brand">
                    </div>
                    <div class="input-group">
                        <label>Brewer</label>
                        <input type="text" placeholder="Name">
                    </div>
                </div>
            </div>
        </div>

        <div class="brew-stage">
            <div class="stage-header" onclick="toggleSection('grain-content', this)">
                <h3 class="stage-title">2. Grain Bill & Mash-In</h3>
                <span class="toggle-indicator">+</span>
            </div>
            <div id="grain-content" class="stage-content collapsed">
                
                <h4 class="sub-section-title">Water & Strike Setup</h4>
                <div class="form-grid">
                    <div class="input-group">
                        <label>Mash In Time</label>
                        <input type="time">
                    </div>
                    <div class="input-group">
                        <label>Strike Water Amount</label>
                        <input type="text" placeholder="e.g. 15 BBL">
                    </div>
                    <div class="input-group">
                        <label>Mash In Water Temp</label>
                        <input type="text" placeholder="e.g. 165°F">
                    </div>
                </div>

                <div class="form-grid">
                    <div class="input-group" style="grid-column: span 2;">
                        <label>Mash Salts Used</label>
                        <input type="text" placeholder="e.g. Gypsum, Calcium Chloride">
                    </div>
                    <div class="input-group">
                        <label>Salt Amounts Added</label>
                        <input type="text" placeholder="e.g. 200g, 150g">
                    </div>
                </div>

                <h4 class="sub-section-title">Malt Inventory & Grist</h4>
                <table id="grain-table">
                    <thead>
                        <tr>
                            <th width="25%">Malt Type</th>
                            <th width="15%">Supplier</th>
                            <th width="15%">Lot #</th>
                            <th width="15%">Weight (lb)</th>
                            <th width="10%">% Grist</th>
                            <th width="10%">Added?</th>
                            <th width="10%">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" readonly style="background:#f0f0f0;" value="2-Row Base"></td>
                            <td><input type="text" placeholder="Supplier"></td>
                            <td><input type="text" placeholder="Lot #" onchange="runBridgingLogic(this)"></td>
                            <td>
                                <input type="number" readonly style="background:#f0f0f0;" value="1000" onchange="runBridgingLogic(this)">
                                <div class="inv-status" style="font-size: 10px; color: var(--accent-gray); margin-top:2px;"></div>
                            </td>
                            <td><input type="number" readonly style="background:#f0f0f0;" value="85"></td>
                            <td style="text-align:center;"><input type="checkbox" style="width:20px; height:20px;"></td>
                            <td><input type="time"></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-add-row" onclick="addRow('grain-table')">+ Add Specialty Grain</button>

                <div class="input-group" style="margin-top:20px;">
                    <label>Grain & Milling Notes</label>
                    <textarea style="width:100%; height:80px; padding:10px;" placeholder="Milled gap settings, husk condition..."></textarea>
                </div>
            </div>
        </div>

        <div class="brew-stage">
            <div class="stage-header" onclick="toggleSection('mash-content', this)">
                <h3 class="stage-title">3. Mash Schedule</h3>
                <span class="toggle-indicator">+</span>
            </div>
            <div id="mash-content" class="stage-content collapsed">
                <table id="mash-table">
                    <thead>
                        <tr>
                            <th width="25%">Step Name</th>
                            <th width="15%">Target Temp</th>
                            <th width="15%">Actual Temp</th>
                            <th width="15%">Duration (Min)</th>
                            <th width="15%">Start Time</th>
                            <th width="15%">End Time</th>
                        </tr>
                    </thead>
                    <tbody id="mash-body">
                        <tr>
                            <td>
                                <input type="text" value="Saccharification" readonly style="background:#f0f0f0; font-weight:bold;">
                                <div style="margin-top:5px;">
                                    <label style="font-size:10px; color:var(--active-green);">MASH pH (First Rest Only)</label>
                                    <input type="number" step="0.01" placeholder="5.2">
                                </div>
                            </td>
                            <td><input type="text" value="152°F" readonly style="background:#f0f0f0;"></td>
                            <td><input type="number" placeholder="Actual"></td>
                            <td><input type="text" value="60" readonly style="background:#f0f0f0;"></td>
                            <td><input type="time"></td>
                            <td><input type="time"></td>
                        </tr>
                        <tr>
                            <td><input type="text" value="Mash Out" readonly style="background:#f0f0f0; font-weight:bold;"></td>
                            <td><input type="text" value="168°F" readonly style="background:#f0f0f0;"></td>
                            <td><input type="number" placeholder="Actual"></td>
                            <td><input type="text" value="10" readonly style="background:#f0f0f0;"></td>
                            <td><input type="time"></td>
                            <td><input type="time"></td>
                        </tr>
                    </tbody>
                </table>
                <p style="font-size: 12px; color: #7f8c8d; margin-top: 10px;">* Steps, Target Temps, and Durations are locked based on the selected Recipe.</p>
            </div>
        </div>

        <div class="brew-stage">
            <div class="stage-header" onclick="toggleSection('lauter-content', this)">
                <h3 class="stage-title">4. Lauter & Sparge</h3>
                <span class="toggle-indicator">+</span>
            </div>
            <div id="lauter-content" class="stage-content collapsed">
                
                <div id="lauter-phases">
                    <h4 class="sub-section-title">A. First Runnings</h4>
                    <div class="form-grid">
                        <div class="input-group"><label>Start Time</label><input type="time"></div>
                        <div class="input-group"><label>End Time</label><input type="time"></div>
                        <div class="input-group"><label>Gravity</label><input type="number" step="0.001"></div>
                    </div>
                    <div class="deep-cut-wrapper">
                        <label style="color:var(--active-green)">Deep Cuts</label>
                        <div id="cuts-fr">
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <input type="text" placeholder="Reading" style="flex:2">
                                <input type="time" style="flex:1">
                            </div>
                        </div>
                        <button class="btn-small-add" onclick="addDeepCut('cuts-fr')">+ Add Reading</button>
                    </div>

                    <h4 class="sub-section-title">B. First Sparge</h4>
                    <div class="form-grid">
                        <div class="input-group"><label>Start Time</label><input type="time"></div>
                        <div class="input-group"><label>End Time</label><input type="time"></div>
                    </div>
                    <div class="deep-cut-wrapper">
                        <label style="color:var(--active-green)">Deep Cuts</label>
                        <div id="cuts-sp1">
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <input type="text" placeholder="Reading" style="flex:2">
                                <input type="time" style="flex:1">
                            </div>
                        </div>
                        <button class="btn-small-add" onclick="addDeepCut('cuts-sp1')">+ Add Reading</button>
                    </div>

                    <h4 class="sub-section-title">C. Second Sparge</h4>
                    <div class="form-grid">
                        <div class="input-group"><label>Start Time</label><input type="time"></div>
                        <div class="input-group"><label>End Time</label><input type="time"></div>
                    </div>
                    <div class="deep-cut-wrapper">
                        <label style="color:var(--active-green)">Deep Cuts</label>
                        <div id="cuts-sp2">
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <input type="text" placeholder="Reading" style="flex:2">
                                <input type="time" style="flex:1">
                            </div>
                        </div>
                        <button class="btn-small-add" onclick="addDeepCut('cuts-sp2')">+ Add Reading</button>
                    </div>
                </div>

                <h4 class="sub-section-title">D. Final Totals</h4>
                <div class="form-grid">
                    <div class="input-group"><label>Pre-Boil Vol</label><input type="number" step="0.1"></div>
                    <div class="input-group"><label>Pre-Boil Gravity</label><input type="number" step="0.001"></div>
                    <div class="input-group"><label>Efficiency %</label><input type="number"></div>
                </div>
            </div>
        </div>

        <div class="brew-stage">
            <div class="stage-header" onclick="toggleSection('boil-content', this)">
                <h3 class="stage-title">5. Boil Additions</h3>
                <span class="toggle-indicator">+</span>
            </div>
            <div id="boil-content" class="stage-content collapsed">
                <table id="boil-table">
                    <thead>
                        <tr>
                            <th>Min Left</th><th>Type</th><th>Ingredient</th><th>Amount</th><th>Added?</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number"></td>
                            <td><select><option>Hops</option><option>Other</option></select></td>
                            <td><input type="text"></td>
                            <td><input type="text"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                    </tbody>
                </table>
                <button class="btn-add-row" onclick="addRow('boil-table')">+ Add Addition</button>
            </div>
        </div>

    </div>
<div class="brew-stage">
    <div class="stage-header" onclick="toggleSection('ko-yeast-content', this)">
        <h3 class="stage-title">6. Knockout & Yeast Pitch</h3>
        <span class="toggle-indicator">+</span>
    </div>
    <div id="ko-yeast-content" class="stage-content collapsed">
        
        <h4 class="sub-section-title">Knockout (KO) Details</h4>
        <div class="form-grid">
            <div class="input-group">
                <label>KO Start Time</label>
                <input type="time">
            </div>
            <div class="input-group">
                <label>KO End Time</label>
                <input type="time">
            </div>
            <div class="input-group">
                <label>Total KO Volume</label>
                <input type="text" placeholder="e.g. 12.5 BBL">
            </div>
        </div>

        <div class="form-grid">
            <div class="input-group">
                <label>Target OG</label>
                <input type="text" value="1.052" readonly style="background:#f0f0f0;">
            </div>
            <div class="input-group">
                <label>Actual KO Gravity (OG)</label>
                <input type="text" placeholder="e.g. 1.054">
            </div>
            <div class="input-group">
                <label>KO Temp (°F)</label>
                <input type="text" placeholder="e.g. 68°F">
            </div>
        </div>

        <h4 class="sub-section-title">Yeast Inventory & Pitching</h4>
        <table id="yeast-table">
            <thead>
                <tr>
                    <th width="30%">Yeast Strain</th>
                    <th width="20%">Supplier</th>
                    <th width="20%">Lot # / Generation</th>
                    <th width="15%">Pitch Weight/Qty</th>
                    <th width="15%">Pitch Time</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><input type="text" readonly style="background:#f0f0f0;" value="US-05 American Ale"></td>
                    <td><input type="text" placeholder="Supplier" value="Fermentis"></td>
                    <td><input type="text" placeholder="Lot #" onchange="runBridgingLogic(this)"></td>
                    <td><input type="text" placeholder="e.g. 500g"></td>
                    <td><input type="time"></td>
                </tr>
            </tbody>
        </table>

        <div class="form-grid" style="margin-top:20px;">
            <div class="input-group">
                <label>Aeration Rate (L/min)</label>
                <input type="text" placeholder="e.g. 2.0">
            </div>
            <div class="input-group" style="grid-column: span 2;">
                <label>Yeast & KO Notes</label>
                <input type="text" placeholder="Viability, brink pressure, cold break quality...">
            </div>
        </div>
    </div>
</div>
    <div id="follow-up-sheet"></div>

</div>

<script>
    // Toggle Sections
    function toggleSection(id, header) {
        const content = document.getElementById(id);
        const indicator = header.querySelector('.toggle-indicator');
        content.classList.toggle('collapsed');
        indicator.textContent = content.classList.contains('collapsed') ? "+" : "-";
    }

    // Add Table Rows
    function addRow(tableId) {
        const tbody = document.getElementById(tableId).querySelector('tbody');
        const newRow = tbody.rows[0].cloneNode(true);
        newRow.querySelectorAll('input').forEach(i => { i.value = ""; i.checked = false; });
        tbody.appendChild(newRow);
    }
function getInventoryBridgeData(grainName, primaryLot) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const invSheet = ss.getSheetByName("invoices"); // Your inventory is here
  const data = invSheet.getDataRange().getValues();
  
  let result = { available: 0, backupLot: null };

  for (let i = 1; i < data.length; i++) {
    let invGrain = data[i][0]; // Column A: Grain Name
    let invLot = data[i][2];   // Column C: Lot #
    let invBal = data[i][5];   // Column F: Current Balance
    
    if (invGrain === grainName) {
      if (invLot === primaryLot) {
        result.available = invBal;
      } else if (invBal > 0 && !result.backupLot) {
        // Found a different lot of the same grain with stock
        result.backupLot = invLot;
      }
    }
  }
  return result;
}
    // Add Dynamic Deep Cuts
    function addDeepCut(containerId) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.style.cssText = "display:flex; gap:10px; margin-top:5px;";
        div.innerHTML = `<input type="text" placeholder="Reading" style="flex:2">
                         <input type="time" style="flex:1">`;
        container.appendChild(div);
    }

    // Sync Header Text
    document.getElementById('batchId').oninput = (e) => document.getElementById('header-batch-id').textContent = e.target.value || "---";
    document.getElementById('beerName').oninput = (e) => document.getElementById('header-recipe').textContent = e.target.value || "New Entry";

    function saveBrewLog() {
        alert("Data compiled. Ready for Apps Script injection.");
    }
</script>

</body>
</html>
