<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding-bottom: 130px; color: #2d3436; }
        .site-header { background-color: #ffffff; padding: 10px 5%; border-bottom: 2px solid #1a1a1a; display: flex; align-items: center; gap: 20px; }
        .header-info { font-size: 0.85rem; line-height: 1.3; }
        .header-info h1 { margin: 0 0 2px 0; font-size: 1.2rem; color: #1a1a1a; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; padding: 2rem; border-radius: 12px; border: 1px solid #dee2e6; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        /* Search and Category Styling */
        .controls-area { margin-bottom: 20px; position: sticky; top: 10px; z-index: 100; background: #f8f9fa; padding: 10px 0; }
        .search-input { width: 100%; padding: 15px; border: 2px solid #1a1a1a; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; box-sizing: border-box; }
        .cat-bar { display: flex; gap: 8px; flex-wrap: wrap; }
        
        /* Product Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .product-card { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .product-img-container { width: 100%; height: 200px; background: #fcfcfc; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: center; position: relative; }
        .lifecycle-badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; background: #dfe6e9; }
        .product-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .variant-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; }
        .variant-qty { width: 65px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }
        .stock-tag { font-size: 0.75rem; color: #27ae60; font-weight: bold; }
        .stock-low { color: #d63031; }

        /* Legal/Agreement */
        .legal-scroll { height: 400px; overflow-y: auto; border: 2px solid #1a1a1a; padding: 1.5rem; background: #fff; font-size: 0.85rem; line-height: 1.6; }

        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; color: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1001; border-top: 4px solid #007bff; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        .btn-outline.active { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        .btn-success { background: #27ae60; color: white; }
    </style>
</head>
<body>

<header class="site-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png" alt="SBC Logo" style="height:55px;">
    <div class="header-info">
        <h1>Suburban Brewing Co.</h1>
        3041 Horseshoe Pike, Honey Brook, PA 19344<br>
        Sales Rep: Remy Davis | (908) 642-1019
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div class="live-stats">
        <div id="live-total" style="color:#007bff; font-weight:900; font-size:1.4rem;">$0.00</div>
        <div style="font-size: 0.8rem; opacity: 0.8;">Plus Keg Deposits</div>
    </div>
    <button class="btn btn-primary" onclick="goToReview()">Review Order</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz2YK1MnItnIMJpNHNRCFXoo4hxRJPaF9NmO6ginxaJjfkm7FnbV-gO82_uL8X73AaR/exec"; 
    const BASE_IMG_URL = "https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/";

    let productsDB = [];
    let groupedProducts = {};
    let customersDB = [];
    let state = { step: 0, customer: null, cart: {}, category: 'All' };

    // --- HARDWARE SCANNER LOGIC ---
    // Listen for rapid typing (scanners) and auto-focus search
    document.addEventListener('keydown', (e) => {
        if (state.step === 2 && document.activeElement.tagName !== 'INPUT') {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.focus();
        }
        if (e.key === 'Enter' && state.step === 2) {
            setTimeout(filterProducts, 50); //
        }
    });

    async function init() {
        try {
            const response = await fetch(`${API_URL}?action=getStoreData`);
            const data = await response.json();
            if(data.status === 'success') {
                productsDB = data.products; //
                processProducts(data.products);
                customersDB = data.customers; //
                render();
            }
        } catch (error) { console.error("Init failed", error); }
    }

    function processProducts(rawList) {
        groupedProducts = {};
        rawList.forEach(p => {
            if (!groupedProducts[p.name]) {
                groupedProducts[p.name] = { 
                    name: p.name, 
                    lifecycle: p.lifecycle, //
                    upc: p.upc, //
                    image: p.image, 
                    variants: [] 
                };
            }
            groupedProducts[p.name].variants.push({ type: p.type, price: p.price, stock: p.stock });
        });
    }

    function filterProducts() {
        const query = document.getElementById("searchInput").value.toLowerCase(); //
        const cards = document.querySelectorAll(".product-card");
        
        cards.forEach(card => {
            const name = card.dataset.name.toLowerCase();
            const upc = card.dataset.upc.toLowerCase(); //
            const lifecycle = card.dataset.lifecycle;

            const matchesSearch = name.includes(query) || upc.includes(query) || upc === query; //
            const matchesCategory = (state.category === 'All' || lifecycle === state.category);

            card.style.display = (matchesSearch && matchesCategory) ? "flex" : "none";
        });
    }

    function setCategory(cat) {
        state.category = cat;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        filterProducts();
    }

    function render() {
        const app = document.getElementById("app");
        const liveBar = document.getElementById("live-bar");

        if (state.step === 0) {
            app.innerHTML = `
                <div class="card">
                    <h2 style="text-align:center;">Wholesale Distribution Agreement</h2>
                    <div class="legal-scroll">
                        <p>Purchaser agrees to all PA PLCB regulations including COD requirements. Products must be maintained under 38Â°F at all times...</p>
                    </div>
                    <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="state.step=1;render()">I Accept & Agree</button>
                </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `
                <div class="card" style="max-width:400px; margin:auto; text-align:center;">
                    <h3>Wholesale Login</h3>
                    <input type="text" id="loginInput" placeholder="ENTER UNIQUE KEY" style="width:100%; padding:15px; margin-bottom:15px; border:2px solid #1a1a1a; border-radius:8px; text-align:center; font-size:1.2rem;">
                    <button class="btn btn-primary" style="width:100%;" onclick="attemptLogin()">Log In</button>
                </div>`;
        } else if (state.step === 2) {
            liveBar.style.display = "flex";
            let html = `
                <div class="controls-area">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by name or scan UPC..." oninput="filterProducts()">
                    <div class="cat-bar">
                        <button class="btn btn-outline cat-btn active" onclick="setCategory('All')">All</button>
                        <button class="btn btn-outline cat-btn" onclick="setCategory('Core')">Core</button>
                        <button class="btn btn-outline cat-btn" onclick="setCategory('Seasonal')">Seasonal</button>
                        <button class="btn btn-outline cat-btn" onclick="setCategory('Rotating')">Rotating</button>
                    </div>
                </div>
                <div class="product-grid">`;

            for (const key in groupedProducts) {
                const p = groupedProducts[key];
                html += `
                    <div class="product-card" data-name="${p.name}" data-lifecycle="${p.lifecycle}" data-upc="${p.upc}">
                        <div class="product-img-container">
                            <span class="lifecycle-badge">${p.lifecycle}</span>
                            <img src="${BASE_IMG_URL}${p.image}" class="product-img" onerror="this.src='https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png'">
                        </div>
                        <div style="padding:15px;"><h4 style="margin:0;">${p.name}</h4></div>
                        <div class="variant-list">
                            ${p.variants.map(v => {
                                const cartKey = `${p.name}-${v.type}`;
                                const val = state.cart[cartKey] ? state.cart[cartKey].qty : 0;
                                return `
                                <div class="variant-row">
                                    <div class="variant-info">
                                        <strong>${v.type}</strong><br>$${v.price} 
                                        <span class="stock-tag ${v.stock < 5 ? 'stock-low' : ''}">Stock: ${v.stock}</span>
                                    </div>
                                    <input type="number" class="variant-qty" min="0" max="${v.stock}" value="${val}" 
                                           oninput="updateCart('${p.name}', '${v.type}', ${v.price}, ${v.stock}, this.value)">
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }
            app.innerHTML = html + `</div>`;
        } else if (state.step === 3) {
            liveBar.style.display = "none";
            const math = calculateOrderMath();
            app.innerHTML = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between;"><strong>Suburban Brewing Co.</strong><span>${new Date().toLocaleDateString()}</span></div>
                    <hr>
                    <div style="margin:20px 0;"><strong>BILL TO:</strong><br>${state.customer.name}<br>${state.customer.address}</div>
                    <table class="review-table">
                        <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                        <tbody>${Object.values(state.cart).map(i => `<tr><td>${i.beer} (${i.type})</td><td>${i.qty}</td><td>$${(i.qty * i.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px;">
                        <div>Subtotal: $${math.subtotal}</div>
                        <div>Keg Deposits ($30/ea): $${math.deposits}</div>
                        <div style="font-size:1.4rem; color:#007bff;"><strong>TOTAL: $${math.grandTotal}</strong></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:40px;">
                        <button class="btn btn-outline" onclick="state.step=2;render()">Edit Order</button>
                        <button class="btn btn-success" style="flex:1;" onclick="submitFinalOrder()">Confirm Order</button>
                    </div>
                </div>`;
        }
    }

    function updateCart(beer, type, price, stock, val) {
        const qty = parseInt(val) || 0;
        const key = `${beer}-${type}`;
        if (qty > stock) { Swal.fire("Short Stock", "Requested amount exceeds inventory.", "warning"); return; }
        if (qty > 0) { state.cart[key] = { beer, type, price, qty }; } 
        else { delete state.cart[key]; }
        updateLiveTotals();
    }

    async function attemptLogin() {
        const input = document.getElementById("loginInput").value.trim().toLowerCase();
        const found = customersDB.find(c => c.key === input); //
        if (found) { state.customer = found; state.step = 2; render(); }
        else { Swal.fire("Login Failed", "Invalid Access Key.", "error"); }
    }

    function calculateOrderMath() {
        let sub = 0, kegs = 0;
        for (const k in state.cart) { 
            const item = state.cart[k];
            sub += (item.price * item.qty);
            if (item.type.toLowerCase().includes("keg")) kegs += item.qty;
        }
        let dep = kegs * 30;
        return { subtotal: sub.toFixed(2), deposits: dep.toFixed(2), grandTotal: (sub + dep).toFixed(2) };
    }

    function updateLiveTotals() {
        const math = calculateOrderMath();
        document.getElementById("live-total").innerText = "$" + math.grandTotal;
    }

    function goToReview() { if(Object.keys(state.cart).length === 0) return; state.step = 3; render(); }

    async function submitFinalOrder() {
        const btn = document.querySelector('.btn-success');
        btn.disabled = true; btn.innerText = "PLACING ORDER...";
        try {
            await fetch(API_URL, { 
                method: "POST", 
                mode: "no-cors", 
                body: JSON.stringify({ action: 'submitOrder', customer: state.customer, cart: state.cart }) 
            });
            Swal.fire("Order Placed!", "Your order has been sent successfully.", "success").then(() => location.reload());
        } catch (e) { Swal.fire("Error", "Check your connection.", "error"); btn.disabled = false; }
    }

    init();
</script>
</body>
</html>
