<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8f9fa; margin: 0; padding-bottom: 130px; color: #2d3436; }
        .site-header { background-color: #ffffff; padding: 10px 5%; border-bottom: 2px solid #1a1a1a; display: flex; align-items: center; gap: 20px; }
        .header-info { font-size: 0.85rem; line-height: 1.3; }
        .header-info h1 { margin: 0 0 2px 0; font-size: 1.2rem; color: #1a1a1a; }
        .container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; padding: 2rem; border-radius: 12px; border: 1px solid #dee2e6; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        
        /* Agreement Styling */
        .legal-scroll { height: 450px; overflow-y: auto; border: 2px solid #1a1a1a; padding: 1.5rem; margin: 1rem 0; font-size: 0.85rem; line-height: 1.7; background: #fff; text-align: left; }
        .checkbox-area { background: #f1f2f6; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 12px; border: 1px solid #dfe6e9; }

        /* Multi-Variant Product Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .product-card { background: #fff; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .product-img-container { width: 100%; height: 200px; background: #fcfcfc; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: center; }
        .product-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .variant-list { background: #fff; }
        .variant-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f1f1f1; font-size: 0.9rem; }
        .variant-row:last-child { border-bottom: none; }
        .variant-info { flex: 1; }
        .variant-qty { width: 60px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; font-weight: bold; }
        
        .stock-tag { font-size: 0.75rem; color: #27ae60; font-weight: bold; display: block; margin-top: 2px; }
        .stock-low { color: #d63031; }

        /* Order Bar */
        .live-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; color: white; padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center; z-index: 1001; border-top: 4px solid #007bff; }
        .live-stats { font-size: 0.9rem; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Review Table */
        .review-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        .review-table th { background: #f8f9fa; padding: 10px; text-align: left; border-bottom: 2px solid #1a1a1a; }
        .review-table td { padding: 10px; border-bottom: 1px solid #eee; }

        @media print { .site-header, .live-bar, .btn-area-nav { display: none !important; } body { padding: 0; background: white; } .card { box-shadow: none; border: none; } }
    </style>
</head>
<body>

<header class="site-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png" alt="SBC Logo" style="height:55px;">
    <div class="header-info">
        <h1>Suburban Brewing Co.</h1>
        3041 Horseshoe Pike, Honey Brook, PA 19344<br>
        Sales Rep: Remy Davis | (908) 642-1019
    </div>
</header>

<div class="container" id="app"></div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div class="live-stats">
        <div>SUBTOTAL: <span id="live-sub">$0.00</span> | ITEMS: <span id="live-count">0</span></div>
    </div>
    <div style="text-align:right;">
        <div id="live-total" style="color:#007bff; font-weight:900; font-size:1.4rem;">$0.00</div>
    </div>
    <button class="btn btn-primary" onclick="goToReview()">Review Order</button>
</div>

<script>
    // ðŸ”´ REPLACE WITH YOUR DEPLOYED APPS SCRIPT WEB APP URL
    const API_URL = "https://script.google.com/macros/s/AKfycbz2YK1MnItnIMJpNHNRCFXoo4hxRJPaF9NmO6ginxaJjfkm7FnbV-gO82_uL8X73AaR/exec"; 
    const BASE_IMG_URL = "https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/";

    let groupedProducts = {};
    let customersDB = [];
    let state = { step: 0, customer: null, cart: {} };

    async function init() {
        try {
            const response = await fetch(`${API_URL}?action=getStoreData`);
            const data = await response.json();
            if(data.status === 'success') {
                processProducts(data.products);
                customersDB = data.customers;
                render();
            } else { Swal.fire("Error", "Portal is currently offline.", "error"); }
        } catch (error) { console.error(error); render(); }
    }

    function processProducts(rawList) {
        groupedProducts = {};
        rawList.forEach(p => {
            if (!groupedProducts[p.name]) {
                groupedProducts[p.name] = { 
                    name: p.name, 
                    image: p.image || p.name.split(' ')[0].toLowerCase() + ".jpg", 
                    variants: [] 
                };
            }
            groupedProducts[p.name].variants.push({ type: p.category, price: p.price, stock: p.stock });
        });
    }

    function render() {
        const app = document.getElementById("app");
        const liveBar = document.getElementById("live-bar");

        if (state.step === 0) {
            liveBar.style.display = "none";
            app.innerHTML = `
                <div class="card">
                    <h2 style="text-align:center;">PA WHOLESALE DISTRIBUTION AGREEMENT</h2>
                    <div class="legal-scroll">
                        <p>This agreement is compliant with the laws of the Commonwealth of Pennsylvania and the regulations of the Pennsylvania Liquor Control Board (PLCB). By proceeding, the Purchaser agrees to the following terms and conditions:</p>
                        <h3>1. PLCB COMPLIANCE & LICENSURE</h3>
                        <p>Purchaser warrants that it holds a valid, active retail or wholesale license issued by the PLCB. Purchaser agrees to notify Suburban Brewing Co. (SBC) immediately if said license is suspended, revoked, or expired.</p>
                        <h3>2. PRICE POSTING & ACT 39</h3>
                        <p>In accordance with Act 39 of 2016, SBC maintains a public price list. All products are sold at the posted wholesale price at the time of delivery.</p>
                        <h3>3. CASH ON DELIVERY (COD) & SECTION 493</h3>
                        <p>Per Section 493(2) of the Liquor Code, sales of malt or brewed beverages to retail licensees must be for cash or check paid at or before the time of delivery.</p>
                        <h3>4. COLD CHAIN STORAGE & QUALITY CONTROL</h3>
                        <p>Products produced by SBC are unpasteurized "live" beverages. Purchaser agrees to maintain strict cold chain storage (34Â°F-38Â°F).</p>
                        <h3>5. COOPERAGE & EQUIPMENT LIABILITY</h3>
                        <p>All stainless steel keg shells remain the property of Suburban Brewing Co. A mandatory $30.00 deposit is applied to each keg shell.</p>
                        <h3>6. RETURNED CHECKS & LATE FEES</h3>
                        <p>Any check returned for non-sufficient funds (NSF) will incur a $50.00 administrative fee.</p>
                        <h3>7. RESALE LIMITATIONS</h3>
                        <p>Purchaser agrees that all products are for retail sale at the licensed premises only.</p>
                    </div>
                    <div class="checkbox-area">
                        <input type="checkbox" id="agreeCheck" onchange="document.getElementById('acceptBtn').disabled = !this.checked">
                        <label for="agreeCheck">I certify that I am a licensed PA retail/wholesale agent and agree to all terms above.</label>
                    </div>
                    <button id="acceptBtn" class="btn btn-primary" style="width:100%;" disabled onclick="state.step=1;render()">I Accept & Agree</button>
                </div>`;
        } else if (state.step === 1) {
            app.innerHTML = `
                <div class="card" style="max-width:400px; margin:auto; text-align:center;">
                    <h3>Wholesale Login</h3>
                    <input type="text" id="loginInput" placeholder="ENTER UNIQUE KEY" style="width:100%; padding:15px; margin-bottom:15px; border:2px solid #1a1a1a; border-radius:8px; text-align:center; font-size:1.2rem;">
                    <button class="btn btn-primary" style="width:100%;" onclick="attemptLogin()">Log In</button>
                </div>`;
        } else if (state.step === 2) {
            liveBar.style.display = "flex";
            let html = `<h3>Available Inventory</h3><div class="product-grid">`;
            for (const key in groupedProducts) {
                const p = groupedProducts[key];
                const id = p.name.replace(/\s/g, '');
                html += `
                    <div class="product-card">
                        <div class="product-img-container"><img src="${BASE_IMG_URL}${p.image}" class="product-img" onerror="this.src='https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png'"></div>
                        <div style="padding:15px;"><h4 style="margin:0 0 10px 0;">${p.name}</h4></div>
                        <div class="variant-list">
                            ${p.variants.map((v, i) => {
                                const cartKey = `${p.name}-${v.type}`;
                                const currentQty = state.cart[cartKey] ? state.cart[cartKey].qty : 0;
                                return `
                                <div class="variant-row">
                                    <div class="variant-info">
                                        <strong>${v.type}</strong><br>
                                        $${v.price} <span class="stock-tag ${v.stock < 5 ? 'stock-low' : ''}">Stock: ${v.stock}</span>
                                    </div>
                                    <input type="number" class="variant-qty" min="0" max="${v.stock}" value="${currentQty}" 
                                           oninput="updateCart('${p.name}', '${v.type}', ${v.price}, ${v.stock}, this.value)">
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            }
            app.innerHTML = html + `</div>`;
            updateLiveTotals();
        } else if (state.step === 3) {
            liveBar.style.display = "none";
            const math = calculateOrderMath();
            app.innerHTML = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <div><strong>Suburban Brewing Co.</strong></div>
                        <div>DATE: ${new Date().toLocaleDateString()}</div>
                    </div>
                    <hr>
                    <div style="margin:20px 0;">
                        <strong>BILL TO:</strong><br>${state.customer.name}<br>${state.customer.address}<br>
                        <strong>PAYMENT:</strong> ${state.customer.payment}
                    </div>
                    <table class="review-table">
                        <thead><tr><th>Beer</th><th>Type</th><th>Qty</th><th>Total</th></tr></thead>
                        <tbody>${Object.values(state.cart).map(i => `<tr><td>${i.beer}</td><td>${i.type}</td><td>${i.qty}</td><td>$${(i.qty * i.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px;">
                        <div>Subtotal: $${math.subtotal}</div>
                        <div>Keg Deposits ($30/ea): $${math.deposits}</div>
                        <div style="font-size:1.4rem; color:#007bff;"><strong>TOTAL: $${math.grandTotal}</strong></div>
                    </div>
                    <div class="btn-area-nav" style="display:flex; gap:10px; margin-top:40px;">
                        <button class="btn btn-outline" onclick="state.step=2;render()">Edit</button>
                        <button class="btn btn-success" style="flex:1;" onclick="submitFinalOrder()">Confirm Order</button>
                    </div>
                </div>`;
        }
    }

    async function attemptLogin() {
        const input = document.getElementById("loginInput").value.trim().toLowerCase();
        // Login logic searches against local keys pulled from Backend
        const found = customersDB.find(c => c.key === input);
        if (found) { state.customer = found; state.step = 2; render(); }
        else { Swal.fire("Login Failed", "Invalid Access Key.", "error"); }
    }

    function updateCart(beer, type, price, stock, val) {
        const qty = parseInt(val) || 0;
        const key = `${beer}-${type}`; // Unique Key allowing multiples of same product
        if (qty > stock) { 
            Swal.fire("Short Stock", "Requested amount exceeds current inventory.", "warning"); 
            return; 
        }
        if (qty > 0) { state.cart[key] = { beer, type, price, qty }; } 
        else { delete state.cart[key]; }
        updateLiveTotals();
    }

    function calculateOrderMath() {
        let sub = 0, kegs = 0;
        for (const k in state.cart) { 
            const item = state.cart[k];
            sub += (item.price * item.qty);
            if (item.type.toLowerCase().includes("keg")) kegs += item.qty;
        }
        let deposits = kegs * 30;
        return { 
            subtotal: sub.toFixed(2), 
            deposits: deposits.toFixed(2), 
            grandTotal: (sub + deposits).toFixed(2) 
        };
    }

    function updateLiveTotals() {
        const math = calculateOrderMath();
        const count = Object.values(state.cart).reduce((acc, curr) => acc + curr.qty, 0);
        document.getElementById("live-sub").innerText = "$" + math.subtotal;
        document.getElementById("live-total").innerText = "$" + math.grandTotal;
        document.getElementById("live-count").innerText = count;
    }

    function goToReview() { 
        if(Object.keys(state.cart).length === 0) return Swal.fire("Empty Cart", "Please add items before reviewing.", "info"); 
        state.step = 3; 
        render(); 
    }

    async function submitFinalOrder() {
        const btn = document.querySelector('.btn-success');
        btn.disabled = true; btn.innerText = "PLACING ORDER...";
        const payload = { action: 'submitOrder', customer: state.customer, cart: state.cart, summary: calculateOrderMath() };
        
        try {
            await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
            Swal.fire({
                title: "Order Placed!",
                text: "Your wholesale order has been submitted successfully.",
                icon: "success"
            }).then(() => location.reload());
        } catch (e) { 
            Swal.fire("Error", "Could not reach server. Please try again.", "error"); 
            btn.disabled = false; btn.innerText = "Confirm Order"; 
        }
    }

    init();
</script>
</body>
</html>
