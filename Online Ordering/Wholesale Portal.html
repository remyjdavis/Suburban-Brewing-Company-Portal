<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SBC Portal">

    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Suburban%20Brewing%20Wholesale%22%2C%22short_name%22%3A%22SBC%20Wholesale%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f3f4f6%22%2C%22theme_color%22%3A%22%23ffffff%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fraw.githubusercontent.com%2Fremyjdavis%2FSuburban-Brewing-Company-Portal%2Fmain%2FOnline%2520Ordering%2Flogo.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
    /* --- APP-FIRST THEME --- */
    :root {
        /* üî¥ THE GREY BACKGROUND: Set this to your preferred light grey */
        --bg: #f3f4f6; 
        --sidebar: #0f172a;
        --accent: #2563eb;
        --primary: #1e293b;
        --success: #10b981;
        --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    * { 
        box-sizing: border-box; 
        font-family: 'Inter', -apple-system, system-ui, sans-serif;
        -webkit-font-smoothing: antialiased;
    }

    body { 
        margin: 0; 
        /* üî¥ PAGE BACKGROUND: Set to the grey variable */
        background-color: var(--bg) !important; 
        color: var(--primary); 
        padding-bottom: 100px; 
        overscroll-behavior-y: contain; 
    }

    /* üî¥ ADD THIS: This kills the grey bar behind your search/filters */
    .controls-area {
        background-color: #ffffff !important;
    }
   /* --- UPDATED HEADER CSS --- */
.site-header { 
    background: #ffffff; 
    padding: 12px 20px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    gap: 12px;
    position: sticky;
    top: 0;
    /* üî¥ Z-INDEX INCREASED to 9002 so it sits ON TOP of the login screen */
    z-index: 9002; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    height: 80px; /* Fixed height to keep layout stable */
}

.header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* üî¥ RESTORED REP INFO STYLING */
.header-info h1 { margin: 0; font-size: 1.1rem; font-weight: 800; color: #1e293b; }
.header-info span { display: block; line-height: 1.3; }
.sub-info { font-size: 0.75rem; color: #64748b; }
.rep-info-line { font-size: 0.75rem; color: var(--accent); font-weight: 600; margin-top: 2px; }

.header-right {
    text-align: right;
}

/* User Badge Styles (Right Side) */
.user-badge {
    background-color: #f3f4f6;
    padding: 8px 16px;
    border-radius: 20px;
    border: 1px solid #e5e7eb;
    display: inline-block;
    font-size: 0.9rem;
    color: #1e293b;
    font-weight: 700;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* LOGIN SCREEN ADJUSTMENT */
/* We push the login container down slightly so it doesn't get cut off by the header */
.login-hero-container {
    padding-top: 80px; 
}

.user-name {
    color: var(--accent);
    font-weight: 800;
    display: block;
}

.rep-info {
    font-size: 0.7rem;
    color: #64748b;
    margin-top: 4px;
}

    .site-header img { height: 40px; border-radius: 8px; }
    .header-info h1 { margin: 0; font-size: 1rem; font-weight: 700; }
    .header-info { font-size: 0.7rem; color: #64748b; }

    .container { 
        max-width: 1000px; 
        margin: 10px auto; 
        padding: 0 12px; 
    }

    .card { 
        background: white; 
        padding: 1.2rem; 
        border-radius: 12px; 
        border: 1px solid #dee2e6; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    }

    /* LEGAL SCROLL */
    .legal-scroll { 
        height: 350px; 
        overflow-y: auto; 
        border: 2px solid #1a1a1a; 
        padding: 1rem; 
        margin: 1rem 0; 
        font-size: 0.85rem; 
        line-height: 1.6; 
        background: #fff; 
        -webkit-overflow-scrolling: touch;
    }

    .checkbox-area { 
        background: #f1f2f6; 
        padding: 12px; 
        border-radius: 8px; 
        margin-bottom: 1rem; 
        display: flex; 
        align-items: flex-start; 
        gap: 10px; 
        font-size: 0.85rem;
    }

    /* --- COMPACT CATEGORY PILLS --- */
    .controls-area { 
        background: var(--bg);
        padding: 12px 16px;
        position: sticky;
        top: 64px;
        z-index: 999;
    }

    .search-wrapper {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .search-input { 
        flex: 1;
        background: #fff;
        border: 1px solid #e5e7eb;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 16px; 
        box-shadow: var(--card-shadow);
    }

    .scan-btn {
        width: 50px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--card-shadow);
    }

    .cat-bar { 
        display: flex; 
        gap: 8px; 
        overflow-x: auto; 
        padding: 4px 0;
        scrollbar-width: none; 
    }

    .cat-btn {
        background: white;
        border: 1px solid #e5e7eb;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
        transition: 0.2s;
    }

    .cat-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    /* --- APP-STYLE PRODUCT GRID --- */
    .product-grid { 
        display: grid; 
        grid-template-columns: repeat(2, 1fr); 
        gap: 12px; 
        padding: 0 16px;
    }

    @media (min-width: 768px) {
        .product-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
    }

    /* --- HOVER INFO OVERLAY --- */
    .product-card {
        position: relative;
        overflow: hidden; /* Keeps the overlay inside the card corners */
    }

    .hover-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.95);
        color: white;
        padding: 12px; 
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        justify-content: space-between; 
        z-index: 5;
        height: 85%; 
        pointer-events: none;
    }

    /* Show on hover */
    .product-card:hover .hover-info {
        transform: translateY(0);
    }

    .hover-abv {
        color: var(--accent);
        font-weight: 800;
        font-size: 0.9rem;
        text-transform: uppercase;
    }

    .hover-desc {
        font-size: 0.82rem;      /* Keeps text legible */
        line-height: 1.25;        /* Maintains tight spacing */
        color: #cbd5e1;
        
        /* üî¥ THE FORCE FIX: */
        display: block !important;          /* Disables the "Line Clamp" engine */
        -webkit-line-clamp: none !important; /* Removes the line limit entirely */
        overflow: visible !important;       /* Ensures text isn't hidden if it runs long */
        
        flex-grow: 1;            /* Uses all available space in the 90% height box */
        margin: 5px 0;
    }

    /* --- PERFECT BLEND & SAFARI FIX --- */
.product-card { 
    background: #ffffff !important; 
    background-color: #ffffff !important;
    border-radius: 16px; 
    padding: 12px;
    display: flex; 
    flex-direction: column;
    height: 100%; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid #e5e7eb;
    /* Forces Safari to render as a distinct layer */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
}

/* --- FINAL ZERO-CONTRAST BLEND --- */
.product-img-container { 
    width: 100%; 
    height: 200px; /* Taller for the 16oz can */
    background-color: #ffffff !important; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    overflow: hidden;
    /* üî¥ This tells Safari to force-blend the layers */
    isolation: isolate; 
}

.product-img {
    height: 100% !important; 
    width: auto !important;
    max-height: 180px;
    object-fit: contain; 
    
    /* üî¥ THE FIX: Multiply makes the image background transparent ONLY if we force it to pure white first */
    mix-blend-mode: multiply !important;
    
    /* üî¥ THE CALIBRATION: This forces the light grey background of the JPG to become pure #ffffff */
    filter: contrast(1.15) brightness(1.12) saturate(1.1) !important;
    
    /* üî¥ Ensures Safari doesn't "smooth" the grey box back into existence */
    image-rendering: -webkit-optimize-contrast !important;
    background-color: transparent !important;
}
    .cart-badge {
        position: absolute;
        top: 4px;
        left: 4px;
        background: var(--accent);
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 6px;
        font-weight: bold;
    }

    .product-name-area h4 {
        margin: 4px 0;
        font-size: 0.9rem;
        color: #111827;
    }

    .lifecycle-badge { 
        position: absolute; 
        top: 8px; 
        right: 8px; 
        padding: 2px 6px; 
        background: rgba(255,255,255,0.9);
        border: 1px solid #ddd;
        border-radius: 4px; 
        font-size: 0.6rem; 
        font-weight: bold; 
    }

    .order-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(3px);
    }

    .order-modal-content {
        background-color: #1e293b; 
        color: #ffffff;            
        width: 90%;
        max-width: 400px;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
    }

    #modalTitle { color: #ffffff; }

    @media (min-width: 500px) {
        .order-modal-content {
            border-radius: 24px;
            position: relative;
            bottom: auto;
        }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #334155;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .modal-header h3 { margin: 0; font-size: 1.1rem; color: #ffffff; }
    
    .close-modal {
        background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #ffffff;
    }

    .variant-row { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px 0; 
        border-bottom: 1px solid #334155; 
        color: #ffffff;
    }

    .variant-info { font-size: 0.9rem; }
    
    .qty-stepper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
    }

    .qty-btn {
        background: none;
        border: none;
        color: #ffffff;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        user-select: none;
    }

    .qty-btn:active {
        color: var(--accent);
    }

    .variant-qty { 
        width: 60px; 
        height: 40px; 
        text-align: center; 
        border: 2px solid #334155; 
        border-radius: 6px; 
        font-size: 1.1rem; 
        font-weight: bold; 
        background: #0f172a; 
        color: #ffffff;
        -moz-appearance: textfield;
        appearance: none;
    }

    .variant-qty::-webkit-inner-spin-button, 
    .variant-qty::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
    }

    .btn-add-order {
        width: 100%;
        margin-top: 20px;
        padding: 15px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
    }

    .live-bar { 
        position: fixed; 
        bottom: 20px; 
        left: 20px; 
        right: 20px; 
        background: #111827; 
        color: white; 
        padding: 12px 20px; 
        border-radius: 20px;
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        z-index: 1001; 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
    }

    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 800; font-size: 0.9rem; cursor: pointer; }
    
    .btn-primary { 
        background: var(--accent); 
        color: white; 
        padding: 10px 20px; 
        border-radius: 12px; 
        font-weight: 700; 
    }
    
    .btn-outline { background: white; border: 1px solid #ccc; font-size: 0.8rem;}
    .btn-outline.active { background: #1a1a1a; color: white; border-color: #1a1a1a; }
    .btn-success { background: #27ae60; color: white; width: 100%; }

    .review-table { width: 100%; font-size: 0.85rem; margin-top: 10px;}
    .review-table th { text-align: left; padding: 8px; border-bottom: 2px solid #eee; }
    .review-table td { padding: 8px; border-bottom: 1px solid #f9f9f9; }

    @media print { .site-header, .live-bar, #menu-toggle { display: none !important; } }

    #scanner-container {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
    }

    #reader { width: 90%; max-width: 500px; background: #fff; border-radius: 12px; overflow: hidden; }
    .scanner-close { margin-top: 20px; padding: 15px 30px; background: #d63031; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    
    .search-wrapper { position: relative; display: flex; gap: 10px; align-items: center; width: 100%; }
    .scan-btn { height: 50px; padding: 0 15px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.2rem; }

    /* --- HOVER INFO OVERLAY (REPEATED/CLEANED) --- */
    .product-card {
        position: relative;
        overflow: hidden;
    }

    .hover-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.95);
        color: white;
        padding: 12px;
        transform: translateY(100%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        z-index: 5;
        /* üî¥ INCREASED HEIGHT TO 90% */
        height: 90%; 
        pointer-events: none;
    }

    @media (hover: hover) {
        .product-card:hover .hover-info { transform: translateY(0); }
    }

    .hover-abv { color: var(--accent); font-weight: 800; font-size: 0.9rem; text-transform: uppercase; }
    .hover-desc { line-height: 1.4; color: #cbd5e1; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }

    /* --- QTY STEPPER (WHITE ARROWS) --- */
    .qty-stepper { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .qty-btn { background: none; border: none; color: #ffffff !important; font-size: 1.2rem; cursor: pointer; padding: 0; line-height: 1; user-select: none; }
    .variant-qty { width: 60px; height: 40px; text-align: center; border: 2px solid #334155; border-radius: 6px; font-size: 1.1rem; font-weight: bold; background: #0f172a; color: #ffffff; appearance: textfield; -moz-appearance: textfield; }
    .variant-qty::-webkit-inner-spin-button, .variant-qty::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

    /* --- MOBILE CARD COLOR OVERRIDE --- */
    @media (max-width: 768px) {
        .product-card, 
        .product-img-container {
            /* üî¥ Forces pure white regardless of mobile system theme */
            background-color: #ffffff !important; 
            background: #ffffff !important;
        }
    }
/* Prevents zooming on iPhone when clicking inputs */
input[type="number"] {
    font-size: 16px !important; 
}
    /* --- SAFARI HARDWARE OVERRIDE --- */
:root {
    /* üî¥ Tells Safari to ignore system dark/light modes */
    color-scheme: light;
}

body, 
.product-grid, 
.container, 
#app {
    /* üî¥ Forces Page Grey */
    background-color: #f3f4f6 !important;
    background: #f3f4f6 !important;
    -webkit-appearance: none;
}

.product-card, 
.product-img-container {
    /* üî¥ Forces Card White */
    background-color: #ffffff !important;
    background: #ffffff !important;
    
    /* üî¥ Prevents Safari from adding hardware-level shadows/tints */
    -webkit-backdrop-filter: none !important;
    backdrop-filter: none !important;
    -webkit-print-color-adjust: exact !important;
}

.product-img {
    height: 100% !important;
    width: auto !important;
    max-height: 160px; 
    object-fit: contain;
    
    /* üî¥ Blending Fix */
    mix-blend-mode: multiply !important;
    filter: brightness(1.1) contrast(1.1) !important;
    background: transparent !important;
    
    /* üî¥ Forces Safari to render the blend mode correctly */
    isolation: isolate;
}
        /* =========================================
       NEW LOGIN SCREEN STYLES (BREWHOUSE BG)
       ========================================= */
    .login-hero-container {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100%; height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9000; /* Sit on top of everything */
        overflow: hidden;
    }

    .login-hero-bg {
        position: absolute;
        top: -20px; left: -20px; right: -20px; bottom: -20px;
        background: url('Brewery.jpg') no-repeat center center;
        background-size: cover;
        filter: brightness(0.4) blur(6px); /* The Dark & Blur Effect */
        z-index: -1;
    }

    .login-card-hero {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 40px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        text-align: center;
    }

    .login-logo-area h1 {
        margin: 0;
        color: var(--accent);
        letter-spacing: 2px;
        font-size: 28px;
    }

    .login-logo-area p {
        margin: 0;
        font-size: 10px;
        letter-spacing: 4px;
        color: #333;
        margin-bottom: 20px;
    }

    .login-input-styled {
        width: 100%;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 16px;
        text-align: center;
    }
       /* --- INSTALL BANNER --- */
.install-banner {
    display: none; 
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background-color: #1e293b; 
    color: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
    z-index: 9999;
    align-items: center;
    justify-content: space-between;
    animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.install-text { font-size: 0.9rem; font-weight: 500; }
.install-sub { font-size: 0.8rem; opacity: 0.8; display: block; margin-top: 4px; }
.install-actions { display: flex; gap: 10px; align-items: center;}

.btn-install {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}

.btn-close-banner {
    background: transparent;
    border: 1px solid #475569;
    color: #cbd5e1;
    padding: 5px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
}
        /* TAB STYLES */
.tab-nav { display:flex; background:white; position:sticky; top:80px; z-index:9001; border-bottom:1px solid #e5e7eb; }
.tab-btn { flex:1; text-align:center; padding:12px; font-weight:600; color:#64748b; cursor:pointer; border-bottom:3px solid transparent; }
.tab-btn.active { color:#2563eb; border-bottom-color:#2563eb; background:#f8fafc; }

/* VIEW LOGIC */
.view-section { display:none; padding-top:15px; animation:fadeIn 0.3s ease; }
.view-section.active-view { display:block; }
@keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

/* POS GRID */
.pos-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:15px; }
.pos-card { background:white; border-radius:12px; padding:15px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.05); border:1px solid #e2e8f0; }
.pos-card img { width:100%; height:120px; object-fit:contain; margin-bottom:10px; }
.btn-download { background:#1e293b; color:white; border:none; padding:8px; border-radius:6px; width:100%; cursor:pointer; }
/* --- PRINT GENERATOR STYLES --- */
#print-area { display: none; } /* Hidden normally */

/* THE PRINT MODE MAGIC */
@media print {
    /* 1. HIDE BROWSER URL/DATE HEADERS */
    @page { 
        margin: 0; 
        size: auto; 
    }
    /* 2. HIDE APP UI */
    body > * { display: none !important; }
    /* 3. SETUP PRINT AREA */
    body { 
        background: white !important; 
        margin: 0 !important; 
        padding: 0.5in !important; 
        display: block !important;
    }
    
    /* Show Print Area */
    #print-area { 
        display: block !important; 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
    }

    /* --- SHELF TALKER GRID (Fixed 3x5 Size) --- */
    .print-grid-talkers {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5in;         /* Space between cards */
        padding: 0.5in;     /* Page margins */
        justify-content: center;
    }

    .talker-card {
        width: 5in;         /* Standard Shelf Talker Width */
        height: 3in;        /* Standard Shelf Talker Height */
        border: 2px dashed #999; /* Dashed cut line */
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        text-align: center;
        page-break-inside: avoid; /* Don't split across pages */
        margin-bottom: 20px;
    }
    
    .talker-logo { height: 35px; object-fit: contain; margin: 0 auto 5px; }
    .talker-header { font-size: 18px; font-weight: 900; text-transform: uppercase; line-height: 1; margin-bottom: 4px; }
    .talker-sub { font-size: 12px; font-weight: bold; color: #444; margin-bottom: 8px; }
    .talker-desc { font-size: 10px; line-height: 1.3; font-style: italic; flex-grow: 1; overflow: hidden; }
    
    .talker-price-area { 
        margin-top: 5px; 
        font-weight: 900; 
        font-size: 24px; 
        color: #000;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 4px 10px;
        align-self: center;
        display: inline-block;
    }

    /* Keep Menu Styles Same */
    .print-menu-list { padding: 40px; }
    .menu-item { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    .menu-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; }
}

/* UI FOR THE GENERATOR TAB */
.generator-controls { background: white; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
.product-selector { max-height: 300px; overflow-y: auto; margin: 15px 0; border: 1px solid #eee; padding: 10px; }
.checkbox-row { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f8fafc; }
.checkbox-row:last-child { border-bottom: none; }
.checkbox-row label { margin-left: 10px; flex: 1; font-weight: 500; font-size: 0.9rem; }
   /* --- SHELF TAG (3 x 1.75 inch) --- */
    .qr-talker-card {
        width: 3in;
        height: 1.75in;
        border: 1px dashed #ccc; /* Cut lines */
        padding: 10px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        float: left;
        margin: 5px; /* Spacing between tags */
        background: white;
        overflow: hidden;
        page-break-inside: avoid;
    }
    
    /* Top Section: Header */
    .tag-header {
        display: flex;
        align-items: center;
        border-bottom: 2px solid #000;
        padding-bottom: 5px;
        margin-bottom: 5px;
        height: 40%;
    }
    
    .tag-logo {
        height: 100%;
        width: auto;
        margin-right: 10px;
        object-fit: contain;
    }
    
    .tag-info {
        flex: 1;
        text-align: left;
        line-height: 1.1;
    }
    
    .tag-name { font-size: 11pt; font-weight: 900; text-transform: uppercase; color: #000; }
    .tag-abv { font-size: 9pt; font-weight: bold; color: #555; margin-top: 2px; }

    /* Bottom Section: Split 50/50 */
    .tag-body {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 60%;
        padding-top: 2px;
    }

    /* Left: QR Code */
    .tag-qr-col {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 40%;
        border-right: 1px solid #eee; /* Divider line */
        padding-right: 5px;
    }
    .tag-qr-img { height: 0.65in; width: 0.65in; }
    .tag-qr-text { font-size: 6px; text-transform: uppercase; font-weight: bold; margin-top: 2px; letter-spacing: 0.5px; }

    /* Right: Price */
    .tag-price-col {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    .tag-price {
        font-size: 26pt; /* BIG PRICE */
        font-weight: 900;
        letter-spacing: -1px;
        color: #000;
    }
}
    </style>
</head>
<body>

<header class="site-header" id="mainHeader">
    <div class="header-left">
        <img src="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png" alt="SBC Logo" style="height:50px;">
        <div class="header-info">
            <h1>Suburban Brewing Co.</h1>
            <span class="sub-info">3041 Horseshoe Pike, Honey Brook, PA 19344</span>
            <span class="rep-info-line">Sales Rep: Remy Davis | (908) 642-1019</span>
        </div>
    </div>

    <div class="header-right" id="headerUser"></div>
</header>
    
<div id="installBanner" class="install-banner">
    <div class="install-text">
        üì≤ <strong>Install App</strong><br>
        <span style="font-size:0.8rem; opacity:0.8;">Add to home screen for quick access!</span>
    </div>
    <div class="install-actions">
        <button class="btn-close-banner" onclick="hideInstallBanner()">‚úï</button>
        <button class="btn-install" onclick="installPWA()">Install</button>
    </div>
</div>
    
<div id="main-tabs" class="tab-nav" style="display:none;">
    <div class="tab-btn active" onclick="switchTab('order')">üç∫ Order</div>
    <div class="tab-btn" onclick="switchTab('history')">üìú History</div>
    <div class="tab-btn" onclick="switchTab('pos')">‚¨áÔ∏è POS</div>
</div>

<div class="container" id="app">
    <div id="view-order" class="view-section active-view"></div>

    <div id="view-history" class="view-section">
        <h2 style="margin-top:0;">Order History</h2>
        <div id="history-content-area"><p style="text-align:center;">Loading...</p></div>
    </div>

    <div id="view-pos" class="view-section">
        <h2 style="margin-top:0;">POS Downloads</h2>
        <div id="pos-content-area" class="pos-grid"></div>
    </div>
</div>

<div id="orderModal" class="order-modal">
    <div class="order-modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Product Name</h3>
            <button class="close-modal" onclick="closeOrderModal()">&times;</button>
        </div>
        <div id="modalVariants"></div>
        <button class="btn-add-order" onclick="saveModalOrder()">Update Order</button>
    </div>
</div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div class="live-stats">
        <div id="live-total" style="color:#007bff; font-weight:900; font-size:1.4rem;">$0.00</div>
        <div style="font-size: 0.8rem; opacity: 0.8;">Plus Keg Deposits</div>
    </div>
    <button class="btn btn-primary" onclick="goToReview()">Review Order</button>
</div>
    
<div id="installBanner" class="install-banner">
    </div>
<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz2YK1MnItnIMJpNHNRCFXoo4hxRJPaF9NmO6ginxaJjfkm7FnbV-gO82_uL8X73AaR/exec?secret=SBC_SECURE_2026"; 
    const BASE_IMG_URL = "https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/";
    const FALLBACK_LOGO = "https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png";

    let groupedProducts = {};
    let customersDB = [];
    let state = { step: 0, customer: null, cart: {}, category: 'All', tab: 'order', historyCache: [] };
    let currentModalProduct = null;
    let html5QrCode;

   // --- SCANNER LOGIC ---
async function startScanner() {
    document.getElementById('scanner-container').style.display = 'flex';
    html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 150 } };
    try {
        await html5QrCode.start(
            { facingMode: "environment" }, 
            config,
            (decodedText) => {
                // 1. Put text in search bar
                document.getElementById('searchInput').value = decodedText;

                // üî¥ FIX: Force Category to 'All' so the product isn't hidden
                state.category = 'All';
                
                // üî¥ FIX: Visually update the buttons
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                const allBtn = document.querySelector('.cat-bar .cat-btn'); 
                if(allBtn) allBtn.classList.add('active');

                // 2. Run the search
                filterProducts();
                
                stopScanner();
                Swal.fire({ icon: 'success', title: 'Scanned!', timer: 1000, showConfirmButton: false });
            },
            (errorMessage) => { }
        );
    } catch (err) {
        Swal.fire("Camera Error", "Please allow camera access.", "error");
        stopScanner();
    }
}

    async function stopScanner() {
        if (html5QrCode) {
            try { await html5QrCode.stop(); await html5QrCode.clear(); } catch (e) {}
        }
        document.getElementById('scanner-container').style.display = 'none';
    }

    // --- INITIALIZATION ---//
async function init() {
    // 1. Create a unique global callback name to prevent caching or collisions
    const callbackName = 'jsonp_cb_' + Math.round(100000 * Math.random());
    
    // 2. Define the global function the Google Script will call
    window[callbackName] = function(data) {
        console.log("Data received via JSONP:", data);
        
        if(data.status === 'success') {
            processProducts(data.products);
            customersDB = data.customers;
            render();
        } else {
            console.error("API returned status:", data.status);
            Swal.fire("Data Error", "Could not load products. Check console.", "error");
        }
        
        // Cleanup: remove the script tag and the global function after data is received
        delete window[callbackName];
        const scriptElement = document.getElementById('jsonp-script');
        if (scriptElement) scriptElement.remove();
    };

    // 3. Inject a <script> tag to perform the request
    const script = document.createElement('script');
    script.id = 'jsonp-script';
    
    // üî¥ IMPORTANT: We add &callback=... to the URL
    script.src = `${API_URL}&action=getStoreData&callback=${callbackName}`;
    
    // Handle script load errors (e.g., script fails to load entirely)
    script.onerror = function() {
        console.error("JSONP Script load failed.");
        Swal.fire("Connection Error", "The backend failed to respond.", "error");
    };

    document.body.appendChild(script);
}
   function processProducts(rawList) {
    groupedProducts = {};
    rawList.forEach(p => {
        // 1. Clean the UPC from the raw data
        const incomingUpc = p.upc ? String(p.upc).trim() : "";

        if (!groupedProducts[p.name]) {
            // CREATE NEW PRODUCT GROUP
            groupedProducts[p.name] = { 
                name: p.name, 
                lifecycle: p.lifecycle || "Rotating", 
                upc: incomingUpc, // Set initial UPC
                abv: p.abv || "TBD",
                desc: p.description || p.desc || "No description available.",
                image: p.image || p.name.split(' ')[0].toLowerCase() + ".jpg", 
                variants: [] 
            };
        } else {
            // üî¥ THE FIX: If the group exists but has no UPC, check if THIS row has one.
            // (This fixes the issue where a Keg row [no barcode] hides the Case row [has barcode])
            if (!groupedProducts[p.name].upc && incomingUpc) {
                groupedProducts[p.name].upc = incomingUpc;
            }
        }
        
        // Add variant (Case, Keg, etc.)
        groupedProducts[p.name].variants.push({ type: p.type, price: p.price, stock: p.stock });
    });
}

    // --- RENDER VIEWS ---
   function render() {
    // Targets
    const orderView = document.getElementById("view-order");
    const liveBar = document.getElementById("live-bar");
    const headerUser = document.getElementById("headerUser");
    const tabNav = document.getElementById("main-tabs");

    // 1. Header & Tab Visibility Logic
    if (state.step >= 2 && state.customer) {
        headerUser.innerHTML = `
            <div class="user-badge" onclick="changeAccessKey()" style="cursor: pointer;">
                üë§ ${state.customer.name}
            </div>`; 
        tabNav.style.display = "flex"; // Show Tabs
    } else {
        headerUser.innerHTML = "";
        tabNav.style.display = "none"; // Hide Tabs
    }

        // STEP 0: LEGAL AGREEMENT
        if (state.step === 0) {
        liveBar.style.display = "none";
        // Note: We render this INTO the order view so it's visible immediately
        orderView.innerHTML = `
                   <h2 style="text-align:center;">PA WHOLESALE DISTRIBUTION AGREEMENT</h2>
                    <div class="legal-scroll">
                        <p>This agreement is compliant with the laws of the Commonwealth of Pennsylvania and the regulations of the Pennsylvania Liquor Control Board (PLCB). By proceeding, the Purchaser agrees to the following terms and conditions:
</p>
                        <h3>1. PLCB COMPLIANCE & LICENSURE</h3>
                        <p>Purchaser warrants that it holds a valid, active retail or wholesale license issued by the PLCB. Purchaser agrees to notify Suburban Brewing Co. (SBC) immediately if said license is suspended, revoked, or expired. All sales are contingent upon the verification of a valid license.</p>
                        <h3>2. PRICE POSTING & ACT 39</h3>
                        <p>In accordance with Act 39 of 2016, SBC maintains a public price list. All products are sold at the posted wholesale price at the time of delivery. SBC reserves the right to adjust pricing in accordance with PLCB regulations regarding price change intervals.</p>
                        <h3>3. CASH ON DELIVERY (COD) & SECTION 493</h3>
                        <p>Per Section 493(2) of the Liquor Code, sales of malt or brewed beverages to retail licensees must be for cash or check paid at or before the time of delivery. Failure to provide payment at the time of delivery will result in the refusal of the shipment.</p>
                        <h3>4. COLD CHAIN STORAGE & QUALITY CONTROL</h3>
                        <p>Products produced by SBC are unpasteurized "live" beverages. Purchaser agrees to maintain strict cold chain storage (34¬∞F-38¬∞F) from the moment of delivery. SBC is not liable for product degradation, "skunking," or off-flavors resulting from improper storage, warm handling, or dirty draught lines at the Purchaser's establishment.</p>
                        <h3>5. COOPERAGE & EQUIPMENT LIABILITY</h3>
                        <p>All stainless steel keg shells remain the property of Suburban Brewing Co. A mandatory $30.00 deposit is applied to each keg shell. This deposit is refundable only upon the return of the specific SBC-branded shell in good condition. Purchaser is liable for the full replacement cost (approx. $115.00) of any lost, stolen, or damaged cooperage.</p>
                        <h3>6. RETURNED CHECKS & LATE FEES</h3>
                        <p>Any check returned for non-sufficient funds (NSF) will incur a $50.00 administrative fee. In the event of a returned check, the Purchaser must immediately provide a certified bank check or cash for the balance plus fees. SBC reserves the right to move any repeat offender to a "Cash Only" basis.</p>
                        <h3>7. RESALE LIMITATIONS</h3>
                        <p>Purchaser agrees that all products are for retail sale at the licensed premises only and may not be resold to other retailers or distributors without express written consent and proper PLCB secondary-distribution permits.</p>
                    </div>
                    <div class="checkbox-area">
                        <input type="checkbox" id="agreeCheck" onchange="document.getElementById('acceptBtn').disabled = !this.checked">
                        <label for="agreeCheck">I certify that I am a licensed PA retail/wholesale agent and agree to all terms above.</label>
                    </div>
                    <button id="acceptBtn" class="btn btn-primary" style="width:100%;" disabled onclick="state.step=1;render()">I Accept & Agree</button>
                </div>`;
        
       // STEP 1: LOGIN
    } else if (state.step === 1) {
        liveBar.style.display = "none";
        orderView.innerHTML = `
                <div class="login-hero-container">
                    <div class="login-hero-bg"></div> <div class="login-card-hero">
                        <div class="login-logo-area">
                            <h1>SUBURBAN</h1>
                            <p>BREWING CO.</p>
                        </div>
                        
                        <h2 style="margin-bottom:20px; color:#333;">Wholesale Portal</h2>
                        
                        <input type="text" id="loginInput" class="login-input-styled" placeholder="ENTER UNIQUE KEY" 
       onkeydown="if(event.key === 'Enter') attemptLogin()">
                        
                        <button class="btn btn-primary" style="width:100%; padding:15px; font-size:1.1rem;" onclick="attemptLogin()">Log In</button>
                        
                        <p style="margin-top:20px; font-size:12px; color:#888;">Having trouble? Contact your Sales Rep.</p>
                    </div>
                </div>`;
        
       // STEP 2: PRODUCT GRID
    } else if (state.step === 2) {
        liveBar.style.display = "flex";
        updateLiveTotals();

        let html = `
            <div class="controls-area">
                <div class="search-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search products..." 
       oninput="filterProducts()" 
       onkeydown="if(event.key === 'Enter') this.blur()">
                    <button class="scan-btn" onclick="startScanner()">üì∑</button>
                </div>
                <div class="cat-bar">
                    <button class="btn btn-outline cat-btn active" onclick="setCategory('All')">All</button>
                    <button class="btn btn-outline cat-btn" onclick="setCategory('Core')">Core</button>
                    <button class="btn btn-outline cat-btn" onclick="setCategory('Seasonal')">Seasonal</button>
                    <button class="btn btn-outline cat-btn" onclick="setCategory('Rotating')">Rotating</button>
                </div>
            </div>
            <div class="product-grid">`;
        
        for (const key in groupedProducts) {
            const p = groupedProducts[key];
            const inCart = Object.values(state.cart).some(item => item.beer === p.name);
            html += `
            <div class="product-card ${inCart ? 'card-selected-border' : ''}" data-name="${p.name}" data-lifecycle="${p.lifecycle}" data-upc="${p.upc}" onclick="openOrderModal('${p.name}')">
                ${inCart ? '<div class="cart-badge">IN CART</div>' : ''}
                <div class="hover-info">
                    <div class="hover-abv">ABV: ${p.abv}</div>
                    <div class="hover-desc">${p.desc}</div>
                    <div style="margin-top:auto; font-size: 0.7rem; opacity: 0.6;">Tap to order...</div>
                </div>
                <div class="product-img-container">
                    <span class="lifecycle-badge">${p.lifecycle}</span>
                    <img src="${BASE_IMG_URL}${p.image}" class="product-img" onerror="this.src='${FALLBACK_LOGO}';">
                </div>
                <div class="product-name-area"><h4>${p.name}</h4></div>
            </div>`;
        }
        orderView.innerHTML = html + `</div>`;
        
       // STEP 3: REVIEW ORDER
    } else if (state.step === 3 && state.tab === 'order') {
        liveBar.style.display = "none";
        const math = calculateOrderMath();
        const showEmailPrompt = !state.customer.email;

        // üî¥ THIS WAS THE FIX: Use orderView.innerHTML, NOT app.innerHTML
        orderView.innerHTML = `
            <div class="card">
                <div style="display:flex; justify-content:space-between;">
                    <strong>Suburban Brewing Co.</strong>
                    <span>${new Date().toLocaleDateString()}</span>
                </div>
                <hr>
                <div style="margin:20px 0;">
                    <strong>BILL TO:</strong><br>
                    ${state.customer.name}<br>
                    <span style="font-size:0.85rem; color:#666">${state.customer.address}</span>
                </div>
                
                ${showEmailPrompt ? `<div style="margin-bottom:20px; padding:15px; background:#fff3cd; border-radius:8px;"><strong>Confirmation Email:</strong><br><input type="email" id="custEmail" placeholder="Enter email for PDF receipt" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:4px;"></div>` : `<p style="font-size:0.85rem; color:#666;">PDF Confirmation will be sent to: ${state.customer.email}</p>`}
                
                <table class="review-table">
                    <thead>
                        <tr>
                            <th style="width:45%">Item</th>
                            <th style="width:25%; text-align:center;">Qty</th>
                            <th style="width:20%; text-align:right;">Total</th>
                            <th style="width:10%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(state.cart).map(([key, i]) => `
                        <tr>
                            <td>
                                <div style="font-weight:600;">${i.beer}</div>
                                <div style="font-size:0.75rem; color:#64748b;">${i.type} ($${i.price})</div>
                            </td>
                            <td style="text-align:center;">
                                <input type="number" 
                                       value="${i.qty}" 
                                       min="0" 
                                       style="width:50px; padding:6px; border:1px solid #cbd5e1; border-radius:6px; text-align:center; font-size:16px;"
                                       data-key="${key}"
                                       onchange="updateCartItem(this.dataset.key, this.value)">
                            </td>
                            <td style="text-align:right;">$${(i.qty * i.price).toFixed(2)}</td>
                            <td style="text-align:center;">
                                <button style="background:none; border:none; color:#ef4444; font-size:1.4rem; font-weight:bold; cursor:pointer; padding:0 8px;"
                                        data-key="${key}"
                                        onclick="updateCartItem(this.dataset.key, 0)">
                                    &times;
                                </button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>
                
                <div style="text-align:right; margin-top:20px; font-size:0.95rem;">
                    <div style="margin-bottom:4px;">Subtotal: $${math.subtotal}</div>
                    ${parseFloat(math.discount) > 0 ? `<div style="color:#d63031; margin-bottom:4px;">10% Volume Case Discount: -$${math.discount}</div>` : ''}
                    <div style="margin-bottom:4px;">Keg Deposits ($30/ea): $${math.deposits}</div>
                    <div style="font-size:1.4rem; color:#007bff; margin-top:8px; border-top:1px solid #eee; padding-top:8px;">
                        <strong>TOTAL: $${math.grandTotal}</strong>
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:40px;">
                    <button class="btn btn-outline" onclick="state.step=2;render()">+ Add More</button>
                    <button class="btn btn-success" style="flex:1;" onclick="submitFinalOrder()">Confirm Order</button>
                </div>
            </div>`;
    }
}// <--- üî¥ YOU WERE MISSING THIS CLOSING BRACKET FOR THE RENDER FUNCTION

    // --- MODAL LOGIC ---
    function openOrderModal(productName) {
        currentModalProduct = groupedProducts[productName];
        document.getElementById('modalTitle').innerText = productName;
        const container = document.getElementById('modalVariants');
        container.innerHTML = currentModalProduct.variants.map(v => {
            const cartKey = `${productName}-${v.type}`;
            const val = state.cart[cartKey] ? state.cart[cartKey].qty : 0;
            return `
            <div class="variant-row">
                <div class="variant-info">
                    <strong>${v.type}</strong><br>$${v.price} 
                    <span style="font-size:0.8rem; color:#94a3b8">(${v.stock} in stock)</span>
                </div>
                <div class="qty-stepper">
                    <button class="qty-btn" onclick="let inp=this.parentNode.querySelector('input'); inp.stepUp(); event.stopPropagation();">‚ñ≤</button>
                    <input type="number" class="variant-qty modal-input" 
                           data-type="${v.type}" data-price="${v.price}" data-stock="${v.stock}"
                           min="0" max="${v.stock}" value="${val}">
                    <button class="qty-btn" onclick="let inp=this.parentNode.querySelector('input'); inp.stepDown(); event.stopPropagation();">‚ñº</button>
                </div>
            </div>`;
        }).join('');
        document.getElementById('orderModal').style.display = "flex";
    }

    function closeOrderModal() {
        document.getElementById('orderModal').style.display = "none";
    }

    function saveModalOrder() {
    const inputs = document.querySelectorAll('.modal-input');
    let hasChanges = false;

    inputs.forEach(input => {
        const type = input.dataset.type;
        const price = parseFloat(input.dataset.price);
        const stock = parseInt(input.dataset.stock);
        const qty = parseInt(input.value) || 0;
        const key = `${currentModalProduct.name}-${type}`;

        if (qty > 0) {
            state.cart[key] = { beer: currentModalProduct.name, type, price, qty };
            hasChanges = true;
        } else {
            delete state.cart[key];
        }
    });

    // Native Mobile vibration feedback
    if (hasChanges && "vibrate" in navigator) {
        navigator.vibrate(50); 
    }
    
    updateLiveTotals();
    closeOrderModal();
    render(); 
}

    // --- CORE LOGIC ---
    async function attemptLogin() {
        const input = document.getElementById("loginInput").value.trim().toLowerCase();
        const found = customersDB.find(c => c.key === input);
        if (found) { 
    state.customer = found; 
    state.step = 2; 
    loadDrafts(); 
    fetchOrderHistory(); // <--- Add this line so it pre-loads the latest order items in the background
    render(); 
}
        else { Swal.fire("Login Failed", "Invalid Access Key.", "error"); }
    }

    function filterProducts() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        const cards = document.querySelectorAll(".product-card");
        cards.forEach(card => {
            const nameMatch = card.dataset.name.toLowerCase().includes(query);
            const upcMatch = card.dataset.upc && card.dataset.upc.toLowerCase().includes(query);
            const catMatch = (state.category === 'All' || card.dataset.lifecycle === state.category);
            card.style.display = ((nameMatch || upcMatch) && catMatch) ? "flex" : "none";
        });
    }

    function setCategory(cat) {
    state.category = cat;
    // Remove active class from all buttons
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    // Add active class to clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    }
    filterProducts();
}

    function calculateOrderMath() {
        let sub = 0, kegs = 0, caseTotal = 0, casesCount = 0;
        for (const k in state.cart) { 
            const item = state.cart[k];
            const lineTotal = item.price * item.qty;
            sub += lineTotal;
            if (item.type.toLowerCase().includes("keg")) kegs += item.qty;
            else if (item.type.toLowerCase().includes("case")) {
                caseTotal += lineTotal;
                casesCount += item.qty;
            }
        }
        let discount = (casesCount >= 10) ? (caseTotal * 0.10) : 0;
        let dep = kegs * 30;
        return { 
            subtotal: sub.toFixed(2), 
            discount: discount.toFixed(2), 
            deposits: dep.toFixed(2), 
            grandTotal: (sub + dep - discount).toFixed(2) 
        };
    }
// --- NEW: EDIT CART FUNCTION ---
function updateCartItem(key, newQty) {
    // 1. Convert input to integer
    const qty = parseInt(newQty);
    
    // 2. Logic: If 0 or empty, remove item. Otherwise update.
    if (!qty || qty <= 0) {
        delete state.cart[key];
    } else {
        state.cart[key].qty = qty;
    }
    
    // 3. Re-render the screen to update totals immediately
    render();
}
    function updateLiveTotals() {
        const math = calculateOrderMath();
        const totalEl = document.getElementById("live-total");
        const bar = document.getElementById("live-bar");
        
        if (totalEl) totalEl.innerText = "$" + math.grandTotal;
        
        // Show bar only if there are items in the cart
        if (Object.keys(state.cart).length > 0 && state.step === 2) {
            bar.style.display = "flex";
        } else {
            bar.style.display = "none";
        }
    }

    function goToReview() { if(Object.keys(state.cart).length === 0) return; state.step = 3; render(); }

    async function submitFinalOrder() {
        const btn = document.querySelector('.btn-success');
        const emailInput = document.getElementById("custEmail");
        
        // Validation for new customers or missing emails
        if (emailInput && !emailInput.value) {
            return Swal.fire("Email Required", "Enter an email for your receipt.", "warning");
        }

        btn.disabled = true;
        btn.innerText = "PLACING ORDER...";

        try {
            const payload = {
                action: 'submitOrder',
                customer: state.customer,
                customerEmail: emailInput ? emailInput.value : state.customer.email,
                cart: state.cart,
                summary: calculateOrderMath()
            };

            const response = await fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            });

            Swal.fire({
    title: "Order Placed!",
    text: "Your confirmation has been sent.",
    icon: "success"
}).then(() => {
    // üî¥ ADD THIS LINE:
    localStorage.removeItem('sbc_cart_draft'); 
    
    location.reload();
});
            
        } catch (e) {
            Swal.fire("Error", "Check your connection and try again.", "error");
            btn.disabled = false;
            btn.innerText = "Confirm Order";
        }
    }
    init();
    // ===========================================
    //  üì≤ SMART INSTALL BANNER LOGIC
    // ===========================================
    
    // 1. Define this GLOBALLY (Only Once!)
    let deferredPrompt; 

    // 2. Check if user is already in "App Mode" (Standalone)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

    // 3. Detect Device Type
    const ua = navigator.userAgent;
    const isIOS = /iPhone|iPad|iPod/.test(ua);
    const isMacSafari = /Macintosh/.test(ua) && /Safari/.test(ua) && !/Chrome/.test(ua);

    // --- SCENARIO A: CHROME / ANDROID / EDGE (The "Easy" Way) ---
    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later
        deferredPrompt = e;
        // Show the banner
        showBanner('native');
    });

    // --- SCENARIO B: SAFARI (iOS or Mac) ---
    // If not standalone and no "native" prompt fired, check if it's Safari
    if (!isStandalone) {
        setTimeout(() => {
            if (!deferredPrompt) {
                if (isIOS) showBanner('ios');
                else if (isMacSafari) showBanner('mac');
            }
        }, 1000);
    }

    function showBanner(type) {
        const banner = document.getElementById('installBanner');
        if (!banner) return;
        
        let html = '';
        
        if (type === 'native') {
            html = `
                <div class="install-text">
                    üì≤ <strong>Install App</strong>
                    <span class="install-sub">Add to home screen for quick access!</span>
                </div>
                <div class="install-actions">
                    <button class="btn-close-banner" onclick="closeBanner()">√ó</button>
                    <button class="btn-install" onclick="triggerNativeInstall()">Install</button>
                </div>`;
        } else if (type === 'ios') {
            html = `
                <div class="install-text">
                    üì≤ <strong>Install App</strong>
                    <span class="install-sub">Tap <img src="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/share-icon.png" style="height:14px; vertical-align:middle;"> <strong>Share</strong> then "Add to Home Screen"</span>
                </div>
                <button class="btn-close-banner" onclick="closeBanner()">√ó</button>`;
        } else if (type === 'mac') {
            html = `
                <div class="install-text">
                    üíª <strong>Install to Dock</strong>
                    <span class="install-sub">Click <strong>File</strong> in menu bar > <strong>Add to Dock</strong></span>
                </div>
                <button class="btn-close-banner" onclick="closeBanner()">√ó</button>`;
        }

        banner.innerHTML = html;
        banner.style.display = 'flex';
    }

    async function triggerNativeInstall() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            closeBanner();
        }
    }

    function closeBanner() {
        document.getElementById('installBanner').style.display = 'none';
    }

    // ===========================================
    //  üîë CHANGE SECRET CODE LOGIC
    // ===========================================
    async function changeAccessKey() {
        const { value: newCode } = await Swal.fire({
            title: 'Change Secret Code',
            text: 'Enter a new code that is easy for you to remember.',
            input: 'text',
            inputValue: state.customer.key, 
            showCancelButton: true,
            confirmButtonText: 'Save New Code',
            confirmButtonColor: '#2563eb',
            inputValidator: (value) => {
                if (!value) return 'You need to write something!';
                if (value.length < 4) return 'Code should be at least 4 characters.';
            }
        });

        if (newCode && newCode !== state.customer.key) {
            Swal.fire({ title: 'Updating...', didOpen: () => Swal.showLoading() });

            try {
                const payload = {
                    action: 'updateCustomerKey',
                    oldKey: state.customer.key,
                    newKey: newCode.trim() 
                };

                await fetch(API_URL, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify(payload)
                });

                // Update local state immediately
                state.customer.key = newCode.trim();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Code Updated!',
                    text: `Your new login code is: ${newCode.trim()}`,
                    confirmButtonColor: '#10b981'
                });

            } catch (e) {
                Swal.fire('Error', 'Could not update code. Try again.', 'error');
            }
        }
    }
    // --- 1. AUTO-SAVE & EMAIL MEMORY ---

// Call this function whenever the cart changes (inside updateCartUI or addToCart)
function saveDraft() {
  localStorage.setItem('sbc_cart_draft', JSON.stringify(cart));
}

// Call this when the user types in the email field
function saveEmailDraft() {
  const email = document.getElementById('customerEmail').value;
  if (email) localStorage.setItem('sbc_customer_email', email);
}

// Call this inside window.onload to restore everything
function loadDrafts() {
  // Restore Cart
  const savedCart = localStorage.getItem('sbc_cart_draft');
  if (savedCart) {
    cart = JSON.parse(savedCart);
    updateCartUI(); // This redraws your cart with the saved items
    console.log("üõí Draft Cart Restored");
  }

  // Restore Email
  const savedEmail = localStorage.getItem('sbc_customer_email');
  if (savedEmail) {
    const emailInput = document.getElementById('customerEmail');
    if (emailInput) emailInput.value = savedEmail;
  }
}

// Call this inside submitOrder() on SUCCESS to wipe the save
function clearDrafts() {
  localStorage.removeItem('sbc_cart_draft');
  // We DO NOT clear the email, so it remembers them for next time!
}


// --- 2. ORDER HISTORY LOGIC ---

function fetchOrderHistory() {
  const customerName = document.getElementById('customerSelect').value; // Or however you get the name
  
  if (!customerName) {
    alert("Please select a customer first.");
    return;
  }

  // Show loading state
  const container = document.getElementById('historyContainer');
  container.innerHTML = '<p>Loading history...</p>';
  document.getElementById('historyModal').style.display = 'block';

  const payload = {
    action: 'getOrderHistory',
    customerName: customerName,
    secret: 'SBC_SECURE_2026'
  };

  fetch(SCRIPT_URL, {
    method: 'POST',
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'success') {
      renderHistoryTable(data.history);
    } else {
      container.innerHTML = '<p>No history found.</p>';
    }
  })
  .catch(err => {
    container.innerHTML = '<p>Error loading history.</p>';
  });
}

function renderHistoryTable(history) {
  const container = document.getElementById('historyContainer');
  
  if (history.length === 0) {
    container.innerHTML = "<p>No past orders found.</p>";
    return;
  }

  let html = `
    <table style="width:100%; border-collapse: collapse; margin-top:10px;">
      <thead>
        <tr style="background:#eee; text-align:left;">
          <th style="padding:8px;">Date</th>
          <th style="padding:8px;">Invoice</th>
          <th style="padding:8px;">Total</th>
          <th style="padding:8px;">Status</th>
          <th style="padding:8px;">PDF</th>
        </tr>
      </thead>
      <tbody>
  `;

  history.forEach(order => {
    html += `
      <tr style="border-bottom:1px solid #ddd;">
        <td style="padding:8px;">${order.date}</td>
        <td style="padding:8px;">${order.invoice}</td>
        <td style="padding:8px;">$${order.total}</td>
        <td style="padding:8px;">${order.status}</td>
        <td style="padding:8px;">
          ${order.pdf ? `<a href="${order.pdf}" target="_blank" style="color:blue; text-decoration:underline;">Download</a>` : "Pending"}
        </td>
      </tr>
    `;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

function closeHistoryModal() {
  document.getElementById('historyModal').style.display = 'none';
}
    // ===========================================
// üë§ USER MENU & HISTORY LOGIC
// ===========================================

function fetchOrderHistory() {
    const container = document.getElementById('history-content-area');
    container.innerHTML = '<p style="text-align:center; padding:20px;">‚è≥ Loading history...</p>';

    const payload = {
        action: 'getOrderHistory',
        customerName: state.customer.name,
        secret: 'SBC_SECURE_2026'
    };

    fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            state.historyCache = data.history; // <--- SAVE DATA HERE
            
            // Also update POS latest items for the generator
            if (data.history.length > 0 && data.history[0].items) {
                state.latestOrderProducts = data.history[0].items.map(i => i.beer);
            }
            
            renderHistoryTable(data.history);
        } else {
            container.innerHTML = '<p style="text-align:center;">No history found.</p>';
        }
    })
    .catch(err => {
        container.innerHTML = '<p style="text-align:center; color:red;">Could not load history.</p>';
    });
}

function renderHistoryTable(history) {
    const container = document.getElementById('history-content-area');
    if (!history || history.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:20px;">No past orders found.</p>';
        return;
    }

    let html = `
    <table style="width:100%; border-collapse: collapse; font-size:0.85rem; margin-top:10px;">
        <thead>
            <tr style="background:#f8fafc; text-align:left; border-bottom:2px solid #e2e8f0;">
                <th style="padding:12px;">Date / ID</th>
                <th style="padding:12px;">Order Summary</th>
                <th style="padding:12px; text-align:right;">Actions</th>
            </tr>
        </thead>
        <tbody>`;

    history.forEach((h, index) => {
        // Create a summary string (e.g., "2x IPA, 1x Stout...")
        const summary = h.items.map(i => `${i.qty}x ${i.beer}`).join(', ');
        const truncatedSummary = summary.length > 50 ? summary.substring(0, 50) + "..." : summary;

        html += `
        <tr style="border-bottom:1px solid #e2e8f0;">
            <td style="padding:12px; vertical-align:top;">
                <div style="font-weight:bold; color:#1e293b;">${h.date}</div>
                <div style="font-size:0.75rem; color:#64748b;">${h.invoice}</div>
                <div style="font-size:0.7rem; font-weight:bold; color:${h.status==='Pending'?'#f59e0b':'#10b981'}; margin-top:4px;">
                    ${h.status.toUpperCase()}
                </div>
            </td>
            
            <td style="padding:12px; vertical-align:top;">
                <div style="font-weight:bold; color:#1e293b;">$${h.total}</div>
                <div style="font-size:0.8rem; color:#64748b; margin-top:4px; line-height:1.4;">
                    ${truncatedSummary || "No items details"}
                </div>
            </td>
            
            <td style="padding:12px; text-align:right; vertical-align:top;">
                <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                    
                    <button onclick="triggerReorder(${index})" style="
                        background: #1e293b; color: white; border: none; 
                        padding: 6px 10px; border-radius: 6px; font-size: 0.75rem; 
                        cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        üîÑ Reorder
                    </button>

                    ${h.pdf ? `<a href="${h.pdf}" target="_blank" style="
                        font-size:0.75rem; color:#2563eb; text-decoration:none; 
                        background:#eff6ff; padding:4px 8px; border-radius:4px;">
                        üìÑ Invoice
                    </a>` : ''}
                </div>
            </td>
        </tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}
function triggerReorder(index) {
    const order = state.historyCache[index];
    if (!order || !order.items) return;

    let addedCount = 0;

    order.items.forEach(oldItem => {
        // 1. Check if product still exists in current database
        // We look up the 'groupedProducts' to ensure the product is live and get CURRENT price
        const currentProd = groupedProducts[oldItem.beer];
        
        if (currentProd) {
            // 2. Find the matching variant (Case, Keg) to get current price
            const variant = currentProd.variants.find(v => v.type === oldItem.type);
            
            if (variant) {
                // 3. Add to Cart (using current price, not old price)
                const key = `${oldItem.beer}-${oldItem.type}`;
                
                // If item exists, add to qty. If not, create it.
                if (state.cart[key]) {
                    state.cart[key].qty += oldItem.qty;
                } else {
                    state.cart[key] = {
                        beer: oldItem.beer,
                        type: oldItem.type,
                        price: variant.price, // Uses current price
                        qty: oldItem.qty
                    };
                }
                addedCount++;
            }
        }
    });

    if (addedCount > 0) {
        saveDraft(); // Save to local storage
        
        Swal.fire({
            title: 'Cart Updated!',
            text: `Added items from Invoice ${order.invoice} to your cart.`,
            icon: 'success',
            showCancelButton: true,
            confirmButtonText: 'Go to Checkout',
            cancelButtonText: 'Stay Here'
        }).then((result) => {
            if (result.isConfirmed) {
                switchTab('order'); // Switch view
                render(); // Refresh grid to show new badges
                goToReview(); // Jump to review screen
            } else {
                switchTab('order'); // Switch view so they see the grid
                render();
            }
        });
    } else {
        Swal.fire("Unavailable", "These products are no longer available in the system.", "warning");
    }
}
// ===========================================
// üíæ AUTO-SAVE CONNECTIONS
// ===========================================

// 1. Hook into Login
// Update your attemptLogin() function to call loadDrafts() on success
const originalLogin = attemptLogin;
attemptLogin = async function() {
    const input = document.getElementById("loginInput").value.trim().toLowerCase();
    const found = customersDB.find(c => c.key === input);
    if (found) {
        state.customer = found;
        state.step = 2;
        
        // üî¥ NEW: LOAD DRAFT
        const saved = localStorage.getItem('sbc_cart_draft');
        if (saved) {
            try {
                const draft = JSON.parse(saved);
                // Simple check: Only restore if cart isn't empty
                if (Object.keys(draft).length > 0) {
                    state.cart = draft;
                    Swal.fire({
                        toast: true, position: 'top-end', 
                        icon: 'info', title: 'Cart Restored', 
                        timer: 2000, showConfirmButton: false
                    });
                }
            } catch(e) {}
        }
        
        render();
    } else {
        Swal.fire("Login Failed", "Invalid Access Key.", "error");
    }
}

// 2. Hook into Updates
// Update your updateCartItem function to call saveDraft()
const originalUpdateCart = updateCartItem;
updateCartItem = function(key, newQty) {
    // Run original logic
    const qty = parseInt(newQty);
    if (!qty || qty <= 0) delete state.cart[key];
    else state.cart[key].qty = qty;
    
    // üî¥ NEW: SAVE DRAFT
    localStorage.setItem('sbc_cart_draft', JSON.stringify(state.cart));
    
    render();
}

// 3. Hook into Modal Save
const originalSaveModal = saveModalOrder;
saveModalOrder = function() {
    // Run Logic (duplicated from original to ensure scope)
    const inputs = document.querySelectorAll('.modal-input');
    inputs.forEach(input => {
        const type = input.dataset.type;
        const price = parseFloat(input.dataset.price);
        const qty = parseInt(input.value) || 0;
        const key = `${currentModalProduct.name}-${type}`;
        if (qty > 0) state.cart[key] = { beer: currentModalProduct.name, type, price, qty };
        else delete state.cart[key];
    });

    // üî¥ NEW: SAVE DRAFT
    localStorage.setItem('sbc_cart_draft', JSON.stringify(state.cart));

    updateLiveTotals();
    closeOrderModal();
    render();
}

// 4. Hook into Submit Success (Clear Draft)
// Find your submitFinalOrder function and look for the 'success' block
// We add localStorage.removeItem('sbc_cart_draft'); right before location.reload()
    // --- NEW: TAB SWITCHER ---
function switchTab(tabName) {
    state.tab = tabName;
    
    // 1. Update Buttons
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    // Simple index matching: Order=0, History=1, POS=2
    const btns = document.querySelectorAll('.tab-btn');
    if(tabName === 'order') btns[0].classList.add('active');
    if(tabName === 'history') btns[1].classList.add('active');
    if(tabName === 'pos') btns[2].classList.add('active');

    // 2. Hide all Views
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));

    // 3. Show Target View
    document.getElementById('view-' + tabName).classList.add('active-view');

    // 4. Trigger Data Loads
    if (tabName === 'order') render(); 
    if (tabName === 'history') fetchOrderHistory();
    if (tabName === 'pos') renderPOSDownloads();
}

// --- POS GENERATOR (With Price Inputs) ---//
function renderPOSDownloads() {
    const container = document.getElementById('pos-content-area');
    container.className = ""; 
    
    // üü¢ BACKEND LOGIC: Detect mode based on customer type, but keep it hidden from the UI
    const clientType = state.customer ? state.customer.type.toLowerCase() : 'retailer';
    const hiddenMode = (clientType === 'restaurant') ? 'restaurant' : 'retail';

    // 1. Auto-select logic (Cart items first, then latest order history)
    let preSelectedItems = [];
    const cartItems = Object.values(state.cart).map(i => i.beer);
    if (cartItems.length > 0) preSelectedItems = cartItems;
    else if (state.latestOrderProducts && state.latestOrderProducts.length > 0) preSelectedItems = state.latestOrderProducts;

    // 2. Build List with Price Inputs
    let listHtml = '';
    for (const key in groupedProducts) {
        const p = groupedProducts[key];
        const isChecked = preSelectedItems.includes(p.name) ? 'checked' : '';
        
        listHtml += `
        <div class="checkbox-row" style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">
            <div style="flex:1; display:flex; align-items:center;">
                <input type="checkbox" id="chk-${key}" value="${key}" ${isChecked} style="transform:scale(1.2); margin-right:10px;">
                <label for="chk-${key}" style="font-weight:500;">
                    ${p.name} <br><span style="color:#64748b; font-size:0.75em;">${p.abv}</span>
                </label>
            </div>
            <div style="text-align:right;">
                <input type="text" id="price-${key}" placeholder="$0.00" 
                       style="width:70px; padding:6px; border:1px solid #cbd5e1; border-radius:6px; text-align:right; font-size:0.9rem;">
            </div>
        </div>`;
    }

    container.innerHTML = `
        <div class="generator-controls">
            <h3 style="margin-top:0;">üñ®Ô∏è Signage Generator</h3>
            
            <input type="hidden" id="pos-print-mode" value="${hiddenMode}">

            <p style="font-size:0.85rem; color:#666;">Enter your retail price (e.g. 16.00) to auto-fill the tags.</p>
            
            <div class="product-selector" style="max-height:400px;">
                ${listHtml}
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn btn-primary" onclick="generateDocs('shelf')">üè∑Ô∏è Shelf Talkers</button>
                <button class="btn btn-outline" onclick="generateDocs('menu')">üìù Menu Insert</button>
                <button class="btn btn-outline" onclick="generateDocs('qr')">üì± Small QR Tags</button>
            </div>
        </div>
        
        <h3 style="margin: 20px 0 10px; border-bottom:1px solid #eee;">üìÇ Brand Assets</h3>
        <div class="pos-grid">
             ${createDocCard("Brand Logo Pack", "All Formats", "üé®", "https://github.com/remyjdavis/Suburban-Brewing-Company-Portal/raw/main/Online%20Ordering/SBC-Logos.zip")}
        </div>`;
}

// --- GENERATOR ENGINE (With QR Tags) ---//
function generateDocs(type) {
    const printArea = document.getElementById('print-area');
    const inputs = document.querySelectorAll('.product-selector input[type="checkbox"]:checked');
    const logoUrl = "https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png";
    
    // üü¢ BACKEND AUTO-MODE DETECTION
    const mode = document.getElementById('pos-print-mode').value; 
    const baseUrl = window.location.href.split('?')[0];

    if (inputs.length === 0) {
        return Swal.fire("Select Products", "Please check at least one product.", "warning");
    }

    let html = "";

    if (type === 'shelf') {
        html = `<div class="print-grid-talkers" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">`;
        inputs.forEach(input => {
            const p = groupedProducts[input.value];
            const priceVal = document.getElementById(`price-${input.value}`).value;
            const displayPrice = priceVal ? `$${priceVal}` : "$_______";

            // üü¢ DUAL UNIT LOGIC
            const units = (mode === 'retail') ? ['4-PACK CANS', 'SINGLE CAN'] : ['PINT POUR', 'CAN POUR'];

            units.forEach(unit => {
                html += `
                <div class="talker-card" style="border: 2px dashed #000; padding: 15px; height: 3in; display: flex; flex-direction: row; align-items: center; text-align: left; background: white; page-break-inside: avoid;">
                    <div style="flex: 0 0 30%; display:flex; align-items:center; justify-content:center; border-right:2px solid #eee; padding-right:15px; margin-right:15px; height:100%;">
                        <img src="${logoUrl}" style="width: 100%; max-height: 100%; object-fit: contain;">
                    </div>
                    <div style="flex: 1; display:flex; flex-direction:column; justify-content:center;">
                        <div class="talker-header" style="font-size:1.1rem; margin-bottom:2px;">${p.name}</div>
                        <div class="talker-sub" style="font-size:0.75rem; color:#444; margin-bottom:5px;">${p.abv}% ABV ‚Ä¢ ${unit}</div>
                        <div class="talker-desc" style="font-size:0.7rem; line-height:1.2; font-style:italic; margin-bottom:8px;">${p.desc}</div>
                        <div class="talker-price-area" style="font-size:1.3rem; padding:4px 10px; border:2px solid #000; border-radius:8px; align-self:flex-start; font-weight:900;">${displayPrice}</div>
                    </div>
                </div>`;
            });
        });
        html += `</div>`;
    } 
    else if (type === 'qr') {
        html = `<div style="display:flex; flex-wrap:wrap; align-content: flex-start; padding: 0.25in;">`;
        inputs.forEach(input => {
            const p = groupedProducts[input.value];
            const priceVal = document.getElementById(`price-${input.value}`).value;
            const displayPrice = priceVal ? `$${priceVal}` : "";
            const deepLink = `${baseUrl}?beer=${encodeURIComponent(p.name)}`;
            const qrSrc = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(deepLink)}`;

            // üü¢ DUAL UNIT LOGIC
            const units = (mode === 'retail') ? ['4-PACK', 'SINGLE'] : ['PINT', 'CAN'];

            units.forEach(unit => {
                html += `
                <div class="qr-talker-card" style="width: 3in; height: 1.75in; border: 1px dashed #ccc; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; float: left; margin: 5px; background: white; overflow: hidden; page-break-inside: avoid;">
                    <div class="tag-header" style="display: flex; align-items: center; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 5px; height: 40%;">
                        <img src="${logoUrl}" style="height: 100%; width: auto; margin-right: 10px; object-fit: contain;">
                        <div style="flex: 1; text-align: left; line-height: 1.1;">
                            <div class="tag-name" style="font-size: 10pt; font-weight: 900; text-transform: uppercase;">${p.name}</div>
                            <div class="tag-abv" style="font-size: 8pt; font-weight: bold; color: #555;">${p.abv}% ‚Ä¢ ${unit}</div>
                        </div>
                    </div>
                    <div class="tag-body" style="display: flex; align-items: center; justify-content: space-between; height: 60%;">
                        <div class="tag-qr-col" style="display: flex; flex-direction: column; align-items: center; justify-content: center; width: 40%;">
                            <img src="${qrSrc}" class="tag-qr-img" style="height: 0.6in; width: 0.6in;">
                            <div class="tag-qr-text" style="font-size: 6px; text-transform: uppercase; font-weight: bold; margin-top: 2px;">Scan Info</div>
                        </div>
                        <div class="tag-price-col" style="flex: 1; text-align: center;">
                            <div class="tag-price" style="font-size: 24pt; font-weight: 900;">${displayPrice}</div>
                        </div>
                    </div>
                </div>`;
            });
        });
        html += `</div>`;
    }
    else if (type === 'menu') {
        html = `<div class="print-menu-list" style="padding: 40px; background: white;">`;
        inputs.forEach(input => {
            const p = groupedProducts[input.value];
            const priceVal = document.getElementById(`price-${input.value}`).value;
            const displayPrice = priceVal ? `$${priceVal}` : "";
            
            // üü¢ DUAL CONTEXT SUBTITLE
            const unitContext = (mode === 'retail') ? 'Cans Available' : 'On Draught & Cans';

            html += `
            <div class="menu-item" style="display:flex; align-items:center; margin-bottom:25px; padding-bottom:15px; border-bottom:1px solid #e2e8f0; page-break-inside: avoid;">
                <div style="flex: 0 0 80px; margin-right:20px; display:flex; align-items:center;">
                     <img src="${logoUrl}" style="width:100%; object-fit:contain;">
                </div>
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <span style="font-size:1.4rem; font-weight:800; text-transform:uppercase;">${p.name}</span>
                        <span style="font-weight:bold; font-size:1.3rem;">${displayPrice}</span>
                    </div>
                    <div style="font-weight:bold; color:#64748b; font-size:0.95rem; margin-bottom:6px;">${p.abv}% ABV ‚Ä¢ ${unitContext}</div>
                    <div style="font-size:0.9rem; color:#334155; line-height:1.4; font-style:italic;">${p.desc}</div>
                </div>
            </div>`;
        });
        html += `</div>`;
    }

    printArea.innerHTML = html;
    setTimeout(() => window.print(), 500); 
}

// Helper for the static downloads
function createDocCard(title, subtitle, icon, link) {
    return `
    <div class="pos-card" onclick="window.open('${link}', '_blank')" style="cursor:pointer; border-color:#cbd5e1;">
        <div style="font-size: 35px; margin-bottom:5px;">${icon}</div>
        <h4 style="margin:0; font-size:0.9rem; color:#1e293b;">${title}</h4>
        <div style="margin-top:8px; font-size:0.7rem; color:var(--accent); font-weight:bold;">‚¨áÔ∏è Download</div>
    </div>`;
}
 // --- PUBLIC QR CODE VIEWER (Fixed Logic) ---
const urlParams = new URLSearchParams(window.location.search);
const publicBeerKey = urlParams.get('beer');

if (publicBeerKey) {
    // 1. Hide the main app immediately
    const app = document.getElementById("app");
    if(app) app.style.display = "none";
    
    // Show a loading message
    document.body.insertAdjacentHTML('beforeend', '<div id="public-loader" style="display:flex; height:100vh; justify-content:center; align-items:center; font-family:sans-serif;"><h3>üç∫ Pouring...</h3></div>');

    // 2. FETCH DATA
    fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getProducts', secret: 'SBC_SECURE_2026' })
    })
    .then(res => res.json())
    .then(data => {
        // Remove loader
        const loader = document.getElementById('public-loader');
        if(loader) loader.remove();

        if (data.status === 'success') {
            groupedProducts = data.products;
            
            // 3. SHOW THE PAGE
            showPublicBeerPage(publicBeerKey);
            
            // 4. CLEAN THE URL (Privacy Trick)
            if (window.history.replaceState) {
               const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
               window.history.replaceState({path: cleanUrl}, '', cleanUrl);
            }
        } else {
            // üî¥ DEBUG MODE: Show the actual error message from the server
            document.body.innerHTML = `
                <div style="text-align:center; margin-top:50px; font-family:sans-serif;">
                    <h3>Menu Unavailable</h3>
                    <p style="color:red; font-weight:bold;">Error: ${data.message || "Unknown Error"}</p>
                    <p style="font-size:12px; color:#666;">(Show this to your developer)</p>
                </div>`;
        }
    })
    .catch(err => {
        document.body.innerHTML = `<h3 style='text-align:center; margin-top:50px;'>Connection Error: ${err.message}</h3>`;
    });
}

function showPublicBeerPage(beerKey) {
    const cleanKey = decodeURIComponent(beerKey);
    let product = null;
    
    // Search the list
    for(let k in groupedProducts) {
        if(groupedProducts[k].name === cleanKey) {
            product = groupedProducts[k];
            break;
        }
    }

    if (!product) {
        document.body.innerHTML = `<h2 style='text-align:center; margin-top:50px; font-family:sans-serif;'>Product Not Found</h2>`;
        return;
    }

    // üü¢ UPDATE: Rename the Browser Window/Tab immediately
    document.title = product.name.toUpperCase(); 

    // --- APP MODE INJECTOR ---
    // 1. Set Status Bar Color
    let metaTheme = document.createElement('meta');
    metaTheme.name = "theme-color";
    metaTheme.content = "#ffffff";
    document.head.appendChild(metaTheme);

    // 2. iOS "Web App" Tags
    let metaApple = document.createElement('meta');
    metaApple.name = "apple-mobile-web-app-capable";
    metaApple.content = "yes";
    document.head.appendChild(metaApple);
    
    // 3. Set the "App Name" if they save it to their home screen
    let metaAppName = document.createElement('meta');
    metaAppName.name = "apple-mobile-web-app-title";
    metaAppName.content = product.name;
    document.head.appendChild(metaAppName);

    let metaStatus = document.createElement('meta');
    metaStatus.name = "apple-mobile-web-app-status-bar-style";
    metaStatus.content = "default";
    document.head.appendChild(metaStatus);

    // 4. Prevent Rubber Banding
    document.body.style.overscrollBehavior = "none";
    document.body.style.backgroundColor = "#ffffff";
    // -------------------------

    // Render the Public Card
    const logoUrl = "https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png";
    const imgUrl = `${BASE_IMG_URL}${product.image}`;

    const publicView = document.createElement("div");
    
    publicView.innerHTML = `
        <div style="min-height: 100vh; background: white; font-family: 'Helvetica Neue', sans-serif; display: flex; flex-direction: column;">
            
            <div style="padding: 20px 0; text-align: center; border-bottom: 1px solid #f1f5f9;">
                <img src="${logoUrl}" style="height: 50px;">
            </div>

            <div style="flex: 1; padding: 20px; max-width: 500px; margin: 0 auto; width: 100%; box-sizing: border-box;">
                
                <div style="border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.08); margin-bottom: 25px;">
                    <img src="${imgUrl}" onerror="this.src='${FALLBACK_LOGO}'" style="width: 100%; height: auto; display: block;">
                </div>

                <div style="text-align: center;">
                    <h1 style="margin: 0 0 5px 0; font-size: 2rem; color: #0f172a; text-transform: uppercase; letter-spacing: -0.5px;">${product.name}</h1>
                    
                    <div style="display: inline-block; background: #eff6ff; color: #2563eb; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; margin-bottom: 20px;">
                        ${product.abv}% ABV
                    </div>
                    
                    <p style="line-height: 1.6; color: #475569; font-size: 1.05rem; margin-bottom: 30px;">
                        ${product.desc}
                    </p>
                </div>

                <div style="text-align: center; margin-top: auto; padding-bottom: 30px;">
                    <a href="https://suburbanbrewingco.com" 
                       style="display: block; width: 100%; background: #0f172a; color: white; padding: 15px 0; border-radius: 12px; text-decoration: none; font-weight: bold; font-size: 1rem;">
                        Visit Our Website
                    </a>
                    <p style="margin-top: 15px; font-size: 0.75rem; color: #94a3b8;">Brewed in Honey Brook, PA</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.innerHTML = "";
    document.body.appendChild(publicView);

    setTimeout(function() { window.scrollTo(0, 1); }, 100);
}
</script>

<div id="scanner-container">
    <div id="reader"></div>
    <button class="scanner-close" onclick="stopScanner()">Close Camera</button>
</div>
    <div id="print-area"></div>
</body>
</html>
