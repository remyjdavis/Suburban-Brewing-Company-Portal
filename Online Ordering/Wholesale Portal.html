<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBC Wholesale Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* --- APP-FIRST THEME --- */
:root {
    --bg: #f3f4f6;
    --sidebar: #0f172a;
    --accent: #2563eb;
    --primary: #1e293b;
    --success: #10b981;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

* { 
    box-sizing: border-box; 
    font-family: 'Inter', -apple-system, system-ui, sans-serif;
    -webkit-font-smoothing: antialiased;
}

body { 
    margin: 0; 
    background-color: var(--bg); 
    color: var(--primary); 
    padding-bottom: 100px; /* Space for bottom app bar */
    overscroll-behavior-y: contain; /* Prevents "pull-to-refresh" bounce */
}

        /* --- NATIVE APP HEADER --- */
.site-header { 
    background: #ffffff; 
    padding: 12px 20px; 
    display: flex; 
    align-items: center; 
    gap: 12px;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.site-header img { height: 40px; border-radius: 8px; }
.header-info h1 { margin: 0; font-size: 1rem; font-weight: 700; }
.header-info { font-size: 0.7rem; color: #64748b; }

        .container { 
            max-width: 1000px; 
            margin: 10px auto; 
            padding: 0 12px; 
        }

        .card { 
            background: white; 
            padding: 1.2rem; 
            border-radius: 12px; 
            border: 1px solid #dee2e6; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
        }
        
        /* LEGAL SCROLL */
        .legal-scroll { 
            height: 350px; 
            overflow-y: auto; 
            border: 2px solid #1a1a1a; 
            padding: 1rem; 
            margin: 1rem 0; 
            font-size: 0.85rem; 
            line-height: 1.6; 
            background: #fff; 
            -webkit-overflow-scrolling: touch;
        }

        .checkbox-area { 
            background: #f1f2f6; 
            padding: 12px; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
            font-size: 0.85rem;
        }

        /* --- COMPACT CATEGORY PILLS --- */
.controls-area { 
    background: var(--bg);
    padding: 12px 16px;
    position: sticky;
    top: 64px;
    z-index: 999;
}

.search-wrapper {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

.search-input { 
    flex: 1;
    background: #fff;
    border: 1px solid #e5e7eb;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 16px; /* Prevents iOS zoom on focus */
    box-shadow: var(--card-shadow);
}

.scan-btn {
    width: 50px;
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--card-shadow);
}

.cat-bar { 
    display: flex; 
    gap: 8px; 
    overflow-x: auto; 
    padding: 4px 0;
    scrollbar-width: none; 
}

.cat-btn {
    background: white;
    border: 1px solid #e5e7eb;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    white-space: nowrap;
    transition: 0.2s;
}

.cat-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

        /* --- APP-STYLE PRODUCT GRID --- */
.product-grid { 
    display: grid; 
    grid-template-columns: repeat(2, 1fr); /* 2 per row on mobile */
    gap: 12px; 
    padding: 0 16px;
}

@media (min-width: 768px) {
    .product-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
}

.product-card { 
    background: #fff; 
    border-radius: 16px; 
    padding: 12px;
    display: flex; 
    flex-direction: column;
    box-shadow: var(--card-shadow);
    transition: 0.2s;
    border: 2px solid transparent;
}

.product-card.card-selected-border {
    border-color: var(--accent);
}

.product-img-container { 
    width: 100%; 
    aspect-ratio: 1/1; /* Makes images square */
    background: #f9fafb; 
    border-radius: 12px;
    display: flex; 
    align-items: center; 
    justify-content: center; 
    position: relative;
    margin-bottom: 8px;
}

.cart-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: var(--accent);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 6px;
    font-weight: bold;
}

.product-name-area h4 {
    margin: 4px 0;
    font-size: 0.9rem;
    color: #111827;
}

        .lifecycle-badge { 
            position: absolute; 
            top: 8px; 
            right: 8px; 
            padding: 2px 6px; 
            background: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
            border-radius: 4px; 
            font-size: 0.6rem; 
            font-weight: bold; 
        }

        /* --- ORDER MODAL (POPUP) --- */
        .order-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }

        .order-modal-content {
    border-radius: 24px 24px 0 0; /* Bottom sheet look on mobile */
    width: 100%;
    max-width: 500px;
    position: fixed;
    bottom: 0;
    padding: 24px;
}
        @media (min-width: 500px) {
    .order-modal-content {
        border-radius: 24px;
        position: relative;
        bottom: auto;
    }
}
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        
        .close-modal {
            background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;
        }

        .variant-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #f1f1f1; 
        }

        .variant-info { font-size: 0.9rem; }
        .variant-qty { 
            width: 70px; height: 40px; text-align: center; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; font-weight: bold; 
        }

        .btn-add-order {
            width: 100%;
            margin-top: 20px;
            padding: 15px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }

        /* --- FLOATING BOTTOM BAR --- */
.live-bar { 
    position: fixed; 
    bottom: 20px; 
    left: 20px; 
    right: 20px; 
    background: #111827; 
    color: white; 
    padding: 12px 20px; 
    border-radius: 20px;
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    z-index: 1001; 
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
}

        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: 800; font-size: 0.9rem; cursor: pointer; }
        .btn-primary { 
    background: var(--accent); 
    color: white; 
    padding: 10px 20px; 
    border-radius: 12px; 
    font-weight: 700; 
}
        .btn-outline { background: white; border: 1px solid #ccc; font-size: 0.8rem;}
        .btn-outline.active { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        .btn-success { background: #27ae60; color: white; width: 100%; }

        /* REVIEW TABLE */
        .review-table { width: 100%; font-size: 0.85rem; margin-top: 10px;}
        .review-table th { text-align: left; padding: 8px; border-bottom: 2px solid #eee; }
        .review-table td { padding: 8px; border-bottom: 1px solid #f9f9f9; }

        @media print { .site-header, .live-bar, #menu-toggle { display: none !important; } }

        /* SCANNER OVERLAY */
        #scanner-container {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center;
        }
        #reader { width: 90%; max-width: 500px; background: #fff; border-radius: 12px; overflow: hidden; }
        .scanner-close { margin-top: 20px; padding: 15px 30px; background: #d63031; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        .search-wrapper { position: relative; display: flex; gap: 10px; align-items: center; width: 100%; }
        .scan-btn { height: 50px; padding: 0 15px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.2rem; }
    </style>
</head>
<body>

<header class="site-header">
    <img src="https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png" alt="SBC Logo" style="height:55px;">
    <div class="header-info">
        <h1>Suburban Brewing Co.</h1>
        3041 Horseshoe Pike, Honey Brook, PA 19344<br>
        Sales Rep: Remy Davis | (908) 642-1019
    </div>
</header>

<div class="container" id="app"></div>

<div id="orderModal" class="order-modal">
    <div class="order-modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Product Name</h3>
            <button class="close-modal" onclick="closeOrderModal()">&times;</button>
        </div>
        <div id="modalVariants"></div>
        <button class="btn-add-order" onclick="saveModalOrder()">Update Order</button>
    </div>
</div>

<div id="live-bar" class="live-bar" style="display:none;">
    <div class="live-stats">
        <div id="live-total" style="color:#007bff; font-weight:900; font-size:1.4rem;">$0.00</div>
        <div style="font-size: 0.8rem; opacity: 0.8;">Plus Keg Deposits</div>
    </div>
    <button class="btn btn-primary" onclick="goToReview()">Review Order</button>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz2YK1MnItnIMJpNHNRCFXoo4hxRJPaF9NmO6ginxaJjfkm7FnbV-gO82_uL8X73AaR/exec?secret=SBC_SECURE_2026"; 
    const BASE_IMG_URL = "https://raw.githubusercontent.com/remyjdavis/brewery-order-form/main/";
    const FALLBACK_LOGO = "https://raw.githubusercontent.com/remyjdavis/Suburban-Brewing-Company-Portal/main/Online%20Ordering/logo.png";

    let groupedProducts = {};
    let customersDB = [];
    let state = { step: 0, customer: null, cart: {}, category: 'All' };
    let currentModalProduct = null;
    let html5QrCode;

    // --- SCANNER LOGIC ---
    async function startScanner() {
        document.getElementById('scanner-container').style.display = 'flex';
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 150 } };
        try {
            await html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                (decodedText) => {
                    document.getElementById('searchInput').value = decodedText;
                    filterProducts();
                    stopScanner();
                    Swal.fire({ icon: 'success', title: 'Scanned!', timer: 1000, showConfirmButton: false });
                },
                (errorMessage) => { }
            );
        } catch (err) {
            Swal.fire("Camera Error", "Please allow camera access.", "error");
            stopScanner();
        }
    }

    async function stopScanner() {
        if (html5QrCode) {
            try { await html5QrCode.stop(); await html5QrCode.clear(); } catch (e) {}
        }
        document.getElementById('scanner-container').style.display = 'none';
    }

    // --- INITIALIZATION ---
    // --- INITIALIZATION ---
    async function init() {
        try {
            // ðŸ”´ FIX: Changed '?' to '&' because API_URL already has a '?'
            const response = await fetch(`${API_URL}&action=getStoreData`);
            
            const data = await response.json();
            
            // Debugging: This will show you exactly what the sheet is returning
            console.log("API Response:", data); 

            if(data.status === 'success') {
                processProducts(data.products);
                customersDB = data.customers;
                render();
            } else {
                console.error("API returned status:", data.status);
                // Optional: Alert the user if the backend is not ready
                Swal.fire("Connection Error", "Could not load store data. Check console.", "error");
            }
        } catch (error) { 
            console.error("Fetch Error:", error); 
        }
    }
    function processProducts(rawList) {
        groupedProducts = {};
        rawList.forEach(p => {
            if (!groupedProducts[p.name]) {
                groupedProducts[p.name] = { 
                    name: p.name, 
                    lifecycle: p.lifecycle || "Rotating",
                    upc: p.upc,
                    image: p.image || p.name.split(' ')[0].toLowerCase() + ".jpg", 
                    variants: [] 
                };
            }
            groupedProducts[p.name].variants.push({ type: p.type, price: p.price, stock: p.stock });
        });
    }

    // --- RENDER VIEWS ---
    function render() {
        const app = document.getElementById("app");
        const liveBar = document.getElementById("live-bar");

        // STEP 0: LEGAL AGREEMENT
        if (state.step === 0) {
            liveBar.style.display = "none";
            app.innerHTML = `
                   <h2 style="text-align:center;">PA WHOLESALE DISTRIBUTION AGREEMENT</h2>
                    <div class="legal-scroll">
                        <p>This agreement is compliant with the laws of the Commonwealth of Pennsylvania and the regulations of the Pennsylvania Liquor Control Board (PLCB). By proceeding, the Purchaser agrees to the following terms and conditions:
</p>
                        <h3>1. PLCB COMPLIANCE & LICENSURE</h3>
                        <p>Purchaser warrants that it holds a valid, active retail or wholesale license issued by the PLCB. Purchaser agrees to notify Suburban Brewing Co. (SBC) immediately if said license is suspended, revoked, or expired. All sales are contingent upon the verification of a valid license.</p>
                        <h3>2. PRICE POSTING & ACT 39</h3>
                        <p>In accordance with Act 39 of 2016, SBC maintains a public price list. All products are sold at the posted wholesale price at the time of delivery. SBC reserves the right to adjust pricing in accordance with PLCB regulations regarding price change intervals.</p>
                        <h3>3. CASH ON DELIVERY (COD) & SECTION 493</h3>
                        <p>Per Section 493(2) of the Liquor Code, sales of malt or brewed beverages to retail licensees must be for cash or check paid at or before the time of delivery. Failure to provide payment at the time of delivery will result in the refusal of the shipment.</p>
                        <h3>4. COLD CHAIN STORAGE & QUALITY CONTROL</h3>
                        <p>Products produced by SBC are unpasteurized "live" beverages. Purchaser agrees to maintain strict cold chain storage (34Â°F-38Â°F) from the moment of delivery. SBC is not liable for product degradation, "skunking," or off-flavors resulting from improper storage, warm handling, or dirty draught lines at the Purchaser's establishment.</p>
                        <h3>5. COOPERAGE & EQUIPMENT LIABILITY</h3>
                        <p>All stainless steel keg shells remain the property of Suburban Brewing Co. A mandatory $30.00 deposit is applied to each keg shell. This deposit is refundable only upon the return of the specific SBC-branded shell in good condition. Purchaser is liable for the full replacement cost (approx. $115.00) of any lost, stolen, or damaged cooperage.</p>
                        <h3>6. RETURNED CHECKS & LATE FEES</h3>
                        <p>Any check returned for non-sufficient funds (NSF) will incur a $50.00 administrative fee. In the event of a returned check, the Purchaser must immediately provide a certified bank check or cash for the balance plus fees. SBC reserves the right to move any repeat offender to a "Cash Only" basis.</p>
                        <h3>7. RESALE LIMITATIONS</h3>
                        <p>Purchaser agrees that all products are for retail sale at the licensed premises only and may not be resold to other retailers or distributors without express written consent and proper PLCB secondary-distribution permits.</p>
                    </div>
                    <div class="checkbox-area">
                        <input type="checkbox" id="agreeCheck" onchange="document.getElementById('acceptBtn').disabled = !this.checked">
                        <label for="agreeCheck">I certify that I am a licensed PA retail/wholesale agent and agree to all terms above.</label>
                    </div>
                    <button id="acceptBtn" class="btn btn-primary" style="width:100%;" disabled onclick="state.step=1;render()">I Accept & Agree</button>
                </div>`;
        
        // STEP 1: LOGIN
        } else if (state.step === 1) {
            app.innerHTML = `
                <div class="card" style="max-width:400px; margin:auto; text-align:center;">
                    <h3>Wholesale Login</h3>
                    <input type="text" id="loginInput" placeholder="ENTER UNIQUE KEY" style="width:100%; padding:15px; margin-bottom:15px; border:2px solid #1a1a1a; border-radius:8px; text-align:center; font-size:1.2rem;">
                    <button class="btn btn-primary" style="width:100%;" onclick="attemptLogin()">Log In</button>
                </div>`;
        
        // STEP 2: PRODUCT GRID (COMPACT VIEW)
        } else if (state.step === 2) {
            liveBar.style.display = "flex";
            let html = `
                <div class="controls-area">
                    <div class="search-wrapper">
                        <input type="text" id="searchInput" class="search-input" placeholder="Search or scan UPC..." oninput="filterProducts()">
                        <button class="scan-btn" onclick="startScanner()">ðŸ“·</button>
                    </div>
                    <div class="cat-bar">
                        <button class="btn btn-outline cat-btn active" onclick="setCategory('All')">All</button>
                        <button class="btn btn-outline cat-btn" onclick="setCategory('Core')">Core</button>
                        <button class="btn btn-outline cat-btn" onclick="setCategory('Seasonal')">Seasonal</button>
                        <button class="btn btn-outline cat-btn" onclick="setCategory('Rotating')">Rotating</button>
                    </div>
                </div>
                <div class="product-grid">`;
            
            for (const key in groupedProducts) {
                const p = groupedProducts[key];
                // Check if any variant is in cart to show badge
                let countInCart = 0;
                p.variants.forEach(v => {
                    if(state.cart[`${p.name}-${v.type}`]) countInCart += 1;
                });

                const badgeDisplay = countInCart > 0 ? "block" : "none";
                const borderClass = countInCart > 0 ? "card-selected-border" : "";

                html += `
                <div class="product-card ${borderClass}" data-name="${p.name}" data-lifecycle="${p.lifecycle}" data-upc="${p.upc}" onclick="openOrderModal('${p.name}')">
                    <div class="cart-badge" style="display:${badgeDisplay}">IN CART</div>
                    <div class="product-img-container">
                        <span class="lifecycle-badge">${p.lifecycle}</span>
                        <img src="${BASE_IMG_URL}${p.image}" class="product-img" onerror="this.onerror=null;this.src='${FALLBACK_LOGO}';">
                    </div>
                    <div class="product-name-area">
                        <h4>${p.name}</h4>
                    </div>
                </div>`;
            }
            app.innerHTML = html + `</div>`;
        
        // STEP 3: REVIEW ORDER
        } else if (state.step === 3) {
            liveBar.style.display = "none";
            const math = calculateOrderMath();
            const showEmailPrompt = !state.customer.email;
            app.innerHTML = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between;"><strong>Suburban Brewing Co.</strong><span>${new Date().toLocaleDateString()}</span></div>
                    <hr>
                    <div style="margin:20px 0;"><strong>BILL TO:</strong><br>${state.customer.name}<br>${state.customer.address}</div>
                    ${showEmailPrompt ? `<div style="margin-bottom:20px; padding:15px; background:#fff3cd; border-radius:8px;"><strong>Confirmation Email:</strong><br><input type="email" id="custEmail" placeholder="Enter email for PDF receipt" style="width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:4px;"></div>` : `<p>PDF Confirmation will be sent to: ${state.customer.email}</p>`}
                    <table class="review-table">
                        <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                        <tbody>${Object.values(state.cart).map(i => `<tr><td>${i.beer} (${i.type})</td><td>${i.qty}</td><td>$${(i.qty * i.price).toFixed(2)}</td></tr>`).join('')}</tbody>
                    </table>
                    <div style="text-align:right; margin-top:20px;">
                        <div>Subtotal: $${math.subtotal}</div>
                        ${parseFloat(math.discount) > 0 ? `<div style="color:#d63031;">10% Volume Case Discount: -$${math.discount}</div>` : ''}
                        <div>Keg Deposits ($30/ea): $${math.deposits}</div>
                        <div style="font-size:1.4rem; color:#007bff;"><strong>TOTAL: $${math.grandTotal}</strong></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-top:40px;">
                        <button class="btn btn-outline" onclick="state.step=2;render()">Edit Order</button>
                        <button class="btn btn-success" style="flex:1;" onclick="submitFinalOrder()">Confirm Order</button>
                    </div>
                </div>`;
        }
    }

    // --- MODAL LOGIC ---
    function openOrderModal(productName) {
        currentModalProduct = groupedProducts[productName];
        document.getElementById('modalTitle').innerText = productName;
        
        const container = document.getElementById('modalVariants');
        container.innerHTML = currentModalProduct.variants.map(v => {
            const cartKey = `${productName}-${v.type}`;
            const val = state.cart[cartKey] ? state.cart[cartKey].qty : 0;
            return `
            <div class="variant-row">
                <div class="variant-info">
                    <strong>${v.type}</strong><br>$${v.price} 
                    <span style="font-size:0.8rem; color:${v.stock < 5 ? 'red':'green'}">(${v.stock} in stock)</span>
                </div>
                <input type="number" class="variant-qty modal-input" 
                       data-type="${v.type}" data-price="${v.price}" data-stock="${v.stock}"
                       min="0" max="${v.stock}" value="${val}">
            </div>`;
        }).join('');

        document.getElementById('orderModal').style.display = "flex";
    }

    function closeOrderModal() {
        document.getElementById('orderModal').style.display = "none";
    }

    function saveModalOrder() {
    const inputs = document.querySelectorAll('.modal-input');
    let hasChanges = false;

    inputs.forEach(input => {
        const type = input.dataset.type;
        const price = parseFloat(input.dataset.price);
        const stock = parseInt(input.dataset.stock);
        const qty = parseInt(input.value) || 0;
        const key = `${currentModalProduct.name}-${type}`;

        if (qty > 0) {
            state.cart[key] = { beer: currentModalProduct.name, type, price, qty };
            hasChanges = true;
        } else {
            delete state.cart[key];
        }
    });

    // Native Mobile vibration feedback
    if (hasChanges && "vibrate" in navigator) {
        navigator.vibrate(50); 
    }
    
    updateLiveTotals();
    closeOrderModal();
    render(); 
}

    // --- CORE LOGIC ---
    async function attemptLogin() {
        const input = document.getElementById("loginInput").value.trim().toLowerCase();
        const found = customersDB.find(c => c.key === input);
        if (found) { state.customer = found; state.step = 2; render(); }
        else { Swal.fire("Login Failed", "Invalid Access Key.", "error"); }
    }

    function filterProducts() {
        const query = document.getElementById("searchInput").value.toLowerCase();
        const cards = document.querySelectorAll(".product-card");
        cards.forEach(card => {
            const nameMatch = card.dataset.name.toLowerCase().includes(query);
            const upcMatch = card.dataset.upc && card.dataset.upc.toLowerCase().includes(query);
            const catMatch = (state.category === 'All' || card.dataset.lifecycle === state.category);
            card.style.display = ((nameMatch || upcMatch) && catMatch) ? "flex" : "none";
        });
    }

    function setCategory(cat) {
    state.category = cat;
    // Remove active class from all buttons
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    // Add active class to clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    }
    filterProducts();
}

    function calculateOrderMath() {
        let sub = 0, kegs = 0, caseTotal = 0, casesCount = 0;
        for (const k in state.cart) { 
            const item = state.cart[k];
            const lineTotal = item.price * item.qty;
            sub += lineTotal;
            if (item.type.toLowerCase().includes("keg")) kegs += item.qty;
            else if (item.type.toLowerCase().includes("case")) {
                caseTotal += lineTotal;
                casesCount += item.qty;
            }
        }
        let discount = (casesCount >= 10) ? (caseTotal * 0.10) : 0;
        let dep = kegs * 30;
        return { 
            subtotal: sub.toFixed(2), 
            discount: discount.toFixed(2), 
            deposits: dep.toFixed(2), 
            grandTotal: (sub + dep - discount).toFixed(2) 
        };
    }

    function updateLiveTotals() {
        const math = calculateOrderMath();
        const totalEl = document.getElementById("live-total");
        const bar = document.getElementById("live-bar");
        
        if (totalEl) totalEl.innerText = "$" + math.grandTotal;
        
        // Show bar only if there are items in the cart
        if (Object.keys(state.cart).length > 0 && state.step === 2) {
            bar.style.display = "flex";
        } else {
            bar.style.display = "none";
        }
    }

    function goToReview() { if(Object.keys(state.cart).length === 0) return; state.step = 3; render(); }

    async function submitFinalOrder() {
        const btn = document.querySelector('.btn-success');
        const emailInput = document.getElementById("custEmail");
        
        // Validation for new customers or missing emails
        if (emailInput && !emailInput.value) {
            return Swal.fire("Email Required", "Enter an email for your receipt.", "warning");
        }

        btn.disabled = true;
        btn.innerText = "PLACING ORDER...";

        try {
            const payload = {
                action: 'submitOrder',
                customer: state.customer,
                customerEmail: emailInput ? emailInput.value : state.customer.email,
                cart: state.cart,
                summary: calculateOrderMath()
            };

            const response = await fetch(API_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify(payload)
            });

            Swal.fire({
                title: "Order Placed!",
                text: "Your confirmation has been sent.",
                icon: "success"
            }).then(() => location.reload());
            
        } catch (e) {
            Swal.fire("Error", "Check your connection and try again.", "error");
            btn.disabled = false;
            btn.innerText = "Confirm Order";
        }
    }
    init();
</script>

<div id="scanner-container">
    <div id="reader"></div>
    <button class="scanner-close" onclick="stopScanner()">Close Camera</button>
</div>
</body>
</html>
