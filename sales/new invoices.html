<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    (function() {
        const auth = sessionStorage.getItem("sbc_auth");
        const isLoginPage = window.location.pathname.includes("login.html");

        if (auth !== "true" && !isLoginPage) {
            const repoPath = "/Suburban-Brewing-Company-Portal/";
            window.location.replace(repoPath + "login.html");
        }
    })();
  </script>
  
  <meta charset="UTF-8" />
  <title>Suburban Brewing Co. | New Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Suburban Brewing">
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">
  
   <link rel="icon" type="image/png" href="../logo.png">
<link rel="apple-touch-icon" href="../logo.png">
  <link rel="manifest" href="../manifest.json">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    
    :root {
      --bg: #f8fafc;
      --sidebar: #0f172a; /* Dark Navy */
      --accent: #2563eb;
      --text: #1f2937;
      --ready: #10b981;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', -apple-system, system-ui, sans-serif;
      display: flex;
      min-height: 100vh;
    }

    /* =========================================
       SIDEBAR STYLES (EXACT INDEX MATCH)
       ========================================= */
    .sidebar { 
      width: 260px; 
      background: var(--sidebar); 
      color: #fff; 
      padding: 24px 0; 
      flex-shrink: 0; 
      position: fixed; 
      height: 100vh; 
      overflow-y: auto; 
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    /* Header: 20px, Single Line */
    .sidebar h2 { 
      margin: 0 24px 32px; 
      font-size: 20px; 
      font-weight: 800; 
      color: #fff; 
      white-space: nowrap; 
      border-bottom: none;
      padding-bottom: 0;
    }

    /* COLLAPSIBLE HEADERS */
    .nav-section-header {
      font-size: 11px; 
      text-transform: uppercase; 
      color: #94a3b8; 
      margin: 18px 24px 8px; 
      font-weight: 700; 
      letter-spacing: 1px; 
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      user-select: none;
    }
    .nav-section-header:hover { color: #fff; }

    .chevron { transition: transform 0.3s ease; font-size: 10px; }
    .collapsed .chevron { transform: rotate(-90deg); }

    .collapsible-content {
      max-height: 2000px; 
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
      opacity: 1;
    }
    .collapsible-content.collapsed { max-height: 0; opacity: 0; }

    /* LINKS */
    .nav-link { 
      display: flex; 
      align-items: center; 
      padding: 10px 24px; 
      color: #64748b; 
      text-decoration: none; 
      font-size: 14px; 
      transition: 0.2s; 
      border-left: 4px solid transparent;
    }
    .nav-link:hover, .nav-link.active { color: #fff; background: #1e293b; }
    .nav-link.active { border-left-color: var(--accent); color: #fff; }

    /* LOGOUT LINK STYLE */
    .logout-link { 
      margin-top: 12px; 
      color: #f87171 !important; 
      border-left: 4px solid transparent; 
      transition: all 0.2s ease; 
      cursor: pointer; 
    }
    .logout-link:hover { 
      background: #450a0a !important; 
      color: #fee2e2 !important; 
      border-left-color: #ef4444; 
    }
    
    /* ‚ö†Ô∏è ICON SPACING FIX */
    .logout-link span.icon { 
        margin-right: 12px; 
        font-size: 16px; 
    }

    /* ===== MAIN ===== */
    .main {
      margin-left: 260px;
      padding: 40px 40px 0 40px; 
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .section-heading {
      font-size: 18px;
      font-weight: 700;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }

    /* ===== INVOICE PAGE ===== */
    .invoice-page {
      background: #fff;
      width: 8.5in;
      min-height: 11in;
      margin: 0 auto;
      padding: 0.75in;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
    }

    .invoice-header {
      display: flex;
      gap: 24px;
      align-items: center;
    }

    .invoice-header img {
      width: 120px;
    }

    .invoice-company-info {
      font-size: 13px;
      line-height: 1.6;
    }

    .invoice-title {
      text-align: center;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 2px;
      margin: 16px 0 6px;
    }

    .invoice-divider {
      height: 1px;
      background: #111;
      margin-bottom: 14px;
    }

    /* ===== CUSTOMER + META ===== */
    .invoice-meta-row {
      display: flex;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .customer-block {
      max-width: 60%;
    }

    .customer-search {
      width: 100%;
      font-size: 12px;
      padding: 4px 6px;
    }

    .customer-name {
      font-weight: 700;
      font-size: 13px;
    }

    .customer-address {
      font-size: 12px;
      line-height: 1.3;
    }

    .invoice-meta {
      margin-left: auto;
      text-align: right;
      font-size: 12px;
      min-width: 220px;
    }

    .meta-line {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-bottom: 6px;
    }

    #barcode {
      display: block;
      margin-left: auto;
      margin-top: 6px;
    }

    /* ===== PRODUCT TABLE ===== */
    table.invoice-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }

    table.invoice-table th,
    table.invoice-table td {
      border: 1px solid #000;
      padding: 6px;
      vertical-align: top;
    }

    table.invoice-table th {
      background: #f3f4f6;
      font-weight: 700;
    }

    .type-checkboxes label {
      display: block;
      font-size: 11px;
      white-space: nowrap;
    }

    .qty-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .add-product-btn {
      font-size: 11px;
      padding: 4px 8px;
      margin-top: 6px;
    }

    .product-suggestions div {
      background: #fff;
      border: 1px solid #ddd;
      padding: 4px;
      cursor: pointer;
    }

    .product-suggestions div:hover {
      background: #f3f4f6;
    }
    .type-checkboxes em {
      color: #9ca3af;
      font-style: normal;
    }

    .type-checkboxes span {
      font-weight: 600;
    }
    
    /* ===== INVOICE FOOTER (Inside Paper) ===== */
    .invoice-footer {
      padding-top: 12px;
      border-top: 1px solid #000;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 0.5px;
      margin-top: auto; 
    }

    .footer-message {
      text-transform: uppercase;
    }
    .invoice-action-bar {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
      margin-bottom: 50px; 
    }

    /* Base button style */
    .invoice-btn {
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      background: #2563eb;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      appearance: none;
    }

    .invoice-btn:hover {
      background: #1d4ed8;
    }

    .invoice-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    /* ===== PRICE OVERRIDE STYLES ===== */
    .price-edit-input {
        width: 70px;
        padding: 4px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        color: #4b5563;
        background: #f3f4f6; /* Grey/Locked look */
        cursor: not-allowed;
        transition: all 0.2s ease;
    }

    .price-edit-input.unlocked {
        background: #ffffff;
        border-color: #f59e0b; /* Amber warning border */
        color: #b45309;
        cursor: text;
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    /* --- GLOBAL FOOTER STYLES (EXACT INDEX MATCH) --- */
    .app-footer {
        margin-top: auto;
        padding: 8px 0 !important; 
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #94a3b8; 
        font-size: 11px !important;
        font-weight: 500;
        line-height: 1.2 !important;
        min-height: 35px;
        margin-bottom: 10px;
        width: 100%;
    }

    .footer-links a {
        color: #94a3b8;
        text-decoration: none;
        margin-left: 20px;
        transition: color 0.2s ease;
    }

    .footer-links a:hover {
        color: #2563eb;
        text-decoration: underline;
    }

    .system-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-left: 15px;
        padding-left: 15px;
        border-left: 1px solid #cbd5e1;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background-color: #10b981; 
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
        70% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    /* ===== PRINT LAYOUT FIX ===== */
    @media print {
      body { margin: 0; background: #fff; }
      .sidebar, .header-bar, #save-invoice-btn, .invoice-action-bar, #menu-toggle, .app-footer { display: none !important; }
      .main { margin: 0; padding: 0; }
      .invoice-page { width: 7.75in; padding: 0.5in; box-shadow: none; display: flex; flex-direction: column; min-height: 10in; }
      table.invoice-table { width: 100%; table-layout: fixed; }
      table.invoice-table th, table.invoice-table td { font-size: 11px; padding: 5px; }
      .price-edit-input { border: none; background: transparent; padding: 0; color: #000; width: auto; text-align: right; }
      .invoice-footer { margin-top: auto; }
    }
    
    /* ===== BARCODE COLUMN OPTIMIZATION ===== */
.invoice-table td:nth-child(5) { 
    width: 35% !important; /* Increased from 30% */
    padding: 12px !important; 
    vertical-align: middle;
    text-align: center;
}

.invoice-table svg.line-barcode { 
    max-width: 100%; 
    height: auto; 
    /* Ensures the barcode doesn't shrink when printed */
    min-width: 180px; 
}

    /* --- MOBILE & TABLET DRAWER LOGIC --- */
    #menu-toggle { display: none; }
    .menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(2px); }

    @media (max-width: 1024px) {
      .sidebar { left: -260px; }
      .sidebar.open { left: 0; }
      .main { margin-left: 0 !important; padding: 15px !important; width: 100%; }
      .menu-overlay.active { display: block; }
      
      #menu-toggle {
        display: flex; position: fixed; bottom: 25px; right: 25px;
        width: 60px; height: 60px; background: var(--accent); color: white;
        border-radius: 50%; justify-content: center; align-items: center;
        font-size: 24px; z-index: 10001; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: none;
      }

      .main { overflow-x: auto; -webkit-overflow-scrolling: touch; }
      .invoice-page { margin: 0; box-shadow: none; border: 1px solid #e5e7eb; }
      .invoice-action-bar { flex-direction: column; gap: 10px; width: 100%; }
      .invoice-btn { width: 100%; padding: 15px; }
    }
    
    .logout-link { margin-top: 12px; color: #f87171 !important; border-left: 4px solid transparent; transition: all 0.2s ease; cursor: pointer; }
    .logout-link:hover { background: #450a0a !important; color: #fee2e2 !important; border-left-color: #ef4444; }
    .logout-link span.icon { margin-right: 12px; font-size: 16px; }
  </style>
</head>
<body>
  <button id="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
  <div id="menu-overlay" class="menu-overlay" onclick="toggleMobileMenu()"></div>
  
  <aside class="sidebar">
    <h2>SUBURBAN BREWING</h2>
    <div class="nav-section-header">
      <span>System</span>
    </div>
    
    <a href="#" class="nav-link logout-link" onclick="handleLogout()">
      <span class="icon">üö™</span>
      <span>Logout of Portal</span>
    </a>

    <script>
     function handleLogout() {
       sessionStorage.removeItem("sbc_auth");
       const repoPath = "/Suburban-Brewing-Company-Portal/";
       window.location.replace(repoPath + "login.html");
    }
    </script>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-main', this)">
      <span>Main Menu</span><span class="chevron">‚ñº</span>
    </div>
    <div id="grp-main" class="collapsible-content">
      <a href="../index.html" class="nav-link"><span>Command Center</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-sample', this)">
      <span>Samplings</span><span class="chevron">‚ñº</span>
    </div>
    <div id="grp-sample" class="collapsible-content">
      <a href="../Samplings/Schedule-Sampling.html" class="nav-link"><span>Schedule Sampling</span></a>
      <a href="../Samplings/sampling-calendar.html" class="nav-link"><span>Sampling Calendar</span></a>
      <a href="../Samplings/sampling-report.html" class="nav-link"><span>Log Sampling Report</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-sales', this)">
      <span>Sales</span><span class="chevron">‚ñº</span>
    </div>
    <div id="grp-sales" class="collapsible-content">
      <a href="Marketing.html" class="nav-link"><span>Marketing Hub</span></a>
      <a href="sales-opportunities.html" class="nav-link"><span>Sales Opportunities</span></a>
      <a href="leads.html" class="nav-link"><span>AI Sales Leads</span></a>
      <a href="invoice-search.html" class="nav-link"><span>Invoice Search</span></a>
      <a href="deliveries.html" class="nav-link"><span>Delivery Tracking</span></a>
      <a href="new invoices.html" class="nav-link active"><span>New Invoice</span></a>
    </div>

    <div class="nav-section-header" onclick="toggleGroup('grp-inv', this)">
      <span>Inventory</span><span class="chevron">‚ñº</span>
    </div>
    <div id="grp-inv" class="collapsible-content">
      <a href="../inventory/Ingredient-inventory.html" class="nav-link"><span>Ingredient Inventory</span></a>
      <a href="../inventory/brewery.html" class="nav-link"><span>Packaged Inventory</span></a>
      <a href="../inventory/wholesaler-inventory.html" class="nav-link"><span>Wholesaler Inventory</span></a>
      <a href="../inventory/restaurant-inventory.html" class="nav-link"><span>Restaurant Inventory</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-brew', this)">
      <span>Brewing</span><span class="chevron">‚ñº</span>
    </div>
    <div id="grp-brew" class="collapsible-content">
      <a href="../Brewing/brew-calendar.html" class="nav-link"><span>Brewing Calendar</span></a>
      <a href="../Brewing/Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
      <a href="../Brewing/Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
      <a href="../Brewing/cellar.html" class="nav-link"><span>Cellar Management</span></a>
      <a href="../Brewing/qc-dashboard.html" class="nav-link"><span>QC Dashboard</span></a>
      <a href="../Brewing/packaging.html" class="nav-link"><span>Packaging log</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-rep', this)">
      <span>Reporting & Analytics</span><span class="chevron">‚ñº</span>
    </div>
    <div id="grp-rep" class="collapsible-content">
      <a href="../Reports/Monthly-sales.html" class="nav-link"><span>Monthly Sales Report</span></a>
      <a href="../Reports/ProfitAnalysis.html" class="nav-link"><span>Profit Analysis Report</span></a>
      <a href="../Reports/Route.html" class="nav-link"><span>Sales Route Opt.</span></a>
    </div>
  </aside>

  <main class="main">

    <div class="header-bar">
      <h1>New Invoice</h1>
      <div id="current-date"></div>
    </div>

    <div class="section-heading">Invoice Details</div>

    <section class="invoice-page">

      <header class="invoice-header">
        <img src="../background.jpg">
        <div class="invoice-company-info">
          <strong>Suburban Brewing Company</strong><br>
          3041 Horseshoe Pike Suite 120 & 130<br>
          Honey Brook, PA 19344<br>
          Sales Rep: Remy Davis ¬∑ 908-642-1019 ¬∑ Remyjdavis90@gmail.com
        </div>
      </header>

      <div class="invoice-title">INVOICE</div>
      <div class="invoice-divider"></div>

      <section class="invoice-meta-row">
        <div class="customer-block">
          <div style="position: relative;">
  <input id="customer-search" class="customer-search" placeholder="Search customer or type address..." autocomplete="off" style="width:100%;">
  <div id="search-results" style="position: absolute; width: 100%; background: white; border: 1px solid #cbd5e1; z-index: 5000; max-height: 300px; overflow-y: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.1);"></div>
</div>
          <div id="customer-display" hidden>
            <div id="customer-name" class="customer-name"></div>
            <div id="customer-address" class="customer-address"></div>
          </div>
        </div>

        <div class="invoice-meta">
          <div class="meta-line">
            <strong>Date:</strong>
            <span id="invoice-date"></span>
          </div>
          <div class="meta-line" id="invoice-number-row">
            <strong>Invoice #:</strong>
            <input id="invoice-number" style="width:80px;">
          </div>
          <svg id="barcode"></svg>
        </div>
      </section>

      <table class="invoice-table">
        <thead>
          <tr>
            <th style="width:24%;">Product</th>
            <th style="width:16%;">Type</th>
            <th style="width:12%;">Quantity</th>
            <th style="width:10%;">Price</th>
            <th style="width:26%;">Barcode</th>
            <th style="width:12%;">Line Total</th>
          </tr>
        </thead>
        <tbody id="product-body"></tbody>
      </table>
      
      <div style="margin-top:16px; text-align:right; font-size:13px;">
        <strong>Subtotal:</strong>
        <span id="invoice-subtotal">$0.00</span>
      </div>
      <div id="discount-row" style="margin-top:6px; text-align:right; font-size:13px; display:none;">
        <strong>Discount (10%):</strong>
        <span id="invoice-discount">$0.00</span>
      </div>

      <div id="deposit-row" style="margin-top:6px; text-align:right; font-size:13px; display:none;">
        <strong>Keg Deposit:</strong>
        <span id="invoice-deposit">$0.00</span>
      </div>

      <div id="tax-row" style="margin-top:6px; text-align:right; font-size:13px; display:none;">
        <strong>Sales Tax (6%):</strong>
        <span id="invoice-tax">$0.00</span>
      </div>

      <div style="margin-top:6px; text-align:right; font-size:14px;">
        <strong>Total:</strong>
        <span id="invoice-total">$0.00</span>
      </div>
      
      <div id="invoice-footer" class="invoice-footer"></div>
      <div style="margin-top:20px; text-align:right;">  
      </div>

    </section>
    <div class="invoice-action-bar">
      <button id="save-invoice-btn" class="invoice-btn primary">
        Save Invoice
      </button>
      <button id="print-invoice-btn" class="invoice-btn">
        Print
      </button>

      <button id="email-invoice-btn" class="invoice-btn">
        Email
      </button>

    </div>
    
    <footer class="app-footer">
        <div class="footer-left">
            <span>&copy; <span id="copyright-year">2026</span> Suburban Brewing Co.</span>
            <span class="system-status">
                <span class="status-dot"></span>
                System Operational
            </span>
        </div>
        <div class="footer-links">
            <span>Portal v2.5</span>
            <a href="https://github.com/remyjdavis/Suburban-Brewing-Company-Portal" target="_blank">Repo</a>
            <a href="#" onclick="Swal.fire({
                title: 'App Support', 
                html: '<b>Remy Davis</b><br>remyjdavis90@gmail.com', 
                icon: 'info',
                confirmButtonColor: '#2563eb'
            })">Support</a>
            <a href="#" onclick="location.reload()">Refresh Data</a>
        </div>
    </footer>

  </main>
  <script>
    // ===== GLOBAL =====
    const MANAGER_PIN = "19344"; // üîí CHANGE THIS TO YOUR DESIRED PIN
    let overrideLogs = []; // Stores records of who changed what
    const API_URL = "https://script.google.com/macros/s/AKfycbzWSIh-msRqg_tqU3l2jGXlxRIgxZKE-tcVNYadAGb9jKtDV_VZuLS-6hxkMkqdaJoj/exec";
    
    // --- SIDEBAR TOGGLE LOGIC ---
    function toggleGroup(contentId, headerEl) {
      const content = document.getElementById(contentId);
      content.classList.toggle('collapsed');
      headerEl.classList.toggle('collapsed');
    }

    // --- MOBILE DRAWER TOGGLE ---
    function toggleMobileMenu() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('menu-overlay');
        const btn = document.getElementById('menu-toggle');
        const isOpen = sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
        
        // Prevent background scroll when menu is open
        document.body.style.overflow = isOpen ? 'hidden' : '';
        btn.innerText = isOpen ? '‚úï' : '‚ò∞';
    }

    // ===== GLOBAL =====
    let currentInvoiceNumber = "";
    let invoiceNumberValue = "";
    let addProductButtonRow = null;
    let customers = [];
    let selectedCustomer = null;
    let products = [];
    let groupedProducts = {};
    const KEG_DEPOSITS = {
      "1/2 Keg": 30,
      "1/6 Keg": 30
    };
    /* ===== PRODUCT IS ALREADY SELECTED FUNCTION ===== */
    function isProductAlreadySelected(productName, currentRow) {
      let found = false;

      document.querySelectorAll("#product-body tr").forEach(row => {
        if (row === currentRow) return;

        const input = row.querySelector(".product-input");
        if (input && input.value === productName) {
          found = true;
        }
      });

      return found;
    }

    document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toLocaleDateString();
    document.getElementById("current-date").textContent = today;
    document.getElementById("invoice-date").textContent = today;
    
    document.getElementById('copyright-year').innerText = new Date().getFullYear();
   document.getElementById("email-invoice-btn").addEventListener("click", async () => {
    // 1. Validation: Ensure the invoice was saved first to get the fileId
    if (!window.currentInvoiceFileId) {
        Swal.fire("Save First", "You must save the invoice before emailing the team.", "warning");
        return;
    }

    // 2. UI Feedback
    Swal.fire({
        title: 'Attaching PDF...',
        text: 'The backend is fetching the file and notifying Eric, Lambert, and Cassandra.',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    // 3. Build Payload
    const payload = {
        fileId: window.currentInvoiceFileId,
        invoiceNumber: window.currentInvoiceNumber,
        customer: selectedCustomer ? selectedCustomer.name : "Internal Order",
        total: document.getElementById("invoice-total").textContent.replace("$", "")
    };

    try {
        // 4. Call the Backend email action
        const response = await fetch(`${API_URL}?action=emailInvoice&data=${encodeURIComponent(JSON.stringify(payload))}`);
        const result = await response.json();

        if (result.success) {
            Swal.fire({
                title: "Email Sent!",
                text: "The invoice has been sent as a PDF attachment to the team.",
                icon: "success",
                confirmButtonColor: "#2563eb"
            });
        } else {
            throw new Error(result.error || "Server failed to send email");
        }
    } catch (err) {
        Swal.fire("Error", "Failed to send email: " + err.message, "error");
    }
});
    loadCustomers();
    loadProducts();
    addProductRow();
    loadInventory();
    
    // Auto-close menu when a link is clicked on mobile
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => {
            if (window.innerWidth <= 1024) toggleMobileMenu();
        });
    });

    // Existing Sidebar Logic (Keep active group expanded)
    const activeLink = document.querySelector('.nav-link.active');
    if (activeLink) {
        const parentGroup = activeLink.closest('.collapsible-content');
        if (parentGroup) {
            parentGroup.classList.remove('collapsed');
            const header = parentGroup.previousElementSibling;
            if (header) header.classList.remove('collapsed');
        }
    }
});

    /* ===== LOAD CUSTOMERS FUNCTION ===== */
    function loadCustomers() {
      fetch(`${API_URL}?action=getCustomers`)
        .then(r => r.json())
        .then(d => customers = d || []);
    }

    let searchTimeout;
    document.getElementById("customer-search").addEventListener("input", function() {
        const resultsBox = document.getElementById("search-results");
        const val = this.value.trim();

        resultsBox.innerHTML = "";
        resultsBox.style.display = val ? "block" : "none";
        
        if (!val) return;

        // 1. Local Customer Match
        const matches = customers.filter(c => c.name.toLowerCase().includes(val.toLowerCase()));
        matches.forEach(c => {
            const div = document.createElement("div");
            div.style.padding = "10px"; div.style.cursor = "pointer"; div.style.borderBottom = "1px solid #eee";
            div.innerHTML = `üë§ <strong>${c.name}</strong> <small style="color:blue">(In Sheet)</small>`;
            div.onclick = () => { resultsBox.innerHTML = ""; selectCustomer(c); };
            resultsBox.appendChild(div);
        });

        // 2. Global Address Search (OSM)
        clearTimeout(searchTimeout);
        if (val.length >= 5) {
            searchTimeout = setTimeout(async () => {
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&addressdetails=1&namedetails=1&limit=4`);
                    const data = await resp.json();
                    
                    data.forEach(item => {
                        const div = document.createElement("div");
                        div.style.padding = "10px"; div.style.cursor = "pointer"; div.style.borderBottom = "1px solid #eee";
                        div.innerHTML = `üìç ${item.display_name}`;
                        
                      div.onclick = () => {
                            const a = item.address;
                            
                            // 1. Extract Business Name from map data
                            const businessName = item.name || a.amenity || a.shop || a.restaurant || "";
                            const street = `${a.house_number || ''} ${a.road || ''}`.trim();

                            // 2. Open modal first (empty string stops the clearing logic)
                            openNewCustomerModal(""); 

                            // 3. Inject data into modal
                            document.getElementById("new-cust-name").value = businessName;
                            document.getElementById("new-cust-address").value = street;
                            document.getElementById("new-cust-city").value = a.city || a.town || a.village || "";
                            document.getElementById("new-cust-state").value = a.state || "";
                            document.getElementById("new-cust-zip").value = a.postcode || "";
                            
                            resultsBox.innerHTML = "";
                            resultsBox.style.display = "none";
                        };
                        resultsBox.appendChild(div);
                    }); // <--- CLOSE FOR-EACH
                } catch (e) { console.error("Search error", e); }
            }, 500); // <--- CLOSE SET-TIMEOUT
        }
    });
    /* ===== SELECT CUSTOMERS FUNCTION ===== */
    function selectCustomer(c) {
    selectedCustomer = c;
    selectedCustomer.name = c.name; // <--- ADD THIS LINE to ensure the email payload has the name

    selectedCustomer.paymentMethod = c.Payment || c.payment || c.paymentMethod || "";

    updateInvoiceFooter();

    document.querySelectorAll(".suggestion").forEach(e => e.remove());
    document.getElementById("customer-search").style.display = "none";
    document.getElementById("customer-display").hidden = false;

    document.getElementById("customer-name").textContent = c.name;

    // --- CLEAN ADDRESS ---
    const rawLines = (c.address || "")
        .split(/,|\n/)
        .map(l => l.trim())
        .filter(Boolean);

    const seen = new Set();
    const cleanLines = rawLines.filter(line => {
        const normalized = line.toLowerCase();
        if (
            normalized === c.name.toLowerCase() ||
            seen.has(normalized)
        ) {
            return false;
        }
        seen.add(normalized);
        return true;
    });

    document.getElementById("customer-address").innerHTML =
        cleanLines.join("<br>");
        
    // Toggle sales tax visibility
    const taxRow = document.getElementById("tax-row");
    if (taxRow) {
        taxRow.style.display = c.type === "Restaurant" ? "block" : "none";
    }
    recalcInvoiceTotals();
}
    /* ===== FOOTER SELECTION FUNCTION ===== */
    function updateInvoiceFooter() {
      const footer = document.getElementById("invoice-footer");
      if (!footer) return;

      // Always reset
      footer.innerHTML = "";

      if (!selectedCustomer) return;

      let message = "";

      switch (selectedCustomer.paymentMethod) {
        case "Check":
          message = "MAKE CHECKS PAYABLE TO SUBURBAN BREWING COMPANY";
          break;

        case "Fintech":
          message = "PAID THROUGH FINTECH";
          break;

        default:
          message = "";
      }

      if (!message) return;

      footer.innerHTML = `
    <div class="footer-message">
      ${message}
    </div>
  `;
    }

    /* ===== INVOICE BARCODE ===== */
    document.getElementById("invoice-number").addEventListener("change", e => {
      const val = e.target.value.trim();
      if (!val) return;

      currentInvoiceNumber = val; // ‚úÖ STORE IT

      document.getElementById("invoice-number-row").innerHTML =
        `<strong>Invoice #:</strong> <span id="invoice-number-text">${val}</span>`;

      JsBarcode("#barcode", val, {
        height: 30,
        displayValue: false
      });
    });

    /* ===== LOAD PRODUCTS FUNCTION ===== */
    function loadProducts() {
      fetch(`${API_URL}?action=getProducts`)
        .then(r => r.json())
        .then(data => {
          products = data || [];
          groupedProducts = {};

          products.forEach(p => {
            if (!groupedProducts[p.name]) {
              groupedProducts[p.name] = {};
            }

            groupedProducts[p.name][p.package] = {
              price: p.price,
              sku: p.sku || ""
            };
          });
        });
    }

    /* ===== LOAD INVENTORY FUNCTION ===== */
    let inventoryMap = {};

    function loadInventory() {
      fetch(`${API_URL}?action=getBreweryInventory`)
        .then(r => r.json())
        .then(data => {
          inventoryMap = {};

          data.forEach(product => {
            const name = product.product;

            if (!inventoryMap[name]) inventoryMap[name] = {};

            product.packages.forEach(pkg => {
              inventoryMap[name][pkg.type] = Number(pkg.qty) || 0;
            });
          });

          console.log("INVENTORY MAP READY:", inventoryMap);
        });
    }

    /* ===== ADD PRODUCT ROW FUNCTION ===== */
    function addProductRow() {
      const tbody = document.getElementById("product-body");

      /* ----- CREATE PRODUCT ROW ----- */
      const tr = document.createElement("tr");
      tr.innerHTML = `
    <td>
      <input class="product-input" placeholder="Product..." autocomplete="off">
      <div class="product-suggestions"></div>
    </td>
    <td class="type-checkboxes"></td>
    <td class="qty-group"></td>
    <td class="price-cell"></td>
    <td class="barcode-cell"></td>
    <td class="line-total">$0.00</td>
  `;

      /* ----- REMOVE BUTTON ROW TEMPORARILY ----- */
      if (addProductButtonRow) {
        addProductButtonRow.remove();
      }

      /* ----- APPEND PRODUCT ROW ----- */
      tbody.appendChild(tr);

      /* ----- RECREATE / MOVE BUTTON ROW ----- */
      addProductButtonRow = document.createElement("tr");
      addProductButtonRow.innerHTML = `
    <td colspan="6" style="text-align:left;">
      <button class="add-product-btn">+ Add another product</button>
    </td>
  `;

      addProductButtonRow
        .querySelector("button")
        .onclick = addProductRow;

      tbody.appendChild(addProductButtonRow);

      /* ----- WIRE LOGIC ----- */
      wireProductRow(tr);
    }

    /* ===== WIRE PRODUCT ROW FUNCTION ===== */
    function wireProductRow(row) {
      const input = row.querySelector(".product-input");
      const suggestions = row.querySelector(".product-suggestions");

      input.addEventListener("input", () => {
        suggestions.innerHTML = "";
        const val = input.value.toLowerCase();
        if (!val) return;

        Object.keys(groupedProducts)
          .filter(p => p.toLowerCase().includes(val))
          .forEach(p => {
            const d = document.createElement("div");
            d.textContent = p;
            d.onclick = () => selectProduct(row, p);
            suggestions.appendChild(d);
          });
      });
    }
    /* ===== SELECT PRODUCT FUNCTION ===== */
    function selectProduct(row, product) {

      function createLowBadge(stock) {
        const badge = document.createElement("span");
        badge.textContent = `LOW (${stock})`;
        badge.style.background = "#fde68a";
        badge.style.color = "#92400e";
        badge.style.fontSize = "10px";
        badge.style.padding = "1px 4px";
        badge.style.marginLeft = "6px";
        badge.style.borderRadius = "4px";
        return badge;
      }

      // ‚ùå PREVENT DUPLICATES
      if (isProductAlreadySelected(product, row)) {
        alert(`"${product}" is already on this invoice.\nPlease adjust quantities in the existing row.`);
        row.querySelector(".product-input").value = "";
        row.querySelector(".product-suggestions").innerHTML = "";
        return;
      }

      row.querySelector(".product-input").value = product;
      row.querySelector(".product-suggestions").innerHTML = "";

      const typesCell = row.querySelector(".type-checkboxes");
      const qtyCell = row.querySelector(".qty-group");
      const barcodeCell = row.querySelector(".barcode-cell");

      typesCell.innerHTML = "";
      qtyCell.innerHTML = "";
      barcodeCell.innerHTML = "";

      ["Case", "1/2 Keg", "1/6 Keg"].forEach(type => {
        if (groupedProducts[product][type] === undefined) return;

        const stock =
          inventoryMap[product] &&
          inventoryMap[product][type] !== undefined ?
          Number(inventoryMap[product][type]) :
          null;

        const label = document.createElement("label");
        label.style.display = "block";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = type;

        // ‚ùå OUT OF STOCK
        if (stock === 0) {
          checkbox.disabled = true;
          label.style.opacity = "0.5";
          label.appendChild(checkbox);
          label.append(` ${type} ‚Äî Out of Stock`);
        }

        // ‚ö†Ô∏è LOW STOCK
        else if (stock !== null && stock < 10) {
          label.appendChild(checkbox);
          label.append(` ${type} `);
          label.appendChild(createLowBadge(stock));
        }

        // ‚úÖ NORMAL
        else {
          label.appendChild(checkbox);
          label.append(` ${type}`);
        }

        // üîπ LIFECYCLE NOTE (FIXED ‚Äî label exists, scope correct)
        const lifecycleNote = getLifecycleWarning(product, type);
        if (lifecycleNote) {
          const note = document.createElement("div");
          note.style.fontSize = "10px";
          note.style.color = "#6b7280";
          note.textContent = lifecycleNote;
          label.appendChild(note);
        }

        checkbox.onchange = () => updateQuantities(row, product);
        typesCell.appendChild(label);
      });
    }

    /* ===== LIFECYLCE WARNING FUNCTION ===== */
    function getLifecycleWarning(product, type) {
      const lifecycle = products.find(
        p => p.name === product && p.package === type
      )?.lifecycle;

      if (lifecycle === "Seasonal") return "‚ö† Seasonal Item";
      if (lifecycle === "Rotating") return "‚è≥ Rotating Item";
      return null;
    }

    /* ===== UPDATE QUANTITIES FUNCTION (WITH SECURE OVERRIDE) ===== */
    function updateQuantities(row, product) {
      const qtyCell = row.querySelector(".qty-group");
      const priceCell = row.querySelector(".price-cell");
      const barcodeCell = row.querySelector(".barcode-cell");

      const checkboxes = row.querySelectorAll(".type-checkboxes input");

      checkboxes.forEach(cb => {
        const type = cb.value;
        const existingQty = qtyCell.querySelector(`[data-type="${type}"]`);
        const existingPrice = priceCell.querySelector(`[data-type="${type}"]`);

        // ADD TYPE
        if (cb.checked && !existingQty) {
          /* ---------- QTY ---------- */
          const qtyWrap = document.createElement("div");
          qtyWrap.dataset.type = type;
          qtyWrap.style.display = "flex";
          qtyWrap.style.justifyContent = "space-between";
          qtyWrap.style.alignItems = "center";
          qtyWrap.style.gap = "6px";
          qtyWrap.style.marginBottom = "4px";

          const qtyLabel = document.createElement("span");
          qtyLabel.textContent = type + ":";

          const qtyInput = document.createElement("input");
          qtyInput.type = "number";
          qtyInput.min = 0;
          qtyInput.value = 0;
          qtyInput.style.width = "60px";
          qtyInput.style.padding = "8px";
          qtyInput.style.fontSize = "16px"; 
          
          qtyInput.oninput = () => {
            const max = inventoryMap[product]?.[type];
            if (max !== undefined && Number(qtyInput.value) > max) {
              qtyInput.value = max;
              alert(`Only ${max} units of ${product} (${type}) available`);
            }
            recalcLine(row, product);
          };

          qtyWrap.appendChild(qtyLabel);
          qtyWrap.appendChild(qtyInput);
          qtyCell.appendChild(qtyWrap);

          /* ---------- PRICE (SECURE OVERRIDE LOGIC) ---------- */
          const priceWrap = document.createElement("div");
          priceWrap.dataset.type = type;
          priceWrap.style.marginBottom = "4px"; // Align with qty inputs
          
          const defaultPrice = groupedProducts[product][type].price;

          const priceInput = document.createElement("input");
          priceInput.type = "number";
          priceInput.step = "0.01";
          priceInput.className = "price-edit-input"; // Default: Locked
          priceInput.value = defaultPrice.toFixed(2);
          priceInput.readOnly = true; // Start Locked
          
          // Store original for logging purposes later
          priceInput.dataset.original = defaultPrice;
          priceInput.dataset.type = type;

          // üîí DOUBLE CLICK TO UNLOCK
          priceInput.ondblclick = async () => {
              if(!priceInput.readOnly) return; // Already unlocked

              const { value: pin } = await Swal.fire({
                  title: 'Manager Override',
                  text: 'Enter PIN to unlock price:',
                  input: 'password',
                  inputAttributes: { autocapitalize: 'off', autocorrect: 'off' },
                  showCancelButton: true,
                  confirmButtonColor: '#2563eb',
                  confirmButtonText: 'Unlock'
              });

              if (pin === MANAGER_PIN) {
                  priceInput.readOnly = false;
                  priceInput.classList.add("unlocked");
                  priceInput.focus();
                  priceInput.select();
                  
                  const Toast = Swal.mixin({
                      toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
                  });
                  Toast.fire({ icon: 'warning', title: 'Price Unlocked. Change will be logged.' });
              } else if (pin) {
                  Swal.fire('Error', 'Incorrect PIN', 'error');
              }
          };

          // Recalculate invoice when price changes
          priceInput.oninput = () => {
             recalcLine(row, product);
          };

          priceWrap.appendChild(priceInput);
          priceCell.appendChild(priceWrap);

        /* ---------- BARCODE (CASE ONLY) ---------- */
        if (type === "Case") {
            barcodeCell.innerHTML = "";
            const sku = groupedProducts[product][type].sku;
            if (!sku) {
                barcodeCell.innerHTML = `<em style="font-size:10px;color:#6b7280;">SKU missing</em>`;
            } else {
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.classList.add("line-barcode");
                barcodeCell.appendChild(svg);
                JsBarcode(svg, sku, { 
                    format: "CODE128", 
                    width: 2.5, 
                    height: 65, 
                    margin: 10, 
                    displayValue: true, 
                    fontSize: 14, 
                    fontOptions: "bold" 
                });
            }
        }
    }
        
        // REMOVE TYPE logic
    if (!cb.checked && existingQty) {
      existingQty.remove();
      if (existingPrice) existingPrice.remove();
      if (type === "Case") barcodeCell.innerHTML = "";
    }
  }); // This closes the forEach
      recalcLine(row, product);
} // This closes the function
    
    /* ===== FOCUS FIRST PRODUCT ROW FUNCTION ===== */
    function focusFirstProductRow() {
      const firstProductInput = document.querySelector(".product-input");
      if (firstProductInput) {
        firstProductInput.focus();
      }
    }

    /* ===== RECALCLINE FUNCTION (UPDATED) ===== */
    function recalcLine(row, product) {
      const totalCell = row.querySelector(".line-total");
      totalCell.innerHTML = "";

      let rowTotal = 0;

      row.querySelectorAll(".qty-group div").forEach(div => {
        const type = div.dataset.type;
        
        // 1. Get Quantity
        const qty = Number(div.querySelector("input").value || 0);
        
        // 2. Get Price (From Input Field)
        const priceInput = row.querySelector(`.price-cell input[data-type="${type}"]`);
        const price = priceInput ? Number(priceInput.value) : 0;

        const lineTotal = qty * price;
        rowTotal += lineTotal;

        const line = document.createElement("div");
        line.textContent = `$${lineTotal.toFixed(2)}`;
        line.style.padding = "8px 0"; // Visual alignment
        totalCell.appendChild(line);
      });

      totalCell.dataset.value = rowTotal;
      recalcInvoiceTotals();
    }
    /* ===== RECALC INVOICE TOTAL FUNCTION ===== */
    function recalcInvoiceTotals() {
      let subtotal = 0;

      // ----- PRODUCT SUBTOTAL -----
      document.querySelectorAll(".line-total").forEach(cell => {
        if (cell.dataset.value !== undefined) {
          subtotal += Number(cell.dataset.value);
        }
      });

      // ----- CASE DISCOUNT (10%) -----
      const totalCases = getTotalCaseQty();
      let discount = 0;

      if (totalCases >= 10) {
        discount = subtotal * 0.10;
        document.getElementById("discount-row").style.display = "block";
      } else {
        document.getElementById("discount-row").style.display = "none";
      }

      document.getElementById("invoice-discount").textContent =
        "-$" + discount.toFixed(2);

      const discountedSubtotal = subtotal - discount;

      // ----- KEG DEPOSIT -----
      const deposit = recalcKegDeposit();

      // ----- SALES TAX -----
      const isRestaurant =
        selectedCustomer && selectedCustomer.type === "Restaurant";

      const taxRate = 0.06;
      const tax = isRestaurant ? discountedSubtotal * taxRate : 0;

      // ----- FINAL TOTAL -----
      const total = discountedSubtotal + tax + deposit;

      // ----- UPDATE UI -----
      document.getElementById("invoice-subtotal").textContent =
        "$" + subtotal.toFixed(2);

      document.getElementById("invoice-tax").textContent =
        "$" + tax.toFixed(2);

      document.getElementById("invoice-total").textContent =
        "$" + total.toFixed(2);
    }

    /* ===== RECALC KEG DEPOSIT FUNCTION ===== */
    function recalcKegDeposit() {
      let depositTotal = 0;

      document.querySelectorAll("#product-body tr").forEach(row => {
        if (!row.querySelector(".qty-group")) return;

        row.querySelectorAll(".qty-group div").forEach(div => {
          const type = div.dataset.type;
          const qty = Number(div.querySelector("input").value || 0);

          if (KEG_DEPOSITS[type] && qty > 0) {
            depositTotal += qty * KEG_DEPOSITS[type];
          }
        });
      });

      const depositRow = document.getElementById("deposit-row");

      if (depositTotal > 0) {
        depositRow.style.display = "block";
        document.getElementById("invoice-deposit").textContent =
          "$" + depositTotal.toFixed(2);
      } else {
        depositRow.style.display = "none";
        document.getElementById("invoice-deposit").textContent = "$0.00";
      }

      return depositTotal;
    }
    /* ===== TOTAL CASE QUANTITY FUNCTION ===== */
    function getTotalCaseQty() {
      let total = 0;

      document.querySelectorAll(".qty-group div").forEach(div => {
        if (div.dataset.type === "Case") {
          total += Number(div.querySelector("input").value || 0);
        }
      });

      return total;
    }
    /* ===== MODAL LOGIC ===== */
    function openNewCustomerModal(prefillName = "") {
    // 1. Only check existence if we aren't using map data (prefillName isn't empty)
    if (prefillName !== "") {
        const exists = customers.some(c => c.name.toLowerCase() === prefillName.toLowerCase());
        if (exists) {
            Swal.fire("Note", "This customer is already in your system.", "info");
            return;
        }
    }

    // 2. Show the modal
    document.getElementById("new-customer-modal").style.display = "block";

    // 3. LOGIC: 
    // If prefillName has a value (Manual Add button), reset fields.
    // If prefillName is empty (Map Click), keep fields ready for injection.
    if (prefillName !== "") {
        document.getElementById("new-cust-name").value = prefillName;
        document.getElementById("new-cust-address").value = "";
        document.getElementById("new-cust-city").value = "";
        document.getElementById("new-cust-state").value = "";
        document.getElementById("new-cust-zip").value = "";
    }

    // Always ensure these defaults are set for new entries
    document.getElementById("new-cust-type").value = "Restaurant";
    document.getElementById("new-cust-payment").value = "Check";
}

    function closeNewCustomerModal() {
        document.getElementById("new-customer-modal").style.display = "none";
    }

    /* ===== SAVE NEW CUSTOMER FUNCTION ===== */
    function saveNewCustomer() {
      const name = document.getElementById("new-cust-name").value.trim();
      const street = document.getElementById("new-cust-address").value.trim();
      const city = document.getElementById("new-cust-city").value.trim();
      const state = document.getElementById("new-cust-state").value.trim();
      const zip = document.getElementById("new-cust-zip").value.trim();
      const type = document.getElementById("new-cust-type").value;
      const paymentMethod = document.getElementById("new-cust-payment").value;

      if (!name) {
        alert("Customer name is required");
        return;
      }

      // üîß Build address string (keeps rest of system intact)
      const addressParts = [street, city, state, zip].filter(Boolean);
      const address = addressParts.join(", ");

      const duplicate = customers.some(c =>
        c.name.toLowerCase() === name.toLowerCase()
      );

      if (duplicate) {
        alert("This customer already exists.");
        return;
      }

      const newCustomer = {
        name,
        address,
        type,
        paymentMethod
      };

      fetch(`${API_URL}?action=addCustomer`, {
    method: "POST",
    // FIX: Changing this to text/plain stops the browser from sending an OPTIONS request
    headers: {
        "Content-Type": "text/plain"
    },
    body: JSON.stringify(newCustomer)
})
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            customers.push(newCustomer); // keep local list updated
            closeNewCustomerModal();
            selectCustomer(newCustomer);
            focusFirstProductRow();
          } else {
            alert("Failed to save customer");
          }
        })
        .catch(() => {
          // Fallback (offline-safe)
          customers.push(newCustomer);
          closeNewCustomerModal();
          selectCustomer(newCustomer);
          focusFirstProductRow();
        });
    }
    /* ===== BUILD INVOICE PAYLOAD FUNCTION (WITH LOGGING) ===== */
    function buildInvoicePayload() {
      if (!selectedCustomer) { alert("Select a customer first"); return null; }

      const items = [];
      overrideLogs = []; // Reset logs

      document.querySelectorAll("#product-body tr").forEach(row => {
        const productInput = row.querySelector(".product-input");
        if (!productInput || !productInput.value) return;

        const productName = productInput.value;

        row.querySelectorAll(".qty-group div").forEach(div => {
          const type = div.dataset.type;
          const qty = Number(div.querySelector("input").value || 0);

          if (qty <= 0) return;

          // GRAB PRICE & CHECK FOR OVERRIDE
          const priceInput = row.querySelector(`.price-cell input[data-type="${type}"]`);
          let finalPrice = 0;
          
          if(priceInput) {
              finalPrice = Number(priceInput.value);
              const originalPrice = Number(priceInput.dataset.original);
              
              // üìù LOGGING: If price differs from original
              if(finalPrice !== originalPrice) {
                  const logEntry = `Price Override: ${productName} (${type}) changed from $${originalPrice.toFixed(2)} to $${finalPrice.toFixed(2)}`;
                  overrideLogs.push(logEntry);
              }
          }

          items.push({
            product: productName,
            type: type,
            qty: qty,
            price: finalPrice,
            sku: groupedProducts[productName][type].sku || ""
          });
        });
      });

      if (items.length === 0) { alert("Add at least one product"); return null; }

      const subtotal = Number(document.getElementById("invoice-subtotal").textContent.replace("$", ""));
      const discount = document.getElementById("discount-row").style.display !== "none" ? Number(document.getElementById("invoice-discount").textContent.replace(/[^0-9.-]/g, "")) : 0;
      const deposit = document.getElementById("deposit-row").style.display !== "none" ? Number(document.getElementById("invoice-deposit").textContent.replace("$", "")) : 0;
      const tax = document.getElementById("tax-row").style.display !== "none" ? Number(document.getElementById("invoice-tax").textContent.replace("$", "")) : 0;
      const total = Number(document.getElementById("invoice-total").textContent.replace("$", ""));

      return {
        invoiceNumber: currentInvoiceNumber,
        customer: selectedCustomer.name,
        address: selectedCustomer.address,
        customerType: selectedCustomer.type,
        paymentMethod: selectedCustomer.paymentMethod,
        subtotal, discount, tax, deposit, total,
        items,
        
        // üîí SEND LOGS TO BACKEND
        logs: overrideLogs 
      };
    }
    /* ===============================
       BUTTON STATE CONTROL
       =============================== */

    // Disable Print + Email on load
    document.getElementById("print-invoice-btn").disabled = true;
    document.getElementById("email-invoice-btn").disabled = true;

   /* ===== SAVE INVOICE FUNCTION (UPDATED) ===== */
function saveInvoice() {
  const payload = buildInvoicePayload();
  if (!payload) return;

  const url =
    API_URL +
    "?action=saveInvoice" +
    "&data=" +
    encodeURIComponent(JSON.stringify(payload));

  fetch(url)
    .then(r => r.json())
    .then(res => {
      if (!res.success) {
        console.error(res);
        alert("Save failed");
        return;
      }

      // 1. ENABLE BUTTONS
      document.getElementById("print-invoice-btn").disabled = false;
      document.getElementById("email-invoice-btn").disabled = false;

      // 2. STORE GLOBALS FOR EMAIL BUTTON
      window.lastSavedPayload = payload; 
      window.lastSavedPdfUrl = res.pdfUrl;
      window.currentInvoiceFileId = res.fileId || res.pdfUrl.match(/[-\w]{25,}/)[0];
      window.currentInvoiceNumber = res.invoiceNumber;

      Swal.fire({
        title: "Invoice Saved!",
        text: `Invoice #${res.invoiceNumber} is ready for Outlook.`,
        icon: "success",
        confirmButtonColor: "#2563eb"
      });
    })
    .catch(err => {
      console.error(err);
      alert("Network error saving invoice");
    });
}
    document.getElementById("save-invoice-btn").addEventListener("click", saveInvoice);
    /* ===== PRINT INVOICE FUNCTION ===== */
    async function printInvoice() {
    if (!window.currentInvoiceFileId) {
        Swal.fire("Error", "Invoice must be saved before printing", "error");
        return;
    }

    Swal.fire({
        title: 'Preparing Print...',
        text: 'Fetching document from server...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });

    try {
        // Request the raw file data from the backend proxy
        const resp = await fetch(`${API_URL}?action=printProxy&fileId=${window.currentInvoiceFileId}`);
        const base64Data = await resp.text();
        
        if (base64Data.startsWith("Error")) throw new Error(base64Data);

        // Convert Base64 string back into a PDF Blob
        const byteCharacters = atob(base64Data);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        
        // Create a local URL for the PDF and open it
        const blobURL = URL.createObjectURL(blob);
        Swal.close();
        
        const printWindow = window.open(blobURL, "_blank");
        if (!printWindow) {
            Swal.fire("Popup Blocked", "Please allow popups to view the printable invoice.", "warning");
        }
    } catch (err) {
        Swal.fire("Error", "Could not generate print preview: " + err.message, "error");
    }
}
    document.getElementById("print-invoice-btn").addEventListener("click", printInvoice);
  </script>
  <div id="new-customer-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:999;">
  <div style="background:#fff; width:450px; margin:5% auto; padding:25px; border-radius:8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
    <h3 style="margin-top:0; border-bottom: 2px solid #f3f4f6; padding-bottom: 10px;">Add New Customer</h3>

    <div style="margin-bottom:12px;">
      <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Business Name</label>
      <input id="new-cust-name" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
    </div>

    <div style="margin-bottom:12px;">
      <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Street Address</label>
      <input id="new-cust-address" placeholder="Street" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
    </div>

    <div style="display:flex; gap:8px; margin-bottom:12px;">
      <div style="flex:2;">
        <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">City</label>
        <input id="new-cust-city" placeholder="City" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
      </div>
      <div style="flex:1;">
        <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">State</label>
        <input id="new-cust-state" placeholder="PA" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
      </div>
      <div style="flex:1;">
        <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Zip</label>
        <input id="new-cust-zip" placeholder="Zip" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
      </div>
    </div>

    <div style="margin-bottom:12px;">
      <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Customer Type</label>
      <select id="new-cust-type" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
        <option value="Restaurant">Restaurant</option>
        <option value="Wholesaler">Wholesaler</option>
      </select>
    </div>

    <div style="margin-bottom:20px;">
      <label style="display:block; font-size:12px; font-weight:600; margin-bottom:4px;">Payment Method</label>
      <select id="new-cust-payment" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
        <option value="Check">Check</option>
        <option value="Fintech">Fintech</option>
      </select>
    </div>

    <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
      <button onclick="closeNewCustomerModal()" style="padding:8px 15px; border:1px solid #ccc; background:#fff; border-radius:4px; cursor:pointer;">Cancel</button>
      <button onclick="saveNewCustomer()" style="padding:8px 15px; background:#2563eb; color:#fff; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Save Customer</button>
    </div>
  </div>
</div>

</body>
</html>
