<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<script>
/******************************************************
 * CONFIG
 ******************************************************/
const API_URL =
  "https://script.google.com/macros/s/AKfycbzWSIh-msRqg_tqU3l2jGXlxRIgxZKE-tcVNYadAGb9jKtDV_VZuLS-6hxkMkqdaJoj/exec";

/******************************************************
 * STATE
 ******************************************************/
let customers = [];
let selectedCustomer = null;

/******************************************************
 * INIT
 ******************************************************/
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toLocaleDateString();
  document.getElementById("current-date").textContent = today;
  document.getElementById("invoice-date").textContent = today;

  loadCustomers();
  setupBarcode();
});

/******************************************************
 * LOAD CUSTOMERS (BACKEND SYNC)
 ******************************************************/
function loadCustomers() {
  fetch(`${API_URL}?action=getCustomers`)
    .then(res => res.json())
    .then(data => {
      customers = data || [];
      setupCustomerAutocomplete();
    })
    .catch(err => console.error("Customer sync error:", err));
}

/******************************************************
 * AUTOCOMPLETE
 ******************************************************/
function setupCustomerAutocomplete() {
  const input = document.getElementById("customer-search");

  input.addEventListener("input", () => {
    const value = input.value.toLowerCase();
    clearSuggestions();
    if (!value) return;

    const matches = customers.filter(c =>
      c.name.toLowerCase().includes(value)
    );

    if (!matches.length) return;

    const list = document.createElement("div");
    list.id = "customer-suggestions";
    list.style.position = "absolute";
    list.style.background = "#fff";
    list.style.border = "1px solid #ccc";
    list.style.zIndex = 1000;
    list.style.width = input.offsetWidth + "px";

    matches.forEach(c => {
      const item = document.createElement("div");
      item.textContent = c.name;
      item.style.padding = "6px";
      item.style.cursor = "pointer";
      item.onclick = () => selectCustomer(c);
      list.appendChild(item);
    });

    input.parentNode.appendChild(list);
  });
}

function clearSuggestions() {
  const el = document.getElementById("customer-suggestions");
  if (el) el.remove();
}

/******************************************************
 * SELECT CUSTOMER
 ******************************************************/
function selectCustomer(customer) {
  selectedCustomer = customer;

  document.getElementById("customer-search").style.display = "none";
  clearSuggestions();

  document.getElementById("customer-display").hidden = false;
  document.getElementById("customer-name").textContent = customer.name;

  const lines = customer.address.split(",").slice(0, 2);
  document.getElementById("customer-address").innerHTML = lines.join("<br>");
}

/******************************************************
 * BARCODE
 ******************************************************/
function setupBarcode() {
  const input = document.getElementById("invoice-number");

  input.addEventListener("input", () => {
    const val = input.value.trim();
    if (!val) {
      document.getElementById("barcode").innerHTML = "";
      return;
    }

    JsBarcode("#barcode", val, {
      format: "CODE128",
      width: 1.6,
      height: 32,
      displayValue: false,
      margin: 0
    });
  });
}

/******************************************************
 * EXPORT (SAVE LATER)
 ******************************************************/
function getInvoiceHeaderData() {
  return {
    customer: selectedCustomer,
    invoiceNumber: document.getElementById("invoice-number").value,
    date: document.getElementById("invoice-date").textContent
  };
}
</script>
