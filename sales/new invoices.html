<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>

<body>

<script>
/* ===== GLOBAL STATE ===== */
let invoiceSaved = false;
let invoicePdfGenerated = false;
let lastGeneratedPdfId = null;
let cachedLogoBase64 = null;
</script>

<!-- ================= HEADER ================= -->
<img id="logoImg" src="background.jpg" style="display:none">

<script>
/* ===== HEADER LOGIC ===== */
(function(){
  const invoiceNumber = document.getElementById("invoiceNumber");
})();
</script>

<!-- ================= CUSTOMER / PRODUCT / TOTALS ================= -->
<!-- YOUR ENTIRE EXISTING HTML IS UNCHANGED ABOVE THIS POINT -->

<!-- ================= BUTTONS ================= -->
<div style="margin-top:20px; text-align:right">
  <button onclick="saveInvoice()">ðŸ’¾ Save Invoice</button>
  <button class="print-btn" onclick="printInvoice()">Print</button>
  <button onclick="goBackToInvoices()">â¬… Back to Invoices</button>
</div>

<script>
/******************************************************
 * REQUIRED MISSING FUNCTIONS (NO LOGIC CHANGED)
 ******************************************************/

function printInvoice() {
  window.print();
}

async function preloadLogoBase64() {
  if (cachedLogoBase64) return cachedLogoBase64;

  const img = document.getElementById("logoImg");
  if (!img || !img.complete) return null;

  const canvas = document.createElement("canvas");
  canvas.width = img.naturalWidth;
  canvas.height = img.naturalHeight;

  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0);

  cachedLogoBase64 = canvas.toDataURL("image/png");
  return cachedLogoBase64;
}

function validateInvoiceBeforeSave(payload) {
  const errors = [];

  if (!payload.invoiceNumber) errors.push("Invoice number missing");
  if (!payload.customer?.name) errors.push("Customer missing");
  if (!payload.items || !payload.items.length) errors.push("No products added");

  return errors;
}

function getBarcodeBase64() {
  const canvas = document.getElementById("barcodeCanvas");
  return canvas ? canvas.toDataURL("image/png") : null;
}

/******************************************************
 * SAVE INVOICE â€” FIXED (NO FEATURE CHANGES)
 ******************************************************/
async function saveInvoice() {
  try {
    if (!customerState.name) {
      alert("Select a customer first");
      return;
    }

    const payload = {
      invoiceNumber: document.getElementById("invoiceNumber").value,
      date: document.getElementById("invoiceDateValue").value,
      logoBase64: await preloadLogoBase64(),
      barcodeBase64: getBarcodeBase64(),
      customer: customerState,
      items: invoiceLines,
      subtotal: Number(document.getElementById("subtotal").textContent.replace("$","")),
      tax: Number(document.getElementById("salesTax").textContent.replace("$","")),
      discount: Number(document.getElementById("discountInput").value || 0),
      deposit: Number(document.getElementById("depositInput").value || 0),
      total: Number(document.getElementById("grandTotal").textContent.replace("$",""))
    };

    const errors = validateInvoiceBeforeSave(payload);
    if (errors.length) {
      alert(errors.join("\n"));
      return;
    }

    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    const result = await res.json();
    if (!result.success) throw result;

    invoiceSaved = true;
    invoicePdfGenerated = true;
    alert("Invoice saved successfully âœ…");

  } catch (e) {
    console.error(e);
    alert("Save failed â€” see console");
  }
}

/******************************************************
 * NAVIGATION
 ******************************************************/
function goBackToInvoices() {
  if (confirm("Leave this invoice?")) {
    window.location.href = "invoices.html";
  }
}
</script>

</body>
</html>
