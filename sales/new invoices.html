<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>New Invoice | Suburban Brewing Company</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

  <style>
    /* ==========================================================================
       COMMAND CENTER LAYOUT & SIDEBAR (RESTORED)
       ========================================================================== */
    :root {
      --sidebar-width: 240px;
      --sidebar-bg: #1f2937;
      --app-bg: #f4f6f8;
    }

    body { 
      margin: 0; 
      display: flex; 
      min-height: 100vh; 
      background-color: var(--app-bg); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      color: #fff;
      height: 100vh;
      position: fixed;
      z-index: 1000;
    }

    .sidebar h2 { margin: 20px; font-size: 18px; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .nav-section-title { font-size: 11px; text-transform: uppercase; opacity: 0.5; margin: 20px 20px 8px; font-weight: 700; }
    .nav-link { display: block; padding: 12px 24px; color: #d1d5db; text-decoration: none; font-size: 14px; }
    .nav-link:hover, .nav-link.active { background: #374151; color: #fff; }

    .main-wrapper { flex: 1; margin-left: var(--sidebar-width); display: flex; flex-direction: column; }

    /* SOLID BLACK TOP HEADER */
    .app-header {
      background: #000;
      color: #fff;
      padding: 15px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 900;
    }
    .app-header img { height: 50px; }

    /* THE INVOICE SHEET CONTAINER */
    #invoice-paper {
      background: #fff;
      margin: 30px auto;
      padding: 50px;
      width: 95%;
      max-width: 950px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body>

  <aside class="sidebar">
    <h2>SUBURBAN</h2>
    <div class="nav-section-title">Operations</div>
    <a href="../index.html" class="nav-link">!Main Screen</a>
    <div class="nav-section-title">Sales & Inventory</div>
    <a href="invoices.html" class="nav-link active">Invoices</a>
    <a href="inventory.html" class="nav-link">Live Tracking</a>
    <a href="customers.html" class="nav-link">Customer List</a>
  </aside>

  <div class="main-wrapper">
    <header class="app-header">
      <img src="background.jpg" alt="SBC Logo">
      <div style="text-align: right;">
        <div style="font-weight: 900; font-size: 18px;">INVOICE GENERATOR</div>
        <div style="font-size: 12px; opacity: 0.8;">v4.2 Internal System</div>
      </div>
    </header>

    <main id="invoice-paper">
      <script>
        /* ===== GLOBAL STATE ===== */
        let invoiceSaved = false;
        let invoicePdfGenerated = false;
        let lastGeneratedPdfId = null;
        let cachedLogoBase64 = null;
      </script>

      <style>
        .invoice-header {
          position: relative;
          display: grid;
          grid-template-columns: auto 1fr;
          column-gap: 30px;
          align-items: start;
          padding-bottom: 28px;
        }
        .print-only { display: none; }
        .company-block { display: flex; gap: 15px; }
        .company-block img { width: 90px; height: 90px; object-fit: contain; display: block; }
        .company-info { font-size: 11.5px; line-height: 1.6; }
        .invoice-meta { display: flex; flex-direction: column; align-items: flex-start; text-align: left; font-size: 14px; min-width: 260px; grid-column: 2; }
        .meta-row { display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-top: 6px; }
        .meta-row label { font-weight: bold; white-space: nowrap; }
        .meta-row input { padding: 6px; width: 160px; }
        #barcodeCanvas { display: block; margin-top: 10px; max-width: 260px; }
        .header-divider { margin-top: 4px; border-top: 2px solid #222; }
        .invoice-title { margin-top: 14px; margin-bottom: 14px; letter-spacing: 2px; text-align: center; font-weight: bold; font-size: 24px; }
      </style>

      <header class="invoice-header">
        <div class="company-block">
          <img id="logoImg" src="background.jpg" alt="Logo">
          <div class="company-info">
            <strong>Suburban Brewing Company</strong><br>
            3041 Horseshoe Pike Suite 120 & 130, Honey Brook, PA 19344<br>
            Sales Rep: Remy Davis Â· 908-642-1019 Â· Remyjdavis90@gmail.com
          </div>
        </div>

        <div class="invoice-meta">
          <div class="meta-row">
            <label>Date:</label>
            <span id="printInvoiceDate"></span>
            <input type="date" id="invoiceDateValue" style="border:1px solid #ccc;">
          </div>
          <div class="meta-row">
            <label>Invoice #:</label>
            <input id="invoiceNumber" type="text">
            <span id="printInvoiceNumber" class="print-only"></span>
          </div>
          <canvas id="barcodeCanvas" width="260" height="60"></canvas>
        </div>
      </header>
      
      <div class="invoice-title">INVOICE</div>
      <div class="header-divider"></div>

      <section class="customer-section" style="margin-top:20px; position:relative;">
        <div id="printCustomerInfo" style="display:none">
          <strong id="printCustomerName"></strong><br>
          <div id="printCustomerAddressLines"></div>
        </div>

        <div class="customer-row" style="display:flex; align-items:center; gap:10px;">
          <label style="font-weight:bold; min-width:130px;">Customer Name:</label>
          <input id="customerName" type="text" placeholder="Start typing..." autocomplete="off" style="flex:1; padding:6px;">
        </div>
        <div id="customerAutocomplete" class="autocomplete-list" hidden 
             style="position:absolute; top:35px; left:140px; width:360px; background:#fff; border:1px solid #ccc; z-index:1000;"></div>

        <input type="hidden" id="customerAddress">
        <input type="hidden" id="customerType">
        <input type="hidden" id="paymentMethod">
      </section>

      <div class="section-divider" style="margin:24px 0; border-top:2px solid #222;"></div>

      <table class="product-table" style="width:100%; border-collapse:collapse;">
        <thead>
          <tr style="background:#f3f4f6;">
            <th style="border:1px solid #ddd; padding:8px;">Product</th>
            <th style="border:1px solid #ddd; padding:8px;">Type</th>
            <th style="border:1px solid #ddd; padding:8px;">Qty</th>
            <th style="border:1px solid #ddd; padding:8px;">Price</th>
            <th style="border:1px solid #ddd; padding:8px;">Total</th>
            <th style="border:1px solid #ddd; padding:8px;"></th>
          </tr>
        </thead>
        <tbody id="productBlocks"></tbody>
      </table>
      <button onclick="addProductBlock()" style="margin-top:12px;">âž• Add Another Product</button>

      <section class="totals-section" style="margin-top:25px; display:flex; justify-content:flex-end;">
        <table class="totals-table" style="width:320px;">
          <tr><td>Subtotal:</td><td id="subtotal" style="text-align:right;">$0.00</td></tr>
          <tr id="taxRow"><td>Sales Tax (6%):</td><td id="salesTax" style="text-align:right;">$0.00</td></tr>
          <tr id="discountRow" style="display:none; color:red;"><td>Discount (10%):</td><td style="text-align:right;"><input id="discountInput" type="text" disabled style="border:none; background:none; text-align:right;"></td></tr>
          <tr id="depositRow" style="display:none; color:blue;"><td>Keg Deposit:</td><td style="text-align:right;"><input id="depositInput" type="text" disabled style="border:none; background:none; text-align:right;"></td></tr>
          <tr class="grand-total" style="font-size:18px; font-weight:bold; border-top:2px solid #000;">
            <td>Total:</td><td id="grandTotal" style="text-align:right;">$0.00</td>
          </tr>
        </table>
      </section>

      <div id="paymentFooter" class="payment-footer" style="margin-top:20px; font-weight:bold; border-left:4px solid #000; padding-left:10px;"></div>

      <div style="margin-top:40px; text-align:right;">
        <button onclick="saveInvoice()" style="padding:10px 20px; background:#000; color:#fff; border:none; cursor:pointer;">ðŸ’¾ Save Invoice</button>
        <button onclick="window.print()" style="padding:10px 20px; cursor:pointer;">Print</button>
        <button onclick="goBackToInvoices()" style="padding:10px 20px; cursor:pointer;">â¬… Back</button>
      </div>

    </main>
  </div>

  <div id="newCustomerBackdrop" class="modal-backdrop" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:2000;">
    <div class="modal" style="background:#fff; padding:25px; border-radius:8px; width:400px;">
      <h3 style="margin-top:0;">New Customer Setup</h3>
      <div style="margin-bottom:10px;"><label>Name</label><input id="newCustName" disabled style="width:100%; padding:6px; background:#eee;"></div>
      <div style="margin-bottom:10px;"><label>Address</label><textarea id="newCustAddress" style="width:100%; padding:6px;"></textarea></div>
      <div style="margin-bottom:10px;">
        <label>Type</label>
        <select id="newCustType" style="width:100%; padding:6px;"><option value="Restaurant">Restaurant</option><option value="Wholesale">Wholesale</option></select>
      </div>
      <div style="margin-bottom:10px;">
        <label>Payment</label>
        <select id="newCustPayment" style="width:100%; padding:6px;"><option value="Check">Check</option><option value="Fintech">Fintech</option></select>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
        <button onclick="closeNewCustomerModal()">Cancel</button>
        <button onclick="saveNewCustomer()" style="background:#000; color:#fff; border:none; padding:8px 15px;">Save</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== RESTORED LOGIC FROM YOUR 1,003 LINE VERSION ===== */
    const API_URL = "https://script.google.com/macros/s/AKfycbzWSIh-msRqg_tqU3l2jGXlxRIgxZKE-tcVNYadAGb9jKtDV_VZuLS-6hxkMkqdaJoj/exec";
    let customers = [];
    let rawProducts = [];
    let productsByName = {};
    let invoiceLines = [];
    let productBlockId = 0;

    // Initialize Header
    (function(){
      const invNum = document.getElementById("invoiceNumber");
      invNum.value = "INV-" + Date.now();
      document.getElementById("invoiceDateValue").value = new Date().toISOString().split("T")[0];
      const refresh = () => JsBarcode("#barcodeCanvas", invNum.value, { displayValue: false, height: 50 });
      invNum.addEventListener("input", refresh);
      refresh();
    })();

    // Load Data
    fetch(`${API_URL}?action=getCustomers`).then(r => r.json()).then(d => customers = d.data || d);
    fetch(`${API_URL}?action=getProducts`).then(r => r.json()).then(d => {
      rawProducts = d || [];
      rawProducts.forEach(p => {
        if(!productsByName[p.name]) productsByName[p.name] = [];
        productsByName[p.name].push({ type: p.type, price: p.price });
      });
    });

    // Customer Autocomplete (Restored)
    const nameIn = document.getElementById("customerName");
    const autoBox = document.getElementById("customerAutocomplete");
    nameIn.addEventListener("input", () => {
      const q = nameIn.value.trim().toLowerCase();
      autoBox.innerHTML = "";
      if(!q) { autoBox.hidden = true; return; }
      const matches = customers.filter(c => c.name.toLowerCase().includes(q));
      if(matches.length === 0) {
        autoBox.innerHTML = `<div onclick="openNewCustomerModal('${nameIn.value}')" style="padding:10px; color:blue; cursor:pointer;">+ Add New: ${nameIn.value}</div>`;
      } else {
        matches.forEach(c => {
          const div = document.createElement("div");
          div.style.padding = "8px"; div.style.cursor = "pointer"; div.textContent = c.name;
          div.onclick = () => {
            nameIn.value = c.name;
            document.getElementById("customerType").value = c.type;
            document.getElementById("paymentMethod").value = c.payment;
            document.getElementById("customerAddress").value = c.address;
            autoBox.hidden = true;
            updatePaymentFooter();
            calculateTotals();
          };
          autoBox.appendChild(div);
        });
      }
      autoBox.hidden = false;
    });

    // Product Block Logic
    function addProductBlock() {
      const id = productBlockId++;
      const tr = document.createElement("tr");
      tr.setAttribute("data-block-id", id);
      tr.innerHTML = `
        <td style="position:relative; border:1px solid #ddd; padding:8px;">
          <input class="product-search" data-id="${id}" style="width:100%; padding:6px;" autocomplete="off">
          <div class="autocomplete-box" data-box="${id}" hidden style="position:absolute; background:#fff; border:1px solid #ccc; width:100%; z-index:100;"></div>
        </td>
        <td data-types="${id}" style="border:1px solid #ddd; padding:8px;"></td>
        <td data-qty="${id}" style="border:1px solid #ddd; padding:8px;"></td>
        <td data-price="${id}" style="border:1px solid #ddd; padding:8px; text-align:right;"></td>
        <td data-total="${id}" style="border:1px solid #ddd; padding:8px; text-align:right;"></td>
        <td style="border:1px solid #ddd; padding:8px; text-align:center;"><button onclick="this.closest('tr').remove()">ðŸ—‘</button></td>
      `;
      document.getElementById("productBlocks").appendChild(tr);
      setupProdAuto(id);
    }

    function setupProdAuto(id) {
      const inp = document.querySelector(`[data-id="${id}"]`);
      const box = document.querySelector(`[data-box="${id}"]`);
      inp.addEventListener("input", () => {
        const q = inp.value.toLowerCase();
        box.innerHTML = "";
        if(!q) { box.hidden = true; return; }
        Object.keys(productsByName).filter(n => n.toLowerCase().includes(q)).forEach(n => {
          const d = document.createElement("div");
          d.style.padding = "5px"; d.style.cursor = "pointer"; d.textContent = n;
          d.onclick = () => {
            inp.value = n; box.hidden = true;
            const typeCell = document.querySelector(`[data-types="${id}"]`);
            typeCell.innerHTML = "";
            productsByName[n].forEach(t => {
              typeCell.innerHTML += `<label style="display:block;"><input type="checkbox" onchange="toggleLine(${id},'${n}','${t.type}',${t.price},this.checked)"> ${t.type}</label>`;
            });
          };
          box.appendChild(d);
        });
        box.hidden = false;
      });
    }

    function toggleLine(blockId, prod, type, price, checked) {
      if(checked) invoiceLines.push({ id: crypto.randomUUID(), blockId, product: prod, type, qty: 1, price, isKeg: type.toLowerCase().includes("keg") });
      else invoiceLines = invoiceLines.filter(l => !(l.blockId === blockId && l.type === type));
      renderBlock(blockId);
    }

    function renderBlock(blockId) {
      const qCell = document.querySelector(`[data-qty="${blockId}"]`);
      const pCell = document.querySelector(`[data-price="${blockId}"]`);
      const tCell = document.querySelector(`[data-total="${blockId}"]`);
      qCell.innerHTML = ""; pCell.innerHTML = ""; tCell.innerHTML = "";
      invoiceLines.filter(l => l.blockId === blockId).forEach(l => {
        qCell.innerHTML += `<div style="margin-bottom:8px;"><input type="number" value="${l.qty}" onchange="updateQty('${l.id}',this.value)" style="width:50px; padding:4px;"></div>`;
        pCell.innerHTML += `<div style="height:35px;">$${l.price.toFixed(2)}</div>`;
        tCell.innerHTML += `<div style="height:35px;">$${(l.qty * l.price).toFixed(2)}</div>`;
      });
      calculateTotals();
    }

    function updateQty(id, val) {
      const line = invoiceLines.find(l => l.id === id);
      if(line) { line.qty = Number(val) || 1; renderBlock(line.blockId); }
    }

    function calculateTotals() {
      let sub = 0, cases = 0, kegs = 0;
      invoiceLines.forEach(l => {
        sub += l.qty * l.price;
        if(l.type.toLowerCase().includes("case")) cases += l.qty;
        if(l.isKeg) kegs += l.qty;
      });
      const taxable = document.getElementById("customerType").value === "Restaurant";
      const tax = taxable ? sub * 0.06 : 0;
      const disc = cases >= 10 ? sub * 0.10 : 0;
      const dep = kegs * 30;

      document.getElementById("subtotal").textContent = `$${sub.toFixed(2)}`;
      document.getElementById("salesTax").textContent = `$${tax.toFixed(2)}`;
      
      const dr = document.getElementById("discountRow");
      dr.style.display = disc > 0 ? "table-row" : "none";
      document.getElementById("discountInput").value = `-$${disc.toFixed(2)}`;

      const depR = document.getElementById("depositRow");
      depR.style.display = dep > 0 ? "table-row" : "none";
      document.getElementById("depositInput").value = `$${dep.toFixed(2)}`;

      document.getElementById("grandTotal").textContent = `$${(sub + tax + dep - disc).toFixed(2)}`;
    }

    function updatePaymentFooter() {
      const p = document.getElementById("paymentMethod").value;
      document.getElementById("paymentFooter").textContent = p === "Check" ? "Payable to: Suburban Brewing Company" : (p === "Fintech" ? "Paid via Fintech" : "");
    }

    function openNewCustomerModal(name) { document.getElementById("newCustName").value = name; document.getElementById("newCustomerBackdrop").style.display = "flex"; }
    function closeNewCustomerModal() { document.getElementById("newCustomerBackdrop").style.display = "none"; }

    async function saveInvoice() {
      if(invoiceSaved) return alert("Saved.");
      const payload = {
        action: "saveInvoice",
        invoiceData: {
          number: document.getElementById("invoiceNumber").value,
          date: document.getElementById("invoiceDateValue").value,
          customer: document.getElementById("customerName").value,
          total: document.getElementById("grandTotal").textContent,
          items: invoiceLines
        }
      };
      await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
      invoiceSaved = true;
      alert("Inventory Updated and Invoice Saved!");
    }

    addProductBlock();
  </script>

  <style>
    /* PRINT OVERRIDES (RESTORED) */
    @media print {
      .sidebar, .app-header, button, .autocomplete-list, .autocomplete-box { display: none !important; }
      .main-wrapper { margin-left: 0 !important; }
      #invoice-paper { box-shadow: none; margin: 0; padding: 20px; width: 100%; }
      input { border: none !important; }
      #printCustomerInfo { display: block !important; }
      .customer-row { display: none !important; }
    }
  </style>

</body>
</html>
