<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Invoice | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
body { font-family: Arial, sans-serif; }
.autocomplete-item { cursor:pointer; padding:4px; }
.autocomplete-item:hover { background:#eee; }
</style>
</head>

<body>

<img id="logoImg" src="background.jpg" style="display:none">

<script>
/* ================= GLOBAL ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzWSIh-msRqg_tqU3l2jGXlxRIgxZKE-tcVNYadAGb9jKtDV_VZuLS-6hxkMkqdaJoj/exec";

let customers = [];
let rawProducts = [];
let productsByName = {};
let invoiceLines = [];
let blockId = 0;

const customerState = {
  name:"",
  address:"",
  type:"",
  payment:"",
  email:"",
  isNew:false
};
</script>

<!-- ================= HEADER ================= -->
<h2>Suburban Brewing Company</h2>

Invoice #: <input id="invoiceNumber"><br>
Date: <input type="date" id="invoiceDateValue"><br>

<canvas id="barcodeCanvas" width="260" height="60"></canvas>

<script>
(function initHeader(){
  const num = document.getElementById("invoiceNumber");
  const date = document.getElementById("invoiceDateValue");
  const today = new Date().toISOString().split("T")[0];

  num.value = "INV-" + Date.now();
  date.value = today;

  JsBarcode("#barcodeCanvas", num.value, { displayValue:false, height:50 });

  num.addEventListener("input", () => {
    JsBarcode("#barcodeCanvas", num.value, { displayValue:false, height:50 });
  });
})();
</script>

<hr>

<!-- ================= CUSTOMER ================= -->
<input id="customerName" placeholder="Customer name" autocomplete="off">
<div id="customerAutocomplete"></div>

<input type="hidden" id="customerType">
<input type="hidden" id="paymentMethod">

<script>
function loadCustomers(){
  const cb = "cb_" + Date.now();
  window[cb] = d => customers = d || [];
  const s = document.createElement("script");
  s.src = `${API_URL}?action=getCustomers&callback=${cb}`;
  document.body.appendChild(s);
}
loadCustomers();

customerName.addEventListener("input", e => {
  const q = e.target.value.toLowerCase();
  customerAutocomplete.innerHTML = "";

  if (!q) return;

  customers
    .filter(c => c.name.toLowerCase().includes(q))
    .forEach(c => {
      const div = document.createElement("div");
      div.className = "autocomplete-item";
      div.textContent = c.name;
      div.onclick = () => selectCustomer(c);
      customerAutocomplete.appendChild(div);
    });
});

function selectCustomer(c){
  customerName.value = c.name;
  customerAutocomplete.innerHTML = "";

  Object.assign(customerState, {
    name:c.name,
    address:c.address,
    type:c.type,
    payment:c.payment,
    email:c.email,
    isNew:false
  });

  customerType.value = c.type;
  paymentMethod.value = c.payment;

  calculateTotals();
  updatePaymentFooter();
}
</script>

<hr>

<!-- ================= PRODUCTS ================= -->
<table border="1">
<thead>
<tr><th>Product</th><th>Qty</th><th>Price</th></tr>
</thead>
<tbody id="productBlocks"></tbody>
</table>

<button onclick="addProductBlock()">Add Product</button>

<script>
function loadProducts(){
  const cb="cbp_"+Date.now();
  window[cb]=d=>{
    rawProducts=d||[];
    rawProducts.forEach(p=>{
      productsByName[p.name]=productsByName[p.name]||[];
      productsByName[p.name].push(p);
    });
  };
  const s=document.createElement("script");
  s.src=`${API_URL}?action=getProducts&callback=${cb}`;
  document.body.appendChild(s);
}
loadProducts();

function addProductBlock(){
  const id=blockId++;
  const tr=document.createElement("tr");
  tr.innerHTML=`
    <td><input onchange="selectProduct(${id},this.value)"></td>
    <td><input type="number" value="1" onchange="updateQty(${id},this.value)"></td>
    <td class="price"></td>
  `;
  tr.dataset.id=id;
  productBlocks.appendChild(tr);
}

function selectProduct(id,name){
  const prod=productsByName[name]?.[0];
  if(!prod) return;

  invoiceLines.push({
    id:crypto.randomUUID(),
    blockId:id,
    product:name,
    type:prod.type,
    qty:1,
    price:prod.price
  });

  [...productBlocks.children]
    .find(r=>r.dataset.id==id)
    .querySelector(".price").textContent = prod.price.toFixed(2);

  calculateTotals();
}

function updateQty(id,qty){
  const line=invoiceLines.find(l=>l.blockId==id);
  if(line){
    line.qty=Number(qty)||0;
    calculateTotals();
  }
}
</script>

<hr>

<!-- ================= TOTALS ================= -->
Subtotal: <span id="subtotal">$0.00</span><br>
Tax: <span id="salesTax">$0.00</span><br>
Total: <span id="grandTotal">$0.00</span><br>

<script>
const TAX_RATE=0.06;

function calculateTotals(){
  let sub=0;
  invoiceLines.forEach(l=>sub+=l.qty*l.price);

  const tax = customerState.type==="Restaurant" ? sub*TAX_RATE : 0;

  subtotal.textContent=`$${sub.toFixed(2)}`;
  salesTax.textContent=`$${tax.toFixed(2)}`;
  grandTotal.textContent=`$${(sub+tax).toFixed(2)}`;
}
</script>

<hr>

<!-- ================= PAYMENT FOOTER ================= -->
<div id="paymentFooter"></div>

<script>
function updatePaymentFooter(){
  paymentFooter.textContent =
    customerState.payment==="Check"
      ? "Make checks payable to Suburban Brewing Company"
      : customerState.payment==="Fintech"
      ? "Paid through Fintech"
      : "";
}
</script>

<hr>

<!-- ================= SAVE ================= -->
<button onclick="saveInvoice()">Save Invoice</button>

<script>
async function preloadLogoBase64(){
  const img=document.getElementById("logoImg");
  const c=document.createElement("canvas");
  c.width=img.naturalWidth;
  c.height=img.naturalHeight;
  c.getContext("2d").drawImage(img,0,0);
  return c.toDataURL("image/png");
}

function getBarcodeBase64(){
  return barcodeCanvas.toDataURL("image/png");
}

async function saveInvoice(){
  const payload={
    invoiceNumber:invoiceNumber.value,
    date:invoiceDateValue.value,
    logoBase64:await preloadLogoBase64(),
    barcodeBase64:getBarcodeBase64(),
    customer:customerState,
    items:invoiceLines,
    subtotal:+subtotal.textContent.replace("$",""),
    tax:+salesTax.textContent.replace("$",""),
    discount:0,
    deposit:0,
    total:+grandTotal.textContent.replace("$","")
  };

  const res = await fetch(`${API_URL}?action=saveInvoice`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  const r = await res.json();
  if(!r.success) throw r;

  alert("Invoice saved and emailed âœ…");
}
</script>

</body>
</html>
