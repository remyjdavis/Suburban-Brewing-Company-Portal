<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; padding: 20px; color: #1f2937; }
    .card { background: #fff; padding: 25px; border-radius: 12px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    label { display: block; font-weight: 700; margin: 15px 0 5px; font-size: 12px; color: #4b5563; text-transform: uppercase; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; }
    .btn { width: 100%; padding: 15px; background: #1f2937; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 20px; }
    .info-note { font-size: 11px; color: #6b7280; font-style: italic; margin-top: 4px; }
  </style>
</head>
<body>

<div class="card">
  <h2>Sales Activity Log</h2>
  <form id="salesForm">
    <label>Account Name</label>
    <input list="customers" id="name" placeholder="Start typing..." onblur="checkExisting()" required>
    <datalist id="customers"></datalist>

    <label>Manager Name</label>
    <input type="text" id="manager" placeholder="TBD / Unknown">
    <p class="info-note">You can update this name during follow-ups if it changes.</p>

    <div id="contactInfo">
      <label>Street Address</label>
      <input type="text" id="address">
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Phone</label><input type="tel" id="phone"></div>
        <div style="flex:1"><label>Email</label><input type="email" id="email"></div>
      </div>
    </div>

    <label>Result</label>
    <select id="outcome" required>
      <option value="">-- Select --</option>
      <option value="Sale">Sale (Write Invoice)</option>
      <option value="Warm">Warm (Back in 14 Days)</option>
      <option value="Cold">Cold (Back in 60 Days)</option>
      <option value="Not Interested">Not Interested</option>
    </select>

    <label>Notes</label>
    <textarea id="notes" rows="3"></textarea>

    <button type="submit" class="btn">Submit & Save</button>
  </form>
</div>

<script>
  // Load customer list from Invoices sheet on start
  window.onload = () => {
    google.script.run.withSuccessHandler(list => {
      const dl = document.getElementById('customers');
      list.forEach(n => { let o = document.createElement('option'); o.value = n; dl.appendChild(o); });
    }).getCustomerNames();
  };

  function checkExisting() {
    const name = document.getElementById('name').value;
    google.script.run.withSuccessHandler(data => {
      if (data && !data.error) {
        document.getElementById('manager').value = data.manager || "";
        document.getElementById('address').value = data.address || "";
        document.getElementById('phone').value = data.phone || "";
        document.getElementById('email').value = data.email || "";
      }
    }).getLeadDetails(name);
  }

  document.getElementById('salesForm').onsubmit = function(e) {
    e.preventDefault();
    const outcome = document.getElementById('outcome').value;
    const name = document.getElementById('name').value;
    
    const payload = {
      name: name,
      manager: document.getElementById('manager').value,
      address: document.getElementById('address').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      outcome: outcome,
      notes: document.getElementById('notes').value
    };

    google.script.run.withSuccessHandler(res => {
      if (res.redirect) {
        window.location.href = "invoices.html?customer=" + encodeURIComponent(name);
      } else {
        alert("Log Saved!");
        location.reload();
      }
    }).submitSalesActivity(JSON.stringify(payload));
  };
</script>

</body>
</html>
