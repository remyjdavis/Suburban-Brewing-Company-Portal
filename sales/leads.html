<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sales & Follow-Up | Suburban Brewing Co.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ... (Styles remain the same as your Dashboard for consistency) ... */
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    body { margin: 0; background: #f4f6f8; display: flex; min-height: 100vh; color: #1f2937; }
    .sidebar { width: 240px; background: #1f2937; color: #fff; padding: 20px 0; flex-shrink: 0; }
    .nav-link { display: block; padding: 10px 24px; color: #d1d5db; text-decoration: none; font-size: 14px; }
    .nav-link.active { background: #2563eb; color: #fff; font-weight: 600; }
    .main { flex: 1; padding: 40px; }
    .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 600px; margin: 0 auto; }
    label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #374151; margin-top: 15px; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; }
    .info-note { font-size: 11px; color: #6b7280; margin-top: -10px; margin-bottom: 10px; font-style: italic; }
    .btn-submit { width: 100%; padding: 16px; background: #1f2937; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 20px; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <div style="padding: 0 24px 20px;"><h2>Suburban</h2></div>
    <a class="nav-link" href="../index.html">Dashboard</a>
    <a class="nav-link active" href="leads.html">Sales Leads</a>
    <a class="nav-link" href="invoices.html">Invoices</a>
  </aside>

  <main class="main">
    <div class="card">
      <h1>Sales Activity</h1>
      
      <label>Entry Type</label>
      <select id="entryType" onchange="toggleView()">
        <option value="new">New Lead (Initial Visit)</option>
        <option value="followup">Follow-Up (Existing Account)</option>
      </select>

      <form id="leadForm" onsubmit="submitLead(event)">
        <label>Account Name</label>
        <input type="text" id="custName" placeholder="Enter business name..." onblur="fetchExistingData()" required>

        <label>Manager Name</label>
        <input type="text" id="mgrName" placeholder="TBD / Unknown">
        <p class="info-note" id="mgrNote">Leave blank if unknown; you can add this during follow-up.</p>

        <div id="newFields">
          <label>Address</label>
          <input type="text" id="address">
          
          <label>Phone / Email</label>
          <div style="display: flex; gap: 10px;">
            <input type="tel" id="phone" placeholder="Phone">
            <input type="email" id="email" placeholder="Email">
          </div>
        </div>

        <label>Result</label>
        <select id="outcome" required>
          <option value="">-- Choose Outcome --</option>
          <option value="Sale">Sale (Write Invoice)</option>
          <option value="Warm">Warm (Back in 14 days)</option>
          <option value="Cold">Cold (Back in 60 days)</option>
          <option value="Not Interested">Not Interested</option>
        </select>

        <label>Notes</label>
        <textarea id="notes" rows="3" placeholder="Details about tap space, competition, or the conversation..."></textarea>

        <button type="submit" class="btn-submit">Submit Activity</button>
      </form>
    </div>
  </main>

  <script>
    function toggleView() {
      const isNew = document.getElementById('entryType').value === 'new';
      document.getElementById('newFields').style.display = isNew ? 'block' : 'none';
      if (!isNew) {
        document.getElementById('mgrNote').innerText = "Updating this will overwrite the previous manager name.";
      } else {
        document.getElementById('mgrNote').innerText = "Leave blank if unknown; you can add this during follow-up.";
      }
    }

    // Function to pull data when typing an existing name
    function fetchExistingData() {
      const name = document.getElementById('custName').value;
      const type = document.getElementById('entryType').value;
      
      if (type === 'followup' && name.length > 2) {
        // This triggers the backend 'getLeadDetails' action we wrote in the Apps Script
        google.script.run.withSuccessHandler(function(data) {
          if (data && !data.error) {
            document.getElementById('mgrName').value = data.manager || "";
            document.getElementById('address').value = data.address || "";
            document.getElementById('phone').value = data.phone || "";
            document.getElementById('email').value = data.email || "";
          }
        }).getLeadDetails(name);
      }
    }

    function submitLead(event) {
      event.preventDefault();
      const outcome = document.getElementById('outcome').value;
      
      // Package data for backend
      const formData = {
        name: document.getElementById('custName').value,
        manager: document.getElementById('mgrName').value,
        address: document.getElementById('address').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        outcome: outcome,
        notes: document.getElementById('notes').value
      };

      // Call the backend 'submitSalesActivity' action
      google.script.run.withSuccessHandler(function(response) {
        if (response.redirect) {
          window.location.href = "invoices.html?customer=" + encodeURIComponent(formData.name);
        } else {
          alert("Activity Logged!");
          location.reload();
        }
      }).submitSalesActivity(JSON.stringify(formData));
    }
  </script>
</body>
</html>
