<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; padding: 20px; color: #1f2937; }
    .card { background: #fff; padding: 25px; border-radius: 12px; max-width: 600px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    label { display: block; font-weight: 700; margin: 15px 0 5px; font-size: 12px; color: #4b5563; text-transform: uppercase; }
    input, select, textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
    .btn { width: 100%; padding: 15px; background: #1f2937; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 20px; }
    .btn:disabled { background: #9ca3af; }
    .info-note { font-size: 11px; color: #6b7280; font-style: italic; margin-top: 4px; }
  </style>
</head>
<body>

<div class="card">
  <h2>Sales Activity Log</h2>
  <form id="salesForm">
    <input type="hidden" id="accountType" value="Restaurant">

    <label>Account Name</label>
    <input list="customers" id="name" placeholder="Start typing..." onblur="checkExisting()" required>
    <datalist id="customers"></datalist>

    <label>Manager Name</label>
    <input type="text" id="manager" placeholder="TBD / Unknown">
    <p class="info-note">AI will remember this name for your daily route planning.</p>

    <div id="contactInfo">
      <label>Street Address</label>
      <input type="text" id="address">
      <div style="display:flex; gap:10px;">
        <div style="flex:1"><label>Phone</label><input type="tel" id="phone"></div>
        <div style="flex:1"><label>Email</label><input type="email" id="email"></div>
      </div>
    </div>

    <label>Result</label>
    <select id="outcome" required>
      <option value="">-- Select --</option>
      <option value="Sale">Sale (Write Invoice)</option>
      <option value="Warm">Warm (Interested / Follow-up)</option>
      <option value="Cold">Cold (Long-term Prospect)</option>
      <option value="Not Interested">Not Interested</option>
    </select>

    <label>Notes (For AI Analysis)</label>
    <textarea id="notes" rows="3" placeholder="Example: Manager back on Tuesday. Low on 4-packs."></textarea>

    <button type="submit" id="submitBtn" class="btn">Submit & Save Activity</button>
  </form>
</div>

<script>
  // 1. On Load: Pull existing customer names from the Invoice sheet
  window.onload = () => {
    google.script.run.withSuccessHandler(list => {
      const dl = document.getElementById('customers');
      list.forEach(n => { 
        let o = document.createElement('option'); 
        o.value = n; 
        dl.appendChild(o); 
      });
    }).getCustomerNames();
  };

  // 2. Auto-fill: Pull details and determine if it's a Wholesaler or Restaurant
  function checkExisting() {
    const name = document.getElementById('name').value;
    if (!name) return;
    
    google.script.run.withSuccessHandler(data => {
      if (data && !data.error) {
        document.getElementById('manager').value = data.manager || "";
        document.getElementById('address').value = data.address || "";
        document.getElementById('phone').value = data.phone || "";
        document.getElementById('email').value = data.email || "";
        // Store the type so the backend knows which inventory tab to use later
        document.getElementById('accountType').value = data.type || "Restaurant";
      }
    }).getLeadDetails(name);
  }

  // 3. Submit: Send to Master Backend for AI processing and Tab routing
  document.getElementById('salesForm').onsubmit = function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "Processing with AI...";

    const name = document.getElementById('name').value;
    const payload = {
      name: name,
      type: document.getElementById('accountType').value,
      manager: document.getElementById('manager').value,
      address: document.getElementById('address').value,
      phone: document.getElementById('phone').value,
      email: document.getElementById('email').value,
      outcome: document.getElementById('outcome').value,
      notes: document.getElementById('notes').value
    };

    google.script.run.withSuccessHandler(res => {
      if (res.redirect) {
        // Redirect to Invoice portal if it was a Sale
        window.location.href = "invoices.html?customer=" + encodeURIComponent(name);
      } else {
        alert("Success! AI has scheduled your next follow-up for: " + res.nextDate);
        location.reload();
      }
    })
    .withFailureHandler(err => {
      alert("Error: " + err);
      btn.disabled = false;
      btn.innerText = "Submit & Save Activity";
    })
    .submitSalesActivity(JSON.stringify(payload));
  };
</script>

</body>
</html>
