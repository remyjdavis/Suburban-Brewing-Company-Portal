<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Invoices | Suburban Brewing Company</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- ======================================================
     GLOBAL STYLES
====================================================== -->
<style>
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
body { margin:0; background:#f4f6f8; color:#1f2937; }
.layout { display:flex; min-height:100vh; }
.sidebar { width:240px; background:#1f2937; color:#fff; padding:20px 0; }
.sidebar h2 { margin:0 20px 20px; font-size:18px; }
.nav-link { display:block; padding:10px 20px; color:#d1d5db; text-decoration:none; }
.nav-link.active, .nav-link:hover { background:#374151; color:#fff; }
.main { flex:1; display:flex; flex-direction:column; }
.topbar { background:#fff; border-bottom:1px solid #e5e7eb; padding:16px 24px; }
.content { padding:24px; }
.section { background:#fff; border-radius:8px; padding:20px; margin-bottom:24px; box-shadow:0 1px 3px rgba(0,0,0,0.08); }
h2 { margin-top:0; font-size:16px; font-weight:600; }
.form-grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); }
label { font-size:12px; font-weight:600; margin-bottom:4px; display:block; }
input { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; }
input:disabled { background:#f3f4f6; }

button { padding:8px 14px; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; }
button.secondary { background:#6b7280; }

table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { padding:10px; border-bottom:1px solid #e5e7eb; font-size:14px; }
tr.selected { background:#eff6ff; }

.preview { background:#fafafa; padding:16px; border-left:4px solid #2563eb; }
</style>
</head>

<body>
<div class="layout">

<!-- ======================================================
     SIDEBAR
====================================================== -->
<aside class="sidebar">
  <h2>Suburban Brewing</h2>
  <a class="nav-link active" href="invoices.html">Invoices</a>
  <a class="nav-link" href="leads.html">Sales Leads</a>
  <a class="nav-link" href="deliveries.html">Deliveries</a>
  <a class="nav-link" href="sampling.html">Sampling</a>
  <div style="margin-top:32px; font-size:12px; opacity:0.6; padding-left:20px;">Back</div>
  <a class="nav-link" href="../index.html">Dashboard</a>
</aside>

<!-- ======================================================
     MAIN
====================================================== -->
<div class="main">
<header class="topbar">
  <h1>Invoices</h1>
</header>

<section class="content">
<div style="margin-bottom:16px;">
  <button onclick="location.href='new invoices.html'">
    Create New Invoice
  </button>
</div>

<!-- ======================================================
     SEARCH CUSTOMER
====================================================== -->
<div class="section">
<h2>Find Customer Invoices</h2>
<div class="form-grid">
  <div>
    <label>Customer Name</label>
    <input id="customerName" placeholder="Type customer name..." oninput="debouncedLoadInvoices()">
  </div>
  <div>
    <label>Invoice #</label>
    <input id="invoiceNumber" disabled>
  </div>
  <div>
    <label>Date</label>
    <input id="invoiceDate" disabled>
  </div>
</div>

<div style="margin-top:16px;">
  <button class="secondary" onclick="clearSelection()">Clear</button>
  <button onclick="editInvoice()">Edit Invoice</button>
</div>
</div>

<!-- ======================================================
     INVOICE HISTORY
====================================================== -->
<div class="section">
<h2>Invoice History</h2>
<table>
<thead>
<tr>
  <th>Invoice #</th>
  <th>Date</th>
  <th>Total</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="historyBody">
<tr><td colspan="4">Search a customer to load invoices.</td></tr>
</tbody>
</table>
</div>

<!-- ======================================================
     PREVIEW
====================================================== -->
<div class="section preview" id="previewPanel" style="display:none;">
<h2>Invoice Preview</h2>
<div id="previewContent"></div>
</div>

</section>
</div>
</div>

<!-- ======================================================
     SCRIPT
====================================================== -->
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzWSIh-msRqg_tqU3l2jGXlxRIgxZKE-tcVNYadAGb9jKtDV_VZuLS-6hxkMkqdaJoj/exec";

let debounceTimer = null;
let selectedInvoice = null;
let invoiceHistory = [];
// DOM ELEMENTS (REQUIRED – DO NOT REMOVE)
const customerName  = document.getElementById("customerName");
const historyBody   = document.getElementById("historyBody");
const invoiceNumber = document.getElementById("invoiceNumber");
const invoiceDate   = document.getElementById("invoiceDate");
const previewPanel  = document.getElementById("previewPanel");
const previewContent = document.getElementById("previewContent");

/* ---------------- LOAD INVOICES ---------------- */
function debouncedLoadInvoices() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const name = customerName.value.trim();
    if (name.length < 2) return;
    loadInvoices(name);
  }, 300);
}
function loadInvoices(customer) {
  historyBody.innerHTML =
    "<tr><td colspan='4'>Loading invoices...</td></tr>";

  const cb = "cb_" + Date.now();

  window[cb] = function (data) {
    delete window[cb];
    script.remove();

    invoiceHistory = Array.isArray(data) ? data : [];
    historyBody.innerHTML = "";

    if (!invoiceHistory.length) {
      historyBody.innerHTML =
        "<tr><td colspan='4'>No invoices found.</td></tr>";
      return;
    }

    invoiceHistory.forEach(inv => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${inv.invoiceNumber}</td>
        <td>${inv.date}</td>
        <td>$${Number(inv.total).toFixed(2)}</td>
        <td>
          <button onclick="selectInvoice('${inv.invoiceNumber}', this)">
            Load
          </button>
        </td>
      `;
      historyBody.appendChild(tr);
    });
  };

  const script = document.createElement("script");
  script.src =
    `${API_URL}?action=getInvoicesByCustomer` +
    `&customer=${encodeURIComponent(customer)}` +
    `&callback=${cb}`;

  script.onerror = () => {
    historyBody.innerHTML =
      "<tr><td colspan='4'>Failed to load invoices.</td></tr>";
  };

  document.body.appendChild(script);
}

async function selectInvoice(invNum, btn) {
  selectedInvoice = invoiceHistory.find(i => i.invoiceNumber === invNum);
  if (!selectedInvoice) return;

  document.querySelectorAll("#historyBody tr").forEach(r =>
    r.classList.remove("selected")
  );
  btn.closest("tr").classList.add("selected");

  invoiceNumber.value = selectedInvoice.invoiceNumber || "";
invoiceDate.value = selectedInvoice.date || "";

  try {
  await new Promise(resolve => {
    const cb = "cb_items_" + Date.now();

    window[cb] = function (items) {
      selectedInvoice.items = (Array.isArray(items) ? items : []).map(i => ({
  qty: Number(i.qty) || 0,
  product: String(i.product || "").trim(),
  type: String(i.type || "").trim(),   // ← SHEETS "Type"
  price: Number(i.price) || 0,
  lineTotal: Number(i.lineTotal) || 0
}));

      delete window[cb];
      script.remove();
      resolve();
    };

    const script = document.createElement("script");
    script.src =
      `${API_URL}?action=getInvoiceItems` +
      `&invoiceNumber=${encodeURIComponent(invNum)}` +
      `&callback=${cb}`;

    document.body.appendChild(script);
  });

  renderPreview();

} catch (err) {
  console.error("Failed to load invoice items", err);
  selectedInvoice.items = [];
  renderPreview();
}

}
/* ---------------- PREVIEW ---------------- */
function renderPreview() {
  if (!selectedInvoice) return;

  const panel = document.getElementById("previewPanel");
  const content = document.getElementById("previewContent");

  const itemsHtml = selectedInvoice.items.length
    ? selectedInvoice.items.map(item => `
        <div style="margin-bottom:6px;">
         ${item.qty} × <strong>${item.product}</strong>
(${item.type}) — $${item.lineTotal.toFixed(2)}
        </div>
      `).join("")
    : "<em>No line items found.</em>";

  content.innerHTML = `
    <strong>Invoice #:</strong> ${selectedInvoice.invoiceNumber}<br>
    <strong>Date:</strong> ${selectedInvoice.date}<br>
    <strong>Status:</strong> Delivered<br>
    <strong>Total:</strong> $${Number(selectedInvoice.total).toFixed(2)}<br><br>

    <strong>Items:</strong><br>
    ${itemsHtml}
  `;

  panel.style.display = "block";
}
/* ---------------- EDIT ---------------- */
function editInvoice() {
  if (!selectedInvoice) return alert("Select an invoice first.");
  location.href = `new invoices.html?invoice=${encodeURIComponent(
    selectedInvoice.invoiceNumber
  )}`;
}

/* ---------------- CLEAR ---------------- */
function clearSelection() {
  selectedInvoice = null;
  invoiceNumber.value = "";
  invoiceDate.value = "";
  previewPanel.style.display = "none";
previewContent.innerHTML = "";
}
</script>


</body>
</html>
