<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console | Suburban Brewing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    /* BASIC STYLING TO KEEP PAGE USABLE */
    :root { --bg: #f8fafc; --sidebar: #0f172a; --accent: #2563eb; --text-main: #1e293b; }
    body { margin: 0; background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--sidebar); color: #fff; padding: 20px; flex-shrink: 0; }
    .main { flex-grow: 1; padding: 20px; }
    .status-bar { background: #fee2e2; color: #991b1b; padding: 15px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #f87171; display:none; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h2>SUBURBAN</h2>
    <p>Admin Console</p>
    <br>
    <a href="index.html" style="color:white; text-decoration:none;">&larr; Back to Dashboard</a>
  </aside>

  <main class="main">
    <div id="error-display" class="status-bar"></div>

    <h1>Admin Console</h1>
    <div style="background:white; padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        <h3>System Status</h3>
        <p id="system-status">Initializing...</p>
    </div>
  </main>

<script>
    // --- CONFIGURATION ---
    const MASTER_API_URL = "https://script.google.com/macros/s/AKfycbzzkG7_Def-aiH-cF_m0NrdJe53WqQEqRDPa4Fa0nQz9-tu7kII6XmU29N3fe5T6UDF/exec";
    
    // ðŸ”´ 1. DEFINE EXACT PATHS
    const BASE_URL = "https://remyjdavis.github.io/Suburban-Brewing-Company-Portal/";
    const WORKER_FILE = "OneSignalSDKWorker.js"; 
    const FULL_WORKER_URL = BASE_URL + WORKER_FILE;
    const SCOPE = "/Suburban-Brewing-Company-Portal/";

    // --- INITIALIZATION ---
    window.addEventListener('load', async () => {
        console.log("ðŸŸ¢ System Starting...");
        document.getElementById('system-status').innerText = "Checking Worker File...";

        // ðŸ”´ 2. DIAGNOSTIC CHECK: DOES THE FILE EXIST?
        try {
            const response = await fetch(FULL_WORKER_URL, { method: 'HEAD' });
            
            if (response.status === 404) {
                throw new Error("404 Not Found");
            }
            
            console.log("âœ… File found at:", FULL_WORKER_URL);
            document.getElementById('system-status').innerText = "File Verified. Installing...";
            
            // ðŸ”´ 3. INSTALL WORKER MANUALLY
            await installWorker();

        } catch (e) {
            // STOP HERE IF FILE IS MISSING
            showCriticalError(e);
            return; 
        }

        // 4. LOAD DASHBOARD DATA
        setupUserProfile();
        loadUsers();
        loadSystemConfig();
        // checkUnreadCount(); // Uncomment when fixed
    });

    async function installWorker() {
        if ('serviceWorker' in navigator) {
            try {
                // Unregister bad workers first
                const regs = await navigator.serviceWorker.getRegistrations();
                for(let reg of regs) {
                    if (reg.scope !== location.origin + SCOPE) await reg.unregister();
                }

                // Register correct worker
                const reg = await navigator.serviceWorker.register(WORKER_FILE, { scope: SCOPE });
                console.log("âœ… Worker Installed:", reg.scope);
                document.getElementById('system-status').innerText = "Worker Active. Starting OneSignal...";

                // Start OneSignal
                initOneSignal();

            } catch (e) {
                console.error("Worker Install Failed:", e);
                document.getElementById('system-status').innerText = "Worker Install Failed: " + e.message;
            }
        }
    }

    function initOneSignal() {
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                await OneSignal.init({
                    appId: "3a6852ed-53d7-4cf0-a14b-c0102564d81d",
                    // We already registered the worker, so we point to the folder path
                    path: SCOPE, 
                    allowLocalhostAsSecureOrigin: true,
                    logLevel: "warn"
                });
                console.log("âœ… OneSignal Running");
                document.getElementById('system-status').innerText = "System Online âœ…";
                
                // Login
                const user = sessionStorage.getItem("user_name");
                if(user) OneSignal.login(user.toLowerCase());

            } catch (e) { console.error("Init Error:", e); }
        });
    }

    function showCriticalError(e) {
        const msg = `
            <strong>ðŸ›‘ CRITICAL ERROR: WORKER FILE MISSING</strong><br>
            The system looked for the file here:<br>
            <a href="${FULL_WORKER_URL}" target="_blank" style="color:#b91c1c; word-break:break-all;">${FULL_WORKER_URL}</a>
            <br><br>
            <strong>Result:</strong> 404 (Not Found)<br>
            <strong>Fix:</strong> Go to GitHub. Rename your worker file to exactly <code>OneSignalSDKWorker.js</code>.
        `;
        const div = document.getElementById('error-display');
        div.innerHTML = msg;
        div.style.display = 'block';
        document.getElementById('system-status').innerText = "System Halted.";
        console.error("CRITICAL:", msg);
    }

    // --- DASHBOARD HELPERS ---
    async function loadUsers() {
        // (Placeholder for existing logic)
        try { const res = await fetch(`${MASTER_API_URL}?action=getUsers`); } catch(e){}
    }
    function setupUserProfile() {
        // (Placeholder)
    }
    function loadSystemConfig() {
        // (Placeholder)
    }
    function loadMasterData() {}
    function loadAuditLogs() {}
</script>
</body>
</html>
