<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console | Suburban Brewing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    /* BASIC STYLING */
    :root { --bg: #f8fafc; --sidebar: #0f172a; --accent: #2563eb; --text-main: #1e293b; }
    body { margin: 0; background: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: var(--sidebar); color: #fff; padding: 20px; flex-shrink: 0; position: fixed; height: 100vh; overflow-y: auto; }
    .main { margin-left: 260px; flex-grow: 1; padding: 20px; }
    .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
    @media (max-width: 1024px) { .sidebar { display:none; } .main { margin-left: 0; } }
    
    /* STATUS BAR */
    .status-bar { padding: 10px; background: #e0f2fe; color: #0369a1; border-radius: 6px; font-family: monospace; font-size: 12px; margin-bottom: 20px; border: 1px solid #bae6fd; }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h2>SUBURBAN</h2>
    <p style="color:#94a3b8; font-size:12px;">Admin Console</p>
    <div style="margin-top:20px;">
        <a href="index.html" style="color:white; text-decoration:none; display:block; padding:10px 0;">Dashboard</a>
    </div>
  </aside>

  <main class="main">
    <div class="status-bar" id="system-status">System Initializing...</div>

    <div class="card">
        <h1 style="margin:0 0 20px 0; font-size:24px;">Admin Console</h1>
        <p>Welcome back, <b id="display-username">User</b>.</p>
        <button onclick="handleLogout()" style="background:#ef4444; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Logout</button>
    </div>

    <div class="card">
        <h3>ðŸ’¬ Team Inbox</h3>
        <button onclick="openCompose()" style="background:#2563eb; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; margin-bottom:10px;">+ New Message</button>
        <div id="msg-table-body" style="max-height:300px; overflow-y:auto; border-top:1px solid #eee;">
            <div style="padding:20px; text-align:center; color:#94a3b8;">Loading messages...</div>
        </div>
    </div>
  </main>

<script>
    // --- CONFIGURATION ---
    const MASTER_API_URL = "https://script.google.com/macros/s/AKfycbzzkG7_Def-aiH-cF_m0NrdJe53WqQEqRDPa4Fa0nQz9-tu7kII6XmU29N3fe5T6UDF/exec";
    
    // ðŸ”´ EXACT PATH CONFIGURATION
    const FOLDER_NAME = "Suburban-Brewing-Company-Portal";
    const WORKER_FILE = "OneSignalSDKWorker.js";
    const FULL_WORKER_PATH = `${FOLDER_NAME}/${WORKER_FILE}`; // "Suburban.../OneSignal..."
    const SCOPE = `/${FOLDER_NAME}/`;

    // --- INITIALIZATION ---
    window.addEventListener('load', async () => {
        log("ðŸŸ¢ System Starting...");
        
        // 1. MANUAL REGISTRATION (Already Proven to Work)
        if ('serviceWorker' in navigator) {
            try {
                // Kill bad workers first
                const regs = await navigator.serviceWorker.getRegistrations();
                for(let reg of regs) {
                    if (reg.scope === "https://remyjdavis.github.io/") await reg.unregister();
                }

                // Register Correctly
                const reg = await navigator.serviceWorker.register(WORKER_FILE, { scope: SCOPE });
                log("âœ… Worker Installed manually at: " + reg.scope);
                
                // 2. START ONESIGNAL (With Path Override)
                initOneSignal();

            } catch (e) {
                log("âŒ Manual Install Error: " + e.message);
                initOneSignal(); // Try anyway
            }
        }

        // 3. LOAD DATA
        setupUserProfile();
        loadInbox();
    });

    function initOneSignal() {
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                log("ðŸš€ Initializing SDK...");
                await OneSignal.init({
                    appId: "3a6852ed-53d7-4cf0-a14b-c0102564d81d",
                    
                    // ðŸ”´ THE FIX: We put the folder name IN the filename path.
                    // This forces the SDK to build "https://domain.com/FOLDER/Worker.js"
                    serviceWorkerPath: FULL_WORKER_PATH,
                    
                    // ðŸ”´ Match the scope we used manually
                    serviceWorkerParam: { scope: SCOPE },
                    
                    // ðŸ”´ Set path for other assets
                    path: SCOPE,
                    
                    allowLocalhostAsSecureOrigin: true,
                    logLevel: "warn"
                });
                
                log("âœ… OneSignal Connected!");
                
                const user = sessionStorage.getItem("user_name");
                if(user) OneSignal.login(user.toLowerCase());

            } catch (e) { log("âŒ SDK Error: " + e); }
        });
    }

    function log(msg) {
        console.log(msg);
        document.getElementById('system-status').innerText = msg;
    }

    // --- DATA FUNCTIONS ---
    async function loadInbox() {
        const user = sessionStorage.getItem("user_name");
        if(!user) return;
        try {
            const res = await fetch(`${MASTER_API_URL}?action=getMessages&user=${encodeURIComponent(user)}&ts=${Date.now()}`, {redirect:"follow", headers:{"Content-Type":"text/plain;charset=utf-8"}});
            const json = await res.json();
            if(json.status === 'success') {
                const rows = json.messages.map(m => `
                    <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; cursor:pointer;" onclick="readMsg('${m.id}','${m.from}','${m.subject}','${m.body}')">
                        <div><b>${m.from}</b>: ${m.subject}</div>
                        <div style="font-size:12px; color:#888;">${new Date(m.date).toLocaleDateString()}</div>
                    </div>`).join('');
                document.getElementById('msg-table-body').innerHTML = rows || '<div style="padding:20px; text-align:center;">No messages.</div>';
            }
        } catch(e) { console.error(e); }
    }

    function readMsg(id, from, subj, body) {
        Swal.fire({ title: subj, html: `<p style="color:#666; font-size:12px;">From: ${from}</p><div style="background:#f9f9f9; padding:10px; border-radius:5px;">${body}</div>`, showCancelButton: true, confirmButtonText: "Reply", cancelButtonText: "Close" }).then(r => {
            if(r.isConfirmed) openCompose(from, "Re: " + subj);
        });
    }

    async function openCompose(to="", subj="") {
        const { value: f } = await Swal.fire({ title: 'New Message', html: `<input id="swal-to" class="swal2-input" placeholder="To" value="${to}"><input id="swal-subj" class="swal2-input" placeholder="Subject" value="${subj}"><textarea id="swal-body" class="swal2-textarea" placeholder="Message"></textarea>`, preConfirm: () => ({ to: document.getElementById('swal-to').value, subj: document.getElementById('swal-subj').value, body: document.getElementById('swal-body').value }) });
        if(f) {
            Swal.fire({title:'Sending...', didOpen:()=>Swal.showLoading()});
            await fetch(MASTER_API_URL, {method:'POST', body:JSON.stringify({action:'sendMessage', data:{sender:sessionStorage.getItem("user_name"), recipient:f.to, subject:f.subj, body:f.body}})});
            Swal.fire('Sent!', '', 'success');
        }
    }

    function setupUserProfile() {
        const u = sessionStorage.getItem("user_name");
        if(u) document.getElementById('display-username').innerText = u;
    }
    function handleLogout() { sessionStorage.clear(); window.location.replace("index.html"); }
</script>
</body>
</html>
