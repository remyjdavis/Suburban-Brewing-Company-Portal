<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console | Suburban Brewing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js"></script>

  <style>
    body { font-family: sans-serif; background: #f8fafc; padding: 20px; text-align: center; }
    .log-box { text-align: left; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 8px; font-family: monospace; max-width: 600px; margin: 20px auto; overflow-x: auto; }
  </style>
</head>
<body>

  <h1>Admin Console (Manual Override)</h1>
  <div class="log-box" id="debug-log">System Initializing...<br></div>

<script>
    // --- HELPERS ---
    function log(msg) {
        console.log(msg);
        document.getElementById('debug-log').innerHTML += ">> " + msg + "<br>";
    }

    const WORKER_URL = "https://remyjdavis.github.io/Suburban-Brewing-Company-Portal/OneSignalSDKWorker.js";
    const SCOPE_URL = "/Suburban-Brewing-Company-Portal/";

    // --- MAIN LOGIC ---
    window.addEventListener('load', async () => {
        log("üöÄ Starting Manual Override...");

        if ('serviceWorker' in navigator) {
            
            // 1. KILL BAD WORKERS (Cleanup)
            const regs = await navigator.serviceWorker.getRegistrations();
            for(let reg of regs) {
                // If it's registered at the ROOT, it is wrong. Kill it.
                if (reg.scope === "https://remyjdavis.github.io/") {
                    log("üíÄ Killing Root Worker: " + reg.scope);
                    await reg.unregister();
                }
            }

            // 2. MANUAL REGISTRATION (The Fix)
            // We force the browser to go to the specific URL we know exists.
            try {
                log("üõ†Ô∏è Attempting Manual Register: " + WORKER_URL);
                
                const registration = await navigator.serviceWorker.register(WORKER_URL, { 
                    scope: SCOPE_URL 
                });
                
                log("‚úÖ Worker Registered! Scope: " + registration.scope);
                
                // 3. START ONESIGNAL (Only after worker exists)
                initOneSignal();

            } catch (err) {
                log("‚ùå Manual Register Failed: " + err.message);
                log("‚ö†Ô∏è Verify file name in GitHub is explicitly: OneSignalSDKWorker.js");
            }
        } else {
            log("‚ùå Service Workers not supported in this browser.");
        }
    });

    function initOneSignal() {
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                log("üì° Initializing OneSignal SDK...");
                
                await OneSignal.init({
                    appId: "3a6852ed-53d7-4cf0-a14b-c0102564d81d",
                    allowLocalhostAsSecureOrigin: true,
                    // We don't need 'path' parameters because we manually registered it above
                });
                
                log("üéâ OneSignal Connected!");
                
                // Login
                const userName = sessionStorage.getItem("user_name");
                if(userName) {
                    log("üë§ Logging in: " + userName);
                    OneSignal.login(userName.toLowerCase());
                }

            } catch (error) {
                log("‚ùå SDK Init Error: " + error);
            }
        });
    }
</script>
</body>
</html>
