<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Console | Suburban Brewing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <style>
    body { font-family: sans-serif; background: #f8fafc; padding: 20px; text-align: center; }
    h1 { color: #1e293b; }
    .status { margin-top: 20px; padding: 15px; background: white; border: 1px solid #ccc; display: inline-block; border-radius: 8px; }
  </style>
</head>
<body>

  <h1>Admin Console (Reset Mode)</h1>
  <div class="status" id="log-output">System initializing...</div>

<script>
    // --- 2. CONFIGURATION ---
    const MASTER_API_URL = "https://script.google.com/macros/s/AKfycbzzkG7_Def-aiH-cF_m0NrdJe53WqQEqRDPa4Fa0nQz9-tu7kII6XmU29N3fe5T6UDF/exec";

    // --- 3. DYNAMIC PATH CALCULATOR ---
    // This finds "/Suburban-Brewing-Company-Portal/" automatically
    const CURRENT_PATH = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

    function log(msg) {
        console.log(msg);
        document.getElementById('log-output').innerHTML += "<br>" + msg;
    }

    window.addEventListener('load', async () => {
        log("üöÄ Starting System Reset...");

        // --- 4. KILL THE ZOMBIE WORKER (ROOT) ---
        if ('serviceWorker' in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            for(let reg of regs) {
                // If scope is NOT our current folder, it's the bad root worker. Kill it.
                if (!reg.scope.includes(CURRENT_PATH)) {
                    log("üíÄ Killing Bad Worker: " + reg.scope);
                    await reg.unregister();
                }
            }
        }

        // --- 5. INITIALIZE ONESIGNAL (CORRECTLY) ---
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            try {
                log("‚öôÔ∏è Configuring OneSignal with path: " + CURRENT_PATH);
                
                await OneSignal.init({
                    appId: "3a6852ed-53d7-4cf0-a14b-c0102564d81d",
                    
                    // üî¥ USE THE DYNAMIC PATH (Impossible to be wrong)
                    path: CURRENT_PATH, 
                    
                    // üî¥ WORKER FILE NAME
                    serviceWorkerPath: "OneSignalSDKWorker.js",
                    
                    // üî¥ LOCK SCOPE TO FOLDER
                    serviceWorkerParam: { scope: CURRENT_PATH },
                    
                    allowLocalhostAsSecureOrigin: true,
                    logLevel: "warn"
                });
                
                log("‚úÖ OneSignal SUCCESS!");
                
                // --- 6. LOGIN (ONLY AFTER SUCCESS) ---
                const userName = sessionStorage.getItem("user_name");
                if(userName) {
                    log("üë§ Logging in as: " + userName);
                    OneSignal.login(userName.toLowerCase());
                }

            } catch (error) {
                log("‚ùå ERROR: " + error.message);
                console.error(error);
            }
        });
    });
</script>
</body>
</html>
