<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    (function() {
        const auth = sessionStorage.getItem("sbc_auth");
        const isLoginPage = window.location.pathname.includes("login.html");
        if (auth !== "true" && !isLoginPage) {
            const repoPath = "/Suburban-Brewing-Company-Portal/";
            window.location.replace(repoPath + "login.html");
        }
    })();
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Suburban Brewing">
  
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">
  
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/931/931949.png">
  <link rel="manifest" href="../manifest.json">
  <title>Suburban Brewing - Ingredient Inventory</title>
  
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* --- SHARED THEME VARIABLES (EXACT MATCH TO INDEX) --- */
    :root {
      --bg: #f8fafc;
      --sidebar: #0f172a; /* Dark Navy */
      --accent: #2563eb;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --card-bg: #ffffff;
      
      --accent-green: #10b981;
      --danger: #ef4444;
      --ready: #10b981;
    }

    /* --- GLOBAL RESET & LAYOUT --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text-main); 
      /* ‚ö†Ô∏è EXACT FONT MATCH */
      font-family: 'Inter', -apple-system, sans-serif; 
      display: flex; 
      min-height: 100vh; 
    }

    /* =========================================
       SIDEBAR STYLES (COPIED FROM INDEX.HTML)
       ========================================= */
    .sidebar { 
      width: 260px; 
      background: var(--sidebar); 
      color: #fff; 
      padding: 24px 0; 
      flex-shrink: 0; 
      position: fixed; 
      height: 100vh; 
      overflow-y: auto; 
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .sidebar h2 { 
      margin: 0 24px 32px; 
      font-size: 20px; 
      font-weight: 800; 
      color: #fff; 
      white-space: nowrap; /* Forces one line */
    }

    /* COLLAPSIBLE HEADERS */
    .nav-section-header {
      font-size: 11px; 
      text-transform: uppercase; 
      color: #94a3b8; 
      margin: 18px 24px 8px; 
      font-weight: 700; 
      letter-spacing: 1px; 
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      user-select: none;
    }
    .nav-section-header:hover { color: #fff; }

    .chevron { transition: transform 0.3s ease; font-size: 10px; }
    .collapsed .chevron { transform: rotate(-90deg); }

    .collapsible-content {
      max-height: 2000px; 
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease;
      opacity: 1;
    }
    .collapsible-content.collapsed { max-height: 0; opacity: 0; }

    /* LINKS */
    .nav-link { 
      display: flex; 
      align-items: center; 
      padding: 10px 24px; 
      color: #64748b; 
      text-decoration: none; 
      font-size: 14px; 
      transition: 0.2s; 
      border-left: 4px solid transparent;
    }
    .nav-link:hover, .nav-link.active { color: #fff; background: #1e293b; }
    .nav-link.active { border-left-color: var(--accent); color: #fff; }

    /* LOGOUT LINK STYLE */
    .logout-link { 
      margin-top: 20px; 
      color: #f87171 !important; 
      border-left: 4px solid transparent; 
      transition: all 0.2s ease; 
      cursor: pointer; 
    }
    .logout-link:hover { 
      background: #450a0a !important; 
      color: #fee2e2 !important; 
      border-left-color: #ef4444; 
    }
    .logout-link span.icon { margin-right: 12px; font-size: 16px; }

    /* --- MAIN CONTENT & HEADER --- */
    #main-content { 
        flex: 1; 
        margin-left: 260px; 
        /* Match Index Padding Logic */
        padding: 40px 40px 0 40px; 
        transition: 0.3s; 
        width: 100%; 
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }
    
    .header-bar { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; }
    .header-bar h1 { font-size: 28px; font-weight: 800; margin: 0; }

    /* --- QTY ALERTS --- */
    .qty-low { color: #ef4444 !important; background: #fef2f2; padding: 2px 6px; border-radius: 4px; border: 1px solid #fee2e2; animation: pulse 2s infinite; font-weight: bold; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    /* --- GRID & FORM STYLES --- */
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .section-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 20px; cursor: pointer; transition: 0.2s; }
    .section-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .section-header { font-weight: 800; font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
    .item-list { padding: 0; margin: 0; list-style: none; }
    .item-row { padding: 8px 0; border-bottom: 1px dotted #eee; display: flex; justify-content: space-between; font-size: 13px; }
    
    .add-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 32px; border: 1px solid #e2e8f0; border-top: 4px solid var(--accent); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
    .form-group label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; font-size: 16px; transition: background-color 0.5s ease; }
    .form-group input:focus { background-color: #fff; border-color: var(--accent); outline: none; }

    .btn-scan { background: var(--sidebar); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .btn-save { background: var(--accent-green); color: white; border: none; padding: 16px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: 700; font-size: 16px; }
    
    /* --- MODAL --- */
    #inventory-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    .modal-content { background: white; margin: 5% auto; padding: 20px; width: 95%; max-width: 900px; border-radius: 20px; max-height: 85vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px; }
    
    .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .inventory-table { width: 100%; border-collapse: collapse; min-width: 600px; }
    .inventory-table th { text-align: left; padding: 12px; background: #f8fafc; color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
    .inventory-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
    .close-btn { font-size: 28px; cursor: pointer; color: var(--text-muted); }

    /* --- FOOTER STYLES (MATCHES INDEX) --- */
    .app-footer {
        margin-top: auto;
        padding: 10px 0; 
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #94a3b8; 
        font-size: 11px;
        font-weight: 500;
        width: 100%;
        margin-bottom: 10px;
    }

    .footer-links a {
        color: #94a3b8;
        text-decoration: none;
        margin-left: 20px;
        transition: color 0.2s ease;
    }

    .footer-links a:hover {
        color: var(--accent);
        text-decoration: underline;
    }

    .system-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin-left: 15px;
        padding-left: 15px;
        border-left: 1px solid #cbd5e1;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background-color: var(--ready); /* Green */
        border-radius: 50%;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
        70% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
    }

    /* ============================================================
       MOBILE DRAWER & GRID LOGIC 
       ============================================================ */
    #menu-toggle { display: none; }
    .menu-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(2px); }

    @media (max-width: 1024px) {
      .sidebar { left: -260px; z-index: 2001; }
      .sidebar.open { left: 0; }
      #main-content { margin-left: 0 !important; padding: 20px; }
      .menu-overlay.active { display: block; }
      
      #menu-toggle {
        display: flex; position: fixed; bottom: 25px; right: 25px;
        width: 65px; height: 65px; background: var(--accent); color: white;
        border-radius: 50%; justify-content: center; align-items: center;
        font-size: 28px; z-index: 2002; box-shadow: 0 4px 15px rgba(0,0,0,0.4); border: none;
      }

      .header-bar { flex-direction: column; align-items: flex-start; gap: 15px; }
      .btn-scan { width: 100%; }
      .inventory-grid { grid-template-columns: 1fr; }
      .modal-content { margin: 2% auto; width: 98%; height: 96vh; border-radius: 12px; }
      
      /* Footer Stack */
      .app-footer { flex-direction: column; gap: 15px; text-align: center; }
      .footer-links a { margin: 0 10px; }
      .system-status { border-left: none; padding-left: 0; margin-left: 0; margin-top: 5px; }
    }
  </style>
</head>
<body>
  <button id="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
  <div id="menu-overlay" class="menu-overlay" onclick="toggleMobileMenu()"></div>
  
  <aside class="sidebar">
    <h2>SUBURBAN BREWING</h2>
    <div class="nav-section-header"><span>System</span></div>
    <div class="collapsible-content">
      <a href="#" class="nav-link logout-link" onclick="handleLogout()">
        <span class="icon">üö™</span> <span>Logout of Portal</span>
      </a>
    </div>

    <script>
     function handleLogout() {
       sessionStorage.removeItem("sbc_auth");
       const repoPath = "/Suburban-Brewing-Company-Portal/";
       window.location.replace(repoPath + "login.html");
    }
    </script>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-main', this)"><span>Main Menu</span><span class="chevron">‚ñº</span></div>
    <div id="grp-main" class="collapsible-content">
      <a href="../index.html" class="nav-link"><span>Command Center</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-sample', this)"><span>Samplings</span><span class="chevron">‚ñº</span></div>
    <div id="grp-sample" class="collapsible-content">
      <a href="../Samplings/Schedule-Sampling.html" class="nav-link"><span>Schedule Sampling</span></a>
      <a href="../Samplings/sampling-calendar.html" class="nav-link"><span>Sampling Calendar</span></a>
      <a href="../Samplings/sampling-report.html" class="nav-link"><span>Log Sampling Report</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-sales', this)"><span>Sales</span><span class="chevron">‚ñº</span></div>
    <div id="grp-sales" class="collapsible-content">
      <a href="../sales/sales-opportunities.html" class="nav-link"><span>Sales Opportunities</span></a>
      <a href="../sales/leads.html" class="nav-link"><span>AI Sales Leads</span></a>
      <a href="../sales/invoice-search.html" class="nav-link"><span>Invoice Search</span></a>
      <a href="../sales/deliveries.html" class="nav-link"><span>Delivery Tracking</span></a>
      <a href="../sales/new invoices.html" class="nav-link"><span>New Invoice</span></a>
    </div>

    <div class="nav-section-header" onclick="toggleGroup('grp-inv', this)"><span>Inventory</span><span class="chevron">‚ñº</span></div>
    <div id="grp-inv" class="collapsible-content">
      <a href="Ingredient-inventory.html" class="nav-link active"><span>Ingredient Inventory</span></a>
      <a href="brewery.html" class="nav-link"><span>Packaged Inventory</span></a>
      <a href="wholesaler-inventory.html" class="nav-link"><span>Wholesaler Inventory</span></a>
      <a href="restaurant-inventory.html" class="nav-link"><span>Restaurant Inventory</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-brew', this)"><span>Brewing</span><span class="chevron">‚ñº</span></div>
    <div id="grp-brew" class="collapsible-content">
      <a href="../Brewing/brew-calendar.html" class="nav-link"><span>Brewing Calendar</span></a>
      <a href="../Brewing/Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
      <a href="../Brewing/Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
      <a href="../Brewing/cellar.html" class="nav-link"><span>Cellar Management</span></a>
      <a href="../Brewing/qc-dashboard.html" class="nav-link"><span>QC Dashboard</span></a>
      <a href="../Brewing/packaging.html" class="nav-link"><span>Packaging log</span></a>
    </div>
    
    <div class="nav-section-header" onclick="toggleGroup('grp-rep', this)"><span>Reporting & Analytics</span><span class="chevron">‚ñº</span></div>
    <div id="grp-rep" class="collapsible-content">
      <a href="../Reports/Monthly-sales.html" class="nav-link"><span>Monthly Sales Report</span></a>
      <a href="../Reports/ProfitAnalysis.html" class="nav-link"><span>Profit Analysis Report</span></a>
      <a href="../Reports/Route.html" class="nav-link"><span>Sales Route Opt.</span></a>
    </div>
  </aside>

  <main id="main-content">
    <div class="header-bar">
      <h1>Ingredient Inventory</h1>
      <button class="btn-scan" onclick="toggleScanner()">Toggle Scanner (QR & Barcode)</button>
    </div>

    <form id="inventoryForm">
      <div class="add-card" id="entry-form">
        <h3 style="margin-top:0; color: var(--accent);">Inventory Entry Portal</h3>
        <div id="reader" style="display:none; margin-bottom: 15px; border-radius: 12px; overflow: hidden; border: 2px solid #e2e8f0;"></div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="inv-cat" name="category" onchange="renderDynamicFields()" required>
              <option value="">Select Category...</option>
              <option value="Malt">Malt/Grain</option>
              <option value="Hops">Hops</option>
              <option value="Yeast">Yeast</option>
              <option value="Boil">Boil Additions</option>
              <option value="Water">Water Chemistry</option>
              <option value="Packaging">Packaging</option>
            </select>
          </div>
          <div class="form-group">
            <label>Item Name</label>
            <input type="text" id="inv-name" name="name" required placeholder="e.g. 2-Row / Citra">
          </div>
          <div class="form-group">
            <label>Lot Number</label>
            <input type="text" id="inv-lot" name="lot" required placeholder="Scan or Type Lot">
          </div>
          <div class="form-group">
            <label>Quantity In</label>
            <input type="number" step="0.01" id="inv-qty" name="qty" required placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Unit Price ($)</label>
            <input type="number" step="0.01" id="inv-price" name="price" placeholder="0.00">
          </div>
        </div>

        <div id="coa-fields-container" class="form-row"></div>
        
        <button type="submit" class="btn-save">Update Inventory Levels</button>
      </div>
    </form>

    <div class="inventory-grid">
      <div class="section-card" onclick="setCategoryAndOpenModal('Malt')">
        <div class="section-header">Malt / Grains</div>
        <ul class="item-list"><li class="item-row"><span>View Current Grain Stock</span></li></ul>
      </div>
      <div class="section-card" onclick="setCategoryAndOpenModal('Hops')">
        <div class="section-header">Hops</div>
        <ul class="item-list"><li class="item-row"><span>View Current Hop Stock</span></li></ul>
      </div>
      <div class="section-card" onclick="setCategoryAndOpenModal('Yeast')">
        <div class="section-header">Yeast</div>
        <ul class="item-list"><li class="item-row"><span>View Yeast Library</span></li></ul>
      </div>
      <div class="section-card" onclick="setCategoryAndOpenModal('Boil')">
        <div class="section-header">Boil Additions</div>
        <ul class="item-list"><li class="item-row"><span>View Salts & Finings</span></li></ul>
      </div>
      <div class="section-card" onclick="setCategoryAndOpenModal('Water')">
        <div class="section-header">Water Chemistry</div>
        <ul class="item-list"><li class="item-row"><span>View Acids & Salts</span></li></ul>
      </div>
      <div class="section-card" onclick="setCategoryAndOpenModal('Packaging')">
        <div class="section-header">Packaging</div>
        <ul class="item-list"><li class="item-row"><span>View Cans, Lids, & Boxes</span></li></ul>
      </div>
    </div>

    <div style="flex-grow:1;"></div>
    <footer class="app-footer">
        <div class="footer-left">
            <span>&copy; <span id="copyright-year">2026</span> Suburban Brewing Co.</span>
            <span class="system-status">
                <span class="status-dot"></span>
                System Operational
            </span>
        </div>
        <div class="footer-links">
            <span>Portal v2.5</span>
            <a href="https://github.com/remyjdavis/Suburban-Brewing-Company-Portal" target="_blank">Repo</a>
            <a href="#" onclick="Swal.fire({
                title: 'App Support', 
                html: '<b>Remy Davis</b><br>remyjdavis90@gmail.com', 
                icon: 'info',
                confirmButtonColor: 'var(--accent)'
            })">Support</a>
            <a href="#" onclick="location.reload()">Refresh Data</a>
        </div>
    </footer>
  </main>

  <div id="inventory-modal" onclick="if(event.target == this) closeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title" style="margin:0;">Category Inventory</h2>
        <span class="close-btn" onclick="closeModal()">&times;</span>
      </div>
      <div id="modal-body">
        <table class="inventory-table">
          <thead>
            <tr>
              <th>Item Name</th>
              <th>Lot #</th>
              <th>On Hand</th>
              <th>COA/Specs</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="inventory-details-rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxA6EQy6w8k6VSevKLS9Dis0egMQ--k7mHKy9kBJ5u9XsDhk46jDun46w02rs1hcT5iLQ/exec';
    const form = document.getElementById('inventoryForm');
    let html5QrCode;

    // --- 1. NAVIGATION & UI LOGIC ---
    
    function toggleGroup(contentId, headerEl) {
        const content = document.getElementById(contentId);
        content.classList.toggle('collapsed');
        headerEl.classList.toggle('collapsed');
    }

    function toggleMobileMenu() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('menu-overlay');
        const btn = document.getElementById('menu-toggle');
        
        const isOpen = sidebar.classList.toggle('open');
        overlay.classList.toggle('active');
        
        // Prevent background scrolling on phone while menu is open
        document.body.style.overflow = isOpen ? 'hidden' : '';
        
        // Switch icon between Hamburger and X
        btn.innerText = isOpen ? '‚úï' : '‚ò∞';
    }

    // Consolidated Initializer
    window.addEventListener('DOMContentLoaded', () => {
        // Set Year
        document.getElementById('copyright-year').innerText = new Date().getFullYear();

        // 1. Sidebar Auto-expand active group
        const activeLink = document.querySelector('.nav-link.active');
        if (activeLink) {
            const parentGroup = activeLink.closest('.collapsible-content');
            if (parentGroup) {
                parentGroup.classList.remove('collapsed');
                const header = parentGroup.previousElementSibling;
                if (header) header.classList.remove('collapsed');
            }
        }

        // 2. Mobile Link Auto-close Listener
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 1024) {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar.classList.contains('open')) toggleMobileMenu();
                }
            });
        });
    });

    // --- 2. SCANNER & AI SCRAPER LOGIC ---

    function toggleScanner() {
        const readerDiv = document.getElementById('reader');
        if (readerDiv.style.display === 'none') {
            readerDiv.style.display = 'block';
            
            // NOTE: Using a verbose config to enable 1D Barcodes + QR
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                formatsToSupport: [
                    Html5QrcodeSupportedFormats.QR_CODE,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.CODE_128
                ]
            };

            // Re-instantiate to apply new format configs if needed
            if(html5QrCode) { try{ html5QrCode.clear(); }catch(e){} }
            html5QrCode = new Html5Qrcode("reader");

            html5QrCode.start({ facingMode: "environment" }, config, (txt) => {
                html5QrCode.stop().then(() => {
                    readerDiv.style.display = 'none';
                    handleScannedData(txt);
                });
            });
        } else {
            readerDiv.style.display = 'none';
            if(html5QrCode) html5QrCode.stop();
        }
    }

    function handleScannedData(txt) {
        // 1. Fill Lot Number
        if (!txt.startsWith('http')) {
            document.getElementById('inv-lot').value = txt;
            // AUTO-FOCUS QUANTITY so user can type immediately
            document.getElementById('inv-qty').focus();
            return;
        }

        const parts = txt.split('/');
        const likelyLot = parts[parts.length - 1];
        document.getElementById('inv-lot').value = likelyLot;

        const btn = document.querySelector('.btn-scan');
        const originalText = btn.innerText;
        btn.innerText = "‚è≥ AI Analyzing COA...";
        btn.disabled = true;

        fetch(`${scriptURL}?action=scrapeCOA&url=${encodeURIComponent(txt)}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                const fields = document.getElementById('coa-fields-container');
                let foundAny = false;
                
                const setVal = (name, val) => {
                    const input = fields.querySelector(`input[name="${name}"]`);
                    if(input && val) {
                        input.value = val;
                        input.style.backgroundColor = '#dcfce7'; 
                        setTimeout(() => input.style.backgroundColor = '#f8fafc', 2000);
                        foundAny = true;
                    }
                };

                // --- MALT MAPPING ---
                setVal('color', data.color); setVal('extract', data.extract);
                setVal('moisture', data.moisture); setVal('protein', data.protein);
                setVal('diastatic', data.diastatic); setVal('fan', data.fan);
                setVal('beta_glucan', data.beta); setVal('st_ratio', data.st_ratio);
                setVal('friability', data.friability); setVal('assortment', data.assortment);
                
                // --- HOPS MAPPING ---
                setVal('alpha', data.alpha); setVal('beta', data.beta);
                setVal('oil', data.oil); setVal('hsi', data.hsi);
                setVal('myrcene', data.myrcene); setVal('humulene', data.humulene);
                setVal('caryophyllene', data.caryophyllene); setVal('cohumulone', data.cohumulone);
                setVal('crop_year', data.crop_year);

                // --- BOIL ADDITIONS MAPPING ---
                setVal('cas_num', data.cas);
                setVal('purity', data.purity);
                setVal('heavy_metals', data.heavy_metals);
                setVal('ph_impact', data.ph);
                
                if(foundAny) alert("Success: Extracted COA Data!");
                else alert("Connected to COA, but couldn't find fields matching your current Category selection.");
            } else {
                if(confirm("Could not auto-read. Open link?")) window.open(txt, '_blank');
            }
        })
        .catch(err => {
            console.error(err);
            window.open(txt, '_blank');
        })
        .finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
            // AUTO-FOCUS QUANTITY after scraping is done
            document.getElementById('inv-qty').focus();
        });
    }

    // --- 3. DYNAMIC FORM FIELDS ---
    
    function renderDynamicFields() {
        const cat = document.getElementById('inv-cat').value;
        const container = document.getElementById('coa-fields-container');
        container.innerHTML = "";
        
        if (cat === "Malt") {
            container.innerHTML = `
                <div class="form-group"><label>Maltster</label><input type="text" name="source"></div>
                <div class="form-group"><label>Bag Weight (lbs)</label><input type="number" name="bag_weight" placeholder="50 or 55"></div>
                <div class="form-group"><label>Color (¬∞L)</label><input type="number" step="0.1" name="color"></div>
                <div class="form-group"><label>Extract FGDB %</label><input type="number" step="0.1" name="extract"></div>
                <div class="form-group"><label>Moisture %</label><input type="number" step="0.1" name="moisture"></div>
                <div class="form-group"><label>Protein %</label><input type="number" step="0.1" name="protein"></div>
                <div class="form-group"><label>Diastatic Power (¬∞L)</label><input type="number" step="1" name="diastatic"></div>
                <div class="form-group"><label>FAN (mg/L)</label><input type="number" step="1" name="fan"></div>
                <div class="form-group"><label>Beta-Glucan (mg/L)</label><input type="number" step="1" name="beta_glucan"></div>
                <div class="form-group"><label>S/T Ratio %</label><input type="number" step="0.1" name="st_ratio"></div>
                <div class="form-group"><label>Friability %</label><input type="number" step="0.1" name="friability"></div>
                <div class="form-group"><label>Assortment %</label><input type="number" step="0.1" name="assortment"></div>
            `;
        } else if (cat === "Hops") {
            container.innerHTML = `
                <div class="form-group"><label>Grower/Source</label><input type="text" name="source"></div>
                <div class="form-group"><label>Crop Year</label><input type="number" name="crop_year" placeholder="2024"></div>
                <div class="form-group"><label>Form</label>
                    <select name="form"><option value="Pellet">Pellet T-90</option><option value="Cryo">Cryo/Lupulin</option><option value="Leaf">Leaf/Whole</option><option value="Extract">Extract</option></select>
                </div>
                <div class="form-group"><label>Alpha Acid %</label><input type="number" step="0.1" name="alpha"></div>
                <div class="form-group"><label>Beta Acid %</label><input type="number" step="0.1" name="beta"></div>
                <div class="form-group"><label>Total Oil (mL/100g)</label><input type="number" step="0.1" name="oil"></div>
                <div class="form-group"><label>Moisture %</label><input type="number" step="0.1" name="moisture"></div>
                <div class="form-group"><label>Myrcene %</label><input type="number" step="0.1" name="myrcene"></div>
                <div class="form-group"><label>Humulene %</label><input type="number" step="0.1" name="humulene"></div>
                <div class="form-group"><label>Caryophyllene %</label><input type="number" step="0.1" name="caryophyllene"></div>
                <div class="form-group"><label>Cohumulone %</label><input type="number" step="0.1" name="cohumulone"></div>
                <div class="form-group"><label>HSI (Index)</label><input type="number" step="0.01" name="hsi"></div>
                <div class="form-group"><label>Storage Notes</label><input type="text" name="notes"></div>
            `;
        } else if (cat === "Yeast") {
            container.innerHTML = `
                <div class="form-group"><label>Source Type</label>
                    <select name="source_type"><option value="Fresh">Fresh Pitch</option><option value="Harvest">Harvest/Slurry</option><option value="Prop">Propagated</option></select>
                </div>
                <div class="form-group"><label>Supplier / Parent Batch</label><input type="text" name="source" placeholder="e.g. Omega or Batch #102"></div>
                <div class="form-group"><label>Gen #</label><input type="number" name="gen" value="1"></div>
                <div class="form-group"><label>Harvest Date</label><input type="date" name="harvest_date"></div>
                <div class="form-group"><label>Expiry Date</label><input type="date" name="expiry_date"></div>
                <div class="form-group"><label>Viability %</label><input type="number" step="1" name="viability"></div>
                <div class="form-group"><label>Cell Count</label><input type="text" name="cell_count" placeholder="e.g. 1.2e9"></div>
                <div class="form-group"><label>Trub Level</label><select name="trub"><option value="Low">Low</option><option value="Med">Medium</option><option value="High">High</option></select></div>
                <div class="form-group"><label>Diastaticus</label><select name="diastaticus"><option value="Pending">Pending</option><option value="Neg">Negative</option><option value="Pos">Positive</option></select></div>
                <div class="form-group"><label>Bacteria</label><select name="bacteria"><option value="Pending">Pending</option><option value="Neg">Negative</option><option value="Pos">Positive</option></select></div>
                <div class="form-group"><label>VDK Potential</label><select name="vdk"><option value="Low">Low</option><option value="Med">Medium</option><option value="High">High</option></select></div>
                <div class="form-group"><label>Flocculation (1-5)</label><input type="number" min="1" max="5" name="flocculation"></div>
            `;
        } else if (cat === "Boil") {
            container.innerHTML = `
                <div class="form-group"><label>Source/Brand</label><input type="text" name="source"></div>
                <div class="form-group"><label>CAS Number</label><input type="text" name="cas_num" placeholder="00-00-0"></div>
                <div class="form-group"><label>Purity/Assay %</label><input type="text" name="purity"></div>
                <div class="form-group"><label>Mfg Date</label><input type="date" name="mfg_date"></div>
                <div class="form-group"><label>Expiry Date</label><input type="date" name="expiry_date"></div>
                <div class="form-group"><label>Heavy Metals</label><input type="text" name="heavy_metals"></div>
                <div class="form-group"><label>pH Impact (1% Sol)</label><input type="number" step="0.1" name="ph_impact"></div>
                <div class="form-group"><label>Solubility Index</label><input type="text" name="solubility"></div>
                <div class="form-group"><label>Usage Notes</label><input type="text" name="notes"></div>
            `;
        } else if (cat === "Water") {
            container.innerHTML = `
                <div class="form-group"><label>Strength/Purity %</label><input type="number" step="0.01" name="strength"></div>
                <div class="form-group"><label>Notes</label><input type="text" name="notes"></div>`;
        } else if (cat === "Packaging") {
            container.innerHTML = `<div class="form-group"><label>Supplier</label><input type="text" name="source"></div><div class="form-group"><label>Notes</label><input type="text" name="notes"></div>`;
        }
    }

    // --- 4. DATA SUBMISSION (POST) ---
    
    form.addEventListener('submit', e => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerText;
        submitBtn.innerText = "Syncing with Brewery Sheet...";
        submitBtn.disabled = true;

        fetch(scriptURL, { 
            method: 'POST', 
            body: new FormData(form),
            mode: 'no-cors' 
        })
        .then(() => {
            alert('Success: Inventory Record Updated!');
            form.reset();
            document.getElementById('coa-fields-container').innerHTML = "";
        })
        .catch(error => {
            alert('Connection Error. Check console.');
            console.error('Error!', error.message);
        })
        .finally(() => {
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
        });
    });

    // --- 5. DATA FETCHING (GET) ---
    
    function fetchRealData(cat) {
        const tbody = document.getElementById('inventory-details-rows');
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>Syncing with Suburban API...</td></tr>";

        const url = `${scriptURL}?category=${encodeURIComponent(cat)}`;

        fetch(url, {
            method: "GET",
            mode: "cors", 
            redirect: "follow" 
        })
        .then(response => {
            if (!response.ok) throw new Error('API returned status ' + response.status);
            return response.json();
        })
        .then(items => {
            renderInventoryRows(items);
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            tbody.innerHTML = `<tr><td colspan='5' style='color:red; text-align:center;'>
                <strong>SYNC FAILED</strong><br>
                ${err.message}<br>
                <small>Ensure Script is deployed as 'Anyone'.</small>
            </td></tr>`;
        });
    }

    function renderInventoryRows(items) {
        const tbody = document.getElementById('inventory-details-rows');
        if (!items || items.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No stock found.</td></tr>";
            return;
        }

        tbody.innerHTML = items.map((item) => {
            const specsHtml = Object.entries(item.specs || {})
                .map(([key, val]) => `
                    <span style="display:inline-block; background:#f1f5f9; border:1px solid #e2e8f0; 
                                padding:2px 6px; margin:2px; border-radius:4px; font-size:10px; font-weight:600;">
                        <span style="color:var(--accent)">${key.toUpperCase()}:</span> ${val}
                    </span>
                `).join('');

            const lowStockClass = item.isLow ? 'qty-low' : '';
            const warningLabel = item.isLow ? '<br><small style="color:#ef4444; font-weight:800;">‚ö†Ô∏è REORDER</small>' : '';

            return `
                <tr>
                    <td>
                        <div style="font-weight:700; color:var(--text-main);">${item.name}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${item.source || ''}</div>
                    </td>
                    <td style="font-family:monospace; font-size:12px;">${item.lot}</td>
                    <td class="${lowStockClass}" style="font-weight:700;">
                        ${item.qty} ${item.unit || ''} ${warningLabel}
                    </td>
                    <td>
                        <div style="display:flex; flex-wrap:wrap; max-width:300px;">
                            ${specsHtml || '<span style="color:#cbd5e1; font-style:italic; font-size:12px;">No specs</span>'}
                        </div>
                    </td>
                    <td>
                        <button class="btn-scan" style="padding:6px 12px; font-size:11px;" onclick="useItemForEntry('${item.name}', '${item.lot}')">SELECT</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // --- 6. UTILS ---
    
    function setCategoryAndOpenModal(cat) {
        document.getElementById('inv-cat').value = cat;
        renderDynamicFields();
        document.getElementById('modal-title').innerText = cat + " Stock Control";
        document.getElementById('inventory-modal').style.display = "block";
        fetchRealData(cat); 
    }

    function useItemForEntry(name, lot) {
        document.getElementById('inv-name').value = name;
        document.getElementById('inv-lot').value = lot;
        closeModal();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closeModal() { document.getElementById('inventory-modal').style.display = "none"; }
  </script>
</body>
</html>
