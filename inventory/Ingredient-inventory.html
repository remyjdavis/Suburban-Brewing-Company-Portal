<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Suburban Brewing - Ingredient Inventory</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --bg: #f8fafc;
            --sidebar: #0f172a;
            --accent: #2563eb;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-bg: #ffffff;
            --accent-green: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text-main); font-family: 'Inter', -apple-system, sans-serif; display: flex; min-height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 260px; background: var(--sidebar); color: #fff; padding: 24px 0; 
            flex-shrink: 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 1000;
        }
        .sidebar h2 { margin: 0 24px 32px; font-size: 20px; font-weight: 800; color: #fff; }
        .nav-section-title { font-size: 11px; text-transform: uppercase; color: #475569; margin: 24px 24px 8px; font-weight: 700; letter-spacing: 1px; }
        .nav-link { display: flex; align-items: center; padding: 10px 24px; color: #94a3b8; text-decoration: none; font-size: 14px; transition: 0.2s; border-left: 4px solid transparent; }
        .nav-link:hover, .nav-link.active { color: #fff; background: #1e293b; }
        .nav-link.active { border-left-color: var(--accent); color: #fff; }

        /* --- MAIN CONTENT & HEADER --- */
        #main-content { flex: 1; margin-left: 260px; padding: 40px; transition: 0.3s; width: 100%; }
        .header-bar { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; }
        .header-bar h1 { font-size: 28px; font-weight: 800; margin: 0; }

        /* --- MOBILE LOGIC --- */
        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; top: auto; left: 0; right: 0; height: 60px; width: 100%; display: flex; flex-direction: row; padding: 0; background: var(--sidebar); justify-content: flex-start; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
            .sidebar h2, .nav-section-title { display: none; }
            .nav-link { display: inline-flex; padding: 0 20px; height: 100%; align-items: center; border: none; font-size: 12px; font-weight: 700; text-transform: uppercase; }
            .nav-link.active { border-top: 4px solid var(--accent); border-left: none; background: #1e293b; }
            #main-content { margin-left: 0; padding: 20px 20px 90px; }
            .header-bar h1 { font-size: 20px; }
        }

        /* --- QTY ALERTS --- */
        .qty-low { color: #ef4444 !important; background: #fef2f2; padding: 2px 6px; border-radius: 4px; border: 1px solid #fee2e2; animation: pulse 2s infinite; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- GRID & FORM STYLES --- */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .section-card { background: white; border-radius: 16px; border: 1px solid #e2e8f0; padding: 20px; cursor: pointer; transition: 0.2s; }
        .section-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .section-header { font-weight: 800; font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
        .item-list { padding: 0; margin: 0; list-style: none; }
        .item-row { padding: 8px 0; border-bottom: 1px dotted #eee; display: flex; justify-content: space-between; font-size: 13px; }
        
        .add-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 32px; border: 1px solid #e2e8f0; border-top: 4px solid var(--accent); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; }
        
        .btn-scan { background: var(--sidebar); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-save { background: var(--accent-green); color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: 700; }
        
        /* --- MODAL --- */
        #inventory-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 90%; max-width: 900px; border-radius: 20px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); padding-bottom: 15px; margin-bottom: 20px; }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table th { text-align: left; padding: 12px; background: #f8fafc; color: var(--text-muted); font-size: 11px; text-transform: uppercase; }
        .inventory-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .close-btn { font-size: 28px; cursor: pointer; color: var(--text-muted); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2>SUBURBAN</h2>
        <div class="nav-section-title">Operations</div>
        <a href="../!Main.html" class="nav-link"><span>Command Center</span></a>
        <a href="../Samplings/Schedule-Sampling.html" class="nav-link"><span>Schedule Sampling</span></a>
        <a href="../Samplings/sampling-calendar.html" class="nav-link"><span>Sampling Calendar</span></a>
        <div class="nav-section-title">Inventory</div>
        <a href="Ingredient-inventory.html" class="nav-link active"><span>Ingredient Inventory</span></a>
        <a href="brewery.html" class="nav-link"><span>Packaged Inventory</span></a>
        <div class="nav-section-title">Brewing</div>
        <a href="../Brewing/Recipe-management.html" class="nav-link"><span>Recipe Management</span></a>
        <a href="../Brewing/Brew-Log.html" class="nav-link"><span>New Brew Log</span></a>
        <a href="../Brewing/cellar.html" class="nav-link"><span>Cellar Management</span></a>
    </aside>

    <main id="main-content">
        <div class="header-bar">
            <h1>Ingredient Inventory</h1>
            <button class="btn-scan" onclick="toggleScanner()">Toggle QR Scanner</button>
        </div>

        <form id="inventoryForm">
            <div class="add-card" id="entry-form">
                <h3 style="margin-top:0; color: var(--accent);">Inventory Entry Portal</h3>
                <div id="reader" style="display:none; margin-bottom: 15px; border-radius: 12px; overflow: hidden;"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Category</label>
                        <select id="inv-cat" name="category" onchange="renderDynamicFields()" required>
                            <option value="">Select Category...</option>
                            <option value="Malt">Malt/Grain</option>
                            <option value="Hops">Hops</option>
                            <option value="Yeast">Yeast</option>
                            <option value="Water">Water Chemistry</option>
                            <option value="Packaging">Packaging</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" id="inv-name" name="name" required placeholder="e.g. Lactic Acid">
                    </div>
                    <div class="form-group">
                        <label>Lot Number</label>
                        <input type="text" id="inv-lot" name="lot" required placeholder="Scan or Type Lot">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" step="0.01" id="inv-qty" name="qty" required placeholder="0.00">
                    </div>
                </div>

                <div id="coa-fields-container" class="form-row"></div>
                
                <button type="submit" class="btn-save">Update Inventory Levels</button>
            </div>
        </form>

        <div class="inventory-grid">
            <div class="section-card" onclick="setCategoryAndOpenModal('Malt')">
                <div class="section-header">Malt / Grains</div>
                <ul class="item-list"><li class="item-row"><span>View Current Grain Stock</span></li></ul>
            </div>
            <div class="section-card" onclick="setCategoryAndOpenModal('Hops')">
                <div class="section-header">Hops</div>
                <ul class="item-list"><li class="item-row"><span>View Current Hop Stock</span></li></ul>
            </div>
            <div class="section-card" onclick="setCategoryAndOpenModal('Water')">
                <div class="section-header">Water Chemistry</div>
                <ul class="item-list"><li class="item-row"><span>View Acids, Salts & pH Control</span></li></ul>
            </div>
            <div class="section-card" onclick="setCategoryAndOpenModal('Yeast')">
                <div class="section-header">Yeast</div>
                <ul class="item-list"><li class="item-row"><span>View Yeast Pitches</span></li></ul>
            </div>
            <div class="section-card" onclick="setCategoryAndOpenModal('Packaging')">
                <div class="section-header">Packaging</div>
                <ul class="item-list"><li class="item-row"><span>View Packaging Stock</span></li></ul>
            </div>
        </div>
    </main>

    <div id="inventory-modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" style="margin:0;">Category Inventory</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Lot #</th>
                            <th>On Hand</th>
                            <th>COA/Specs</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-details-rows"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxA6EQy6w8k6VSevKLS9Dis0egMQ--k7mHKy9kBJ5u9XsDhk46jDun46w02rs1hcT5iLQ/exec';
    const form = document.getElementById('inventoryForm');

    // --- 1. SEND DATA (POST) ---
    form.addEventListener('submit', e => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerText;
        submitBtn.innerText = "Syncing with Brewery Sheet...";
        submitBtn.disabled = true;

        fetch(scriptURL, { 
            method: 'POST', 
            body: new FormData(form),
            mode: 'no-cors' 
        })
        .then(() => {
            alert('Success: Inventory Record Updated!');
            form.reset();
            document.getElementById('coa-fields-container').innerHTML = "";
        })
        .catch(error => {
            alert('Connection Error. Check console.');
            console.error('Error!', error.message);
        })
        .finally(() => {
            submitBtn.innerText = originalText;
            submitBtn.disabled = false;
        });
    });

    // --- 2. FETCH DATA (GET) ---
    // DEFINITIVE FIX: Handles Google 302 Redirects by removing headers and using redirect: "follow"
    function fetchRealData(cat) {
        const tbody = document.getElementById('inventory-details-rows');
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px;'>Syncing with Suburban API...</td></tr>";

        const url = `${scriptURL}?category=${encodeURIComponent(cat)}`;

        fetch(url, {
            method: "GET",
            mode: "cors", 
            redirect: "follow" 
        })
        .then(response => {
            if (!response.ok) throw new Error('API returned status ' + response.status);
            return response.json();
        })
        .then(items => {
            renderInventoryRows(items);
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            tbody.innerHTML = `<tr><td colspan='5' style='color:red; text-align:center;'>
                <strong>SYNC FAILED</strong><br>
                ${err.message}<br>
                <small>Ensure Script is deployed as 'Anyone'.</small>
            </td></tr>`;
        });
    }

    function renderInventoryRows(items) {
        const tbody = document.getElementById('inventory-details-rows');
        if (!items || items.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No stock found.</td></tr>";
            return;
        }

        tbody.innerHTML = items.map((item) => {
            const specsHtml = Object.entries(item.specs || {})
                .map(([key, val]) => `
                    <span style="display:inline-block; background:#f1f5f9; border:1px solid #e2e8f0; 
                                 padding:2px 6px; margin:2px; border-radius:4px; font-size:10px; font-weight:600;">
                        <span style="color:var(--accent)">${key.toUpperCase()}:</span> ${val}
                    </span>
                `).join('');

            const lowStockClass = item.isLow ? 'qty-low' : '';
            const warningLabel = item.isLow ? '<br><small style="color:#ef4444; font-weight:800;">⚠️ REORDER</small>' : '';

            return `
                <tr>
                    <td>
                        <div style="font-weight:700; color:var(--text-main);">${item.name}</div>
                        <div style="font-size:11px; color:var(--text-muted);">${item.source || ''}</div>
                    </td>
                    <td style="font-family:monospace; font-size:12px;">${item.lot}</td>
                    <td class="${lowStockClass}" style="font-weight:700;">
                        ${item.qty} ${item.unit || ''} ${warningLabel}
                    </td>
                    <td>
                        <div style="display:flex; flex-wrap:wrap; max-width:300px;">
                            ${specsHtml || '<span style="color:#cbd5e1; font-style:italic; font-size:12px;">No specs</span>'}
                        </div>
                    </td>
                    <td>
                        <button class="btn-scan" style="padding:6px 12px; font-size:11px;" onclick="useItemForEntry('${item.name}', '${item.lot}')">SELECT</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // --- 3. DYNAMIC FIELD GENERATOR ---
    function renderDynamicFields() {
        const cat = document.getElementById('inv-cat').value;
        const container = document.getElementById('coa-fields-container');
        container.innerHTML = ""; 
        
        if (cat === "Hops") {
            container.innerHTML = `
                <div class="form-group"><label>Alpha %</label><input type="number" step="0.1" name="alpha"></div>
                <div class="form-group"><label>Oil (mL)</label><input type="number" step="0.1" name="oil"></div>
                <div class="form-group"><label>Grower/Source</label><input type="text" name="source"></div>`;
        } else if (cat === "Malt") {
            container.innerHTML = `
                <div class="form-group"><label>Extract %</label><input type="number" step="0.1" name="extract"></div>
                <div class="form-group"><label>Color (°L)</label><input type="number" step="0.1" name="color"></div>
                <div class="form-group"><label>Protein %</label><input type="number" step="0.1" name="protein"></div>
                <div class="form-group"><label>Maltster</label><input type="text" name="source"></div>`;
        } else if (cat === "Water") {
            container.innerHTML = `
                <div class="form-group"><label>Strength/Purity %</label><input type="number" step="0.01" name="strength" placeholder="e.g. 0.88"></div>
                <div class="form-group">
                    <label>Unit</label>
                    <select name="unit">
                        <option value="gal">Gallons</option>
                        <option value="lbs">lbs</option>
                        <option value="kg">kg</option>
                        <option value="ml">ml</option>
                    </select>
                </div>
                <div class="form-group"><label>COA Notes</label><input type="text" name="notes"></div>`;
        } else if (cat === "Yeast") {
            container.innerHTML = `
                <div class="form-group"><label>Gen #</label><input type="number" name="gen" value="1"></div>
                <div class="form-group"><label>Supplier</label><input type="text" name="source"></div>`;
        }
    }

    // --- 4. UTILS ---
    let html5QrCode;
    function toggleScanner() {
        const readerDiv = document.getElementById('reader');
        if (readerDiv.style.display === 'none') {
            readerDiv.style.display = 'block';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                document.getElementById('inv-lot').value = txt;
                toggleScanner();
            });
        } else {
            readerDiv.style.display = 'none';
            if(html5QrCode) html5QrCode.stop();
        }
    }

    function setCategoryAndOpenModal(cat) {
        document.getElementById('inv-cat').value = cat;
        renderDynamicFields();
        document.getElementById('modal-title').innerText = cat + " Stock Control";
        document.getElementById('inventory-modal').style.display = "block";
        fetchRealData(cat); 
    }

    function useItemForEntry(name, lot) {
        document.getElementById('inv-name').value = name;
        document.getElementById('inv-lot').value = lot;
        closeModal();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closeModal() { document.getElementById('inventory-modal').style.display = "none"; }
</script>
</body>
</html>
