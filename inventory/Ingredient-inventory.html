<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suburban Brewing - Ingredient Inventory</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --primary-dark: #2c3e50;
            --accent-blue: #3498db;
            --accent-green: #27ae60;
            --bg-gray: #f4f7f6;
            --sidebar-width: 240px;
        }
.qty-low { 
    color: #e74c3c !important; 
    background: #fdedec; 
    padding: 2px 6px; 
    border-radius: 4px; 
    border: 1px solid #fadbd8;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; background-color: var(--bg-gray); height: 100vh; }

        /* --- SIDEBAR --- */
        #sidebar { width: var(--sidebar-width); background: var(--primary-dark); color: white; position: fixed; height: 100%; }
        .sidebar-header { padding: 25px; border-bottom: 1px solid #34495e; text-align: center; font-weight: bold; }
        .sidebar-menu { list-style: none; padding: 0; }
        .sidebar-menu li { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #34495e; color: #bdc3c7; }
        .active-nav { background: var(--accent-blue) !important; color: white !important; }

        /* --- MAIN CONTENT --- */
        #main-content { margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width)); overflow-y: auto; padding-bottom: 50px; }
        .header-bar { background: white; padding: 15px 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .container { padding: 20px 30px; }

        /* --- INVENTORY SECTIONS --- */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .section-card { background: white; border-radius: 8px; border: 1px solid #ddd; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .section-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: var(--accent-blue); }
        .section-header { background: #eee; padding: 12px 15px; font-weight: bold; color: var(--primary-dark); border-bottom: 1px solid #ddd; }
        .item-list { padding: 0; margin: 0; list-style: none; }
        .item-row { padding: 10px 15px; border-bottom: 1px dotted #eee; display: flex; justify-content: space-between; }
        .qty { font-weight: bold; color: var(--accent-blue); }

        /* --- ADD NEW / SCANNER --- */
        .add-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 2px solid var(--accent-blue); }
        #reader { width: 100%; max-width: 400px; margin: 10px auto; border-radius: 8px; overflow: hidden; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        #coa-fields-container:not(:empty) {
            background: #fdfdfd; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px;
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 20px;
        }

        /* --- MODAL STYLING --- */
        #inventory-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 85%; max-width: 900px; border-radius: 12px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-blue); padding-bottom: 15px; margin-bottom: 20px; }
        .inventory-table { width: 100%; border-collapse: collapse; }
        .inventory-table th, .inventory-table td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .inventory-table th { background-color: #f8f9fa; color: var(--primary-dark); font-size: 0.85rem; }
        .close-btn { font-size: 32px; cursor: pointer; color: #888; line-height: 1; }
        .close-btn:hover { color: #e74c3c; }
        .btn-add-inline { background: var(--accent-blue); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        .btn-scan { background: var(--primary-dark); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-save { background: var(--accent-green); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="sidebar-header">SUBURBAN BREWING</div>
        <ul class="sidebar-menu">
            <li>Brew Log</li>
            <li>Cellar Management</li>
            <li class="active-nav">Ingredient Inventory</li>
            <li>Packaging Log</li>
        </ul>
    </nav>

    <main id="main-content">
        <div class="header-bar">
            <h2>Ingredient & Supply Inventory</h2>
            <button class="btn-scan" onclick="toggleScanner()">Toggle QR Scanner</button>
        </div>

        <div class="container">
            <form id="inventoryForm">
                <div class="add-card" id="entry-form">
                    <h3 style="margin-top:0; color: var(--accent-blue);">Inventory Entry Portal</h3>
                    <div id="reader" style="display:none;"></div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Category</label>
                            <select id="inv-cat" name="category" onchange="renderDynamicFields()">
                                <option value="">Select Category...</option>
                                <option value="Malt">Malt/Grain</option>
                                <option value="Hops">Hops</option>
                                <option value="Yeast">Yeast</option>
                                <option value="Salts">Salts & Water</option>
                                <option value="Packaging">Packaging</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" id="inv-name" name="name" placeholder="e.g. Citra">
                        </div>
                        <div class="form-group">
                            <label>Lot Number</label>
                            <input type="text" id="inv-lot" name="lot" placeholder="Scan or Type Lot">
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" step="0.01" id="inv-qty" name="qty" placeholder="0.00">
                        </div>
                    </div>

                    <div id="coa-fields-container" class="form-row"></div>
                    
                    <button type="submit" class="btn-save">Update Inventory Levels</button>
                </div>
            </form>

            <div class="inventory-grid">
                <div class="section-card" onclick="setCategoryAndOpenModal('Malt')">
                    <div class="section-header">Malt / Grains</div>
                    <ul class="item-list">
                        <li class="item-row"><span>View Current Grain Stock</span></li>
                    </ul>
                </div>
                <div class="section-card" onclick="setCategoryAndOpenModal('Hops')">
                    <div class="section-header">Hops</div>
                    <ul class="item-list">
                        <li class="item-row"><span>View Current Hop Stock</span></li>
                    </ul>
                </div>
                <div class="section-card" onclick="setCategoryAndOpenModal('Packaging')">
                    <div class="section-header">Packaging</div>
                    <ul class="item-list">
                        <li class="item-row"><span>View Packaging Stock</span></li>
                    </ul>
                </div>
                <div class="section-card" onclick="setCategoryAndOpenModal('Yeast')">
                    <div class="section-header">Yeast</div>
                    <ul class="item-list">
                        <li class="item-row"><span>View Yeast Pitches</span></li>
                    </ul>
                </div>
                <div class="section-card" onclick="setCategoryAndOpenModal('Salts')">
                    <div class="section-header">Salts & Water Prep</div>
                    <ul class="item-list">
                        <li class="item-row"><span>View Salt Inventory</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <div id="inventory-modal" onclick="if(event.target == this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" style="margin:0;">Category Inventory</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Lot #</th>
                            <th>On Hand</th>
                            <th>COA/Specs</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-details-rows"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxA6EQy6w8k6VSevKLS9Dis0egMQ--k7mHKy9kBJ5u9XsDhk46jDun46w02rs1hcT5iLQ/exec';
    const form = document.getElementById('inventoryForm');

    // --- SEND DATA (POST) ---
    form.addEventListener('submit', e => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerText = "Syncing with Brewery Sheet...";
        submitBtn.disabled = true;

        fetch(scriptURL, { 
            method: 'POST', 
            body: new FormData(form),
            mode: 'no-cors' 
        })
        .then(() => {
            alert('Success: Inventory Record Updated!');
            form.reset();
            document.getElementById('coa-fields-container').innerHTML = "";
        })
        .catch(error => {
            alert('Connection Error. Check console.');
            console.error('Error!', error.message);
        })
        .finally(() => {
            submitBtn.innerText = "Update Inventory Levels";
            submitBtn.disabled = false;
        });
    });

    // --- FETCH DATA (GET) ---
    function fetchRealData(cat) {
        const tbody = document.getElementById('inventory-details-rows');
        tbody.innerHTML = "<tr><td colspan='5'>Loading from Google Sheets...</td></tr>";

        // We append the category as a URL parameter so the Backend knows what to send
        fetch(`${scriptURL}?category=${cat}`)
            .then(response => response.json())
            .then(items => {
                renderInventoryRows(items);
            })
            .catch(err => {
                console.error("Fetch Error:", err);
                tbody.innerHTML = "<tr><td colspan='5' style='color:red;'>Error connecting to Google. Make sure you deployed as 'Anyone'.</td></tr>";
            });
    }

   function renderInventoryRows(items) {
    const tbody = document.getElementById('inventory-details-rows');
    if (!items || items.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>No stock found.</td></tr>";
        return;
    }

    tbody.innerHTML = items.map((item) => {
        // Build "Tags" for each spec found in the spreadsheet
        const specsHtml = Object.entries(item.specs)
            .map(([key, val]) => `
                <span style="display:inline-block; background:#ebf5fb; border:1px solid #d6eaf8; 
                             padding:2px 6px; margin:2px; border-radius:4px; font-size:11px;">
                    <strong style="color:#2980b9">${key}:</strong> ${val}
                </span>
            `).join('');

        // NEW: Check if the item is low stock to apply the CSS class
        const lowStockClass = item.isLow ? 'qty-low' : '';
        const warningLabel = item.isLow ? '<br><small>⚠️ REORDER</small>' : '';

        return `
            <tr>
                <td>
                    <div style="font-weight:bold; color:#2c3e50;">${item.name}</div>
                    <div style="font-size:11px; color:#7f8c8d;">${item.source || ''}</div>
                </td>
                <td style="font-family:monospace; font-size:12px;">${item.lot}</td>
                <td class="qty ${lowStockClass}">
                    ${item.qty} ${warningLabel}
                </td>
                <td>
                    <div style="display:flex; flex-wrap:wrap; max-width:350px;">
                        ${specsHtml || '<span style="color:#ccc; font-style:italic;">No extra specs</span>'}
                    </div>
                </td>
                <td>
                    <button class="btn-add-inline" onclick="useItemForEntry('${item.name}', '${item.lot}')">Select</button>
                </td>
            </tr>
        `;
    }).join('');
}

    tbody.innerHTML = items.map((item) => {
        // Build "Tags" for each spec found in the spreadsheet
        const specsHtml = Object.entries(item.specs)
            .map(([key, val]) => `
                <span style="display:inline-block; background:#ebf5fb; border:1px solid #d6eaf8; 
                             padding:2px 6px; margin:2px; border-radius:4px; font-size:11px;">
                    <strong style="color:#2980b9">${key}:</strong> ${val}
                </span>
            `).join('');

        return `
            <tr>
                <td>
                    <div style="font-weight:bold; color:#2c3e50;">${item.name}</div>
                    <div style="font-size:11px; color:#7f8c8d;">${item.source || ''}</div>
                </td>
                <td style="font-family:monospace; font-size:12px;">${item.lot}</td>
                <td class="qty">${item.qty}</td>
                <td>
                    <div style="display:flex; flex-wrap:wrap; max-width:350px;">
                        ${specsHtml || '<span style="color:#ccc; font-style:italic;">No extra specs</span>'}
                    </div>
                </td>
                <td>
                    <button class="btn-add-inline" onclick="useItemForEntry('${item.name}', '${item.lot}')">Select</button>
                </td>
            </tr>
        `;
    }).join('');
}
        function getLowStockSummary() {
  const categories = ["Malt", "Hops", "Yeast", "Salts", "Packaging"];
  let lowItems = [];
  
  categories.forEach(cat => {
    const items = getInventoryByCategory(cat);
    const filtered = items.filter(i => i.isLow);
    if(filtered.length > 0) {
      lowItems.push({ category: cat, items: filtered });
    }
  });
  
  return lowItems; // This will populate your Dashboard "To Order" card
}
    // --- UTILITIES (QR & Modals) ---
    let html5QrCode;

    function toggleScanner() {
        const readerDiv = document.getElementById('reader');
        if (readerDiv.style.display === 'none') {
            readerDiv.style.display = 'block';
            startScanner();
        } else {
            readerDiv.style.display = 'none';
            if(html5QrCode) html5QrCode.stop();
        }
    }

    function startScanner() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            document.getElementById('inv-lot').value = decodedText;
            toggleScanner();
        });
    }

    function setCategoryAndOpenModal(cat) {
        document.getElementById('inv-cat').value = cat;
        renderDynamicFields();
        const modal = document.getElementById('inventory-modal');
        document.getElementById('modal-title').innerText = cat + " Stock Details";
        modal.style.display = "block";
        fetchRealData(cat); 
    }

    function useItemForEntry(name, lot) {
        document.getElementById('inv-name').value = name;
        document.getElementById('inv-lot').value = lot;
        closeModal();
        document.getElementById('entry-form').scrollIntoView({ behavior: 'smooth' });
    }

    function closeModal() { document.getElementById('inventory-modal').style.display = "none"; }

    function renderDynamicFields() {
        const cat = document.getElementById('inv-cat').value;
        const container = document.getElementById('coa-fields-container');
        container.innerHTML = ""; 
        
        if (cat === "Hops") {
            container.innerHTML = `
                <div class="form-group"><label>Alpha %</label><input type="number" step="0.1" name="alpha"></div>
                <div class="form-group"><label>Oil (mL)</label><input type="number" step="0.1" name="oil"></div>
                <div class="form-group"><label>Grower/Source</label><input type="text" name="source"></div>`;
        } else if (cat === "Malt") {
            container.innerHTML = `
                <div class="form-group"><label>Extract %</label><input type="number" step="0.1" name="extract"></div>
                <div class="form-group"><label>Color (°L)</label><input type="number" step="0.1" name="color"></div>
                <div class="form-group"><label>Protein %</label><input type="number" step="0.1" name="protein"></div>
                <div class="form-group"><label>Maltster</label><input type="text" name="source"></div>`;
        } else if (cat === "Yeast") {
            container.innerHTML = `
                <div class="form-group"><label>Gen #</label><input type="number" name="gen" value="1"></div>
                <div class="form-group"><label>Supplier</label><input type="text" name="source"></div>`;
        }
    }
</script>
</body>
</html>
